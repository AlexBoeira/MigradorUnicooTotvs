        1   /** Campos reserva em uso:
        2    * IMPORT-PROPOST
        3    * LOG-LIVRE-1:  
        4    * LOG-LIVRE-2:  tpnumeracao_familia (se eh normal ou automatico)
        5    *
        6    * COD-LIVRE-2: numero da lotacao ou 0. o codigo 1 indica DEMITIDO/APOSENTADO (fixo)
        7    *
        8    * NUM-LIVRE-2: contrato_da_pessoa.nrregistro
        9    * NUM-LIVRE-3: contrato_da_pessoa.nrcontrato
       10    * NUM-LIVRE-4: numero da familia ou 0
       11    * NUM-LIVRE-5: id pessoa do contratante origem
       12    * NUM-LIVRE-8: in-tipo-regulamentacao
       13    * NUM-LIVRE-10: nr-proposta. eh gerado no PL/SQL
       14    *
       15    * IMPORT-LOTAC-PROPOST
       16    * NUM-LIVRE-1
       17    * NUM-LIVRE-2
       18    * NUM-LIVRE-3: NRDIA_DE_VENCIMENTO
       19    *
       20    * OBS: alguns sao utilizados apenas para controles internos nas procedures PL/SQL.
       21    *      ainda assim nao devem ser alterados, pois afetaria o processo.
       22    *
       23    * ALTERACOES IMPORTANTES
       24    * 14/02/2017 - implementado tratamento de IMPORT-LOTAC-PROPOST, para popular LOTAC-PROPOST com o novo conceito de LOTACAO.
       25    *              apenas planos com modalidade JURIDICA terao lotacao.
       26    *              os planos JURIDICOS que nao possuem lotacao no UNICOO terao lotacao 0
       27    *              a lotacao 1 eh reservada para DEMITIDOS/APOSENTADOS
       28    */
       29   
       30   /* CG0310X1.P - VALIDA CRIACAO DAS PROPOSTAS */
       31   
       32   /* ultimo ID de mensagem de erro: 177 */
       33   
       34   def input param in-batch-online-par          AS CHAR NO-UNDO.
       35   DEF INPUT PARAM in-status-monitorar-par      AS CHAR NO-UNDO.
       36   def input param lg-registro-modulos-par      as log no-undo.
       37   def input param in-classif-par               as INT no-undo.
       38   def input param lg-registro-faixa-par        as log no-undo.
       39   def input param lg-registro-negociacao-par   as log no-undo.
       40   def input param lg-registro-cobertura-par    as log no-undo.
       41   def input param lg-registro-especifico-par   as log no-undo.
       42   def input param lg-registro-procedimento-par as log no-undo.
       43   def input param qt-sair-par                  as INT no-undo.
       44   
       45   /**
       46    * TRANSFORMAR ISSO EM PARAMETRO DE ENTRADA. AJUSTAR CHAMADORES!
       47    */
       48   DEF VAR lg-gerar-termo-par AS LOG INIT NO NO-UNDO.
       49   ASSIGN lg-gerar-termo-par = YES.
       50   
       51   /*DEF STREAM s-rel-erro.
       52   DEF VAR nm-rel-erro-aux AS CHAR INIT "c:\temp\erros_cg0310x1.txt" NO-UNDO.
       53   */
       54   
       55   /********************************************************************************
       56   ** Copyright DATASUL S.A. (1997)
       57   ** Todos os Direitos Reservados.
       58   **
       59   ** Este fonte e de propriedade exclusiva da DATASUL, sua reproducao
       60   ** parcial ou total por qualquer meio, so podera ser feita mediante
       61   ** autorizacao expressa.
       62   *******************************************************************************/
       63   /* Begin_Include: i_version_extract */
       64   def new global shared var v_cod_arq
       65       as char  
       66       format 'x(60)'
       67       no-undo.
       68   def new global shared var v_cod_tip_prog
       69       as character
       70       format 'x(8)'
       71       no-undo.
       72   
       73   def stream s-arq.
       74   
       75   def var c_prg_vrs as char init "" no-undo.
       76   assign c_prg_vrs = "2.00.00.025".
       77   
       78   /* LS */
       79   /* DEF VAR c_id_modulo_ls   AS CHAR NO-UNDO.  */
       80   /* DEF VAR c_desc_modulo_ls AS CHAR NO-UNDO.  */
       81   /* FIM LS */
       82   
       83   if  v_cod_arq <> '' and v_cod_arq <> ?
       84   then do:
       85       /*Exemplo de chamada do EMS5
       86       run pi_version_extract ('api_login':U, 'prgtec/btb/btapi910za.py':U, '1.00.00.008':U, 'pro':U).
       87       */
       88       run pi_version_extract ('':U, 'CG0310X1':U, '2.00.00.025':U, '':U).
       89   end /* if */.
       90   /* End_Include: i_version_extract */
       91   
       92   /*****************************************************************************
       93   ** Procedure Interna.....: pi_version_extract
       94   ** Descricao.............: pi_version_extract
       95   ** Criado por............: jaison
       96   ** Criado em.............: 31/07/1998 09:33:22
       97   ** Alterado por..........: tech14013
       98   ** Alterado em...........: 05/01/2005 19:27:44
       99   *****************************************************************************/
      100   PROCEDURE pi_version_extract:
      101   
      102       /************************ Parameter Definition Begin ************************/
      103   
      104       def Input param p_cod_program
      105           as character
      106           format "x(08)"
      107           no-undo.
      108       def Input param p_cod_program_ext
      109           as character
      110           format "x(8)"
      111           no-undo.
      112       def Input param p_cod_version
      113           as character
      114           format "x(8)"
      115           no-undo.
      116       def Input param p_cod_program_type
      117           as character
      118           format "x(8)"
      119           no-undo.
      120   
      121   
      122       /************************* Parameter Definition End *************************/
      123   
      124       /************************* Variable Definition Begin ************************/
      125   
      126       def var v_cod_event_dic
      127           as character
      128           format "x(20)":U
      129           label "Evento"
      130           column-label "Evento"
      131           no-undo.
      132       def var v_cod_tabela
      133           as character
      134           format "x(28)":U
      135           label "Tabela"
      136           column-label "Tabela"
      137           no-undo.
      138   
      139   
      140       /************************** Variable Definition End *************************/
      141       IF p_cod_program_type = "" OR p_cod_program_type = ? THEN DO:
      142           ASSIGN p_cod_program_type = "pro".
      143       END.
      144   
      145   
      146       if  can-do(v_cod_tip_prog, p_cod_program_type)
      147       then do:
      148           if p_cod_program_type = 'dic' then 
      149              assign p_cod_program_ext = replace(p_cod_program_ext, 'database/', '').
      150   
      151           output stream s-arq to value(v_cod_arq) append.
      152   
      153           
      154   
      155           put stream s-arq unformatted
      156               p_cod_program            at 1 
      157               p_cod_program_ext        at 43 
      158               p_cod_version            at 69 
      159               today                    at 84 
      160               string(time, 'HH:MM:SS') at 94 skip.
      161   
      162           if  p_cod_program_type = 'pro' then do:
      163               
      164           end.
      165   
      166           if  p_cod_program_type = 'dic' then do:
      167               
      168           end.
      169   
      170           output stream s-arq close.
      171       end /* if */.
      172   
      173   END PROCEDURE. /* pi_version_extract */
      174     /*** 010025 ***/
      175   
      176   
      177   
      178   /******************************************************************************
      179   *      Programa .....: CG0310X1.p                                              *
      180   *      Data .........: 29 de Janeiro de 2015                                  *
      181   *      Autor ........: TOTVS                                                  *
      182   *      Sistema ......: CG - CADASTROS GERAIS                                  *
      183   *      Programador ..: Ja¡ne Marin                                            *
      184   *      Objetivo .....: Importacao de Dados da Proposta                        *
      185   ******************************************************************************/
      186   /*hide all no-pause.*/
      187   /*****************************************************************************
      188   *      Programa .....: hdvarregua.i                                          *
      189   *      Data .........: 20 de Janeiro de 1998                                 *
      190   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
      191   *      Sistema ......: HD - Includes Padroes                                 *
      192   *      Programador ..: Airton Nora                                           *
      193   *      Objetivo .....: Variaveis para montagem das reguas                    *
      194   *----------------------------------------------------------------------------*
      195   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
      196   *      7.00.000  06/03/2003  Nora           Desenvolvimento                  *
      197   *****************************************************************************/
      198   
      199   def var lg-permitido        as log                                      no-undo.
      200   def var lg-btn-principal    as log                                      no-undo.
      201   def var lg-btn-inclui       as log                                      no-undo.
      202   def var lg-btn-modifica     as log                                      no-undo.
      203   def var lg-btn-elimina      as log                                      no-undo.
      204   def var lg-btn-funcao       as log                                      no-undo.
      205   def var lg-btn-relatorio    as log                                      no-undo.
      206   def var lg-btn-copiar       as log                                      no-undo.
      207   def var lg-btn-congela      as log                                      no-undo.
      208   def var lg-btn-descongela   as log                                      no-undo.
      209   def var lg-btn-parametro    as log                                      no-undo.
      210   def var lg-btn-atualiza     as log                                      no-undo.
      211   def var lg-btn-selecao      as log                                      no-undo.
      212   def var lg-btn-executa      as log                                      no-undo.
      213   def var lg-btn-geracao      as log                                      no-undo.
      214   def var lg-btn-transfere    as log                                      no-undo.
      215   def var lg-btn-reativa      as log                                      no-undo.
      216   def var lg-btn-habilita     as log                                      no-undo.
      217   def var lg-btn-desabilita   as log                                      no-undo.
      218   def var lg-btn-beneficiario as log                                      no-undo.
      219   def var lg-btn-contratante  as log                                      no-undo.
      220   def var lg-btn-simulacao    as log                                      no-undo.
      221   def var lg-btn-suspende     as log                                      no-undo.
      222   def var lg-btn-arquivo      as log                                      no-undo.
      223   def var lg-btn-cancela      as log                                      no-undo.
      224   def var lg-btn-duplicar     as log                                      no-undo.
      225   def var lg-btn-reajustar    as log                                      no-undo.
      226   def var lg-btn-revalorizar  as log                                      no-undo.
      227   def var lg-btn-estornar     as log                                      no-undo.
      228   def var lg-btn-exames       as log                                      no-undo.
      229   def var lg-btn-fechar       as log                                      no-undo.
      230   def var lg-btn-prorrogar    as log                                      no-undo.
      231   def var lg-btn-antecipacao  as log                                      no-undo.
      232   def var lg-btn-confirma     as log                                      no-undo.
      233   def var nr-tam-permis       as int                                      no-undo.
      234   def var nm-prg-novo         as char format "x(100)"                     no-undo.
      235   def var c-opcao             as char                                     no-undo.
      236   
      237   /**
      238    * Auxiliares para montagem das mensagens de erro, para impedir
      239    * que a mensagem fique "?" quando contiver conteudo nulo.
      240    */
      241   DEF VAR char-aux1 AS CHAR NO-UNDO.
      242   DEF VAR char-aux2 AS CHAR NO-UNDO.
      243   DEF VAR char-aux3 AS CHAR NO-UNDO.
      244   DEF VAR char-aux4 AS CHAR NO-UNDO.
      245   DEF VAR char-aux5 AS CHAR NO-UNDO.
      246   
      247   /* --------------------------------------------------- BOTOES PARA WINDOWS --- */
      248   /*****************************************************************************
      249   *      Programa .....: hddefbotao.i                                          *
      250   *      Data .........: 06 de Marco de 2003                                   *
      251   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
      252   *      Sistema ......: Includes padraes                                      *
      253   *      Programador ..: Airton Nora                                           *
      254   *      Objetivo .....: Definicao dos botoes para windows                     *
      255   *----------------------------------------------------------------------------*
      256   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
      257   *****************************************************************************/
      258   
      259   /* --------------------------------------------------- BOTOES PARA WINDOWS --- */
      260   define button b-primeiro 
      261        image-up file "igp/primeiro-up.gif" image-size 4 by 4
      262        label "P&rimeiro" 
      263        size 4 BY 2.0 tooltip "Primeiro"
      264        auto-go.
      265   
      266   define button b-ultimo 
      267        image-up file "igp/ultimo-up.gif" image-size 4 by 4
      268        label "&Ultimo" 
      269        size 4 BY 2.0 tooltip "Ultimo"
      270        auto-go.
      271   
      272   define button b-proximo 
      273        image-up file "igp/proximo-up.gif" image-size 4 by 4
      274        label "&Proximo" 
      275        size 4 BY 2.0 tooltip "Proximo"
      276        auto-go.
      277   
      278   define button b-anterior 
      279        image-up file "igp/anterior-up.gif" image-size 4 by 4
      280        label "&Anterior" 
      281        size 4 BY 2.0 tooltip "Anterior"
      282        auto-go.
      283   
      284   define button b-codigo 
      285        image-up file "igp/pesquisa-up.gif" image-size 4 by 4
      286        label "&Codigo" 
      287        size 4 BY 2.0 tooltip "Codigo"
      288        auto-go.
      289   
      290   define button b-inclui 
      291        image-up file "igp/inclui-up.gif" image-size 4 by 4
      292        label "&Inclui" 
      293        size 4 BY 2.0 tooltip "Inclui"
      294        auto-go.
      295   
      296   define button b-modifica 
      297        image-up file "igp/modifica-up.gif" image-size 4 by 4
      298        label "&Modifica" 
      299        size 4 BY 2.0 tooltip "Modifica"
      300        auto-go.
      301   
      302   define button b-elimina 
      303        image-up file "igp/elimina-up.gif" image-size 4 by 4
      304        label "&Elimina" 
      305        size 4 BY 2.0 tooltip "Elimina"
      306        auto-go.
      307   
      308   define button b-funcao  
      309        image-up file "igp/funcoes-up.gif" image-size 4 by 4
      310        label "&Funcao" 
      311        size 4 BY 2.0 tooltip "Funcao"
      312        auto-go.
      313   
      314   define button b-lista 
      315        image-up file "igp/lista-up.gif" image-size 4 by 4
      316        label "&Lista" 
      317        size 4 BY 2.0 tooltip "Lista"
      318        auto-go.
      319   
      320   define button b-relatorio 
      321        image-up file "igp/relatorio-up.gif" image-size 4 by 4
      322        label "Rela&torio" 
      323        size 4 BY 2.0 tooltip "Relatorio"
      324        auto-go.
      325   
      326   define button b-imprime
      327        image-up file "igp/imprime-up.gif" image-size 4 by 4
      328        label "Imprime" 
      329        size 4 BY 2.0 tooltip "Imprime"
      330        auto-go.
      331   
      332   define button b-fim DEFAULT 
      333        image-up file "igp/saida-up.gif" image-size 4 by 4
      334        label "&Fim" 
      335        size 4 BY 2.0 tooltip "Saida"
      336        auto-go.
      337   
      338   define button b-help DEFAULT 
      339        image-up file "igp/help-up.gif" image-size 4 by 4
      340        label "&Help" 
      341        size 4 BY 2.0 tooltip "Ajuda"
      342        .
      343   
      344   define button b-copia
      345        image-up file "igp/copia-up.gif" image-size 4 by 4
      346        label "&Copia" 
      347        size 4 BY 2.0 tooltip "Copia"
      348        auto-go.
      349   
      350   define button b-congela
      351        image-up file "igp/congela-up.gif" image-size 4 by 4
      352        label "Con&gela" 
      353        size 4 BY 2.0 tooltip "Congela"
      354        auto-go.
      355   
      356   define button b-descongela
      357        image-up file "igp/descongela-up.gif" image-size 4 by 4
      358        label "&Descongela" 
      359        size 4 BY 2.0 tooltip "Descongela"
      360        auto-go.
      361   
      362   define button b-parametro
      363        image-up file "igp/parametro-up.gif" image-size 4 by 4
      364        label "&Parametro" 
      365        size 4 BY 2.0 tooltip "Parametro"
      366        auto-go.
      367   
      368   define button b-atualiza
      369        image-up file "igp/atualiza-up.gif" image-size 4 by 4
      370        label "&Atualiza" 
      371        size 4 BY 2.0 tooltip "Atualiza"
      372        auto-go.
      373   
      374   define button b-selecao
      375        image-up file "igp/selecao-up.gif" image-size 4 by 4
      376        label "&Selecao" 
      377        size 4 BY 2.0 tooltip "Selecao"
      378        auto-go.
      379   
      380   define button b-executa
      381        image-up file "igp/executa-up.gif" image-size 4 by 4
      382        label "&Executa" 
      383        size 4 BY 2.0 tooltip "Executa"
      384        auto-go.
      385   
      386   define button b-geracao
      387        image-up file "igp/geracao-up.gif" image-size 4 by 4
      388        label "&Geracao" 
      389        size 4 BY 2.0 tooltip "Geracao"
      390        auto-go.
      391   
      392   define button b-transferencia
      393        image-up file "igp/transferencia-up.gif" image-size 4 by 4
      394        label "&Transferencia" 
      395        size 4 BY 2.0 tooltip "Transferencia"
      396        auto-go.
      397   
      398   define button b-reativa
      399        image-up file "igp/reativa-up.gif" image-size 4 by 4
      400        label "&Reativa" 
      401        size 4 BY 2.0 tooltip "Reativa"
      402        auto-go.
      403   
      404   define button b-habilita
      405        image-up file "igp/habilita-up.gif" image-size 4 by 4
      406        label "&Habilita" 
      407        size 4 BY 2.0 tooltip "Habilita"
      408        auto-go.
      409   
      410   define button b-desabilita
      411        image-up file "igp/desabilita-up.gif" image-size 4 by 4
      412        label "&Desabilita" 
      413        size 4 BY 2.0 tooltip "Desabilita"
      414        auto-go.
      415   
      416   define button b-beneficiario
      417        image-up file "igp/beneficiario-up.gif" image-size 4 by 4
      418        label "&Beneficiario" 
      419        size 4 BY 2.0 tooltip "Beneficiario"
      420        auto-go.
      421   
      422   define button b-contratante
      423        image-up file "igp/contratante-up.gif" image-size 4 by 4
      424        label "&Contratante" 
      425        size 4 BY 2.0 tooltip "Contratante"
      426        auto-go.
      427   
      428   define button b-simulacao
      429        image-up file "igp/simulacao-up.gif" image-size 4 by 4
      430        label "&Simulacao" 
      431        size 4 BY 2.0 tooltip "Simulacao"
      432        auto-go.
      433   
      434   define button b-suspende
      435        image-up file "igp/suspende-up.gif" image-size 4 by 4
      436        label "&Suspende" 
      437        size 4 BY 2.0 tooltip "Suspende"
      438        auto-go.
      439   
      440   define button b-arquivo
      441        image-up file "igp/arquivo-up.gif" image-size 4 by 4
      442        label "&Arquivo" 
      443        size 4 BY 2.0 tooltip "Arquivo"
      444        auto-go.
      445   
      446   define button b-cancela
      447        image-up file "igp/cancela-up.gif" image-size 4 by 4
      448        label "&Cancela" 
      449        size 4 BY 2.0 tooltip "Cancela"
      450        auto-go.
      451   
      452   define button b-classificacao
      453        image-up file "igp/classificacao-up.gif" image-size 4 by 4
      454        label "&Classificacao" 
      455        size 4 BY 2.0 tooltip "Classificacao"
      456        auto-go.
      457   
      458   define button b-duplicar 
      459        image-up file "igp/duplicar-up.gif" image-size 4 by 4
      460        label "&Duplicar" 
      461        size 4 BY 2.0 tooltip "Duplicar"
      462        auto-go.
      463   
      464   define button b-reajustar
      465        image-up file "igp/reajustar-up.gif" image-size 4 by 4
      466        label "&Reajustar" 
      467        size 4 BY 2.0 tooltip "Reajustar"
      468        auto-go.
      469   
      470   define button b-revalorizar
      471        image-up file "igp/revalorizar-up.gif" image-size 4 by 4
      472        label "&Revalorizar" 
      473        size 4 BY 2.0 tooltip "Revalorizar"
      474        auto-go.
      475   
      476   define button b-consiste
      477        image-up file "igp/consiste-up.gif" image-size 4 by 4
      478        label "&Consiste" 
      479        size 4 BY 2.0 tooltip "Consiste"
      480        auto-go.
      481   
      482   define button b-importa
      483        image-up file "igp/importa-up.gif" image-size 4 by 4
      484        label "&Importa" 
      485        size 4 BY 2.0 tooltip "Importa"
      486        auto-go.
      487   
      488   define button b-carrega
      489        image-up file "igp/carrega-up.gif" image-size 4 by 4
      490        label "&Carrega" 
      491        size 4 BY 2.0 tooltip "Carrega"
      492        auto-go.
      493   
      494   define button b-layout
      495        image-up file "igp/layout-up.gif" image-size 4 by 4
      496        label "&Layout" 
      497        size 4 BY 2.0 tooltip "Layout"
      498        auto-go.
      499   
      500   define button b-exporta
      501        image-up file "igp/exporta-up.gif" image-size 4 by 4
      502        label "&Exporta" 
      503        size 4 BY 2.0 tooltip "Exporta"
      504        auto-go.
      505   
      506   define button b-reexporta
      507        image-up file "igp/reexporta-up.gif" image-size 4 by 4
      508        label "&Reexporta" 
      509        size 4 BY 2.0 tooltip "Reexporta"
      510        auto-go.
      511   
      512   define button b-estornar
      513        image-up file "igp/estornar-up.gif" image-size 4 by 4
      514        label "&Estornar" 
      515        size 4 BY 2.0 tooltip "Estornar"
      516        auto-go.
      517   
      518   define button b-exames
      519        image-up file "igp/exames-up.gif" image-size 4 by 4
      520        label "&Exames" 
      521        size 4 BY 2.0 tooltip "Exames"
      522        auto-go.
      523   
      524   define button b-parecer
      525        image-up file "igp/parecer-up.gif" image-size 4 by 4
      526        label "&Parecer" 
      527        size 4 BY 2.0 tooltip "Parecer"
      528        auto-go.
      529   
      530   define button b-antecipacao
      531        image-up file "igp/antecipacao-up.gif" image-size 4 by 4
      532        label "&Antecipacao" 
      533        size 4 BY 2.0 tooltip "Gera Antecipacao de guias"
      534        auto-go.
      535   
      536   define button b-confirma
      537        image-up file "igp/confirma-up.gif" image-size 4 by 4
      538        label "&Confirma"  
      539        size 4 BY 2.0 tooltip "Confirma orcamento"
      540        auto-go.
      541   
      542   define button b-orcamento
      543        image-up file "igp/orcamento-up.gif" image-size 4 by 4
      544        label "&Orcamento" 
      545        size 4 BY 2.0 tooltip "Orcamento"
      546        auto-go.
      547   
      548   define button b-autorizacao
      549        image-up file "igp/autorizacao-up.gif" image-size 4 by 4
      550        label "&Autorizacao" 
      551        size 4 BY 2.0 tooltip "Autorizacao"
      552        auto-go.
      553   
      554   define button b-fechar
      555        image-up file "igp/fechar-up.gif" image-size 4 by 4
      556        label "&Fechar"   
      557        size 4 BY 2.0 tooltip "Fechar"
      558        auto-go.
      559   
      560   define button b-prorrogar
      561        image-up file "igp/prorrogar-up.gif" image-size 4 by 4
      562        label "&Prorrogar" 
      563        size 4 BY 2.0 tooltip "Prorrogar"
      564        auto-go.
      565   
      566   define button b-prestador
      567        image-up file "igp/prestador-up.gif" image-size 4 by 4
      568        label "&Prestador" 
      569        size 4 BY 2.0 tooltip "Prestador"
      570        auto-go.
      571   
      572   define button b-ocorrencia
      573        image-up file "igp/ocorrencia-up.gif" image-size 4 by 4
      574        label "&Ocorrencia" 
      575        size 4 BY 2.0 tooltip "Ocorrencia"
      576        auto-go.
      577   
      578   define button b-solucao
      579        image-up file "igp/solucao-up.gif" image-size 4 by 4
      580        label "&Solucao" 
      581        size 4 BY 2.0 tooltip "Solucao"
      582        auto-go.
      583   
      584   define button b-reimprime
      585        image-up file "igp/reimprime-up.gif" image-size 4 by 4
      586        label "&Reimprime" 
      587        size 4 BY 2.0 tooltip "Reimprime"
      588        auto-go.
      589   
      590   define button b-contabiliza
      591        image-up file "igp/contabiliza-up.gif" image-size 4 by 4
      592        label "&Contabiliza" 
      593        size 4 BY 2.0 tooltip "Contabiliza"
      594        auto-go.
      595   
      596   define button b-descontabiliza
      597        image-up file "igp/descontabiliza-up.gif" image-size 4 by 4
      598        label "&Descontabiliza" 
      599        size 4 BY 2.0 tooltip "Descontabiliza"
      600        auto-go.
      601   
      602   define button b-emissao 
      603        image-up file "igp/relatorio-up.gif" image-size 4 by 4
      604        label "Emissao" 
      605        size 4 BY 2.0 tooltip "Emissao"
      606        auto-go.
      607   
      608   define button b-reemissao
      609        image-up file "igp/reimprime-up.gif" image-size 4 by 4
      610        label "Reemissao" 
      611        size 4 BY 2.0 tooltip "Reemissao"
      612        auto-go.
      613   
      614   define button b-renovacao
      615        image-up file "igp/atualiza-up.gif" image-size 4 by 4
      616        label "Renovacao" 
      617        size 4 BY 2.0 tooltip "Renovacao"
      618        auto-go.
      619   
      620   define button b-novavia
      621        image-up file "igp/inclui-up.gif" image-size 4 by 4
      622        label "Nova Via" 
      623        size 4 BY 2.0 tooltip "Nova Via"
      624        auto-go.
      625   define button b-reembolso
      626        image-up file "igp/reajustar-up.gif" image-size 4 by 4
      627        label "&Reembolso" 
      628        size 4 BY 2.0 tooltip "Reembolso"
      629        auto-go.
      630        
      631   define button b-gera-reembolso
      632        image-up file "igp/reajustar-up.gif" image-size 4 by 4
      633        label "&Gera Reembolso" 
      634        size 4 BY 2.0 tooltip "Gera Reembolso"
      635        auto-go.
      636        
      637   define rectangle Retangulo-1
      638        edge-pixels 2 graphic-edge  
      639        size 78 BY 3
      640        no-fill.
      641        
      642   /******************************************************************************
      643       Programa .....: hdregcpimla.i
      644       Data .........: 05/01/2004
      645       Sistema ......:
      646       Empresa ......: DZSET SOLUCOES E SISTEMAS
      647       Cliente ......:
      648       Programador ..: ELIZETE
      649       Objetivo .....: Rgua de arquivo, consiste, parametro, importa e layout
      650   *-----------------------------------------------------------------------------*
      651       Versao     DATA         RESPONSAVEL
      652                  05/01/2004   ELIZETE
      653   ******************************************************************************/
      654   /* ---------------------------------------------------- REGUAS PARA UNIX --- */
      655   def var tb-cpimla as char extent 6 initial ["Arquivo",
      656                                               "Consiste",
      657                                               "Parametro",
      658                                               "Importa",
      659                                               "Layout",      
      660                                               "Fim"]       no-undo.
      661    
      662   /******************************************************************************
      663       Programa .....: hdregcpimla.f
      664       Data .........: 05/01/2004
      665       Sistema ......:
      666       Empresa ......: DZSET SOLUCOES E SISTEMAS
      667       Cliente ......:
      668       Programador ..: ELIZETE
      669       Objetivo .....: Rgua de arquivo, consiste, parametro, importa e layout
      670   *-----------------------------------------------------------------------------*
      671       Versao     DATA         RESPONSAVEL
      672                  05/01/2004   ELIZETE
      673   ******************************************************************************/
      674   /* --------------------------------------------------- FRAMES PARA UNIX --- */
      675   form tb-cpimla[1] format "x(7)"
      676        tb-cpimla[2] format "x(8)"
      677        tb-cpimla[3] format "x(9)"
      678        tb-cpimla[4] format "x(7)"
      679        tb-cpimla[5] format "x(6)"
      680        tb-cpimla[6] format "x(3)"
      681        with no-labels attr row 21 no-box overlay centered frame f-cpimla.
      682                   
      683   /* ----------------------------------------------- FRAMES PARA WINDOWS --- */                
      684   define frame f-regua-cpimla 
      685        b-arquivo    at row 1.48 col 24
      686        b-consiste   at row 1.48 col 28
      687        b-parametro  at row 1.48 col 32
      688        b-importa    at row 1.48 col 36
      689        b-layout     at row 1.48 col 40
      690        b-fim        at row 1.48 col 58
      691        b-help       at row 1.48 col 62
      692        Retangulo-1  at row 1    col 2
      693        with 1 down no-box keep-tab-order overlay centered
      694             side-labels no-underline three-d 
      695             at col 1 row 1
      696             size 80 by 3.
      697    
      698   
      699   /* include de variaveis dos display de tela dos relatorios */
      700   /* hdp/hdvarrel.i */
      701   
      702   
      703   def  var nm-cab-usuario           as char format "x(70)"                no-undo.
      704   def  var nm-prog                  as char format "x(08)"                no-undo.
      705   def  var nr-posicao               as integer                            no-undo.
      706   def  var espacos                  as char format "x(80)"                no-undo.
      707   def  var c-versao                 as char format "x(08)"                no-undo.
      708   def  var ds-inicializa-aux        as char format "x(40)"                no-undo.
      709   def  var ds-normal-ativa-aux      as char format "x(40)"                no-undo.
      710   def  var ds-normal-desat-aux      as char format "x(40)"                no-undo.
      711   def  var ds-negrit-ativa-aux      as char format "x(40)"                no-undo.
      712   def  var ds-negrit-desat-aux      as char format "x(40)"                no-undo.
      713   def  var ds-italic-ativa-aux      as char format "x(40)"                no-undo.
      714   def  var ds-italic-desat-aux      as char format "x(40)"                no-undo.
      715   def  var ds-expand-ativa-aux      as char format "x(40)"                no-undo.
      716   def  var ds-expand-desli-aux      as char format "x(40)"                no-undo.
      717   def  var ds-10cpp-ativa-aux       as char format "x(40)"                no-undo.
      718   def  var ds-10cpp-desat-aux       as char format "x(40)"                no-undo.
      719   def  var ds-15cpp-ativa-aux       as char format "x(40)"                no-undo.
      720   def  var ds-15cpp-desat-aux       as char format "x(40)"                no-undo.
      721   def  var ds-20cpp-ativa-aux       as char format "x(40)"                no-undo.
      722   def  var ds-20cpp-desat-aux       as char format "x(40)"                no-undo.
      723   def  var ds-format-folha-aux      as char format "x(40)"                no-undo.
      724   def  var ds-linha-folha-aux       as char format "x(40)"                no-undo.
      725   def  var ds-margem-aux            as char format "x(40)"                no-undo.
      726   def  var ds-primei-linha-aux      as char format "x(40)"                no-undo.
      727   def  var ds-mc-linha-ativa-aux    as char format "x(40)"                no-undo.
      728   def  var ds-mc-linha-desat-aux    as char format "x(40)"                no-undo.
      729   def  var ds-eq-margem-ativa-aux   as char format "x(40)"                no-undo.
      730   def  var ds-eq-margem-desat-aux   as char format "x(40)"                no-undo.
      731   def  var lg-ver-tela-aux          as logical initial no
      732                                        Format "Video/Arquivo"                no-undo.
      733   def  var nm-arq-tela-quo          as char format "x(24)"                no-undo.
      734   def  var ds-campo-imp-quo         as char format "x(132)"               no-undo.
      735   
      736   def  var nm-arquivo-windows-aux   as character                          no-undo.
      737   def  var nr-linhas-windows-aux    as int init 64  format "9999"         no-undo.
      738   def  var nr-pagina-windows-aux    as integer                            no-undo.
      739   def  var nr-fonte-windows-aux     as int init 1                         no-undo.
      740   def  var lg-ok-imprime-windows-aux as logical                           no-undo.
      741   def new global shared var v_cod_usuar_corren as character
      742           format "x(12)":U label "Usu rio Corrente"
      743           column-label "Usu rio Corrente"                                    no-undo.       
      744   assign espacos = fill(" ",80).
      745   
      746    
      747    
      748   assign nm-cab-usuario = "Importacao das Propostas" 
      749          nm-prog        = "CG0310X1"
      750          c-versao       = "1.02.00.019".
      751   /******************************************************************************
      752       Programa .....: hdlog.i
      753       Data .........: 01/11/2005
      754       Sistema ......:
      755       Empresa ......: DZSET SOLUCOES E SISTEMAS
      756       Cliente ......:
      757       Programador ..: NORA
      758       Objetivo .....: Rotina que gera o log de versao
      759   *-----------------------------------------------------------------------------*
      760       Versao     DATA         RESPONSAVEL
      761       7.00.000   01/11/2005   NORA
      762   ******************************************************************************/
      763   /* --- IMPLEMENTADO UMA CHAMADA A PROGRAMA POIS ESTAVA ESTOURANDO 
      764          O SEGMENTO DOS PROGRAMAS                                          --- */
      765   def new global shared var v_cod_usuar_corren as character
      766                             format "x(12)":U label "Usu rio Corrente"
      767                                           column-label "Usu rio Corrente" no-undo.       
      768   def new global shared var in-origem-chamada-menu as character format "x(12)"    
      769                                                                           no-undo.
      770   /* ----------------------------- testa se Serious 7.0 ou GESTAO DE PLANOS ---*/
      771   /* ------------- CASO FOR GESTÃO DE PLANOS RETORNA A VERSÃO DO ROUNTABLE --- */
      772   if in-origem-chamada-menu <> "TEMENU70"
      773   then assign c-versao      = c_prg_vrs. 
      774   
      775   if session:multitasking-interval = 1
      776   then do:
      777          run rtp/rthdlog.p (input c-versao,
      778                             input program-name(1)).
      779        end.
      780       
      781    
      782   
      783   /********************* Definicao Variaveis de Importacao *********************/
      784    
      785   def stream s-import.
      786   def stream s-relat-incl.
      787   def stream s-relat-erro.
      788   
      789   def new shared var lg-registro-modulos            as log init no  format "Sim/Nao"     no-undo.
      790   def new shared var lg-registro-faixa              as log init no  format "Sim/Nao"     no-undo.
      791   def new shared var lg-registro-negociacao         as log init no  format "Sim/Nao"     no-undo.
      792   def new shared var lg-registro-cobertura          as log init no  format "Sim/Nao"     no-undo.
      793   def new shared var lg-registro-especifico         as log init no  format "Sim/Nao"     no-undo.
      794   def new shared var lg-registro-procedimento       as log init no  format "Sim/Nao"     no-undo.
      795   def new shared var lg-ver-imp8                    as log initial no                    no-undo.
      796   def new shared var lg-ver-imp9                    as log initial no                    no-undo.
      797   DEF NEW SHARED VAR lg-gerar-termo-aux             AS LOG INIT NO                       NO-UNDO.
      798   DEF NEW SHARED VAR dt-minima-termo-aux            AS DATE                              NO-UNDO.
      799   
      800   /**
      801    * Quando qt-sair-aux tiver valor diferente de zero, processara registros ate
      802    * atingir esse numero e saira do programa.
      803    * Usar essa opcao quando o chamador for um laco encadeado com os outros processos
      804    * de migracao, para dividir o processamento.
      805    */
      806   DEF            VAR qt-sair-aux      AS INT INIT 0 NO-UNDO.
      807   DEF NEW SHARED VAR qt-cont-sair-aux AS INT INIT 0 NO-UNDO.
      808   
      809   /*-------------------------------------------------------------------------*/
      810   def var lg-relat-erro-aux                         as logi initial no                   no-undo.
      811   def var ds-cabecalho                              as char format "x(30)"               no-undo.
      812   def var ds-rodape                                 as char format "x(80)"  init ""      no-undo.
      813   def var lg-relat-erro                             as logi                              no-undo.
      814   def var nr-insc-contrat-aux                       like contrat.nr-insc-contratante     no-undo.
      815   def var nm-arquivo-mag                            as char format "x(30)"               no-undo.
      816   def var lg-parametro                              as log initial no                    no-undo.
      817   def var tp-registro-imp-ant                       as int format "9"                    no-undo.
      818   def var lg-imp-erro                               as log initial no                    no-undo.
      819   def var lg-tem-proposta-aux                       as   log       initial no            no-undo.
      820   def var nr-contrat-aux                            like contrat.nr-insc-contratante     no-undo.
      821   def var nm-diretorio-aux                          as char format "x(80)"               no-undo.
      822   def var ds-barra                                  as char format "x(1)"                no-undo.
      823   def var nr-insc-contrat-ant                       like propost.nr-insc-contratante     no-undo.
      824   def var nr-insc-contrat-origem-ant                like propost.nr-insc-contratante     no-undo.
      825   def var cd-modalidade-ant                         like modalid.cd-modalidade           no-undo.
      826   def var cd-plano-ant                              like propost.cd-plano                no-undo.
      827   def var nr-proposta-ant                           like propost.nr-proposta             no-undo.
      828   def var lg-ver-imp4                               as log initial no                    no-undo.
      829   def var lg-ver-imp5                               as log initial no                    no-undo.
      830   DEF VAR lg-aceita-repasse-aux                     AS LOG INITIAL NO                    NO-UNDO.                   
      831   def var ds-mensagem-aux                           as char format "x(100)"              no-undo.
      832   def var lg-erro-aux                               as log                               no-undo.
      833   def var lg-passou                                 as log initial no                    no-undo.
      834   def var ix                                        as int format "99"                   no-undo.
      835   def var dt-inicio-comerc-aux                      like ti-pl-sa.dt-inicio-comerc       no-undo.
      836   def var dt-fim-comerc-aux                         like ti-pl-sa.dt-fim-comerc          no-undo.
      837   def var lg-erro-processo-aux                      as   logical   format "yes/no"       no-undo.
      838   def var cd-tab-preco-proc-aux                     as char                              no-undo.
      839   def var ct-tamanho                                as int   format "999"                no-undo.
      840   def var ct-posicao-ini                            as integer                           no-undo.
      841   DEF VAR lg-modulo-erro                            AS LOG                               NO-UNDO.
      842   DEF VAR qtd-reg-rest                              AS INT                               NO-UNDO.
      843   def var lg-medocup-aux                            as log                               no-undo.
      844   DEF VAR cont-aux                                  AS INT                               NO-UNDO.
      845   
      846   DEF VAR h-handle-aux AS HANDLE NO-UNDO.
      847   disable triggers for load of propost.
      848   RUN cgp/cg0311x.p PERSISTENT SET h-handle-aux.
      849   
      850   DEF TEMP-TABLE tt-erro NO-UNDO
      851       FIELD nr-seq            AS INT
      852       FIELD nr-seq-contr      LIKE erro-process-import.num-seqcial-control 
      853       FIELD nom-tab-orig-erro AS CHAR
      854       FIELD des-erro          AS CHAR
      855       INDEX nr-seq       
      856             nr-seq-contr.
      857   
      858   DEF NEW SHARED TEMP-TABLE tt-import-propost NO-UNDO
      859       FIELD rowid-import-prop AS ROWID
      860       FIELD nr-proposta       AS INT
      861       FIELD nr-insc-contrat   like contrat.nr-insc-contratante 
      862       INDEX ID rowid-import-prop.
      863   
      864   def buffer b-import-propost for import-propost.
      865   DEF BUFFER b-propost        FOR propost.
      866   def buffer b-tt-erro        for tt-erro.
      867   
      868   /*----------------------------------------------------------------------------*/
      869   def new shared var in-classif       as int  init 1                     no-undo.
      870   def var tb-classif                  as char extent 3 initial
      871      ["1 - Obriga", "2 - Opcional", "3 - Ambos"]                          no-undo.
      872    
      873   form tb-classif[1] format "x(12)"
      874        tb-classif[2] format "x(12)"
      875        tb-classif[3] format "x(12)"
      876        with no-labels 1 column column 46 no-attr row 13 overlay frame f-classif
      877        title " Opcao ".
      878    
      879   /*----------------------------------------------------------------------------*/
      880   find first paramecp no-lock no-error.
      881   if   available paramecp
      882   then do:
      883          find unimed where unimed.cd-unimed = paramecp.cd-unimed no-lock no-error.
      884          if   available unimed
      885          then assign ds-cabecalho = unimed.nm-unimed-reduz.
      886        end.
      887   else do:
      888          message "Parametros gerais do sistema nao cadastrados."
      889                  view-as alert-box title " Atencao !!! ".
      890          return.
      891        end.
      892   
      893   find first paravpmc no-lock no-error.
      894   if   not avail paravpmc
      895   then do:
      896          message "Parametros dos modulos VP e MC nao localizados."
      897                  view-as alert-box title " Atencao !!! ".
      898          return.
      899        end.
      900   
      901   form header
      902        fill("-", 132) format "x(132)"                           skip
      903        ds-cabecalho
      904        "Inconsistencias Importacao das Propostas"               at 47
      905        "Folha:"                                                 at 122
      906        page-number(s-relat-erro)                                at 128
      907        format ">>>9" skip
      908        fill("-", 112) format "x(112)"
      909        today "-" string(time, "HH:MM:SS")
      910        skip(1)
      911        with no-labels no-box page-top width 132 frame f-cabeca-erro STREAM-IO.
      912    
      913   form header
      914        fill("-", 132) format "x(132)"                         skip
      915        ds-cabecalho
      916        "      Relatorio de Importacao da Proposta         "   at 46
      917        "Folha:"                                               at 122
      918        page-number(s-relat-incl)                              at 128
      919        format ">>>9" skip
      920        fill("-", 112) format "x(112)"
      921        today "-" string(time, "HH:MM:SS")
      922        skip(1)
      923        with no-labels no-box page-top width 132 frame f-cabeca STREAM-IO.
      924    
      925   def rectangle f-param
      926       edge-pixels 3 graphic-edge no-fill size 35 by 8.9.
      927   
      928   form skip(1)
      929        lg-registro-modulos      view-as fill-in size 04 by 1.3 native label "Modulos da Proposta"       colon 28
      930        lg-registro-faixa        view-as fill-in size 04 by 1.3 native label "Faixa Etaria Especial"     colon 28
      931        lg-registro-negociacao   view-as fill-in size 04 by 1.3 native label "Negociacao entre Unidades" colon 28
      932        lg-registro-cobertura    view-as fill-in size 04 by 1.3 native label "Padrao de Cobertura"       colon 28
      933        lg-registro-especifico   view-as fill-in size 04 by 1.3 native label "Campos Especificos"        colon 28
      934        lg-registro-procedimento view-as fill-in size 04 by 1.3 native label "Procedimentos Especiais"   colon 28
      935        f-param at row 1.3 col 1.7
      936        with three-d overlay row 12 column 12 no-labels side-labels frame f-parametro size 37 by 11
      937        title " Parametros da Importacao ".
      938    
      939   form header ds-rodape format "x(132)"
      940        with no-labels no-box width 132 page-bottom frame f-rodape STREAM-IO.
      941    
      942   def var nm-arquivo-erros     as char format "x(35)"
      943           initial "spool/ERROS-P.LST".
      944    
      945   def rectangle f-arq-mag
      946       edge-pixels 3 graphic-edge no-fill size 67 by 3.
      947   
      948   form skip(1.3)
      949        nm-arquivo-erros    view-as fill-in size 36 by 1.3 native label   "   Nome do Arquivo de Erros" at 03
      950           validate(nm-arquivo-erros <> "", "Nao pode ser espacos")
      951        skip
      952        f-arq-mag at row 1.45 col 2
      953        with three-d row 14 column 8 side-labels attr-space overlay frame f-arquivo-mag size 69 by 4.
      954    
      955   def rectangle f-cont
      956       edge-pixels 3 graphic-edge no-fill size 36 by 5.7.                                                                      
      957   
      958   form tt-erro.nr-seq-contr                      column-label "Nro.Seq.Controle"         
      959        tt-erro.nom-tab-orig-erro  format "x(30)" column-label "Tab.Origem Erro"
      960        tt-erro.des-erro           format "x(80)" column-label "Descricao Erro"           
      961        with width 132 down no-box attr-space frame f-erro stream-io.  
      962    
      963   def new shared temp-table w-grava
      964           field cd-campo as inte
      965           field ds-campo as char format "x(355)".
      966    
      967   /*----------------  Opcao Consistencia ------------------------------------*/
      968   def var ct-linhas                       as int  format "999"           no-undo.
      969   def var ct-grava                        as int                         no-undo.
      970   def new shared var nr-cont-antigo       as char                        no-undo.
      971   def new shared var tam                  as int     format "999"        no-undo.
      972   def new shared var posicao-ini          as integer                     no-undo.
      973   def new shared var cd-dados             as char                        no-undo.
      974   def new shared var ct-tam               as int     format "99"         no-undo.
      975   def new shared var lg-consist           as logical initial no          no-undo.
      976   def new shared var lg-consist-aux       as logical initial no          no-undo.
      977    
      978   run rtp/rtspool.p(input-output nm-diretorio-aux). 
      979   
      980   assign ds-barra = substring(nm-diretorio-aux,(length(nm-diretorio-aux)),1).
      981   
      982   if    ds-barra <> "/"
      983   then  assign nm-diretorio-aux = nm-diretorio-aux + "/".
      984   
      985   assign nm-arquivo-erros     = nm-diretorio-aux + "ERROS-C.LST" .
      986    
      987   def new shared temp-table w-inconsistencia
      988           field cd-campo-consist as int
      989           field nr-cont-antigo   as char
      990           field ct-linhas        as int
      991           field ds-mensagem      as char format "x(92)"
      992           field tp-registro      as int  format "z9"
      993           field ds-complemento   as char format "x(56)".
      994    
      995   form w-inconsistencia.tp-registro        column-label "Tp Registro"
      996        w-inconsistencia.nr-cont-antigo     column-label "Contrato Antigo"
      997        w-inconsistencia.ct-linhas          column-label "Linha"
      998        w-inconsistencia.ds-mensagem        column-label "Mensagem de Erro"
      999        w-inconsistencia.ds-complemento         no-label at 39
     1000        with width 132 down no-box no-attr-space frame f-consistencia-erro.
     1001    
     1002   /* --------------------------------------------------------------------------*/
     1003    
     1004   /*******************************************************************************
     1005   ** hdvararq.i - definicao de variaveis e form para abrir a saida
     1006   ** {1}      - diretorio do arquivo
     1007   ** {2}      - Nome do arquivo
     1008   ** {3}      - extensao do arquivo
     1009   ** {4}      - tipo da variavel
     1010   ** {5}      - possui relatorio de erro? "1" = possui.
     1011   *******************************************************************************/
     1012   
     1013   def  var l-saida       as logical format "Impressora/Arquivo" init yes.
     1014   def  var nm-diretorio  as char format "x(30)"
     1015                             label "Nome do diretorio"  initial "spool/"     no-undo.
     1016   def  var nm-arquivo    as char format "x(20)"
     1017                             label "     Nome arquivo"  initial "PROPOSTA"     no-undo.
     1018   def  var nm-extensao   as char format "x(03)"
     1019                             label "         Extensao" initial "LST"      no-undo.
     1020   def  var nm-diretorio-old   as char  format "x(30)"                 no-undo.
     1021   def  var nm-arquivo-old     as char  format "x(20)"                 no-undo.
     1022   def  var nm-extensao-old    as char  format "x(03)"                 no-undo.
     1023   def  var c-saida       as character format "x(30)"                  no-undo.
     1024   def  var c-arquivo1    as character                                 no-undo.
     1025   def  var c-arquivo2    as character                                 no-undo.
     1026   def  var c-arquivo     as character extent 2 initial
     1027                     [ "", "" ]                                           no-undo.
     1028   def  var nr-contador-aux   as int format  "9" initial 1             no-undo.
     1029   def  var nr-contador-fim   as int format "9" initial 1              no-undo.
     1030   def  var ds-titulo-imp     as char format "x(20)" initial "Saida"   no-undo.
     1031   def  var c-nome-imp    as character format "x(12)"
     1032                             label "Nome da Impressora" init "default".
     1033   def  var l-xxxtmp      as logical                                   no-undo.
     1034   def  var c-yyytmp      as character                                 no-undo.
     1035   def  var l-resp        as log   no-undo format "S/N".
     1036   def  var l-letra       as char  format "x(01)"                      no-undo.
     1037   def var nm-programa-hdvararq-aux as char no-undo.
     1038   def var ds-param-hdpedarq-aux as char no-undo.
     1039   /*---------------------------------------------------------------------------*/
     1040   
     1041   define temp-table disp-tela
     1042          field ds-linha1 as char format "x(77)"
     1043          field ds-linha2 as char format "x(77)".
     1044   
     1045   
     1046   define query zoom-tela for disp-tela scrolling.
     1047   define browse browse-disp-tela query zoom-tela no-lock
     1048   display disp-tela.ds-linha1 no-label
     1049           disp-tela.ds-linha2 no-label
     1050           with 2 down size 77 by 17.
     1051   
     1052   define frame f-disp-tela
     1053          browse-disp-tela at row 01 col 02
     1054          "F1-Sair"        at row 18 col 02
     1055          "-> p/Direita"   at row 18 col 16
     1056          "<- p/Esquerda"  at row 18 col 35
     1057          with row 03 column 01 size 80 by 21 overlay view-as dialog-box three-d
     1058               title " RELATORIO EM VIDEO ".
     1059   
     1060   on help, end-error of browse-disp-tela in frame f-disp-tela
     1061   do:
     1062     return no-apply.
     1063   end.
     1064   
     1065   on go of browse-disp-tela in frame f-disp-tela
     1066   do:
     1067     close query zoom-tela.
     1068     hide frame f-disp-tela.
     1069   end.
     1070   
     1071   def  var in-saida as int init 1 view-as radio-set vertical
     1072                 radio-buttons "Impressora Windows", 1,
     1073                               "Impressora Sistema", 2,
     1074                               "Arquivo", 3
     1075                               size 22.5 by 3.67 no-undo.
     1076   
     1077   .
     1078   
     1079   define  variable in-tela as integer 
     1080        view-as radio-set vertical
     1081        radio-buttons 
     1082        "Arquivo", 1,
     1083        "Video", 2 
     1084        size 12.5 by 2.67 no-undo.
     1085   
     1086   assign nm-programa-hdvararq-aux = program-name(1).
     1087   
     1088   
     1089   /* define impressora de acordo com o usuario ativo e o nome do programa */
     1090   
     1091   assign c-yyytmp = substr(program-name(1), r-index(program-name(1), "/") + 1)
     1092          c-yyytmp = substr(c-yyytmp, 1, length(c-yyytmp) - 2).
     1093   
     1094   find dzuseimp where dzuseimp.nm-usuario-sistema = v_cod_usuar_corren
     1095                   and dzuseimp.nm-programa = c-yyytmp
     1096                       no-lock no-error.
     1097   
     1098   if not available dzuseimp
     1099   then find dzuseimp where dzuseimp.nm-usuario-sistema = v_cod_usuar_corren
     1100                        and dzuseimp.nm-programa = "*"
     1101                            no-lock no-error.
     1102   
     1103   if available dzuseimp
     1104   then assign c-nome-imp = dzuseimp.nm-impressora.
     1105   
     1106   if "" = "1"
     1107   then nr-contador-fim = 2.
     1108   else nr-contador-fim = 1.
     1109   
     1110   assign nm-diretorio-old = nm-diretorio
     1111          nm-arquivo-old   = nm-arquivo
     1112          nm-extensao-old  = nm-extensao.
     1113    
     1114    
     1115   assign ds-rodape  = " " + nm-prog + " - " + c-versao
     1116          ds-rodape  = FILL("-", 132 - LENGTH(ds-rodape)) + ds-rodape
     1117    
     1118          nm-arquivo-mag = "imp/PROPOSTA.TXT".
     1119   
     1120   /* ----------------------- INICIALIZACAO ------------------------------------ */
     1121    
     1122   /*****************************************************************************
     1123   *      Programa .....: hdtitrel.i                                            *
     1124   *      Data .........: 20 de Janeiro de 1997                                 *
     1125   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
     1126   *      Sistema ......: RT - Rotinas do Sistema                               *
     1127   *      Programador ..: Nora                                                  *
     1128   *      Objetivo .....: Titulos dos Relatorio dos programas DZSET             *
     1129   ******************************************************************************
     1130   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
     1131   *****************************************************************************/
     1132   def var nm-time  as char no-undo.
     1133   def var dt-today as date no-undo.
     1134   def var nm-traco as char initial "-" no-undo.
     1135   def var ds-linha2 as char format "x(75)" no-undo.
     1136   def var ds-linha2-aux as char format "x(75)" no-undo.
     1137   def var nm-cab-usu-rela as char format "x(75)" no-undo.
     1138   def image in-fundo file "igp/logodzre".
     1139   def rectangle r-relatorio-padrao 
     1140         edge-pixels 3 graphic-edge no-fill size 78 by 17.
     1141   def rectangle r-retangulo-imagem 
     1142         edge-pixels 5 graphic-edge no-fill size 55.1 by 9.2.
     1143   
     1144   if "" <> ""
     1145   then do:
     1146        find first cmovdata where
     1147                   cmovdata.in-entidade = ""
     1148               and cmovdata.dt-inicio-excessao <= today
     1149               and cmovdata.dt-fim-excessao    >= today
     1150                   no-lock no-error.
     1151        if avail cmovdata
     1152        then do:
     1153             message "Movimentacao nao pode ser executada entre as datas de"
     1154                     skip
     1155                     string(cmovdata.dt-inicio-excessao,"99/99/9999")
     1156                     " ate " string(cmovdata.dt-fim-excessao,"99/99/9999")
     1157             view-as alert-box title " Atencao !!! ".
     1158             return.
     1159             end.
     1160        end.
     1161   
     1162   if in-batch-online-par = "online"
     1163   then do:
     1164          define frame windows-rela
     1165            r-relatorio-padrao at row 1 col 1
     1166            r-retangulo-imagem at row 2.5 col 12
     1167            nm-cab-usu-rela view-as fill-in size 70 by 1.3 native at row 14 column 5 
     1168            ds-linha2 view-as fill-in size 76 by 1.3 native at row 16 column 2 
     1169            in-fundo at row 3 col 13
     1170            with centered row 4 no-labels no-box three-d.
     1171          
     1172          dt-today = today.
     1173          nm-time  = string(time,"HH:MM").
     1174          
     1175          define rectangle rodhlire
     1176                 edge-pixels 1 graphic-edge no-fill
     1177                 size 80 by  .1 .
     1178          
     1179          define frame
     1180                 rodapere rodhlire at row 1 col 1 with 1 down no-box
     1181                 keep-tab-order overlay no-hide no-labels no-underline three-d
     1182                 at col 1 row 20 size 80 by 1.
     1183          
     1184          define frame linhare1
     1185                       nm-cab-usu-rela at row 1 col 1
     1186                       with 1 down overlay no-labels no-hide
     1187                       no-underline at col 1 row 15 centered bgcolor 15.
     1188          
     1189          define frame linhare2
     1190                       ds-linha2
     1191                       with 1 down overlay no-labels no-hide no-underline no-box
     1192                       at col 1 row 18 centered bgcolor 15.
     1193          
     1194          nr-posicao     = (70 - (length(nm-cab-usuario))) / 2.
     1195          
     1196          assign nm-cab-usu-rela = substring(espacos,1,nr-posicao) + nm-cab-usuario.
     1197                 ds-linha2-aux   = string(dt-today,"99/99/9999") + " - " + nm-time 
     1198                                          + "  " + nm-prog + " - " + c-versao.
     1199          
     1200          nr-posicao     = (75 - (length(ds-linha2-aux))) / 2.
     1201          
     1202          assign ds-linha2 = substring(espacos,1,nr-posicao) + ds-linha2-aux.
     1203          
     1204          if "MS-WINXP" = "TTY"
     1205          then view frame hdtitrela.
     1206          else do:
     1207                 pause 0.
     1208                 view frame windows-rela.
     1209                 display nm-cab-usu-rela
     1210                         ds-linha2 with frame windows-rela.
     1211               end.
     1212          
     1213          if "MS-WINXP" = "TTY"
     1214          then display substring(espacos,1,nr-posicao) + nm-cab-usuario +
     1215                       substring(espacos,1,nr-posicao) @ nm-cab-usuario
     1216                       with frame linhare1.
     1217          
     1218          nr-posicao     = 19.
     1219          if "MS-WINXP" = "TTY"
     1220          then do:
     1221                 pause 0.
     1222                 display substring(espacos,1,nr-posicao) + string(dt-today,"99/99/9999") +
     1223                         " - " + nm-time + "  " + nm-prog + " - " + c-versao @ ds-linha2
     1224                         with frame linhare2.
     1225                 view frame rodapere.
     1226               end.
     1227          pause 0.
     1228          
     1229          status input "Entre dados ou pressione F4 para sair".
     1230          status default "Datasul Medical                F2 para ajuda".
     1231          
     1232           
     1233          
     1234          assign b-layout:hidden = true.
     1235          assign b-consiste:hidden = true.
     1236        end.
     1237    
     1238   IF v_cod_usuar_corren = ""
     1239   THEN ASSIGN v_cod_usuar_corren = "migracao".
     1240   
     1241   assign lg-gerar-termo-aux = lg-gerar-termo-par
     1242          qt-sair-aux        = qt-sair-par.
     1243   
     1244   if   month(today) = 12
     1245   then assign dt-minima-termo-aux = date(month(today),31,year(today)).
     1246   else assign dt-minima-termo-aux = date(month(today) + 1,01,year(today)) - 1.
     1247   
     1248   IF in-batch-online-par = "BATCH"
     1249   THEN DO:
     1250          assign lg-registro-modulos      = lg-registro-modulos-par
     1251                 in-classif               = in-classif-par
     1252                 lg-registro-faixa        = lg-registro-faixa-par
     1253                 lg-registro-negociacao   = lg-registro-negociacao-par
     1254                 lg-registro-cobertura    = lg-registro-cobertura-par
     1255                 lg-registro-especifico   = lg-registro-especifico-par
     1256                 lg-registro-procedimento = lg-registro-procedimento-par.              
     1257   
     1258          run importa-dados(100).
     1259        END.
     1260   ELSE do:
     1261          repeat on endkey undo,retry on error undo, retry with frame f-arquivo-mag:
     1262                    
     1263                     hide frame f-saida        no-pause.
     1264                     hide frame f-nome         no-pause.
     1265                     hide frame f-nome-imp     no-pause.
     1266                     hide frame f-layout       no-pause.
     1267                     hide frame f-arquivo-mag  no-pause.
     1268                     hide frame f-classif      no-pause.
     1269                     hide frame f-parametro    no-pause.
     1270                     hide frame f-consist      no-pause.
     1271                     hide frame f-contador     no-pause.
     1272                     hide message              no-pause.
     1273                     /******************************************************************************
     1274                       Programa .....: hdbotcpimla.i
     1275                       Data .........: 05/01/2004
     1276                       Sistema ......:
     1277                       Empresa ......: DZSET SOLUCOES E SISTEMAS
     1278                       Cliente ......:
     1279                       Programador ..: ELIZETE
     1280                       Objetivo .....: Rgua de arquivo, consiste, parametro, importa e layout
     1281                   *-----------------------------------------------------------------------------*
     1282                       Versao     DATA         RESPONSAVEL
     1283                                  05/01/2004   ELIZETE
     1284                   ******************************************************************************/
     1285                   
     1286                    do:
     1287                           on choose of b-help in frame f-regua-cpimla
     1288                           do:
     1289                             c-opcao = replace(b-help:label in frame f-regua-cpimla,"&","").
     1290                             run rtp/rtexibehelp.p.
     1291                           end.
     1292                   
     1293                           on end-error of b-help in frame f-regua-cpimla
     1294                           do:
     1295                             return no-apply.
     1296                           end.
     1297                           
     1298                           on choose of b-fim in frame f-regua-cpimla
     1299                           do:
     1300                             c-opcao = replace(b-fim:label in frame f-regua-cpimla,"&","").
     1301                           end.
     1302                           
     1303                           on end-error of b-fim in frame f-regua-cpimla
     1304                           do:
     1305                             return no-apply.
     1306                           end.
     1307                           
     1308                           on choose of b-arquivo in frame f-regua-cpimla
     1309                           do:
     1310                             c-opcao = replace(b-arquivo:label in frame f-regua-cpimla,"&","").
     1311                           end.
     1312                           
     1313                           on end-error of b-arquivo in frame f-regua-cpimla
     1314                           do:
     1315                             return no-apply.
     1316                           end.
     1317                           
     1318                           on choose of b-consiste in frame f-regua-cpimla
     1319                           do:
     1320                             c-opcao = replace(b-consiste:label in frame f-regua-cpimla,"&","").
     1321                           end.
     1322                           
     1323                           on end-error of b-consiste in frame f-regua-cpimla
     1324                           do:
     1325                             return no-apply.
     1326                           end.
     1327                   
     1328                           on choose of b-parametro in frame f-regua-cpimla
     1329                           do:
     1330                             c-opcao = replace(b-parametro:label in frame f-regua-cpimla,"&","").
     1331                           end.
     1332                           
     1333                           on end-error of b-parametro in frame f-regua-cpimla
     1334                           do:
     1335                             return no-apply.
     1336                           end.
     1337                           
     1338                           on choose of b-importa in frame f-regua-cpimla
     1339                           do:
     1340                             c-opcao = replace(b-importa:label in frame f-regua-cpimla,"&","").
     1341                           end.
     1342                           
     1343                           on end-error of b-importa in frame f-regua-cpimla
     1344                           do:
     1345                             return no-apply.
     1346                           end.
     1347                   
     1348                           on choose of b-layout in frame f-regua-cpimla
     1349                           do:
     1350                             c-opcao = replace(b-layout:label in frame f-regua-cpimla,"&","").
     1351                           end.
     1352                           
     1353                           on end-error of b-layout in frame f-regua-cpimla
     1354                           do:
     1355                             return no-apply.
     1356                           end.
     1357                           update unless-hidden b-arquivo b-consiste b-parametro b-importa b-layout b-fim b-help 
     1358                                  go-on("get" "put" "recall" "clear")
     1359                                  with frame f-regua-cpimla.
     1360                         end.
     1361                   
     1362                    .
     1363                     
     1364                     /* c-opcao = "Arquivo" */
     1365                     /**  parametro de entrada:                                                     **
     1366                   **      &permissao - nome do campo que contem a lista de permissoes           **
     1367                   **      &usuario   - nome do usuario que se deseja testar a permissao         **
     1368                   **  parametro de saida:                                                       **
     1369                   **      &tem-permissao - nome do campo que diz se tem ou permissao            **
     1370                   **                                                                            **
     1371                   ** Acrescimo de teste na impressora escrava quando TTY colocado nome do userid**
     1372                   *******************************************************************************/
     1373                   /*define variable nome as character format  "x(50)"      no-undo.*/
     1374                   
     1375                   assign ds-param-hdpedarq-aux = "".
     1376                                                   
     1377                   run rtp/rthdpedarq.p( input        c-opcao                    ,
     1378                                         input        ds-param-hdpedarq-aux      ,
     1379                                         input        nm-programa-hdvararq-aux   ,
     1380                                         input-output nm-cab-usuario             ,
     1381                                         input-output nm-prog                    ,
     1382                                         input-output nr-posicao                 ,
     1383                                         input-output espacos                    ,
     1384                                         input-output c-versao                   ,
     1385                                         input-output ds-inicializa-aux          ,
     1386                                         input-output ds-normal-ativa-aux        ,
     1387                                         input-output ds-normal-desat-aux        ,
     1388                                         input-output ds-negrit-ativa-aux        ,
     1389                                         input-output ds-negrit-desat-aux        ,
     1390                                         input-output ds-italic-ativa-aux        ,
     1391                                         input-output ds-italic-desat-aux        ,
     1392                                         input-output ds-expand-ativa-aux        ,
     1393                                         input-output ds-expand-desli-aux        ,
     1394                                         input-output ds-10cpp-ativa-aux         ,
     1395                                         input-output ds-10cpp-desat-aux         ,
     1396                                         input-output ds-15cpp-ativa-aux         ,
     1397                                         input-output ds-15cpp-desat-aux         ,
     1398                                         input-output ds-20cpp-ativa-aux         ,
     1399                                         input-output ds-20cpp-desat-aux         ,
     1400                                         input-output ds-format-folha-aux        ,
     1401                                         input-output ds-linha-folha-aux         ,
     1402                                         input-output ds-margem-aux              ,
     1403                                         input-output ds-primei-linha-aux        ,
     1404                                         input-output ds-mc-linha-ativa-aux      ,
     1405                                         input-output ds-mc-linha-desat-aux      ,
     1406                                         input-output ds-eq-margem-ativa-aux     ,
     1407                                         input-output ds-eq-margem-desat-aux     ,
     1408                                         input-output lg-ver-tela-aux            ,
     1409                                         input-output nm-arq-tela-quo            ,
     1410                                         input-output ds-campo-imp-quo           ,
     1411                                         input-output nm-arquivo-windows-aux     ,
     1412                                         input-output nr-linhas-windows-aux      ,
     1413                                         input-output nr-pagina-windows-aux      ,
     1414                                         input-output nr-fonte-windows-aux       ,
     1415                                         input-output lg-ok-imprime-windows-aux  ,
     1416                                         input-output l-saida                    ,
     1417                                         input-output nm-diretorio               ,
     1418                                         input-output nm-arquivo                 ,
     1419                                         input-output nm-extensao                ,
     1420                                         input-output nm-diretorio-old           ,
     1421                                         input-output nm-arquivo-old             ,
     1422                                         input-output nm-extensao-old            ,
     1423                                         input-output c-saida                    ,
     1424                                         input-output c-arquivo1                 ,
     1425                                         input-output c-arquivo2                 ,
     1426                                         input-output nr-contador-aux            ,
     1427                                         input-output nr-contador-fim            ,
     1428                                         input-output ds-titulo-imp              ,
     1429                                         input-output c-nome-imp                 ,
     1430                                         input-output l-xxxtmp                   ,
     1431                                         input-output c-yyytmp                   ,
     1432                                         input-output l-resp                     ,
     1433                                         input-output l-letra                    ,
     1434                                         input-output in-saida                   ,
     1435                                         input-output in-tela).            
     1436                   
     1437                   assign c-arquivo[1] = c-arquivo1
     1438                          c-arquivo[2] = c-arquivo2.
     1439                       
     1440                   /*------------------------- EOF ---------------------------------------------*/
     1441                    
     1442                   
     1443                     case c-opcao: 
     1444                        when "Parametro"
     1445                        then do on error undo, retry on endkey undo, leave with frame f-parametro:
     1446                   
     1447                                assign c-opcao = "Parametro".
     1448                                
     1449                                update lg-registro-modulos.
     1450                                
     1451                                if lg-registro-modulos = yes
     1452                                then do on error undo, retry on endkey undo, leave:
     1453                                        
     1454                                        display tb-classif with frame f-classif.
     1455                                        choose field tb-classif auto-return with frame f-classif.
     1456                                        in-classif = frame-index.
     1457                                     end.
     1458                                
     1459                                hide frame f-classif no-pause.
     1460                                
     1461                                update lg-registro-faixa        with frame f-parametro.
     1462                                update lg-registro-negociacao   with frame f-parametro.
     1463                                update lg-registro-cobertura    with frame f-parametro.
     1464                                update lg-registro-especifico   with frame f-parametro.
     1465                                update lg-registro-procedimento with frame f-parametro.
     1466                                
     1467                                assign lg-parametro = yes.
     1468                                
     1469                                hide frame f-parametro no-pause.
     1470                             end.    
     1471                   
     1472                        when "Importa"
     1473                        then do on error undo, retry on endkey undo, leave:
     1474                             
     1475                                if not lg-parametro
     1476                                then do:
     1477                                       message "Nenhum Parametro Selecionado."
     1478                                               view-as alert-box title " Atencao !!! ".
     1479                                       undo, retry.
     1480                                     end.
     1481                                
     1482                                update nm-arquivo-erros with frame f-arquivo-mag.
     1483                                
     1484                                hide frame f-arquivo-mag no-pause.
     1485                                
     1486                                assign lg-imp-erro             = no
     1487                                       ct-grava                = 0 
     1488                                       lg-ver-imp5             = no
     1489                                       lg-ver-imp8             = no
     1490                                       lg-ver-imp9             = no.
     1491                                
     1492                                message " Importando Dados, Aguarde...".
     1493                                
     1494                                output stream s-relat-erro to value(nm-arquivo-erros)    page-size 64.
     1495                                
     1496                                view stream s-relat-erro   frame f-cabeca-erro.
     1497                                view stream s-relat-erro   frame f-rodape.
     1498                   
     1499                                run importa-dados(100).
     1500                                
     1501                                /*--------------------------------------------------------------------*/
     1502                                
     1503                                page.
     1504                                
     1505                                if lg-imp-erro
     1506                                then message "Ocorreram Erro(s)." skip
     1507                                             "Verifique Relatorio de Erros "
     1508                                             view-as alert-box title "Atencao !!!".
     1509                                else message "Importacao concluida com sucesso!"
     1510                                             view-as alert-box title "Atencao !!!".
     1511                                  
     1512                                output stream s-relat-erro close.
     1513                                
     1514                                /*****************************************************************************
     1515                   *      Programa .....: hdclosed.i                                            *
     1516                   *      Data .........: 21 de Agosto de 2000                                  *
     1517                   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
     1518                   *      Sistema ......: RT - Rotinas do Sistema                               *
     1519                   *      Programador ..: Airton Nora                                           *
     1520                   *      Objetivo .....: Fechamento de arquivos de saida                       *
     1521                   ******************************************************************************
     1522                   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
     1523                   *      D.00.000  20/01/1998  Nora           Desenvolvimento                  *
     1524                   *      D.01.000  04/09/2000  Nora           Desvincular do magnus            *
     1525                   *      E.00.000  25/10/2000  Nora            Mudanca Versao Banco            *
     1526                   ****l**************************************************************************
     1527                   * Parametros : &stream = nome do stream a ser fechado                        *
     1528                   *****************************************************************************/
     1529                   
     1530                   case in-saida:
     1531                       when 1
     1532                           then do:
     1533                                  output  close.
     1534                                  
     1535                                  case nr-fonte-windows-aux:
     1536                                      when 1
     1537                                      then assign nr-fonte-windows-aux  = 15. 
     1538                                      when 2
     1539                                      then assign nr-fonte-windows-aux  = 16. 
     1540                                      when 3
     1541                                      then assign nr-fonte-windows-aux  = 17. 
     1542                                  end case.
     1543                                  
     1544                                  run hdp/hdprintwindow.p (current-window,
     1545                                                           nm-arquivo-windows-aux,
     1546                                                           nr-fonte-windows-aux,
     1547                                                           0,
     1548                                                           nr-linhas-windows-aux,
     1549                                                           nr-pagina-windows-aux,
     1550                                                           output lg-ok-imprime-windows-aux).
     1551                                 
     1552                                  os-delete value(nm-arquivo-windows-aux).
     1553                                end.
     1554                       when 2
     1555                           then do:
     1556                                  find dzimpres where dzimpres.nm-impressora
     1557                                               = c-nome-imp no-lock no-error.
     1558                                  if  l-saida
     1559                                  and avail dzimpres
     1560                                  then do:
     1561                                         page.
     1562                                         run "tep/teoctdec.p" (dzimpres.ds-controle-final, output c-yyytmp).
     1563                                         put  control c-yyytmp.
     1564                                         output  close.
     1565                                         pause 0.
     1566                                         if  dzimpres.lg-escrava
     1567                                         then do:
     1568                                                if  opsys = "unix"
     1569                                                then unix echo value(dzimpres.ds-ini-escrava);
     1570                                                cat value(c-saida);
     1571                                                echo value(dzimpres.ds-fim-escrava);
     1572                                                sleep 20;
     1573                                                rm -f value(c-saida).
     1574                                                if  opsys = "vms"
     1575                                                then vms type value(c-saida).
     1576                                              end.
     1577                                       end.
     1578                                  else output  close.
     1579                                end.
     1580                       when 3
     1581                           then do:
     1582                                  output  close.
     1583                                end.
     1584                   end case.
     1585                   
     1586                   /* ----------------------------------------------------------------------------------------------------
     1587                          SE A EXTENSAO DO ARQUIVO FOR HTM OU HTML, ABRE NO INTERNET EXPLORER. CASO CONTRARIO ABRE
     1588                          CONFORME PARAMETRIZADO EM PARAMECP. SE AMBIENTE FOR TTY, NAO ABRE HTM E HTML
     1589                      ------------------------------------------------------------------------------------------------- */
     1590                   if lg-ver-tela-aux
     1591                   then do:
     1592                          assign nm-arq-tela-quo = c-arquivo[1].
     1593                   
     1594                          if   "MS-WINXP" <> "TTY"
     1595                          then do:
     1596                                 find first paramecp no-lock no-error.
     1597                                 if   available paramecp
     1598                                 then do:
     1599                                        /* --- VERIFICA SE EXTENSAO DO ARQUIVO DE RELATORIO Eh HTM OU HTML --- */
     1600                                        if r-index(nm-arq-tela-quo,".") > 0
     1601                                        and  index(substr(nm-arq-tela-quo,r-index(nm-arq-tela-quo,".") + 1, 4),"htm") > 0
     1602                                        then do:
     1603                                               assign file-info:file-name = nm-arq-tela-quo.
     1604                                               if file-info:full-pathname <> ?
     1605                                               then do:
     1606                                                      os-command no-wait Value(trim("start iexplore ")) value(file-info:full-pathname).
     1607                                                      assign lg-ver-tela-aux = no.
     1608                                                    end.
     1609                                             end.
     1610                                        else do:
     1611                                               if   paramecp.nm-editor-windows <> ""
     1612                                               then do:
     1613                                                      os-command no-wait Value(trim("start " + paramecp.nm-editor-windows)) value(nm-arq-tela-quo).
     1614                                                      assign lg-ver-tela-aux = no.
     1615                                                    end.
     1616                                             end.
     1617                   
     1618                                        /* --- VERIFICA SE EXTENSAO DO ARQUIVO DE ERROS Eh HTM OU HTML --- */
     1619                                        if c-arquivo[2] <> ""
     1620                                        then if r-index(c-arquivo[2],".") > 0
     1621                                             and  index(substr(c-arquivo[2],r-index(c-arquivo[2],".") + 1, 4),"htm") > 0
     1622                                             then do:
     1623                                                    assign file-info:file-name = c-arquivo[2].
     1624                                                    if file-info:full-pathname <> ?
     1625                                                    then os-command no-wait Value(trim("start iexplore ")) value(file-info:full-pathname).
     1626                                                  end.
     1627                                             else os-command no-wait Value(trim("start " + paramecp.nm-editor-windows)) value(c-arquivo[2]).
     1628                   
     1629                                      end. /* available paramecp */
     1630                               end. /* <> "TTY" */
     1631                   
     1632                          if  lg-ver-tela-aux
     1633                          and index(substr(nm-arq-tela-quo,r-index(nm-arq-tela-quo,".") + 1, 4),"htm") = 0
     1634                          then do:
     1635                                 message " Gerando dados para tela, Aguarde...".
     1636                                
     1637                                 for each disp-tela:
     1638                                     delete disp-tela.
     1639                                 end.
     1640                                
     1641                                 input from value(nm-arq-tela-quo).
     1642                                
     1643                                 repeat:
     1644                                       assign ds-campo-imp-quo = "".
     1645                   
     1646                                       import unformatted ds-campo-imp-quo.
     1647                                                          ds-campo-imp-quo = replace(ds-campo-imp-quo,chr(12),"").
     1648                                                          ds-campo-imp-quo = replace(ds-campo-imp-quo,chr(15),"").
     1649                                                          ds-campo-imp-quo = replace(ds-campo-imp-quo,chr(18),"").
     1650                                                          ds-campo-imp-quo = replace(ds-campo-imp-quo,chr(27),"").
     1651                                                          
     1652                                       if ds-campo-imp-quo <> ""
     1653                                       then do:
     1654                                              create disp-tela.
     1655                                              assign disp-tela.ds-linha1 = substr(ds-campo-imp-quo,1,77)
     1656                                                     disp-tela.ds-linha2 = substr(ds-campo-imp-quo,77,154).
     1657                                            end.
     1658                                 end.
     1659                                
     1660                                 hide message no-pause.
     1661                                
     1662                                 find first disp-tela no-lock no-error.
     1663                                 if available disp-tela
     1664                                 then do:
     1665                                        open query zoom-tela for each disp-tela no-lock.
     1666                                        update browse-disp-tela with frame f-disp-tela.
     1667                                      end.
     1668                               end.
     1669                        end.
     1670                   
     1671                   /* fim */
     1672                    
     1673                                
     1674                                /*---- TESTA SISTEMA UNIX PARA POSICIONAR NO BOTAO ARQUIVO ---------*/
     1675                                
     1676                                
     1677                                hide message no-pause.
     1678                             
     1679                             end.
     1680                        
     1681                        when "Fim"
     1682                        then do:
     1683                               hide all no-pause.
     1684                               leave.
     1685                             end.
     1686                     end case.
     1687                   end.
     1688        END.
     1689   
     1690        DELETE PROCEDURE h-handle-aux.
     1691   
     1692   /* ------------------------------------------------------------------------------------------- */
     1693   procedure importa-dados:
     1694   
     1695       DEF INPUT PARAM qtd-reg-par AS INT NO-UNDO.
     1696   
     1697       /**
     1698        * Alex Boeira - 25/02/2016
     1699        * Uma validacao equivalente ocorria no cg0310v.p (migracao de Beneficiarios), durante a validacao
     1700        * de cada beneficiario.
     1701        * Para melhorar a performance, retirei a logica do cg0310v.p e fiz essa adaptacao, executada apenas 
     1702        * uma vez antes de iniciar os demais processos.
     1703        */
     1704       FOR EACH ti-pl-sa FIELDS () NO-LOCK,
     1705           EACH mod-cob  FIELDS () NO-LOCK
     1706          WHERE mod-cob.in-identifica-modulo = "S",
     1707          FIRST pla-mod FIELDS (cd-modalidade cd-plano cd-tipo-plano cd-modulo)
     1708          where pla-mod.cd-modalidade = ti-pl-sa.cd-modalidade 
     1709            and pla-mod.cd-plano      = ti-pl-sa.cd-plano
     1710            and pla-mod.cd-tipo-plano = ti-pl-sa.cd-tipo-plano
     1711            AND pla-mod.cd-modulo     = mod-cob.cd-modulo
     1712            and pla-mod.lg-grava-automatico 
     1713                NO-LOCK,
     1714           first pro-pla FIELDS ()   
     1715           where pro-pla.cd-modalidade = pla-mod.cd-modalidade
     1716             and pro-pla.cd-plano      = pla-mod.cd-plano
     1717             and pro-pla.cd-tipo-plano = pla-mod.cd-tipo-plano
     1718             and pro-pla.cd-modulo     = pla-mod.cd-modulo
     1719             AND NOT pro-pla.lg-cobertura-obrigatoria
     1720                 NO-LOCK:
     1721   
     1722           IF  NOT CAN-FIND (FIRST paramdsg 
     1723                             where paramdsg.cd-chave-primaria = paravpmc.cd-chave-primaria                                             
     1724                               and paramdsg.cd-modalidade     = pla-mod.cd-modalidade                                                  
     1725                               and paramdsg.cd-plano          = pla-mod.cd-plano                                                       
     1726                               and paramdsg.cd-tipo-plano     = pla-mod.cd-tipo-plano                                                  
     1727                               and paramdsg.cd-modulo         = pla-mod.cd-modulo)                         
     1728           then do:                                                                                   
     1729                  assign lg-relat-erro  = yes.
     1730                  RUN pi-cria-tt-erros(166,"Parametros dos Modulos de Seguro nao Cadastrados").
     1731                end.   
     1732       end.
     1733   
     1734       ASSIGN cont-aux = 0.   
     1735   
     1736       REPEAT:
     1737           PROCESS EVENTS.                                             
     1738   
     1739           IF NOT CAN-FIND (FIRST import-propost where import-propost.ind-sit-import = in-status-monitorar-par) 
     1740           THEN LEAVE.
     1741   
     1742           /* --- CONSITE PROPOSTA E DEMAIS DADOS ----------------------------------------------------------------------------- */
     1743           for each import-propost fields (cd-modalidade 
     1744                                           num-seqcial-control 
     1745                                           cd-plano 
     1746                                           cd-tipo-plano 
     1747                                           num-seqcial-propost 
     1748                                           cd-tab-preco 
     1749                                           ind-faixa-etaria-especial 
     1750                                           ind-sit-import
     1751                                           nr-contrato-antigo)
     1752              where import-propost.ind-sit-import = in-status-monitorar-par exclusive-lock query-tuning(no-index-hint):
     1753   
     1754               message in-status-monitorar-par "Imp.Proposta Reg:" import-propost.num-livre-2 "Contr:" import-propost.num-livre-3.
     1755   
     1756               assign lg-ver-imp4           = no 
     1757                      lg-ver-imp5           = no
     1758                      lg-relat-erro-aux     = NO
     1759                      lg-relat-erro         = NO
     1760                      lg-aceita-repasse-aux = NO.
     1761               
     1762               /*FIND FIRST modalid WHERE modalid.cd-modalidade = import-propost.cd-modalidade NO-LOCK NO-ERROR.*/
     1763               FOR FIRST modalid fields(cd-modalidade
     1764                                        lg-aceita-repasse
     1765                                        lg-repasse-obrig
     1766                                        cd-tipo-medicina
     1767                                        in-tipo-pessoa
     1768                                        lg-usa-faixa-etaria) NO-LOCK
     1769                   WHERE modalid.cd-modalidade = import-propost.cd-modalidade:
     1770               END.
     1771               if   not avail modalid
     1772               then do:
     1773                      assign lg-relat-erro = YES.
     1774                      run pi-cria-tt-erros (1,"Modalidade Invalida"). 
     1775                    end.
     1776           
     1777               if  avail modalid
     1778               then do:
     1779                      if modalid.lg-aceita-repasse   
     1780                      THEN DO: 
     1781                              IF modalid.lg-repasse-obrig 
     1782                              THEN ASSIGN lg-ver-imp4 = yes. 
     1783                              ELSE assign lg-aceita-repasse-aux = yes.
     1784                           END.
     1785   
     1786                      if modalid.cd-tipo-medicina = paramecp.cd-mediocupa
     1787                      then assign lg-ver-imp8 = yes
     1788                                  lg-ver-imp9 = yes.
     1789                    end.        
     1790           
     1791               for first ti-pl-sa fields (lg-usa-padrao-cobertura)
     1792                   where ti-pl-sa.cd-modalidade = import-propost.cd-modalidade
     1793                     and ti-pl-sa.cd-plano      = import-propost.cd-plano
     1794                     and ti-pl-sa.cd-tipo-plano = import-propost.cd-tipo-plano no-lock:
     1795               end.
     1796           
     1797               if  avail ti-pl-sa
     1798               and ti-pl-sa.lg-usa-padrao-cobertura = yes
     1799               then assign lg-ver-imp5 = yes.
     1800           
     1801               if not can-find (first import-negociac-propost where import-negociac-propost.num-seqcial-propost = import-propost.num-seqcial-propost)
     1802               and lg-ver-imp4
     1803               then do:
     1804                      run pi-cria-tt-erros (2,"Negociacao deve ser cadastrada para Proposta").
     1805                      assign lg-imp-erro   = YES
     1806                             lg-relat-erro = YES.
     1807                    end.
     1808           
     1809               if not can-find (first import-padr-cobert-propost where import-padr-cobert-propost.num-seqcial-propost = import-propost.num-seqcial-propost)
     1810               and lg-ver-imp5
     1811               and lg-registro-cobertura
     1812               then do:
     1813                      run pi-cria-tt-erros (3,"Padrao Cobertura nao informado").
     1814                      assign lg-imp-erro   = YES
     1815                             lg-relat-erro = YES.
     1816                    end.
     1817               IF lg-relat-erro 
     1818               THEN DO:
     1819                      run pi-grava-erro.
     1820                      assign lg-imp-erro = yes.
     1821                      NEXT.
     1822                    END.
     1823   
     1824               assign lg-imp-erro = NO.
     1825   
     1826               /* --- CONSISTE DADOS -------------------------------------------------------------------- */
     1827           
     1828               /* --- CONSISTE DADOS PROPOSTA ----- */
     1829               assign lg-relat-erro = no.
     1830               run consiste-dados-proposta.
     1831           
     1832               IF lg-relat-erro
     1833               THEN ASSIGN lg-relat-erro-aux = YES.
     1834           
     1835               /* --- CONSISTE CONTRATANTE -------- */
     1836               assign lg-relat-erro = no.
     1837               RUN consiste-contrat.
     1838           
     1839               IF lg-relat-erro 
     1840               THEN ASSIGN lg-relat-erro-aux = YES.
     1841           
     1842               /* --- CONSISTE MODULOS PROPOSTA ------ */
     1843               if lg-registro-modulos
     1844               then do:
     1845                      assign lg-relat-erro = no.
     1846                      RUN consiste-dados-modulos.
     1847               
     1848                      IF lg-relat-erro
     1849                      THEN ASSIGN lg-relat-erro-aux = YES.
     1850                    end.
     1851               
     1852               /* --- CONSISTE FAIXAS PROPOSTA ------- */
     1853               if lg-registro-faixa
     1854               AND import-propost.ind-faixa-etaria-especial <> "N"
     1855               then do:
     1856                      assign lg-relat-erro = no.
     1857                      RUN consiste-dados-faixa.
     1858               
     1859                      IF lg-relat-erro
     1860                      THEN ASSIGN lg-relat-erro-aux = YES.
     1861                    end.
     1862           
     1863               /* --- CONSISTE LOTACAO PROPOSTA ------ */
     1864               assign lg-relat-erro = no.
     1865               RUN consiste-dados-lotacao.
     1866   
     1867               IF lg-relat-erro
     1868               THEN ASSIGN lg-relat-erro-aux = YES.
     1869   
     1870               /* --- CONSISTE NEGOCIACOES REPASSE --- */
     1871               if  lg-registro-negociacao
     1872               AND lg-aceita-repasse-aux
     1873               then do:
     1874                      assign lg-relat-erro = no.
     1875                      RUN consiste-dados-negociac.
     1876           
     1877                      IF lg-relat-erro
     1878                      THEN ASSIGN lg-relat-erro-aux = YES.
     1879                    END.
     1880           
     1881               /* --- CONSISTE COBERTURA PROPOSTA ---- */
     1882               if  lg-registro-cobertura
     1883               AND lg-ver-imp5
     1884               then do:
     1885                      assign lg-relat-erro = no.
     1886                      RUN consiste-dados-cobertura.
     1887           
     1888                      IF lg-relat-erro
     1889                      THEN ASSIGN lg-relat-erro-aux = YES. 
     1890                    END.
     1891           
     1892               /* --- CONSISTE CAMPOS PROPOSTA ------- */
     1893               IF lg-registro-especifico
     1894               THEN DO:
     1895                      assign lg-relat-erro = no.
     1896                      RUN consiste-campos-proposta.
     1897           
     1898                      IF lg-relat-erro
     1899                      THEN ASSIGN lg-relat-erro-aux = YES.
     1900                    END.
     1901           
     1902               /* --- CONSISTE PROCED. PROPOSTA ------ */
     1903               if lg-registro-procedimento
     1904               then do:
     1905                      assign lg-relat-erro = no.
     1906                      RUN consiste-proced-propost.
     1907           
     1908                      IF lg-relat-erro
     1909                      THEN ASSIGN lg-relat-erro-aux = YES.
     1910                    end.
     1911           
     1912               /* --- MEDICINA OCUPACIONAL ----------- */
     1913               if lg-ver-imp8
     1914               then do:   
     1915                      run consiste-mo.
     1916           
     1917                      IF lg-relat-erro
     1918                      THEN ASSIGN lg-relat-erro-aux = YES.
     1919                    end.
     1920           
     1921               /* --- MEDICINA OCUPACIONAL FUNCAO----- */
     1922               if lg-ver-imp9
     1923               then do:
     1924                      run consiste-mo-funcao.
     1925           
     1926                      if lg-relat-erro
     1927                      then assign lg-relat-erro-aux = YES.
     1928                    end.
     1929               
     1930               /* --------------------------------------------------------------------------------------- */
     1931               ASSIGN cont-aux = cont-aux + 1.
     1932           
     1933               if lg-relat-erro-aux
     1934               then DO:
     1935                      run pi-grava-erro.
     1936                      assign lg-imp-erro = yes. 
     1937                    END.
     1938               ELSE DO:
     1939                      CREATE tt-import-propost.
     1940                      ASSIGN tt-import-propost.rowid-import-prop = rowid(import-propost)
     1941                             tt-import-propost.nr-insc-contrat   = nr-insc-contrat-aux.
     1942                    END.
     1943           
     1944               IF cont-aux = qtd-reg-par
     1945               THEN LEAVE.
     1946           end.
     1947   
     1948           ASSIGN cont-aux = 0.
     1949           
     1950           /* cria registros */
     1951           run cria-registros IN h-handle-aux ASYNCHRONOUS .
     1952   
     1953           IF  qt-sair-aux <> 0
     1954           AND qt-cont-sair-aux >= qt-sair-aux
     1955           THEN LEAVE.
     1956   
     1957       END.
     1958   
     1959   end procedure.
     1960   
     1961   /* ---------------------------------------------------------------------------------------------- */
     1962   procedure consiste-dados-proposta:
     1963   
     1964       if  import-propost.nr-contrato-antigo = ""
     1965       or  import-propost.nr-contrato-antigo = ?
     1966       then do:
     1967              assign lg-relat-erro = yes.
     1968              run pi-cria-tt-erros (4,"Contrato Antigo Invalido"). 
     1969            end.
     1970   
     1971       /*if can-find (first propost use-index propo24 where propost.nr-contrato-antigo = import-propost.nr-contrato-antigo)
     1972       then do:
     1973              assign lg-relat-erro = yes.
     1974              run pi-cria-tt-erros (5,"Contrato Antigo ja informado " + import-propost.nr-contrato-antigo). 
     1975            end.*/
     1976   
     1977       FIND first propost use-index propo24 where propost.nr-contrato-antigo = import-propost.nr-contrato-antigo NO-LOCK NO-ERROR.
     1978       IF AVAIL propost then do:
     1979              assign lg-relat-erro = yes.
     1980              run pi-cria-tt-erros (6,"Contrato Antigo ja informado " + import-propost.nr-contrato-antigo). 
     1981       end.
     1982       
     1983       /**
     1984        * 11/04/2016 - Alex Boeira
     1985        * Se num-livre-10 estiver preenchido, sera nr-proposta. Validar se ja esta sendo usado e apresentar erro.
     1986        */
     1987       IF  import-propost.num-livre-10 <> 0
     1988       AND import-propost.num-livre-10 <> ?
     1989       THEN do:
     1990              IF CAN-FIND(FIRST propost
     1991                          WHERE propost.cd-modalidade = import-propost.cd-modalidade
     1992                            AND propost.nr-proposta   = import-propost.num-livre-10)
     1993              THEN DO:
     1994                     assign lg-relat-erro = yes.
     1995                     run pi-cria-tt-erros (168,"Ja existe proposta com Modalidade " + string(import-propost.cd-modalidade) +
     1996                                               " e Nr.Proposta " + STRING(import-propost.num-livre-10)). 
     1997                   END.
     1998            END.
     1999   
     2000       IF NOT CAN-FIND (FIRST pla-sau
     2001                        where pla-sau.cd-modalidade = import-propost.cd-modalidade
     2002                          and pla-sau.cd-plano      = import-propost.cd-plano)
     2003       then do:
     2004              assign lg-relat-erro = yes.
     2005              run pi-cria-tt-erros (7,"Plano nao Cadastrado").
     2006            end.
     2007   
     2008       FOR FIRST ti-pl-sa FIELDS (lg-obriga-responsavel)
     2009           where ti-pl-sa.cd-modalidade = import-propost.cd-modalidade
     2010             and ti-pl-sa.cd-plano      = import-propost.cd-plano
     2011             and ti-pl-sa.cd-tipo-plano = import-propost.cd-tipo-plano NO-LOCK:
     2012       END.
     2013       
     2014       if not avail ti-pl-sa
     2015       then do:
     2016              assign lg-relat-erro = yes.
     2017              run pi-cria-tt-erros (8,"Tipo de Plano nao Cadastrado").
     2018            end.
     2019   
     2020       if import-propost.log-segassist 
     2021       THEN DO:
     2022              if avail ti-pl-sa 
     2023              and ti-pl-sa.lg-obriga-responsavel = no
     2024              then do:
     2025                     assign lg-relat-erro = yes.
     2026                     run pi-cria-tt-erros (9,"Tipo de Plano deve obrigar responsavel em prop. de seguro assist.").
     2027                   end.
     2028   
     2029              if  import-propost.ind-cobr <> "1" 
     2030              and import-propost.ind-cobr <> "0" 
     2031              then do:
     2032                     assign lg-relat-erro = yes.
     2033                     run pi-cria-tt-erros (10,"Indicador de Cobranca para fatura invalido"). 
     2034                   end.
     2035              
     2036              if import-propost.dat-fim-segassist = ?
     2037              then do:
     2038                     assign lg-relat-erro = yes.
     2039                     run pi-cria-tt-erros (11,"Data Final Seguro Assistencial nao Informada"). 
     2040                   end.
     2041              ELSE IF import-propost.dat-fim-segassist <> import-propost.dat-fim-propost
     2042                   then do:
     2043                          assign lg-relat-erro = yes.
     2044                          run pi-cria-tt-erros (12,"Data de fim da Proposta diferente da Data fim Seguro Assistencial"). 
     2045                        end.
     2046            END.
     2047   
     2048       if not can-find (first parapess where parapess.in-tipo-pessoa = import-propost.ind-tip-pessoa)
     2049       then do:
     2050              assign lg-relat-erro = yes. 
     2051              run pi-cria-tt-erros (13,"Tipo de pessoa nao cadastrada").                   
     2052            end.
     2053   
     2054       if modalid.in-tipo-pessoa <> import-propost.ind-tip-pessoa
     2055       then do:
     2056              assign lg-relat-erro = yes.
     2057              run pi-cria-tt-erros (14,"Tipo de pessoa incompativel com a modalidade. Tab. Importacao: " + import-propost.ind-tip-pessoa + " Modalidade: " + modalid.in-tipo-pessoa).                   
     2058            end.
     2059       
     2060       IF NOT CAN-FIND (FIRST formpaga where formpaga.cd-forma-pagto = import-propost.cd-forma-pagto)
     2061       then do:
     2062              assign lg-relat-erro = yes.
     2063              run pi-cria-tt-erros (15,"Forma Pagto nao Cadastrada " + string(import-propost.cd-forma-pagto,"99")). 
     2064            end.
     2065    
     2066       for first for-pag fields (tp-vencimento dd-faturamento lg-trata-inadimplencia-rc)
     2067           where for-pag.cd-modalidade  = import-propost.cd-modalidade
     2068             and for-pag.cd-plano       = import-propost.cd-plano
     2069             and for-pag.cd-tipo-plano  = import-propost.cd-tipo-plano
     2070             and for-pag.cd-forma-pagto = import-propost.cd-forma-pagto 
     2071                 no-lock query-tuning (no-index-hint):
     2072       end.
     2073       if not avail for-pag
     2074       then do:
     2075              assign lg-relat-erro = yes.
     2076              run pi-cria-tt-erros (16,"Forma Pagto Invalida para esta Modalidade. " + 
     2077                                    "Modalidade: "     + string(import-propost.cd-modalidade) + 
     2078                                    "Plano: "          + string(import-propost.cd-plano)      +
     2079                                    "Tipo de Plano: "  + string(import-propost.cd-tipo-plano) +
     2080                                    "Forma de Pagto: " + string(import-propost.cd-forma-pagto)).
     2081            end.
     2082       else do:
     2083              assign lg-passou = no.
     2084       
     2085              do ix = 1 to 31:
     2086                  if  for-pag.tp-vencimento[ix]  = import-propost.cdn-tip-vencto
     2087                  and for-pag.dd-faturamento[ix] = import-propost.num-dia-vencto
     2088                  then do:
     2089                         assign lg-passou = yes.
     2090                         leave.
     2091                       end.
     2092              end.
     2093              
     2094              if not lg-passou
     2095              then do:
     2096                     assign lg-relat-erro = yes.
     2097                     run pi-cria-tt-erros (17,"Tipo/Dia de vencimento invalido p/ Proposta").
     2098                   end.
     2099            end.
     2100   
     2101       FOR FIRST convprop FIELDS (dt-inicio dt-fim cd-convenio) 
     2102           where convprop.cd-convenio = import-propost.cd-convenio NO-LOCK:
     2103       END.
     2104       
     2105       IF NOT AVAIL convprop
     2106       then do:
     2107              assign lg-relat-erro = yes.
     2108              run pi-cria-tt-erros (18,"Convenio nao Cadastrado"). 
     2109            end.
     2110       ELSE DO:
     2111              if  import-propost.dat-propost < convprop.dt-inicio  
     2112              and import-propost.dat-propost > convprop.dt-fim 
     2113              then do:
     2114                     assign lg-relat-erro = yes.
     2115                     IF convprop.dt-inicio <> ?
     2116                     THEN ASSIGN char-aux1 = string(convprop.dt-inicio,"99/99/9999").
     2117                     ELSE ASSIGN char-aux1 = "00/00/0000".
     2118                     IF convprop.dt-fim <> ?
     2119                     THEN ASSIGN char-aux2 = string(convprop.dt-fim,"99/99/9999").
     2120                     ELSE ASSIGN char-aux2 = "00/00/0000".
     2121                     run pi-cria-tt-erros (19,"Convenio fora da validade " + string(convprop.cd-convenio,"999")       +  
     2122                                           " Inic: "                    + char-aux1  + 
     2123                                           " Fim: "                     + char-aux2  + 
     2124                                           " Dt Atual: "                + string(today,"99/99/9999")). 
     2125                   end.
     2126            END.
     2127       
     2128       IF NOT CAN-FIND (first contippl 
     2129                        where contippl.cd-convenio    = import-propost.cd-convenio
     2130                          and contippl.cd-modalidade  = import-propost.cd-modalidade
     2131                          and contippl.cd-plano       = import-propost.cd-plano
     2132                          and contippl.cd-tipo-plano  = import-propost.cd-tipo-plano
     2133                          and contippl.cd-forma-pagto = import-propost.cd-forma-pagto)
     2134       then do:
     2135              assign lg-relat-erro = yes.
     2136              run pi-cria-tt-erros (20,"Nao Existe Faixa de Beneficiarios para este Convenio" +
     2137                                    "Convenio: "    + string(import-propost.cd-convenio)    +
     2138                                    "Modalidade: "  + string(import-propost.cd-modalidade)  +
     2139                                    "Plano: "       + string(import-propost.cd-plano)       +
     2140                                    "Tipo Plano: "  + string(import-propost.cd-tipo-plano)  +
     2141                                    "Forma Pagto: " + string(import-propost.cd-forma-pagto)). 
     2142            end.
     2143       
     2144       IF NOT CAN-FIND (FIRST tipopart where tipopart.cd-tipo-participacao = import-propost.cd-tipo-participacao)
     2145       then do:
     2146              assign lg-relat-erro = yes.
     2147              run pi-cria-tt-erros (21,"Tipo Participacao nao cadastrada"). 
     2148            end.
     2149       
     2150       IF NOT CAN-FIND (FIRST representante 
     2151                        where representante.cod_empresa = string(paramecp.ep-codigo)
     2152                          and representante.cdn_repres  = import-propost.cd-vendedor)
     2153       then do:
     2154              assign lg-relat-erro = yes.
     2155              run pi-cria-tt-erros (22,"Vendedor nao Cadastrado"). 
     2156            end.
     2157   
     2158       find first b-import-propost where rowid(b-import-propost) = rowid(import-propost) exclusive-lock no-error.
     2159       if avail b-import-propost
     2160       then do: 
     2161              assign b-import-propost.cd-tab-preco = REPLACE(b-import-propost.cd-tab-preco, "/", "").
     2162              release b-import-propost.
     2163            END.
     2164       
     2165       FOR FIRST tabprepl FIELDS (lg-situacao dt-inicio dt-fim cd-tab-preco) 
     2166           WHERE tabprepl.cd-tab-preco = import-propost.cd-tab-preco NO-LOCK:
     2167       end.
     2168   
     2169       IF NOT avail tabprepl
     2170       then do:
     2171              assign lg-relat-erro = yes.
     2172              run pi-cria-tt-erros (23,"Tabela de Preco nao Cadastrada"). 
     2173            end.
     2174       else do:
     2175              if not tabprepl.lg-situacao
     2176              then do:
     2177                     assign lg-relat-erro = yes.
     2178                     run pi-cria-tt-erros (24,"Tabela de Preco Invalida"). 
     2179                   end.
     2180              
     2181              if   import-propost.dat-propost < tabprepl.dt-inicio
     2182              or   import-propost.dat-propost > tabprepl.dt-fim
     2183              then do:
     2184                     assign lg-relat-erro = yes.
     2185                     IF tabprepl.dt-inicio <> ?
     2186                     THEN ASSIGN char-aux1 = string(tabprepl.dt-inicio,"99/99/9999").
     2187                     ELSE ASSIGN char-aux1 = "00/00/0000".
     2188                     IF tabprepl.dt-fim <> ?
     2189                     THEN ASSIGN char-aux2 = string(tabprepl.dt-fim,"99/99/9999").
     2190                     ELSE ASSIGN char-aux2 = "00/00/0000".
     2191                     run pi-cria-tt-erros (25,"Dt limite tab precos fora validade "  + string(tabprepl.cd-tab-preco,"XXX/XX")   +  
     2192                                           " Inic: "                              + char-aux1  + 
     2193                                           " Fim:  "                              + char-aux2). 
     2194                   end.
     2195            END.
     2196   
     2197       /* --- Verifica o periodo de comercializacao do tipo de plano ------
     2198          --- Se a data da proposta estiver fora do periodo o log ---------
     2199          --- voltara verdadeiro indicando erro na consistencia. ---------- */
     2200       assign lg-erro-processo-aux = no.
     2201       run rtp/rtcomerc.p(input import-propost.cd-modalidade,
     2202                          input import-propost.cd-plano,
     2203                          input import-propost.cd-tipo-plano,
     2204                          input import-propost.dat-propost,
     2205                          output dt-inicio-comerc-aux,
     2206                          output dt-fim-comerc-aux,
     2207                          output lg-erro-processo-aux ) no-error.
     2208       
     2209       if error-status:error
     2210       then do:
     2211              run pi-cria-tt-erros (26,"Problema no acesso a rotina rtcomerc.p"). 
     2212              assign lg-erro-processo-aux = no.
     2213           end.
     2214         
     2215       if lg-erro-processo-aux
     2216       then do:
     2217              assign lg-relat-erro = yes.
     2218              run pi-cria-tt-erros (27,"Periodo de Comercializacao do Plano Invalido"). 
     2219            end.
     2220       
     2221       
     2222       
     2223       /* ------------------ Acrescimo Mensalidade -------------------------*/
     2224       if import-propost.dat-propost > import-propost.dat-fim-propost
     2225       then do:
     2226              assign lg-relat-erro = yes.
     2227              run pi-cria-tt-erros (28,"Data de Inicio da Proposta maior que data de cancelamento "). 
     2228            end.
     2229   
     2230       if   import-propost.pc-acrescimo <> 0
     2231       then do:
     2232              if   import-propost.dt-lim-acres-mens = ?
     2233              then do:
     2234                     assign lg-relat-erro = yes.
     2235                     run pi-cria-tt-erros (29,"Data Limite Acresc Mens deve ser infomada"). 
     2236                   end.
     2237              ELSE IF import-propost.dt-lim-acres-mens < import-propost.dat-propost
     2238                   then do:
     2239                          assign lg-relat-erro = yes.
     2240                          run pi-cria-tt-erros (30,"Data Limite Acrescimo Mensalidade inferior a Data da Proposta"). 
     2241                        end.
     2242            end.
     2243       else if   import-propost.dt-lim-acres-mens <> ?
     2244            then do:
     2245                   assign lg-relat-erro = yes.
     2246                   run pi-cria-tt-erros (31,"Data Limite Acresc Mens Invalida"). 
     2247                 end.
     2248       
     2249       if   import-propost.pc-acrescimo-inscr <> 0
     2250       then do:
     2251              if   import-propost.dat-lim-acresc-inscr = ?
     2252              then do:
     2253                     assign lg-relat-erro = yes.
     2254                     run pi-cria-tt-erros (32,"Data Limite Acresc Inscricao Invalido"). 
     2255                   end.
     2256              ELSE if   import-propost.dat-lim-acresc-inscr < import-propost.dat-propost
     2257                   then do:
     2258                          assign lg-relat-erro = yes.
     2259                          run pi-cria-tt-erros (33,"Data Limite Acrescimo Inscricao inferior a Data da Proposta"). 
     2260                        end.
     2261            end.
     2262       else if   import-propost.dat-lim-acresc-inscr <> ?
     2263            then do:
     2264                   assign lg-relat-erro = yes.
     2265                   run pi-cria-tt-erros (34,"Data Limite Acresc Inscr Invalida"). 
     2266                end.
     2267   
     2268       /* ------------------  Desconto promocional taxa ---------------- */
     2269       if  import-propost.dat-valid-prom-tax <> ?
     2270       and import-propost.pc-desc-prom-taxa = 0
     2271       then do:
     2272              assign lg-relat-erro = yes.
     2273              run pi-cria-tt-erros (35,"Data Desc Promoc. Inscricao informada, Percentual nao informado"). 
     2274            end.
     2275       
     2276       if import-propost.pc-desc-prom-taxa <> 0
     2277       then do:
     2278              if   import-propost.dat-valid-prom-tax = ?
     2279              then do:
     2280                     assign lg-relat-erro = yes.
     2281                     run pi-cria-tt-erros (36,"Data Limite Desconto Promoc. Inscricao Invalida"). 
     2282                   end.
     2283              ELSE if   import-propost.dat-valid-prom-tax < import-propost.dat-propost
     2284                   then do:
     2285                          assign lg-relat-erro = yes.
     2286                          run pi-cria-tt-erros (37,"Data Limite Desc Promoc. Inscricao inferior a Data da Proposta"). 
     2287                        end.
     2288            end.
     2289       
     2290       /* -------------------- Desconto promoc Plano ---------------------- */
     2291       
     2292       if  import-propost.dat-valid-prom-plano <> ?
     2293       and import-propost.pc-desc-prom-pl = 0
     2294       then do:
     2295              assign lg-relat-erro = yes.
     2296              run pi-cria-tt-erros (38,"Data Desc. Promoc. Plano informada, Percentual nao informado"). 
     2297            end.
     2298       
     2299       if import-propost.pc-desc-prom-pl <> 0
     2300       then do:
     2301              if   import-propost.dat-valid-prom-plano = ?
     2302              then do:
     2303                     assign lg-relat-erro = yes.
     2304                     run pi-cria-tt-erros (39,"Data Limite Desconto Promoc. Plano Invalida"). 
     2305                   end.
     2306              ELSE if   import-propost.dat-valid-prom-plano < import-propost.dat-propost
     2307                   then do:
     2308                          assign lg-relat-erro = yes.
     2309                          run pi-cria-tt-erros (40,"Data Limite Desc Promoc. Plano inferior a Data da Proposta"). 
     2310                        end.
     2311            end.
     2312       
     2313       if   import-propost.pc-desconto <> 0
     2314       then do:
     2315              if   import-propost.dat-lim-desc-mensal = ?
     2316              then do:
     2317                     assign lg-relat-erro = yes.
     2318                     run pi-cria-tt-erros (41,"Data Limite Desconto Mensalidade Invalida"). 
     2319                   end.
     2320              ELSE if   import-propost.dat-lim-desc-mensal < import-propost.dat-propost
     2321                   then do:
     2322                          assign lg-relat-erro = yes.
     2323                          run pi-cria-tt-erros (42,"Data Limite Desc Mensalidade inferior a Data da Proposta"). 
     2324                        end.
     2325            end.
     2326       else if   import-propost.dat-lim-desc-mensal <> ?
     2327            then do:
     2328                   assign lg-relat-erro = yes.
     2329                   run pi-cria-tt-erros (43,"Data Limite Desconto Mensalidade Invalida"). 
     2330                end.
     2331       
     2332       if   import-propost.pc-desconto-inscr <> 0
     2333       then do:
     2334              if   import-propost.dat-lim-desc-inscr = ?
     2335              then do:
     2336                     assign lg-relat-erro = yes.
     2337                     run pi-cria-tt-erros (44,"Data Limite Desc Inscricao Invalida"). 
     2338                   end.
     2339              ELSE if   import-propost.dat-lim-desc-inscr < import-propost.dat-propost
     2340                   then do:
     2341                          assign lg-relat-erro = yes.
     2342                          run pi-cria-tt-erros (45,"Data Limite Desc Inscr inferior a Data da Proposta"). 
     2343                        end.
     2344            end.
     2345       else if   import-propost.dat-lim-desc-inscr <> ?
     2346            then do:
     2347                   assign lg-relat-erro = yes.
     2348                   run pi-cria-tt-erros (46,"Data Limite Desc Inscricao Invalida"). 
     2349                 end.
     2350   
     2351       find first b-import-propost where rowid(b-import-propost) = rowid(import-propost) exclusive-lock no-error.
     2352       if avail b-import-propost
     2353       then do: 
     2354              assign b-import-propost.cd-tab-preco-proc     = REPLACE(b-import-propost.cd-tab-preco-proc, "/", "")
     2355                     b-import-propost.cd-tab-preco-proc-cob = REPLACE(b-import-propost.cd-tab-preco-proc-cob, "/", "").
     2356              release b-import-propost.
     2357            END.
     2358   
     2359       IF NOT CAN-FIND (FIRST tabprepr where tabprepr.cd-tab-preco-proc = import-propost.cd-tab-preco-proc)
     2360       then do:
     2361              assign lg-relat-erro = yes.
     2362              run pi-cria-tt-erros (47,"Tabelas Preco Procedimento/Preco Procedimento Cobranca nao cadastradas"). 
     2363            end.
     2364       
     2365       /*------------------------------------------------------------------- */
     2366       if   import-propost.log-mascar 
     2367       then do:
     2368              if   import-propost.des-mascar <> ""
     2369              then do:
     2370                     assign ct-tamanho     = length(import-propost.des-mascar)
     2371                            ct-posicao-ini = 0.
     2372              
     2373                     do ix = ct-posicao-ini + 1 to ct-tamanho:
     2374              
     2375                        if   (substring(import-propost.des-mascar,ix,1) <> "X")
     2376                        and ((substring(import-propost.des-mascar,ix,1) <> "9"))
     2377                        and ((substring(import-propost.des-mascar,ix,1) <> "."))
     2378                        and ((substring(import-propost.des-mascar,ix,1) <> "/"))
     2379                        and ((substring(import-propost.des-mascar,ix,1) <> "-"))
     2380                        then do:
     2381                               assign lg-relat-erro = yes.
     2382                               run pi-cria-tt-erros (48,"Caracter " + substring(import-propost.des-mascar,ix,1) + "invalido para formato da mascara"). 
     2383                             end.
     2384                     end.
     2385                   end.
     2386            end.
     2387       else if  import-propost.des-mascar <> ""  
     2388            then do:
     2389                   assign lg-relat-erro = yes.
     2390                   run pi-cria-tt-erros (49,"Parametro nao recebe Mascara para Codigo Funcionario"). 
     2391                 end.
     2392       
     2393       /* ------------- TIPO DE CONTRATACAO -------------------------------- */
     2394       if  import-propost.in-tipo-contratacao <> 1
     2395       and import-propost.in-tipo-contratacao <> 3
     2396       and import-propost.in-tipo-contratacao <> 4
     2397       and import-propost.in-tipo-contratacao <> 5
     2398       and import-propost.in-tipo-contratacao <> 6
     2399       and import-propost.in-tipo-contratacao <> 99
     2400       then do:                                                              
     2401              assign lg-relat-erro = yes.                                  
     2402              run pi-cria-tt-erros (50,"Tipo de Contratacao Invalido. Recebido: " + string(import-propost.in-tipo-contratacao)).                              
     2403            end.                                                         
     2404       
     2405       /* ------------- TIPO DE NATUREZA JURIDICA DE CONTRATACAO - PTU ----- */
     2406       if import-propost.in-tipo-natureza <> 2 and
     2407          import-propost.in-tipo-natureza <> 3 and
     2408          import-propost.in-tipo-natureza <> 4 and
     2409          import-propost.in-tipo-natureza <> 5
     2410       then do:
     2411              assign lg-relat-erro = yes.
     2412              run pi-cria-tt-erros (51,"Tipo de Natureza Invalida. Recebido: " + string(import-propost.in-tipo-natureza)). 
     2413            end.
     2414       
     2415       /* ------------- TIPO DE VALIDADE DO DOC DE IDENTIFICACAO DO BENEF  - */
     2416       if import-propost.in-validade-doc-ident <> 1 and
     2417          import-propost.in-validade-doc-ident <> 2
     2418       then do:
     2419              assign lg-relat-erro = yes.
     2420              run pi-cria-tt-erros (52,"Tipo de Validade Documento do Benef. Invalido." +
     2421                                    " Informado: " + string(import-propost.in-validade-doc-ident)).
     2422            end.
     2423       
     2424       /* ------------- TIPO DO REGISTRO DO PLANO ------------------------ */
     2425       if  import-propost.in-registro-plano = 0 
     2426       or  import-propost.in-registro-plano > 2 
     2427       then do:
     2428              assign lg-relat-erro = yes.
     2429              run pi-cria-tt-erros (53,"Indicador do Registro de Plano Invalido. Informado: " + string(import-propost.in-registro-plano)). 
     2430            end.
     2431       else if import-propost.in-registro-plano = 1 /* Proposta */
     2432            then do:
     2433                   if  (import-propost.cd-registro-plano  = 0  or import-propost.cd-registro-plano  = ?)
     2434                   and (import-propost.cd-plano-operadora = "" or import-propost.cd-plano-operadora = ?)
     2435                   then do:
     2436                          assign lg-relat-erro = yes.
     2437                          run pi-cria-tt-erros (54,"Codigo do Registro de Plano Regulamentado ou Nao Regulamentado\Adaptado deve ser informado"). 
     2438                        end.
     2439   
     2440                   if  (import-propost.cd-registro-plano  <> 0  and import-propost.cd-registro-plano  <> ?)
     2441                   and (import-propost.cd-plano-operadora <> "" and import-propost.cd-plano-operadora <> ?)
     2442                   then do:
     2443                          assign lg-relat-erro = yes.
     2444                          run pi-cria-tt-erros (172,"Codigo do Registro de Plano Regulamentado e Codigo do Registro de Plano Nao Regulamentado\Adaptado informados. Informar apenas um."). 
     2445                        end.
     2446                   else do:
     2447                          /* Regulamentado */
     2448                          if  import-propost.cd-registro-plano <> 0
     2449                          and import-propost.cd-registro-plano <> ?
     2450                          then do:
     2451                                 /*for first reg-plano-saude fields(cdn-plano-ans idi-registro)
     2452                                     where reg-plano-saude.cdn-plano-ans = import-propost.cd-registro-plano 
     2453                                           no-lock query-tuning(no-index-hint): 
     2454                                 end.
     2455                                 if not avail reg-plano-saude*/
     2456                                 if NOT CAN-FIND(FIRST reg-plano-saude
     2457                                                 WHERE reg-plano-saude.cdn-plano-ans = import-propost.cd-registro-plano)                              
     2458                                 then do:
     2459                                        assign lg-relat-erro = yes.
     2460                                        run pi-cria-tt-erros (55,"Codigo do Registro de Plano Deve estar previamente cadastrado: " + string(import-propost.cd-registro-plano)). 
     2461                                      end.
     2462                               end.
     2463                          else do:
     2464                                 /* Nao regulamentado */
     2465                                 assign import-propost.cd-registro-plano = 0.
     2466                          
     2467                                 if import-propost.num-livre-8 = 0
     2468                                 or import-propost.num-livre-8 > 3
     2469                                 then do:
     2470                                        assign lg-relat-erro = yes.
     2471                                        run pi-cria-tt-erros(171, "Tipo de regulamentacao (import-propost.num-livre-8) informado invalido: " + string(import-propost.num-livre-8)).
     2472                                      end.
     2473                                 
     2474                                 /*for first reg-plano-saude fields(cod-plano-operadora idi-registro)
     2475                                     where reg-plano-saude.cod-plano-operadora    = import-propost.cd-plano-operadora 
     2476                                       and reg-plano-saude.in-tipo-regulamentacao = import-propost.num-livre-8
     2477                                           no-lock query-tuning (no-index-hint): 
     2478                                 end.
     2479                                 if not avail reg-plano-saude */
     2480                                 if NOT CAN-FIND(FIRST reg-plano-saude
     2481                                                 WHERE reg-plano-saude.cod-plano-operadora    = import-propost.cd-plano-operadora
     2482                                                   AND reg-plano-saude.in-tipo-regulamentacao = import-propost.num-livre-8)
     2483                                 then do:
     2484                                        assign lg-relat-erro = yes.
     2485                                        run pi-cria-tt-erros (56,"Codigo do Registro de Plano Deve estar previamente cadastrado: " + string(import-propost.cd-plano-operadora)). 
     2486                                      end.
     2487                               end.
     2488                        end.
     2489                 end.  
     2490            else do:
     2491                   /* Benefici rio*/
     2492                   if import-propost.num-livre-8 = 0
     2493                   or import-propost.num-livre-8 > 3
     2494                   then do:
     2495                          assign lg-relat-erro = yes.
     2496                          run pi-cria-tt-erros(171, "Tipo de regulamentaÆo (import-propost.num-livre-8) informado inv lido: " + string(import-propost.num-livre-8)).
     2497                        end.
     2498                 end.
     2499            
     2500       /* ------------------------------------------------------------------- */
     2501       if   import-propost.ind-faixa-etaria-especial <> "S" /*lg-faixa-etaria-esp-imp*/
     2502       and  import-propost.ind-faixa-etaria-especial <> "N"
     2503       and  import-propost.ind-faixa-etaria-especial <> "C"
     2504       then do:
     2505              assign lg-relat-erro = yes.
     2506              run pi-cria-tt-erros (57,"Indicador de faixa etaria especial invalido"). 
     2507            end.
     2508       
     2509       /* ------------------------------------------------------------------- */
     2510       if not (    import-propost.num-mes-ult-faturam = 0 
     2511               and import-propost.aa-ult-fat = 0 )
     2512       and    (   import-propost.num-mes-ult-faturam < 1
     2513               or import-propost.num-mes-ult-faturam > 12
     2514               or import-propost.aa-ult-fat = 0 )
     2515       then do:
     2516              assign lg-relat-erro = yes.
     2517              run pi-cria-tt-erros (58,"Ultimo Mes/Ano de Faturamento Invalido"). 
     2518            end.
     2519       
     2520       if   import-propost.num-mes-ult-faturam <> 0
     2521       and  import-propost.aa-ult-fat <> 0
     2522       then do:
     2523              if import-propost.aa-ult-fat < year(import-propost.dat-propost)
     2524              then do:
     2525                     assign lg-relat-erro = yes.
     2526                     run pi-cria-tt-erros (59,"Data do ultimo faturamento difere da data de Inicio da proposta").
     2527                   end.
     2528       
     2529              if  import-propost.aa-ult-fat =  year(import-propost.dat-propost)
     2530              and import-propost.num-mes-ult-faturam < month(import-propost.dat-propost)
     2531              then do:
     2532                     assign lg-relat-erro = yes.
     2533                     run pi-cria-tt-erros (60,"Data do ultimo faturamento difere da data de Inicio da proposta").
     2534                   end.
     2535            end.
     2536       
     2537       if (import-propost.num-mm-ult-reaj > 0 and import-propost.aa-ult-reajuste = 0)
     2538       OR (import-propost.num-mm-ult-reaj = 0 and import-propost.aa-ult-reajuste > 0)
     2539       then do:
     2540              assign lg-relat-erro = yes.
     2541              run pi-cria-tt-erros (61,"Mes X Ano do reajuste de Faturamento Invalido").
     2542            end.
     2543       
     2544       if  import-propost.aa-ult-reajuste > 0
     2545       AND import-propost.dat-fim-propost <> ?
     2546       AND import-propost.aa-ult-reajuste > year(import-propost.dat-fim-propost)
     2547       then do:
     2548              assign lg-relat-erro = yes.
     2549              run pi-cria-tt-erros (62,"Ultimo Ano reajuste maior que Ano da excl. da Proposta").
     2550            end.
     2551       
     2552       if import-propost.num-mm-ult-reaj > 0
     2553       then do:
     2554              if import-propost.num-mm-ult-reaj < 1
     2555              or import-propost.num-mm-ult-reaj > 12
     2556              then do:
     2557                     assign lg-relat-erro = yes.
     2558                     run pi-cria-tt-erros (63,"Ultimo Mes de Reajuste Invalido").
     2559                   end.
     2560   
     2561              if  import-propost.aa-ult-reajuste = year(import-propost.dat-propost)
     2562              and import-propost.num-mm-ult-reaj < month(import-propost.dat-propost)
     2563              then do:
     2564                     assign lg-relat-erro = yes.
     2565                     run pi-cria-tt-erros (64,"Ultimo Mes reajuste menor que Mes Inicio da Proposta").
     2566                   end.
     2567   
     2568              if  import-propost.dat-fim-propost <> ?
     2569              and import-propost.aa-ult-reajuste = year(import-propost.dat-fim-propost)
     2570              and import-propost.num-mm-ult-reaj > month(import-propost.dat-fim-propost)
     2571              then do:
     2572                     assign lg-relat-erro = yes.
     2573                     run pi-cria-tt-erros (65,"Ultimo Mes reajuste maior que Mes da excl. da Proposta").
     2574                   end.
     2575            end.
     2576       
     2577       /*---------------------------- CONSISTE CAMPOS DE VALIDADE TERMO ------------*/
     2578       if   substr(import-propost.um-validade-termo,1,1)  = "?"
     2579       or   substr(import-propost.um-validade-termo,2,1)  = "?"
     2580       then do:
     2581              assign lg-relat-erro = yes.
     2582              run pi-cria-tt-erros (66,"Unidade da Validade do termo com valor invalido").
     2583            end.
     2584        
     2585       if    import-propost.qt-validade-termo <> 0
     2586       and  (import-propost.um-validade-termo <> "AA"
     2587       and   import-propost.um-validade-termo <> "MM"
     2588       and   import-propost.um-validade-termo <> "DD")
     2589       then do:
     2590              assign lg-relat-erro = yes.
     2591              IF import-propost.um-validade-termo <> ?
     2592              THEN char-aux1 = import-propost.um-validade-termo.
     2593              ELSE char-aux1 = "".
     2594              run pi-cria-tt-erros (67,"Unidade de Validade do termo deve ser AA,MM ou DD: " + char-aux1).
     2595            end.
     2596       
     2597       if   import-propost.qt-validade-termo = 0
     2598       and (import-propost.um-validade-termo <> "" or import-propost.um-validade-termo <> ?)
     2599       then do:
     2600              assign lg-relat-erro = yes.
     2601              run pi-cria-tt-erros (68,"Quantidade de Validade do termo deve ser informada").
     2602            end.
     2603       
     2604       /*---------------------------- CONSISTE CAMPOS DE VALIDADE CARTEIRA --------*/
     2605       if   substr(import-propost.um-validade-cart,1,1)  = "?"
     2606       or   substr(import-propost.um-validade-cart,2,1)  = "?"
     2607       then do:
     2608              assign lg-relat-erro = yes.
     2609              run pi-cria-tt-erros (69,"Unidade da Validade da carteira com valor invalido").
     2610            end.
     2611       
     2612       if   import-propost.qt-validade-cart <> 0
     2613       and (import-propost.um-validade-cart <> "AA"
     2614       and  import-propost.um-validade-cart <> "MM"
     2615       and  import-propost.um-validade-cart <> "DD")
     2616       then do:
     2617              assign lg-relat-erro = yes.
     2618              IF import-propost.um-validade-cart <> ?
     2619              THEN char-aux1 = import-propost.um-validade-cart.
     2620              ELSE char-aux1 = "".
     2621              run pi-cria-tt-erros (70,"Unidade de Validade da carteira deve ser AA,MM ou DD: " + char-aux1).
     2622            end.
     2623       
     2624       if   import-propost.qt-validade-cart = 0
     2625       and (import-propost.um-validade-cart <> "" or import-propost.um-validade-termo <> ?)
     2626       then do:
     2627              assign lg-relat-erro = yes.
     2628              run pi-cria-tt-erros (71,"Quantidade de Validade da carteira deve ser informada").
     2629            end.
     2630       
     2631       /*---------------------------- CONSISTE CAMPOS DE VALIDADE CARTAO ------------*/
     2632       if substr(import-propost.um-validade-cartao,1,1)  = "?"
     2633       or substr(import-propost.um-validade-cartao,2,1)  = "?"
     2634       then do:
     2635              assign lg-relat-erro = yes.
     2636              run pi-cria-tt-erros (72,"Unidade da Validade do cartao com valor invalido").
     2637            end.
     2638       
     2639       if    import-propost.qt-validade-cartao <> 0
     2640       and  (import-propost.um-validade-cartao <> "AA"
     2641       and   import-propost.um-validade-cartao <> "MM"
     2642       and   import-propost.um-validade-cartao <> "DD")
     2643       then do:
     2644              assign lg-relat-erro = yes.
     2645              IF import-propost.um-validade-cartao <> ?
     2646              THEN char-aux1 = import-propost.um-validade-cartao.
     2647              ELSE char-aux1 = "".
     2648              run pi-cria-tt-erros (73,"Unidade de Validade do cartao deve ser AA,MM ou DD: " + char-aux1).
     2649            end.
     2650       
     2651       if   import-propost.qt-validade-cartao = 0
     2652       and (import-propost.um-validade-cartao <> "" or import-propost.um-validade-termo <> ?)
     2653       then do:
     2654              assign lg-relat-erro = yes.
     2655              run pi-cria-tt-erros (74,"Quantidade de Validade do cartao deve ser informada ").
     2656            end.
     2657       
     2658       /*-------------- REAJUSTE DA PROPOSTA -------------------------*/                                     
     2659       IF NOT CAN-FIND (first tip-idx-reaj where tip-idx-reaj.cdn-tip-idx = import-propost.cdn-tip-idx)   
     2660       AND import-propost.cdn-tip-idx <> 0
     2661       then do:
     2662              assign lg-relat-erro = yes.                                                                    
     2663              run pi-cria-tt-erros (75,"Tipo de Indice nao Cadastrado").
     2664            end.                                                                                             
     2665       
     2666       if import-propost.cdn-niv-reaj < 0
     2667       or import-propost.cdn-niv-reaj > 2
     2668       then do:                                                                                              
     2669              assign lg-relat-erro = yes.                                                                    
     2670              run pi-cria-tt-erros (76,"Nivel do reajuste invalido").                                                       
     2671            end. 
     2672   
     2673   end procedure.
     2674   
     2675   /* ------------------------------------------------------------------------------------------- */
     2676   PROCEDURE consiste-dados-modulos:
     2677    
     2678       IF NOT CAN-FIND (FIRST import-modul-propost WHERE import-modul-propost.num-seqcial-propost = import-propost.num-seqcial-propost)
     2679       THEN DO:
     2680              RUN pi-cria-tt-erros (170,"Nenhum modulo (tabela import-modul-propost) encontrado").
     2681              ASSIGN lg-relat-erro = YES.
     2682              RETURN.
     2683            END.
     2684   
     2685       FOR EACH import-modul-propost FIELDS (cd-modulo cd-forma-pagto 
     2686                                             in-cobra-participacao 
     2687                                             ind-respons-autoriz 
     2688                                             nr-dias 
     2689                                             log-bonif-penalid 
     2690                                             in-ctrl-carencia-proced 
     2691                                             qt-caren-eletiva 
     2692                                             qt-caren-urgencia 
     2693                                             log-carenc 
     2694                                             dat-inicial 
     2695                                             dat-cancel 
     2696                                             cd-motivo-cancel 
     2697                                             ind-respons-autoriz 
     2698                                             in-cobra-participacao 
     2699                                             in-ctrl-carencia-insumo)
     2700          WHERE import-modul-propost.num-seqcial-propost = import-propost.num-seqcial-propost NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     2701   
     2702           for first pla-mod fields (cd-modulo lg-obrigatorio)
     2703               where pla-mod.cd-modalidade = import-propost.cd-modalidade
     2704                 and pla-mod.cd-plano      = import-propost.cd-plano
     2705                 and pla-mod.cd-tipo-plano = import-propost.cd-tipo-plano
     2706                 and pla-mod.cd-modulo     = import-modul-propost.cd-modulo NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     2707           end.
     2708   
     2709           if   not avail pla-mod
     2710           then do:
     2711                  IF import-modul-propost.cd-modulo <> ?
     2712                  THEN ASSIGN char-aux1 = string(import-modul-propost.cd-modulo,"999").
     2713                  ELSE ASSIGN char-aux1 = "0".
     2714                  run pi-cria-tt-erros (77,"Modulo nao Cadastrado para Mod: " + STRING(import-propost.cd-modalidade) + 
     2715                                           " /Plano: "  + STRING(import-propost.cd-plano) + 
     2716                                           " /Tipo: "   + STRING(import-propost.cd-tipo-plano) + 
     2717                                           " /Modulo: " + char-aux1).
     2718                  assign lg-relat-erro = YES.
     2719                  NEXT.
     2720                end.
     2721   
     2722           FOR FIRST mod-cob FIELDS(in-identifica-modulo) 
     2723               where mod-cob.cd-modulo = import-modul-propost.cd-modulo NO-LOCK:
     2724           END.
     2725   
     2726           if   not avail mod-cob
     2727           then do:
     2728                  IF import-modul-propost.cd-modulo <> ?
     2729                  THEN ASSIGN char-aux1 = string(import-modul-propost.cd-modulo,"999").
     2730                  ELSE ASSIGN char-aux1 = "0".
     2731                  run pi-cria-tt-erros (78,"Modulo nao Cadastrado - Modulo: " + char-aux1).
     2732                  assign lg-relat-erro  = yes.
     2733                end.
     2734   
     2735           else if mod-cob.in-identifica-modulo = "A"  
     2736                and import-propost.log-segassist 
     2737                then do:
     2738                       IF import-modul-propost.cd-modulo <> ?
     2739                       THEN ASSIGN char-aux1 = string(import-modul-propost.cd-modulo,"999").
     2740                       ELSE ASSIGN char-aux1 = "0".
     2741                       run pi-cria-tt-erros (79,"Proposta usufrui de seguro assistencial, impossivel incluir modulo: " + char-aux1).
     2742                       assign lg-relat-erro  = yes.
     2743                     end.    
     2744   
     2745           IF NOT CAN-FIND (FIRST tabpremo 
     2746                            where tabpremo.cd-modalidade = import-propost.cd-modalidade
     2747                              and tabpremo.cd-plano      = import-propost.cd-plano
     2748                              and tabpremo.cd-tipo-plano = import-propost.cd-tipo-plano
     2749                              and tabpremo.cd-modulo     = pla-mod.cd-modulo
     2750                              and tabpremo.cd-tab-preco  = import-propost.cd-tab-preco)
     2751           then do:
     2752                  assign lg-relat-erro  = yes.
     2753                  IF import-propost.cd-modalidade <> ?
     2754                  THEN char-aux1 = STRING(import-propost.cd-modalidade).
     2755                  ELSE char-aux1 = "0".
     2756                  IF import-propost.cd-plano <> ?
     2757                  THEN char-aux2 = STRING(import-propost.cd-plano).
     2758                  ELSE char-aux2 = "0".
     2759                  IF import-propost.cd-tipo-plano <> ?
     2760                  THEN char-aux3 = STRING(import-propost.cd-tipo-plano).
     2761                  ELSE char-aux3 = "0".
     2762                  IF pla-mod.cd-modulo <> ?
     2763                  THEN char-aux4 = STRING(pla-mod.cd-modulo).
     2764                  ELSE char-aux4 = "0".
     2765                  IF import-propost.cd-tab-preco <> ?
     2766                  THEN char-aux5 = substring(import-propost.cd-tab-preco,1,3) + "/" + 
     2767                                   substring(import-propost.cd-tab-preco,4,2).
     2768                  ELSE char-aux5 = "000/00".
     2769   
     2770                  run pi-cria-tt-erros (80,"Tabela de Preco dos modulos nao cadastrada." +
     2771                                        " Modalidade: " + char-aux1 + 
     2772                                        " Plano: "      + char-aux2 +
     2773                                        " Tipo: "       + char-aux3 +
     2774                                        " Modulo: "     + char-aux4 +
     2775                                        " Tabela: "     + char-aux5).
     2776                end.
     2777   
     2778           if   import-modul-propost.cd-forma-pagto <> 1
     2779           and  import-modul-propost.cd-forma-pagto <> 2
     2780           then do:
     2781                  run pi-cria-tt-erros (81,"Forma de Pagamento Invalida para este Modulo - Forma Pagto: " + string(import-modul-propost.cd-forma-pagto,"99")).
     2782                  assign lg-relat-erro  = yes.
     2783                end.
     2784   
     2785            IF NOT CAN-FIND (FIRST formpaga where formpaga.cd-forma-pagto = import-modul-propost.cd-forma-pagto)
     2786            then do:
     2787                   run pi-cria-tt-erros (82,"Forma de Pagamento nao Cadastrada - Forma Pagto: " + string(import-modul-propost.cd-forma-pagto,"99")).   
     2788                   assign lg-relat-erro  = yes.
     2789                 END.
     2790   
     2791            if   import-modul-propost.ind-respons-autoriz <> "E"
     2792            and  import-modul-propost.ind-respons-autoriz <> "U"
     2793            and  import-modul-propost.ind-respons-autoriz <> "A"
     2794            and  import-modul-propost.ind-respons-autoriz <> "N"
     2795            then do:
     2796                   run pi-cria-tt-erros (83,"Responsavel Autorizacao Invalido "  + import-modul-propost.ind-respons-autoriz).
     2797                   assign lg-relat-erro  = yes.
     2798                 end.
     2799   
     2800            if  import-modul-propost.in-cobra-participacao < 1
     2801            OR  import-modul-propost.in-cobra-participacao > 9
     2802            then do:
     2803                   run pi-cria-tt-erros (84,"Indicador p/cobrar participacao invalido " + string(import-modul-propost.in-cobra-participacao, "9")).
     2804                   assign lg-relat-erro  = yes
     2805                          lg-modulo-erro = yes.
     2806                 end.
     2807   
     2808            if   import-modul-propost.dat-inicial = ?
     2809            then do:
     2810                   run pi-cria-tt-erros (85,"Data Inicio do Modulo da Proposta Invalida - Data informada: ?").
     2811                   assign lg-relat-erro  = yes
     2812                          lg-modulo-erro = yes.
     2813                 end.
     2814            ELSE if   import-modul-propost.dat-inicial < import-propost.dat-propost
     2815                 then do:
     2816                        run pi-cria-tt-erros (86,"Data de Inicio do Modulo Menor que Data da Proposta ").
     2817                        assign lg-relat-erro  = yes
     2818                               lg-modulo-erro = yes.
     2819                      end.
     2820   
     2821            if  import-modul-propost.dat-cancel = ?
     2822            THEN DO:
     2823                   IF import-modul-propost.cd-motivo-cancel <> 0
     2824                   then do:
     2825                          run pi-cria-tt-erros (87,"Motivo de cancelamento nao deve ser informado").
     2826                          assign lg-relat-erro  = yes
     2827                                 lg-modulo-erro = yes.
     2828                        end. 
     2829   
     2830                   if  import-propost.dat-fim-propost <> ?
     2831                   then do:
     2832                          run pi-cria-tt-erros (88,"Proposta Cancelada X Modulo Ativo").
     2833                          assign lg-relat-erro  = yes
     2834                                 lg-modulo-erro = yes.
     2835                        end.
     2836                 END.
     2837            ELSE DO:
     2838                   if   pla-mod.lg-obrigatorio
     2839                   and  import-propost.dat-fim-propost = ?
     2840                   then do:
     2841                          run pi-cria-tt-erros (89,"Modulo obrigatorio para estrutura do produto. Modulo: " + string(import-modul-propost.cd-modulo) + " nao pode estar cancelado").
     2842                          assign lg-relat-erro  = yes
     2843                                 lg-modulo-erro = yes.
     2844                        end.
     2845   
     2846                   if import-modul-propost.dat-cancel > import-propost.dat-fim-propost
     2847                   then do:
     2848                          run pi-cria-tt-erros (90,"Data de final do modulo nao pode ser maior que data de final da proposta").
     2849                          assign lg-relat-erro  = yes
     2850                                 lg-modulo-erro = yes.        
     2851                        end.
     2852                   
     2853                   IF import-modul-propost.cd-motivo-cancel = 0
     2854                   or import-modul-propost.cd-motivo-cancel = ?
     2855                   then do:
     2856                          run pi-cria-tt-erros (91,"Motivo do cancelamento obrigatorio").
     2857                          assign lg-relat-erro  = yes
     2858                                 lg-modulo-erro = yes.
     2859                        end. 
     2860                   ELSE DO:
     2861                          FOR FIRST motcange FIELDS (in-tipo-obito-ans)
     2862                              where motcange.in-entidade = "MC"
     2863                                and motcange.cd-motivo   = import-modul-propost.cd-motivo-cancel no-lock:
     2864                          END.
     2865   
     2866                          if   not available motcange
     2867                          then do:
     2868                                 run pi-cria-tt-erros (92,"Codigo motivo de cancelamento do modulo nao cadastrado"). 
     2869                                 assign lg-relat-erro  = yes
     2870                                        lg-modulo-erro = yes.
     2871                               end.
     2872                          else if motcange.in-tipo-obito-ans > 0 
     2873                               then do:
     2874                                      run pi-cria-tt-erros (93,"Codigo motivo de cancelamento do modulo nao pode indicar obito").
     2875                                      assign lg-relat-erro  = yes
     2876                                             lg-modulo-erro = yes.
     2877                                    end.
     2878                        END.
     2879                 END.
     2880   
     2881           /* Indicador de controle de carencia de procedimento */
     2882           if  import-modul-propost.in-ctrl-carencia-proced <> 0
     2883           and import-modul-propost.in-ctrl-carencia-proced <> 1
     2884           and import-modul-propost.in-ctrl-carencia-proced <> 2
     2885           then do:
     2886                  run pi-cria-tt-erros (94,"Indicador controle de carencia de procedimento invalido " + string(import-modul-propost.in-ctrl-carencia-proced,"9")).
     2887                  assign lg-relat-erro  = yes
     2888                         lg-modulo-erro = yes.
     2889                end.          
     2890   
     2891           /* Indicador de controle de carencia de insumo */
     2892           if  import-modul-propost.in-ctrl-carencia-insumo <> 0
     2893           and import-modul-propost.in-ctrl-carencia-insumo <> 1
     2894           and import-modul-propost.in-ctrl-carencia-insumo <> 2
     2895           then do:
     2896                  run pi-cria-tt-erros (95,"Indicador controle de carencia de insumo invalido " + string(import-modul-propost.in-ctrl-carencia-insumo,"9")).
     2897                  assign lg-relat-erro  = yes
     2898                         lg-modulo-erro = yes.
     2899                end.
     2900   
     2901           if pla-mod.lg-obrigatorio
     2902           THEN DO:
     2903                  IF in-classif = 2
     2904                  then do:
     2905                         run pi-cria-tt-erros (96,"Param. para modulo opcional Impossivel incluir modulo obrig. " + string(import-modul-propost.cd-modulo,"999")).
     2906                         assign lg-relat-erro  = yes
     2907                                lg-modulo-erro = yes.
     2908                       end.
     2909                END.
     2910           ELSE IF in-classif = 1
     2911                then do:
     2912                       run pi-cria-tt-erros (97,"Param. para modulo obrig. Impossivel incluir modulo opcional "). 
     2913                       assign lg-relat-erro  = yes
     2914                              lg-modulo-erro = yes.
     2915                     end.
     2916   
     2917           if import-propost.cd-forma-pagto <> 3 and
     2918              import-propost.cd-forma-pagto <>
     2919              import-modul-propost.cd-forma-pagto
     2920           then do:
     2921                  run pi-cria-tt-erros (98,"Forma de pagamento dos modulos deve ser igual a da proposta").
     2922                  assign lg-relat-erro  = yes
     2923                         lg-modulo-erro = yes.
     2924                end.
     2925   
     2926       END.
     2927   
     2928   END.
     2929   
     2930   /* ------------------------------------------------------------------------------------------- */
     2931   PROCEDURE consiste-dados-lotacao:
     2932   
     2933       IF NOT paravpmc.log-livre-26 /* indicador se utiliza o novo conceito de LOTACAO */
     2934       THEN DO:
     2935              IF CAN-FIND(FIRST import-lotac-propost
     2936                          WHERE import-lotac-propost.num-seqcial-propost = import-propost.num-seqcial-propost)
     2937              THEN DO:
     2938                     RUN pi-cria-tt-erros (173,"Sistema parametrizado para nao usar lotacao, e foi encontrado IMPORT-LOTAC-PROPOST para essa proposta. Mod: " 
     2939                                           + STRING(import-propost.cd-modalidade)
     2940                                           + " Prop: " + string(import-propost.num-livre-10)).
     2941                     ASSIGN lg-relat-erro = YES.
     2942                     RETURN.
     2943                   END.
     2944            END.
     2945       ELSE DO:
     2946              IF modalid.in-tipo-pessoa = "F" /* LOTACAO somente se aplica para modalidades PESSOA JURIDICA */
     2947              then do:
     2948                     IF CAN-FIND(FIRST import-lotac-propost WHERE import-lotac-propost.num-seqcial-propost = import-propost.num-seqcial-propost)
     2949                     THEN DO:
     2950                            RUN pi-cria-tt-erros (174,"Lotacao somente pode ser utilizada para Modalidades do tipo Pessoa Juridica. Mod: " 
     2951                                                  + STRING(import-propost.cd-modalidade)
     2952                                                  + " Prop: " + string(import-propost.num-livre-10)).
     2953                            ASSIGN lg-relat-erro = YES.
     2954                            RETURN.
     2955                          END.
     2956                   END.
     2957              ELSE DO:
     2958                     /* validacao retirada pois o processo foi alterado para tornar a lotacao Opcional (solicitado pela Unimed Nova Iguacu)
     2959                     IF NOT CAN-FIND(FIRST import-lotac-propost
     2960                                     WHERE import-lotac-propost.num-seqcial-propost = import-propost.num-seqcial-propost)
     2961                     THEN DO:
     2962                            RUN pi-cria-tt-erros (175,"Sistema parametrizado para usar lotacao, e nao foi encontrado IMPORT-LOTAC-PROPOST para essa proposta. Mod: " 
     2963                                                  + STRING(import-propost.cd-modalidade)
     2964                                                  + " Prop: " + string(import-propost.num-livre-10)).
     2965                            ASSIGN lg-relat-erro = YES.
     2966                            RETURN.
     2967                          END.*/
     2968                   END.
     2969            END.
     2970   
     2971       FOR EACH import-lotac-propost FIELDS (cdn-lotac
     2972                                             cdn-respons-financ)
     2973          WHERE import-lotac-propost.num-seqcial-propost = import-propost.num-seqcial-propost NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     2974   
     2975           IF import-lotac-propost.cdn-lotac <> 0
     2976           AND NOT CAN-FIND(FIRST lotac WHERE lotac.cdn-lotac = import-lotac-propost.cdn-lotac)
     2977           then do:
     2978                  RUN pi-cria-tt-erros (176,"Lotacao cod: " + STRING(import-lotac-propost.cdn-lotac) 
     2979                                        + " nao cadastrada para ser associada a proposta Mod: " 
     2980                                        + STRING(import-propost.cd-modalidade)
     2981                                        + " Prop: " + string(import-propost.num-livre-10)).
     2982                  assign lg-relat-erro = YES.
     2983                  NEXT.
     2984                end.
     2985   
     2986           IF import-lotac-propost.cdn-respons-financ <> 0
     2987           AND import-lotac-propost.cdn-respons-financ <> ?
     2988           AND NOT CAN-FIND(FIRST contrat WHERE contrat.cd-contratante = import-lotac-propost.cdn-respons-financ)
     2989           then do:
     2990                  IF import-lotac-propost.cdn-respons-financ <> ?
     2991                  THEN char-aux1 = STRING(import-lotac-propost.cdn-respons-financ).
     2992                  ELSE char-aux1 = "nulo".
     2993   
     2994                  IF import-lotac-propost.cdn-lotac <> ?
     2995                  THEN char-aux2 = STRING(import-lotac-propost.cdn-lotac).
     2996                  ELSE char-aux2 = "nulo".
     2997                  
     2998                  IF import-propost.cd-modalidade <> ?
     2999                  THEN char-aux3 = STRING(import-propost.cd-modalidade).
     3000                  ELSE char-aux3 = "nulo".
     3001                  
     3002                  IF import-propost.num-livre-10 <> ?
     3003                  THEN char-aux4 = string(import-propost.num-livre-10).
     3004                  ELSE char-aux4 = "nulo".
     3005                  
     3006                  RUN pi-cria-tt-erros (177,"Contratante : " + char-aux1 
     3007                                        + " nao encontrado para ser associado a Lotacao: " + char-aux2
     3008                                        + " Mod: " + char-aux3
     3009                                        + " Prop: " + char-aux4).
     3010                  assign lg-relat-erro = YES.
     3011                  NEXT.
     3012                end.
     3013       END.
     3014   END PROCEDURE.
     3015   
     3016   /* ------------------------------------------------------------------------------------------- */
     3017   PROCEDURE consiste-dados-faixa:
     3018   
     3019       IF import-propost.ind-faixa-etaria-especial <> "N"
     3020       AND NOT modalid.lg-usa-faixa-etaria
     3021       THEN DO:
     3022              run pi-cria-tt-erros (165,"Modalidade nao permite faixa etaria especial. Modalidade: " + STRING(modalid.cd-modalidade)).
     3023              assign lg-relat-erro = yes.
     3024            END.
     3025   
     3026       FOR EACH import-faixa-propost FIELDS (cd-grau-parentesco nr-faixa-etaria num-idade-min num-idade-max qtd-fator-multiplic qtd-fator-multiplic-inscr)
     3027          where import-faixa-propost.num-seqcial-propost = import-propost.num-seqcial-propost NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     3028   
     3029           if  import-propost.ind-faixa-etaria-especial = "N"
     3030           then do:
     3031                  run pi-cria-tt-erros (99,"Proposta nao permite faixa etaria especial").
     3032                  assign lg-relat-erro = yes.
     3033                end.
     3034           
     3035           IF NOT CAN-FIND (FIRST gra-par where gra-par.cd-grau-parentesco = import-faixa-propost.cd-grau-parentesco)
     3036           then do:
     3037                  run pi-cria-tt-erros (100,"Grau de Parentesco nao Cadastrado - Grau: " + string(import-faixa-propost.cd-grau-parentesco,"99")).
     3038                  assign lg-relat-erro = yes.
     3039                end.
     3040           
     3041           if  import-faixa-propost.nr-faixa-etaria = 0
     3042           then do:
     3043                  run pi-cria-tt-erros (101,"Numero da faixa etaria Invalida - Faixa Etaria: " + string(import-faixa-propost.nr-faixa-etaria,"99")).
     3044                  assign lg-relat-erro = yes.
     3045                end.
     3046           
     3047           if import-faixa-propost.num-idade-min < 0
     3048           then do:
     3049                  run pi-cria-tt-erros (102,"Idade Minima Invalida - Idade Minima: " + string(import-faixa-propost.num-idade-min,"999")).
     3050                  assign lg-relat-erro = yes.
     3051                 end.
     3052           
     3053           if import-faixa-propost.num-idade-max = 0
     3054           then do:
     3055                  run pi-cria-tt-erros (103,"Idade Maxima Invalida - Idade Maxima: " + string(import-faixa-propost.num-idade-max,"999")).
     3056                  assign lg-relat-erro = yes.
     3057                end.
     3058           
     3059           if import-faixa-propost.num-idade-min > import-faixa-propost.num-idade-max
     3060           then do:
     3061                  run pi-cria-tt-erros (104,"Idade Minima maior que Idade Maxima ").
     3062                  assign lg-relat-erro = yes.
     3063                end.
     3064       END.
     3065   
     3066   END PROCEDURE.
     3067   
     3068   /* ------------------------------------------------------------------------------------------- */
     3069   PROCEDURE consiste-dados-negociac:
     3070   
     3071       FOR EACH import-negociac-propost FIELDS (cd-unimed cd-forma-pagto cd-plano cd-tipo-plano cdn-tip-vencto num-dia-vencto um-carencia dat-fim-repas dat-inic-repas cd-tab-preco cd-tab-preco-proc cdn-tip-vencto in-tipo-valorizacao num-mes-ult-repas aa-ult-repasse)
     3072          where import-negociac-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock :
     3073   
     3074           if  modalid.lg-aceita-repasse = no
     3075           and modalid.lg-repasse-obrig  = no
     3076           then do:
     3077                  run pi-cria-tt-erros (105,"Modalidade nao Permite Repasse - Modalidade: " + string(import-propost.cd-modalidade,"99")).
     3078                  assign lg-relat-erro = yes.
     3079                end.    
     3080           
     3081           IF NOT CAN-FIND (FIRST unimed where unimed.cd-unimed = import-negociac-propost.cd-unimed)
     3082           then do:
     3083                  run pi-cria-tt-erros (106,"Unidade nao Cadastrada - Unidade: " + string(import-negociac-propost.cd-unimed,"9999")).
     3084                  assign lg-relat-erro = yes.
     3085                end.
     3086           
     3087           IF NOT CAN-FIND (FIRST formpaga where formpaga.cd-forma-pagto = import-negociac-propost.cd-forma-pagto)
     3088           then do:
     3089                  run pi-cria-tt-erros (107,"Forma de Pagamento nao Cadastrada - Forma Pagto: " + string(import-negociac-propost.cd-forma-pagto,"99")).
     3090                  assign lg-relat-erro = yes.
     3091                end.
     3092   
     3093           FOR FIRST for-pag FIELDS (tp-vencimento dd-faturamento)
     3094               where for-pag.cd-modalidade  = import-propost.cd-modalidade
     3095                 and for-pag.cd-plano       = import-negociac-propost.cd-plano
     3096                 and for-pag.cd-tipo-plano  = import-negociac-propost.cd-tipo-plano
     3097                 and for-pag.cd-forma-pagto = import-negociac-propost.cd-forma-pagto no-lock:
     3098           END.
     3099           
     3100           if not avail for-pag
     3101           then do:
     3102                  run pi-cria-tt-erros (108,"Forma de Pagamento dos Tipos de Planos nao Cadastrada para a negociacao - " + string(import-negociac-propost.cd-forma-pagto,"99")).
     3103                  assign lg-relat-erro = yes.
     3104                end.
     3105           else do:
     3106                  assign lg-passou = no.
     3107                  do ix = 1 to 31:
     3108                       if   for-pag.tp-vencimento[ix]  = import-negociac-propost.cdn-tip-vencto
     3109                       and  for-pag.dd-faturamento[ix] = import-negociac-propost.num-dia-vencto
     3110                       then do:
     3111                              assign lg-passou = yes.
     3112                              leave.
     3113                            end.
     3114                  end.
     3115                  if   not lg-passou
     3116                  then do:
     3117                         run pi-cria-tt-erros (109,"Tipo/Dia de vencimento invalido p/ Negociacao").
     3118                         assign lg-relat-erro = yes.
     3119                       end.
     3120                end.
     3121           
     3122           if  import-negociac-propost.um-carencia <> "DD"
     3123           and import-negociac-propost.um-carencia <> "MM"
     3124           and import-negociac-propost.um-carencia <> "AA"
     3125           then do:
     3126                  run pi-cria-tt-erros (110,"Unidade de Carencia Invalida" + import-negociac-propost.um-carencia).
     3127                  assign lg-relat-erro = yes.
     3128                end.
     3129   
     3130           if  import-propost.dat-fim-propost = ?
     3131           THEN DO:
     3132                  if import-negociac-propost.dat-fim-repas <> ?
     3133                  then do:
     3134                         run pi-cria-tt-erros (111,"Proposta Ativa X Repasse Cancelado").
     3135                         assign lg-relat-erro = yes.
     3136                       end.
     3137                END.
     3138           ELSE DO:
     3139                   if import-negociac-propost.dat-fim-repas = ?
     3140                   then do:
     3141                          run pi-cria-tt-erros (112,"Proposta Cancelada X Repasse Ativo").
     3142                          assign lg-relat-erro = yes.
     3143                        end.
     3144                   
     3145                   if import-propost.dat-fim-propost <> import-negociac-propost.dat-fim-repas
     3146                   then do:
     3147                          run pi-cria-tt-erros (113,"Data de fim da proposta diferente de fim da negociacao").
     3148                          assign lg-relat-erro = yes.
     3149                        end.
     3150   
     3151                   if import-negociac-propost.dat-inic-repas > import-propost.dat-fim-propost
     3152                   then do:
     3153                          run pi-cria-tt-erros (114,"Data de inicio negociacao superior a final da proposta").
     3154                          assign lg-relat-erro = yes.
     3155                        end.
     3156                END.
     3157           
     3158           if import-negociac-propost.dat-inic-repas < import-propost.dat-propost
     3159           then do:
     3160                  run pi-cria-tt-erros (115,"Data de inicio negociacao inferior a inicio da proposta").
     3161                  assign lg-relat-erro = yes.
     3162                end.
     3163           
     3164           IF NOT CAN-FIND (FIRST tabprepl where tabprepl.cd-tab-preco = import-negociac-propost.cd-tab-preco)
     3165           then do:
     3166                  run pi-cria-tt-erros (116,"Tabela de Preco nao Cadastrada" + import-negociac-propost.cd-tab-preco).
     3167                  assign lg-relat-erro = yes.
     3168                end.
     3169           
     3170           IF NOT CAN-FIND (first tabpremo
     3171                            where tabpremo.cd-modalidade  = import-propost.cd-modalidade
     3172                              and tabpremo.cd-plano       = import-negociac-propost.cd-plano
     3173                              and tabpremo.cd-tipo-plano  = import-negociac-propost.cd-tipo-plano
     3174                              and tabpremo.cd-tab-preco   = import-negociac-propost.cd-tab-preco )
     3175           then do:
     3176                  run pi-cria-tt-erros (117,"Tabela de Preco dos Modulos Plano de Saude nao Cadastrada " + import-negociac-propost.cd-tab-preco).
     3177                  assign lg-relat-erro = yes.
     3178                end.
     3179           
     3180           IF NOT CAN-FIND (FIRST tabprepr where tabprepr.cd-tab-preco-proc = import-negociac-propost.cd-tab-preco-proc)
     3181           then do:
     3182                  run pi-cria-tt-erros (118,"Tabela de Preco do Procedimento nao Cadastrada " + import-negociac-propost.cd-tab-preco-proc).
     3183                  assign lg-relat-erro = yes.
     3184                end.
     3185           
     3186           IF NOT CAN-FIND (FIRST tipovenc where tipovenc.cd-tipo-vencimento = import-negociac-propost.cdn-tip-vencto)
     3187           then do:
     3188                  run pi-cria-tt-erros (119,"Tipo de Vencimento nao Cadastrado" + string(import-negociac-propost.cdn-tip-vencto,"99")).
     3189                  assign lg-relat-erro = yes.
     3190                end.
     3191           
     3192           if import-negociac-propost.num-dia-vencto < 01 
     3193           or import-negociac-propost.num-dia-vencto > 31
     3194           then do:
     3195                  run pi-cria-tt-erros (120,"Dia para vencimento invalido" + string(import-negociac-propost.cdn-tip-vencto,"99")).
     3196                  assign lg-relat-erro = yes.
     3197                end.
     3198           
     3199           if  import-negociac-propost.in-tipo-valorizacao <> 1
     3200           and import-negociac-propost.in-tipo-valorizacao <> 0
     3201           then do:
     3202                  run pi-cria-tt-erros (121,"Tipo de Valorizacao de CO invalido" + string(import-negociac-propost.in-tipo-valorizacao)).
     3203                  assign lg-relat-erro = yes.
     3204                end.
     3205           
     3206           if import-negociac-propost.num-mes-ult-repas = 0
     3207           then do:
     3208                  run pi-cria-tt-erros (122,"Ultimo mes de Repasse deve ser informado").
     3209                  assign lg-relat-erro = yes.
     3210                end.
     3211           
     3212           if import-negociac-propost.aa-ult-repasse = 0
     3213           then do:
     3214                  run pi-cria-tt-erros (123,"Ultimo ano de Repasse deve ser informado").
     3215                  assign lg-relat-erro = yes.
     3216                end.
     3217           
     3218           if import-propost.num-mes-ult-faturam <> import-negociac-propost.num-mes-ult-repas
     3219           then do:
     3220                  run pi-cria-tt-erros (124,"Ultimo mes Faturado difere do Ultimo mes do Repasse").
     3221                  assign lg-relat-erro = yes.
     3222                end.
     3223           
     3224           if import-propost.aa-ult-fat <> import-negociac-propost.aa-ult-repasse
     3225           then do:
     3226                  run pi-cria-tt-erros (125,"Ultimo ano Faturado difere do Ultimo ano do Repasse").
     3227                  assign lg-relat-erro = yes.
     3228                end.
     3229           
     3230       END.
     3231   
     3232   END PROCEDURE.
     3233   
     3234   /* ------------------------------------------------------------------------------------------- */
     3235   PROCEDURE pi-cria-tt-erros:
     3236   
     3237       DEF INPUT PARAM id-erro-par AS INT  NO-UNDO.
     3238       DEF INPUT PARAM ds-erro-par AS CHAR NO-UNDO.
     3239       
     3240       DEF VAR num-seq-aux AS INT NO-UNDO.
     3241   
     3242       FOR LAST b-tt-erro FIELDS (nr-seq) 
     3243          WHERE b-tt-erro.nr-seq-contr = import-propost.num-seqcial-control NO-LOCK:
     3244       END.
     3245   
     3246       CREATE tt-erro.
     3247   
     3248       IF AVAIL b-tt-erro
     3249       THEN ASSIGN num-seq-aux = b-tt-erro.nr-seq + 1.
     3250       ELSE ASSIGN num-seq-aux = 1.
     3251   
     3252       IF ds-erro-par <> ?
     3253       THEN.
     3254       ELSE ds-erro-par = "ERRO NA MONTAGEM DA MENSAGEM. VERIFIQUE VALORES NULOS.".
     3255   
     3256       ASSIGN tt-erro.nr-seq            = num-seq-aux
     3257              tt-erro.nr-seq-contr      = import-propost.num-seqcial-control
     3258              tt-erro.nom-tab-orig-erro = "BE" + " - import-propost" 
     3259              tt-erro.des-erro          = "(" + string(id-erro-par) + ") " + ds-erro-par. 
     3260   
     3261       /*OUTPUT STREAM s-rel-erro TO VALUE(nm-rel-erro-aux) APPEND.
     3262       PUT STREAM s-rel-erro UNFORMATTED tt-erro.nr-seq-contr " "
     3263                                         tt-erro.nom-tab-orig-erro " "
     3264                                         tt-erro.des-erro SKIP.
     3265       OUTPUT STREAM s-rel-erro CLOSE.
     3266       */
     3267   END PROCEDURE.
     3268   
     3269   /* ------------------------------------------------------------------------------------------- */
     3270   procedure pi-grava-erro:
     3271   
     3272       def var nro-seq-aux as int initial 0 no-undo.
     3273   
     3274       FOR EACH tt-erro FIELDS(nr-seq-contr nom-tab-orig-erro des-erro) EXCLUSIVE-LOCK:
     3275   
     3276           IF nro-seq-aux = 0
     3277           THEN do:
     3278                  IF CAN-FIND (FIRST erro-process-import WHERE erro-process-import.num-seqcial-control = tt-erro.nr-seq-contr)
     3279                  THEN RUN pi-consulta-prox-seq (INPUT tt-erro.nr-seq-contr, OUTPUT nro-seq-aux).
     3280                  ELSE ASSIGN nro-seq-aux = nro-seq-aux + 1.
     3281                END.
     3282           ELSE ASSIGN nro-seq-aux = nro-seq-aux + 1.
     3283   
     3284           /**
     3285            * Garantir unicidade da chave.
     3286            */
     3287           create erro-process-import.
     3288           REPEAT:
     3289               assign erro-process-import.num-seqcial         = nro-seq-aux
     3290                      erro-process-import.num-seqcial-control = tt-erro.nr-seq-contr NO-ERROR.
     3291               VALIDATE erro-process-import NO-ERROR.
     3292               IF ERROR-STATUS:ERROR
     3293               OR ERROR-STATUS:NUM-MESSAGES > 0
     3294               THEN do:
     3295                      ASSIGN nro-seq-aux = nro-seq-aux + 1.
     3296                      PAUSE(1). /* aguarda 1seg e busca novamente o proximo nr livre.*/
     3297                    END.
     3298               else leave.    /* o nr gerado eh valido. continua o processo.*/
     3299           END.
     3300   
     3301           ASSIGN erro-process-import.nom-tab-orig-erro   = tt-erro.nom-tab-orig-erro
     3302                  erro-process-import.des-erro            = tt-erro.des-erro
     3303                  erro-process-import.dat-erro            = today. 
     3304   
     3305           FOR FIRST control-migrac FIELDS (ind-sit-import)
     3306               WHERE control-migrac.num-seqcial = tt-erro.nr-seq-contr EXCLUSIVE-LOCK:
     3307           END.
     3308           if avail control-migrac
     3309           then assign control-migrac.ind-sit-import = "PE".
     3310   
     3311           FOR FIRST b-import-propost FIELDS (ind-sit-import) 
     3312               WHERE b-import-propost.num-seqcial-control = erro-process-import.num-seqcial-control EXCLUSIVE-LOCK:
     3313           END.
     3314           IF AVAIL b-import-propost
     3315           THEN DO:        
     3316                  ASSIGN b-import-propost.ind-sit-import = "PE".
     3317   
     3318                  RELEASE  b-import-propost.
     3319                  VALIDATE b-import-propost.
     3320                END.
     3321   
     3322           DELETE tt-erro.
     3323       END.
     3324   
     3325   end procedure.
     3326   
     3327   procedure pi-consulta-prox-seq:
     3328   
     3329       def input  parameter nr-seq-contr-p like erro-process-import.num-seqcial-control no-undo.
     3330       def output parameter nro-seq-par    as int initial 0                             no-undo.
     3331   
     3332       def buffer b-erro-process-import for erro-process-import.
     3333   
     3334       select max(erro-process-import.num-seqcial) into nro-seq-par 
     3335              from erro-process-import 
     3336              where erro-process-import.num-seqcial-control = nr-seq-contr-p.
     3337   
     3338       if nro-seq-par = ?
     3339       OR nro-seq-par = 0
     3340       then assign nro-seq-par = 1.
     3341       else assign nro-seq-par = nro-seq-par + 1.
     3342   
     3343   end procedure.
     3344   
     3345   /* ------------------------------------------------------------------------------------------- */
     3346   procedure mostra-erro.
     3347   
     3348       FOR EACH tt-erro NO-LOCK:
     3349   
     3350           display stream s-relat-erro
     3351                   tt-erro.nr-seq-contr          
     3352                   tt-erro.nom-tab-orig-erro  
     3353                   tt-erro.des-erro             
     3354                   with frame f-erro.  
     3355           down stream s-relat-erro with frame f-erro.
     3356   
     3357       END.
     3358    
     3359   end procedure.
     3360   
     3361   /* ---------------------------------------------------------------------------------------------- */
     3362   procedure consiste-contrat:
     3363   
     3364     def buffer b-contrat for contrat.
     3365       
     3366     if import-propost.nr-insc-contratante = 0
     3367     or import-propost.nr-insc-contratante = ?
     3368     then do:
     3369            assign lg-relat-erro = yes.
     3370            run pi-cria-tt-erros (167,"Inscricao do Contratante Zero ou nula").
     3371            return.
     3372          end.
     3373   
     3374     for first contrat fields (nr-cgc-cpf in-fiador)
     3375         where contrat.nr-insc-contratante = import-propost.nr-insc-contratante NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     3376     end.
     3377      
     3378     if not avail contrat
     3379     then do:
     3380            assign lg-relat-erro = yes.
     3381            if import-propost.nr-cgc-cpf <> ?
     3382            then assign char-aux1 = string(import-propost.nr-cgc-cpf).
     3383            else assign char-aux1 = "0".
     3384            if import-propost.nr-insc-contratante <> ?
     3385            then assign char-aux2 = string(import-propost.nr-insc-contratante).
     3386            else assign char-aux2 = "0".
     3387            if import-propost.nr-insc-contrat-origem <> ?
     3388            then assign char-aux3 = string(import-propost.nr-insc-contrat-origem).
     3389            else assign char-aux3 = "0".
     3390            run pi-cria-tt-erros (138,"Contratante nao encontrado." +
     3391                                      " CGC/CPF: "   + char-aux1    +
     3392                                      " Insc: "      + char-aux2    +
     3393                                      " Insc.Orig: " + char-aux3).
     3394          end.
     3395     else do:
     3396            if   contrat.in-fiador = "F"
     3397            then do:
     3398                   assign lg-relat-erro = yes.
     3399                   run pi-cria-tt-erros (131,"Contratante cadastrado como fiador nao pode ter proposta").                                 
     3400                 end.
     3401            
     3402            assign nr-insc-contrat-aux = contrat.nr-insc-contratante.
     3403          end.
     3404   
     3405       if   import-propost.nr-insc-contrat-origem <> 0
     3406       and  import-propost.nr-insc-contrat-origem <> ?
     3407       then do:
     3408              for first b-contrat fields (cd-contratante) 
     3409                  where b-contrat.nr-insc-contratante = import-propost.nr-insc-contrat-origem exclusive-lock query-tuning (no-index-hint):
     3410              end.
     3411   
     3412              if not can-find(first ems5.cliente 
     3413                              where ems5.cliente.cod_empresa = string(paramecp.ep-codigo)
     3414                                and ems5.cliente.cdn_cliente = int(b-contrat.cd-contratante))
     3415              then do:
     3416                      assign lg-relat-erro = YES.
     3417                      run pi-cria-tt-erros (169,"Contratante Origem informado nao possui Cliente no EMS").
     3418                   end.
     3419            end.
     3420   
     3421   end procedure.
     3422   
     3423   /* ------------------------------------------------------------------------------------------- */
     3424   PROCEDURE consiste-dados-cobertura:
     3425   
     3426       FOR EACH import-padr-cobert-propost where import-padr-cobert-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock :
     3427   
     3428           IF NOT CAN-FIND (FIRST pad-cob where pad-cob.cd-padrao-cobertura = import-padr-cobert-propost.cd-padrao-cobertura)
     3429           then do:
     3430                  run pi-cria-tt-erros (139,"Padrao de Cobertura nao Cadastrado: " + import-padr-cobert-propost.cd-padrao-cobertura).
     3431                  assign lg-relat-erro = yes.
     3432                end.
     3433           
     3434           IF NOT CAN-FIND (FIRST ftpadcob 
     3435                            where ftpadcob.cd-modalidade       = import-propost.cd-modalidade
     3436                              and ftpadcob.cd-plano            = import-propost.cd-plano
     3437                              and ftpadcob.cd-tipo-plano       = import-propost.cd-tipo-plano
     3438                              and ftpadcob.cd-padrao-cobertura = import-padr-cobert-propost.cd-padrao-cobertura
     3439                              and ftpadcob.cd-modulo           = import-padr-cobert-propost.cd-modulo)
     3440           then do:
     3441                  run pi-cria-tt-erros (140,"Padrao de Cobertura com Percentuais nao Cadastrado" +
     3442                                        " MODALIDADE " + STRING(import-propost.cd-modalidade)    +
     3443                                        " PLANO "      + STRING(import-propost.cd-plano)         +
     3444                                        " TIPO PLANO " + STRING(import-propost.cd-tipo-plano) + 
     3445                                        " PADRAO "     + import-padr-cobert-propost.cd-padrao-cobertura + 
     3446                                        " MODULO "     + STRING(import-padr-cobert-propost.cd-modulo)).
     3447                  assign lg-relat-erro = yes.
     3448                end.
     3449           
     3450           IF NOT CAN-FIND (FIRST mod-cob where mod-cob.cd-modulo = import-padr-cobert-propost.cd-modulo)
     3451           then do:
     3452                  run pi-cria-tt-erros (141,"Modulo de Cobertura nao Cadastrado " + string(import-padr-cobert-propost.cd-modulo,"999")).
     3453                  assign lg-relat-erro = yes.
     3454                end.        
     3455       END.
     3456   
     3457   END PROCEDURE.
     3458   
     3459   /* ------------------------------------------------------------------------------------------- */
     3460   PROCEDURE consiste-campos-proposta:
     3461   
     3462       FOR EACH import-campos-propost where import-campos-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock :
     3463   
     3464           if  import-campos-propost.des-campo-1 = ""
     3465           then do:
     3466                  assign lg-relat-erro = yes.
     3467                  run pi-cria-tt-erros (142,"Campo 1 - tipo de registro 6 nao foi informado").
     3468                end.
     3469           
     3470           if import-campos-propost.des-mascar-1 = ""
     3471           then do:
     3472                  assign lg-relat-erro = yes.
     3473                  run pi-cria-tt-erros (143,"Mascara 1 - tipo de registro 6 nao foi informada").
     3474                end.
     3475   
     3476       END.
     3477   
     3478   END PROCEDURE.
     3479   
     3480   /* ------------------------------------------------------------------------------------------- */
     3481   PROCEDURE consiste-proced-propost:
     3482   
     3483       FOR EACH import-proced-propost where import-proced-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock :
     3484   
     3485           IF NOT CAN-FIND (FIRST mod-cob where mod-cob.cd-modulo = import-proced-propost.cd-modulo)
     3486           then do:
     3487                  run pi-cria-tt-erros (144,"Modulo nao cadastrado " + string(import-proced-propost.cd-modulo,"999")).
     3488           
     3489                  assign lg-relat-erro = yes.
     3490                end.
     3491           
     3492           IF NOT CAN-FIND (FIRST ambproce 
     3493                            where ambproce.cd-esp-amb        = int(substr(string(import-proced-propost.cd-amb,"99999999"),01,02))
     3494                              and ambproce.cd-grupo-proc-amb = int(substr(string(import-proced-propost.cd-amb,"99999999"),03,02))
     3495                              and ambproce.cd-procedimento   = int(substr(string(import-proced-propost.cd-amb,"99999999"),05,03))
     3496                              and ambproce.dv-procedimento   = int(substr(string(import-proced-propost.cd-amb,"99999999"),08,01)))
     3497           then do:
     3498                  run pi-cria-tt-erros (145,"Tabela de Procedimento nao Cadastrada " + string(import-proced-propost.cd-amb,"99999999")).
     3499                  assign lg-relat-erro = yes.
     3500                end.
     3501           
     3502           if not import-propost.log-cobert-especial 
     3503           then do:
     3504                  run pi-cria-tt-erros (146,"Parametro da Proposta nao permite cobertura especial").
     3505                  assign lg-relat-erro = yes.
     3506                end.
     3507   
     3508           if   import-propost.dat-fim-propost = ?
     3509           THEN DO:
     3510                  if import-proced-propost.dt-cancela <> ?
     3511                  then do:
     3512                         run pi-cria-tt-erros (147,"Proposta Ativa X Procedimento Cancelado").
     3513                         assign lg-relat-erro = yes.
     3514                       end.
     3515                END.
     3516           ELSE DO:
     3517                  if import-proced-propost.dt-cancela = ?
     3518                  then do:
     3519                         run pi-cria-tt-erros (148,"Proposta Cancelada X Procedimento Ativo").
     3520                         assign lg-relat-erro = yes.
     3521                       end.
     3522                  
     3523                  if   import-proced-propost.dt-cancela > import-propost.dat-fim-propost
     3524                  then do:
     3525                         run pi-cria-tt-erros (149,"Data de cancelamento do procedimento maior que data de cancelamento da proposta").
     3526                         assign lg-relat-erro = yes.
     3527                       end.
     3528                END.
     3529           
     3530           if   import-proced-propost.dt-inicial = ?
     3531           then do:
     3532                  run pi-cria-tt-erros (150,"Data Inicio Invalida ").
     3533                  assign lg-relat-erro = yes.
     3534                end.
     3535       
     3536       END.
     3537   
     3538   END PROCEDURE.
     3539   
     3540   /* ------------------------------------------------------------------------------------------- */
     3541   PROCEDURE consiste-mo:
     3542   
     3543       FOR EACH import-mo-propost FIELDS (cd-departamento cd-secao cd-setor)
     3544          where import-mo-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock :
     3545   
     3546           run rtp/rttipmed.p(input        import-propost.cd-modalidade,
     3547                              input        no,
     3548                              output       lg-relat-erro,
     3549                              output       ds-mensagem-aux,
     3550                              input-output lg-medocup-aux) no-error.
     3551           
     3552           if error-status:error
     3553           then do:
     3554                  if error-status:num-messages = 0
     3555                  then run pi-cria-tt-erros (151,"Ocorreram erros na execucao da RTTIPMED").                          
     3556                  else run pi-cria-tt-erros (152,"Ocorreram erros na execucao da RTTIPMED. " + substring(error-status:get-message(error-status:num-messages),1,175)).
     3557                  assign lg-relat-erro = yes.
     3558                end.
     3559           
     3560           if not lg-medocup-aux
     3561           then do:
     3562                  run pi-cria-tt-erros (153,"Registro do Tipo 8 deve ser informado apenas para mod.de medicina ocupacional").
     3563                  assign lg-relat-erro = yes.
     3564                end.
     3565           
     3566           /*----- VERIFICA DEPARTAMENTO ----------------------------------------*/
     3567           if  import-mo-propost.cd-departamento = 0
     3568           then do:
     3569                  run pi-cria-tt-erros (154,"Departamento - tipo de registro 8 nao foi informado").
     3570                  assign lg-relat-erro = yes.
     3571                end.
     3572           ELSE IF NOT CAN-FIND (FIRST departa where departa.cd-departamento = import-mo-propost.cd-departamento)
     3573                then do:
     3574                       run pi-cria-tt-erros (155,"Departamento nao Cadastrado - " + string(import-mo-propost.cd-departamento,"999")).
     3575                       assign lg-relat-erro = yes.
     3576                     end.
     3577            
     3578            /*----- VERIFICA SECAO -----------------------------------------------*/
     3579           if  import-mo-propost.cd-secao = 0
     3580           then do:
     3581                  run pi-cria-tt-erros (156,"Secao - tipo de registro 8 nao foi informado").
     3582                  assign lg-relat-erro = yes.
     3583                end.
     3584           ELSE IF NOT CAN-FIND (FIRST secao where secao.cd-secao = import-mo-propost.cd-secao)
     3585                then do:
     3586                       run pi-cria-tt-erros (157,"Secao nao Cadastrada - " + string(import-mo-propost.cd-secao,"999")).
     3587                       assign lg-relat-erro = yes.
     3588                     end.
     3589   
     3590           /*----- VERIFICA SETOR -----------------------------------------------*/
     3591           if  import-mo-propost.cd-setor = 0
     3592           then do:
     3593                  run pi-cria-tt-erros (158,"Setor - tipo de registro 8 nao foi informado").
     3594                  assign lg-relat-erro = yes.
     3595                end.
     3596           ELSE IF NOT CAN-FIND (FIRST setor where setor.cd-setor = import-mo-propost.cd-setor)
     3597                then do:
     3598                       run pi-cria-tt-erros (159,"Setor nao Cadastrado - " + string(import-mo-propost.cd-setor,"999")).
     3599                       assign lg-relat-erro = yes.
     3600                     end.
     3601           END.
     3602   
     3603   END PROCEDURE.
     3604   
     3605   /* ------------------------------------------------------------------------------------------- */
     3606   PROCEDURE consiste-mo-funcao:
     3607   
     3608       FOR EACH import-funcao-propost where import-funcao-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock :
     3609   
     3610           find first import-mo-propost where import-mo-propost.num-seqcial-propost = import-propost.num-seqcial-propost no-lock no-error.
     3611   
     3612           run rtp/rttipmed.p(input        import-propost.cd-modalidade,
     3613                              input        no,
     3614                              output       lg-relat-erro,
     3615                              output       ds-mensagem-aux,
     3616                              input-output lg-medocup-aux) no-error.
     3617           
     3618           if error-status:error
     3619           then do:
     3620                  if error-status:num-messages = 0
     3621                  then run pi-cria-tt-erros (160,"Ocorreram erros na execucao da RTTIPMED").                       
     3622                  else run pi-cria-tt-erros (161,"Ocorreram erros na execucao da RTTIPMED. " + substring(error-status:get-message(error-status:num-messages),1,175)).
     3623                  assign lg-relat-erro = yes.
     3624                end.
     3625           
     3626           if not lg-medocup-aux
     3627           then do:
     3628                  run pi-cria-tt-erros (162,"Registro do Tipo 9 deve ser informado apenas para mod.de medicina ocupacaional").
     3629                  assign lg-relat-erro = yes.
     3630                end.
     3631           
     3632           /*----- VERIFICA SE EH CAMPO ZERADO -------------------------------------*/                
     3633           if  import-funcao-propost.cd-funcao = 0
     3634           then do:
     3635                  run pi-cria-tt-erros (163,"Funcao - tipo de registro 9 nao foi informado").
     3636                  assign lg-relat-erro = yes.
     3637                end.
     3638           
     3639           /******************** FUNCAO ***************************************/
     3640           IF NOT CAN-FIND (FIRST funcempr where funcempr.cd-funcao = import-funcao-propost.cd-funcao)
     3641           then do:
     3642                  run pi-cria-tt-erros (164,"Funcao Empresa nao cadastrada. (Registro 9)").
     3643                  assign lg-relat-erro = yes.
     3644                end.
     3645   
     3646       END.
     3647   
     3648   END PROCEDURE.
     3649   
     3650   PROCEDURE escrever-log:
     3651       DEF INPUT PARAMETER ds-par AS CHAR NO-UNDO.
     3652   END PROCEDURE.
     3653   
     3654   /* ------------------------------------------------------------------------------------------------- */
