        1   def input param in-batch-online-par     as char no-undo.
        2   def input param in-status-monitorar-par AS char no-undo.
        3   def input param lg-plano-par            as log  no-undo.
        4   def input param lg-medocup-par          as log  no-undo.
        5   def input param lg-registro-modulos-par as log  no-undo.
        6   def input param lg-registro-repasse-par as log  no-undo.
        7   def input param in-classif-par          as int  no-undo.
        8   def input param qt-sair-par             as int  no-undo.
        9   def input param in-status-benef-par     as char no-undo.
       10   def input param in-carteira-antig-par   as char no-undo.      
       11   
       12   /*variavel para permitir importar beneficiarios fora de faixa de idade*/
       13   DEFINE VARIABLE lg-valida-idade-aux AS log INITIAL NO NO-UNDO.
       14   /**
       15    * CAMPOS RESERVA EM USO
       16    *
       17    * IMPORT-BNFCIAR.NUM-LIVRE-10: codigo de cliente do beneficiario substituto (PEA)
       18    *               .NUM-LIVRE-9:  regra-menslid-propost.cdd-regra - estara preenchido quando o beneficiario possui uma regra de mensalidade diferente da sua proposta
       19    *               .NUM-LIVRE-1:  cdn-lotac - codigo da lotacao a qual o beneficiario pertence. Caso a proposta do Unicoo nao tenha lotacao, ficara zerado.
       20    *                                          quando for DEMITIDO/APOSENTADO, usara a lotacao default 1. Somente sera preenchido em modalidades JURIDICAS.
       21    *               .NUM-LIVRE-2:  cdn-respons-financ - codigo do responsavel financeiro pelo contrato (relacionamento com CONTRAT.CD-CONTRATANTE).
       22    *                              somente sera preenchido quando o beneficiario for DEMITIDO/APOSENTADO. Para qualquer outra situacao, ficara zero. 
       23    *                              Somente sera preenchido em modalidades JURIDICAS.
       24    *               .NUM-LIVRE-3:  data de vencimento do contrato DEMITIDO/APOSENTADO
       25    *               .NUM-LIVRE-4:  numero da familia do beneficiario no UNICOO
       26    *               .NUM-LIVRE-5:  NRSEQUENCIAL_USUARIO (UNICOO) do dependente que originou o registro de responsavel no plano de remidos (PEA)
       27    *               .DAT-LIVRE-1:  data de validade da carteira no Unicoo
       28    *               .DAT-LIVRE-2:  data de inicio do beneficiario no plano de DEMITIDO/APOSENTADO
       29    *               .DAT-LIVRE-3:  data de desligamento do beneficiario no contrato original quando se referir a DEMITIDO/APOSENTADO
       30    *               .COD_LIVRE_1:  codigo do contrato no Unicoo (USUARIO.CDCONTRATO)
       31    *               .COD_LIVRE_2:  se tiver o valor 'A' indica que eh um registro de DEMITIDO/APOSENTADO e nao esta sendo usado o conceito de LOTACAO
       32    *               .COD_LIVRE_3:  carteira do responsavel, preenchido apenas quando o dependente eh gravado em plano separado, devido aos DEPARAS de estrutura
       33    *
       34    * IMPORT-MODUL-BNFCIAR.NUM-LIVRE-1: 
       35    */
       36   
       37   /** transformar em parametro e preparar os chamadores!*/
       38   DEF VAR lg-gerar-termo-par AS LOG INIT NO NO-UNDO.
       39   lg-gerar-termo-par = YES.
       40   
       41   /*    OUTPUT TO c:\temp\teste-cg0310v1.txt APPEND.
       42       PUT UNFORMATTED "entrando no cg0310v1 com status:" in-status-monitorar-par skip.
       43       OUTPUT CLOSE.*/
       44   
       45   /*DEF STREAM s-rel-erro.
       46   DEF VAR nm-rel-erro-aux AS CHAR INIT "c:\temp\erros_cg0310v1.csv" NO-UNDO.
       47   */
       48   function get-trace returns char:
       49     DEF VAR ds-ret-aux AS CHAR NO-UNDO.
       50     DEF VAR level      AS INT INIT 2 NO-UNDO.
       51     REPEAT WHILE PROGRAM-NAME(level) <> ?:
       52            ASSIGN ds-ret-aux = ds-ret-aux + "/" +
       53                   PROGRAM-NAME(level)
       54                   level = level + 1.
       55     END.
       56   end function.
       57   
       58   /********************************************************************************
       59   ** Copyright DATASUL S.A. (1997)
       60   ** Todos os Direitos Reservados.
       61   **
       62   ** Este fonte e de propriedade exclusiva da DATASUL, sua reproducao
       63   ** parcial ou total por qualquer meio, so podera ser feita mediante
       64   ** autorizacao expressa.
       65   *******************************************************************************/
       66   /* Begin_Include: i_version_extract */
       67   def new global shared var v_cod_arq
       68       as char  
       69       format 'x(60)'
       70       no-undo.
       71   def new global shared var v_cod_tip_prog
       72       as character
       73       format 'x(8)'
       74       no-undo.
       75   
       76   def stream s-arq.
       77   
       78   def var c_prg_vrs as char init "" no-undo.
       79   assign c_prg_vrs = "2.00.00.021".
       80   
       81   /* LS */
       82   /* DEF VAR c_id_modulo_ls   AS CHAR NO-UNDO.  */
       83   /* DEF VAR c_desc_modulo_ls AS CHAR NO-UNDO.  */
       84   /* FIM LS */
       85   
       86   if  v_cod_arq <> '' and v_cod_arq <> ?
       87   then do:
       88       /*Exemplo de chamada do EMS5
       89       run pi_version_extract ('api_login':U, 'prgtec/btb/btapi910za.py':U, '1.00.00.008':U, 'pro':U).
       90       */
       91       run pi_version_extract ('':U, 'CG0310V1':U, '2.00.00.021':U, '':U).
       92   end /* if */.
       93   /* End_Include: i_version_extract */
       94   
       95   /*****************************************************************************
       96   ** Procedure Interna.....: pi_version_extract
       97   ** Descricao.............: pi_version_extract
       98   ** Criado por............: jaison
       99   ** Criado em.............: 31/07/1998 09:33:22
      100   ** Alterado por..........: tech14013
      101   ** Alterado em...........: 05/01/2005 19:27:44
      102   *****************************************************************************/
      103   PROCEDURE pi_version_extract:
      104   
      105       /************************ Parameter Definition Begin ************************/
      106   
      107       def Input param p_cod_program
      108           as character
      109           format "x(08)"
      110           no-undo.
      111       def Input param p_cod_program_ext
      112           as character
      113           format "x(8)"
      114           no-undo.
      115       def Input param p_cod_version
      116           as character
      117           format "x(8)"
      118           no-undo.
      119       def Input param p_cod_program_type
      120           as character
      121           format "x(8)"
      122           no-undo.
      123   
      124   
      125       /************************* Parameter Definition End *************************/
      126   
      127       /************************* Variable Definition Begin ************************/
      128   
      129       def var v_cod_event_dic
      130           as character
      131           format "x(20)":U
      132           label "Evento"
      133           column-label "Evento"
      134           no-undo.
      135       def var v_cod_tabela
      136           as character
      137           format "x(28)":U
      138           label "Tabela"
      139           column-label "Tabela"
      140           no-undo.
      141   
      142   
      143       /************************** Variable Definition End *************************/
      144       IF p_cod_program_type = "" OR p_cod_program_type = ? THEN DO:
      145           ASSIGN p_cod_program_type = "pro".
      146       END.
      147   
      148   
      149       if  can-do(v_cod_tip_prog, p_cod_program_type)
      150       then do:
      151           if p_cod_program_type = 'dic' then 
      152              assign p_cod_program_ext = replace(p_cod_program_ext, 'database/', '').
      153   
      154           output stream s-arq to value(v_cod_arq) append.
      155   
      156           
      157   
      158           put stream s-arq unformatted
      159               p_cod_program            at 1 
      160               p_cod_program_ext        at 43 
      161               p_cod_version            at 69 
      162               today                    at 84 
      163               string(time, 'HH:MM:SS') at 94 skip.
      164   
      165           if  p_cod_program_type = 'pro' then do:
      166               
      167           end.
      168   
      169           if  p_cod_program_type = 'dic' then do:
      170               
      171           end.
      172   
      173           output stream s-arq close.
      174       end /* if */.
      175   
      176   END PROCEDURE. /* pi_version_extract */
      177     /*** 010021 ***/
      178   
      179   
      180   
      181   /******************************************************************************
      182   *      Programa .....: CG0310V1.p                                              *
      183   *      Data .........: 22 de Janeiro de 2015                                  *
      184   *      Autor ........: TOTVS                                                  *
      185   *      Sistema ......: CG - CADASTROS GERAIS                                  *
      186   *      Programador ..: Ja¡ne Marin                                            *
      187   *      Objetivo .....: Importacao de Dados dos Beneficiarios                  *
      188   ******************************************************************************/
      189   hide all no-pause.
      190   /*****************************************************************************
      191   *      Programa .....: hdvarregua.i                                          *
      192   *      Data .........: 20 de Janeiro de 1998                                 *
      193   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
      194   *      Sistema ......: HD - Includes Padroes                                 *
      195   *      Programador ..: Airton Nora                                           *
      196   *      Objetivo .....: Variaveis para montagem das reguas                    *
      197   *----------------------------------------------------------------------------*
      198   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
      199   *      7.00.000  06/03/2003  Nora           Desenvolvimento                  *
      200   *****************************************************************************/
      201   
      202   def var lg-permitido        as log                                      no-undo.
      203   def var lg-btn-principal    as log                                      no-undo.
      204   def var lg-btn-inclui       as log                                      no-undo.
      205   def var lg-btn-modifica     as log                                      no-undo.
      206   def var lg-btn-elimina      as log                                      no-undo.
      207   def var lg-btn-funcao       as log                                      no-undo.
      208   def var lg-btn-relatorio    as log                                      no-undo.
      209   def var lg-btn-copiar       as log                                      no-undo.
      210   def var lg-btn-congela      as log                                      no-undo.
      211   def var lg-btn-descongela   as log                                      no-undo.
      212   def var lg-btn-parametro    as log                                      no-undo.
      213   def var lg-btn-atualiza     as log                                      no-undo.
      214   def var lg-btn-selecao      as log                                      no-undo.
      215   def var lg-btn-executa      as log                                      no-undo.
      216   def var lg-btn-geracao      as log                                      no-undo.
      217   def var lg-btn-transfere    as log                                      no-undo.
      218   def var lg-btn-reativa      as log                                      no-undo.
      219   def var lg-btn-habilita     as log                                      no-undo.
      220   def var lg-btn-desabilita   as log                                      no-undo.
      221   def var lg-btn-beneficiario as log                                      no-undo.
      222   def var lg-btn-contratante  as log                                      no-undo.
      223   def var lg-btn-simulacao    as log                                      no-undo.
      224   def var lg-btn-suspende     as log                                      no-undo.
      225   def var lg-btn-arquivo      as log                                      no-undo.
      226   def var lg-btn-cancela      as log                                      no-undo.
      227   def var lg-btn-duplicar     as log                                      no-undo.
      228   def var lg-btn-reajustar    as log                                      no-undo.
      229   def var lg-btn-revalorizar  as log                                      no-undo.
      230   def var lg-btn-estornar     as log                                      no-undo.
      231   def var lg-btn-exames       as log                                      no-undo.
      232   def var lg-btn-fechar       as log                                      no-undo.
      233   def var lg-btn-prorrogar    as log                                      no-undo.
      234   def var lg-btn-antecipacao  as log                                      no-undo.
      235   def var lg-btn-confirma     as log                                      no-undo.
      236   def var nr-tam-permis       as int                                      no-undo.
      237   def var nm-prg-novo         as char format "x(100)"                     no-undo.
      238   def var c-opcao             as char                                     no-undo.
      239   /* --------------------------------------------------- BOTOES PARA WINDOWS --- */
      240   /*****************************************************************************
      241   *      Programa .....: hddefbotao.i                                          *
      242   *      Data .........: 06 de Marco de 2003                                   *
      243   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
      244   *      Sistema ......: Includes padraes                                      *
      245   *      Programador ..: Airton Nora                                           *
      246   *      Objetivo .....: Definicao dos botoes para windows                     *
      247   *----------------------------------------------------------------------------*
      248   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
      249   *****************************************************************************/
      250   
      251   /* --------------------------------------------------- BOTOES PARA WINDOWS --- */
      252   define button b-primeiro 
      253        image-up file "igp/primeiro-up.gif" image-size 4 by 4
      254        label "P&rimeiro" 
      255        size 4 BY 2.0 tooltip "Primeiro"
      256        auto-go.
      257   
      258   define button b-ultimo 
      259        image-up file "igp/ultimo-up.gif" image-size 4 by 4
      260        label "&Ultimo" 
      261        size 4 BY 2.0 tooltip "Ultimo"
      262        auto-go.
      263   
      264   define button b-proximo 
      265        image-up file "igp/proximo-up.gif" image-size 4 by 4
      266        label "&Proximo" 
      267        size 4 BY 2.0 tooltip "Proximo"
      268        auto-go.
      269   
      270   define button b-anterior 
      271        image-up file "igp/anterior-up.gif" image-size 4 by 4
      272        label "&Anterior" 
      273        size 4 BY 2.0 tooltip "Anterior"
      274        auto-go.
      275   
      276   define button b-codigo 
      277        image-up file "igp/pesquisa-up.gif" image-size 4 by 4
      278        label "&Codigo" 
      279        size 4 BY 2.0 tooltip "Codigo"
      280        auto-go.
      281   
      282   define button b-inclui 
      283        image-up file "igp/inclui-up.gif" image-size 4 by 4
      284        label "&Inclui" 
      285        size 4 BY 2.0 tooltip "Inclui"
      286        auto-go.
      287   
      288   define button b-modifica 
      289        image-up file "igp/modifica-up.gif" image-size 4 by 4
      290        label "&Modifica" 
      291        size 4 BY 2.0 tooltip "Modifica"
      292        auto-go.
      293   
      294   define button b-elimina 
      295        image-up file "igp/elimina-up.gif" image-size 4 by 4
      296        label "&Elimina" 
      297        size 4 BY 2.0 tooltip "Elimina"
      298        auto-go.
      299   
      300   define button b-funcao  
      301        image-up file "igp/funcoes-up.gif" image-size 4 by 4
      302        label "&Funcao" 
      303        size 4 BY 2.0 tooltip "Funcao"
      304        auto-go.
      305   
      306   define button b-lista 
      307        image-up file "igp/lista-up.gif" image-size 4 by 4
      308        label "&Lista" 
      309        size 4 BY 2.0 tooltip "Lista"
      310        auto-go.
      311   
      312   define button b-relatorio 
      313        image-up file "igp/relatorio-up.gif" image-size 4 by 4
      314        label "Rela&torio" 
      315        size 4 BY 2.0 tooltip "Relatorio"
      316        auto-go.
      317   
      318   define button b-imprime
      319        image-up file "igp/imprime-up.gif" image-size 4 by 4
      320        label "Imprime" 
      321        size 4 BY 2.0 tooltip "Imprime"
      322        auto-go.
      323   
      324   define button b-fim DEFAULT 
      325        image-up file "igp/saida-up.gif" image-size 4 by 4
      326        label "&Fim" 
      327        size 4 BY 2.0 tooltip "Saida"
      328        auto-go.
      329   
      330   define button b-help DEFAULT 
      331        image-up file "igp/help-up.gif" image-size 4 by 4
      332        label "&Help" 
      333        size 4 BY 2.0 tooltip "Ajuda"
      334        .
      335   
      336   define button b-copia
      337        image-up file "igp/copia-up.gif" image-size 4 by 4
      338        label "&Copia" 
      339        size 4 BY 2.0 tooltip "Copia"
      340        auto-go.
      341   
      342   define button b-congela
      343        image-up file "igp/congela-up.gif" image-size 4 by 4
      344        label "Con&gela" 
      345        size 4 BY 2.0 tooltip "Congela"
      346        auto-go.
      347   
      348   define button b-descongela
      349        image-up file "igp/descongela-up.gif" image-size 4 by 4
      350        label "&Descongela" 
      351        size 4 BY 2.0 tooltip "Descongela"
      352        auto-go.
      353   
      354   define button b-parametro
      355        image-up file "igp/parametro-up.gif" image-size 4 by 4
      356        label "&Parametro" 
      357        size 4 BY 2.0 tooltip "Parametro"
      358        auto-go.
      359   
      360   define button b-atualiza
      361        image-up file "igp/atualiza-up.gif" image-size 4 by 4
      362        label "&Atualiza" 
      363        size 4 BY 2.0 tooltip "Atualiza"
      364        auto-go.
      365   
      366   define button b-selecao
      367        image-up file "igp/selecao-up.gif" image-size 4 by 4
      368        label "&Selecao" 
      369        size 4 BY 2.0 tooltip "Selecao"
      370        auto-go.
      371   
      372   define button b-executa
      373        image-up file "igp/executa-up.gif" image-size 4 by 4
      374        label "&Executa" 
      375        size 4 BY 2.0 tooltip "Executa"
      376        auto-go.
      377   
      378   define button b-geracao
      379        image-up file "igp/geracao-up.gif" image-size 4 by 4
      380        label "&Geracao" 
      381        size 4 BY 2.0 tooltip "Geracao"
      382        auto-go.
      383   
      384   define button b-transferencia
      385        image-up file "igp/transferencia-up.gif" image-size 4 by 4
      386        label "&Transferencia" 
      387        size 4 BY 2.0 tooltip "Transferencia"
      388        auto-go.
      389   
      390   define button b-reativa
      391        image-up file "igp/reativa-up.gif" image-size 4 by 4
      392        label "&Reativa" 
      393        size 4 BY 2.0 tooltip "Reativa"
      394        auto-go.
      395   
      396   define button b-habilita
      397        image-up file "igp/habilita-up.gif" image-size 4 by 4
      398        label "&Habilita" 
      399        size 4 BY 2.0 tooltip "Habilita"
      400        auto-go.
      401   
      402   define button b-desabilita
      403        image-up file "igp/desabilita-up.gif" image-size 4 by 4
      404        label "&Desabilita" 
      405        size 4 BY 2.0 tooltip "Desabilita"
      406        auto-go.
      407   
      408   define button b-beneficiario
      409        image-up file "igp/beneficiario-up.gif" image-size 4 by 4
      410        label "&Beneficiario" 
      411        size 4 BY 2.0 tooltip "Beneficiario"
      412        auto-go.
      413   
      414   define button b-contratante
      415        image-up file "igp/contratante-up.gif" image-size 4 by 4
      416        label "&Contratante" 
      417        size 4 BY 2.0 tooltip "Contratante"
      418        auto-go.
      419   
      420   define button b-simulacao
      421        image-up file "igp/simulacao-up.gif" image-size 4 by 4
      422        label "&Simulacao" 
      423        size 4 BY 2.0 tooltip "Simulacao"
      424        auto-go.
      425   
      426   define button b-suspende
      427        image-up file "igp/suspende-up.gif" image-size 4 by 4
      428        label "&Suspende" 
      429        size 4 BY 2.0 tooltip "Suspende"
      430        auto-go.
      431   
      432   define button b-arquivo
      433        image-up file "igp/arquivo-up.gif" image-size 4 by 4
      434        label "&Arquivo" 
      435        size 4 BY 2.0 tooltip "Arquivo"
      436        auto-go.
      437   
      438   define button b-cancela
      439        image-up file "igp/cancela-up.gif" image-size 4 by 4
      440        label "&Cancela" 
      441        size 4 BY 2.0 tooltip "Cancela"
      442        auto-go.
      443   
      444   define button b-classificacao
      445        image-up file "igp/classificacao-up.gif" image-size 4 by 4
      446        label "&Classificacao" 
      447        size 4 BY 2.0 tooltip "Classificacao"
      448        auto-go.
      449   
      450   define button b-duplicar 
      451        image-up file "igp/duplicar-up.gif" image-size 4 by 4
      452        label "&Duplicar" 
      453        size 4 BY 2.0 tooltip "Duplicar"
      454        auto-go.
      455   
      456   define button b-reajustar
      457        image-up file "igp/reajustar-up.gif" image-size 4 by 4
      458        label "&Reajustar" 
      459        size 4 BY 2.0 tooltip "Reajustar"
      460        auto-go.
      461   
      462   define button b-revalorizar
      463        image-up file "igp/revalorizar-up.gif" image-size 4 by 4
      464        label "&Revalorizar" 
      465        size 4 BY 2.0 tooltip "Revalorizar"
      466        auto-go.
      467   
      468   define button b-consiste
      469        image-up file "igp/consiste-up.gif" image-size 4 by 4
      470        label "&Consiste" 
      471        size 4 BY 2.0 tooltip "Consiste"
      472        auto-go.
      473   
      474   define button b-importa
      475        image-up file "igp/importa-up.gif" image-size 4 by 4
      476        label "&Importa" 
      477        size 4 BY 2.0 tooltip "Importa"
      478        auto-go.
      479   
      480   define button b-carrega
      481        image-up file "igp/carrega-up.gif" image-size 4 by 4
      482        label "&Carrega" 
      483        size 4 BY 2.0 tooltip "Carrega"
      484        auto-go.
      485   
      486   define button b-layout
      487        image-up file "igp/layout-up.gif" image-size 4 by 4
      488        label "&Layout" 
      489        size 4 BY 2.0 tooltip "Layout"
      490        auto-go.
      491   
      492   define button b-exporta
      493        image-up file "igp/exporta-up.gif" image-size 4 by 4
      494        label "&Exporta" 
      495        size 4 BY 2.0 tooltip "Exporta"
      496        auto-go.
      497   
      498   define button b-reexporta
      499        image-up file "igp/reexporta-up.gif" image-size 4 by 4
      500        label "&Reexporta" 
      501        size 4 BY 2.0 tooltip "Reexporta"
      502        auto-go.
      503   
      504   define button b-estornar
      505        image-up file "igp/estornar-up.gif" image-size 4 by 4
      506        label "&Estornar" 
      507        size 4 BY 2.0 tooltip "Estornar"
      508        auto-go.
      509   
      510   define button b-exames
      511        image-up file "igp/exames-up.gif" image-size 4 by 4
      512        label "&Exames" 
      513        size 4 BY 2.0 tooltip "Exames"
      514        auto-go.
      515   
      516   define button b-parecer
      517        image-up file "igp/parecer-up.gif" image-size 4 by 4
      518        label "&Parecer" 
      519        size 4 BY 2.0 tooltip "Parecer"
      520        auto-go.
      521   
      522   define button b-antecipacao
      523        image-up file "igp/antecipacao-up.gif" image-size 4 by 4
      524        label "&Antecipacao" 
      525        size 4 BY 2.0 tooltip "Gera Antecipacao de guias"
      526        auto-go.
      527   
      528   define button b-confirma
      529        image-up file "igp/confirma-up.gif" image-size 4 by 4
      530        label "&Confirma"  
      531        size 4 BY 2.0 tooltip "Confirma orcamento"
      532        auto-go.
      533   
      534   define button b-orcamento
      535        image-up file "igp/orcamento-up.gif" image-size 4 by 4
      536        label "&Orcamento" 
      537        size 4 BY 2.0 tooltip "Orcamento"
      538        auto-go.
      539   
      540   define button b-autorizacao
      541        image-up file "igp/autorizacao-up.gif" image-size 4 by 4
      542        label "&Autorizacao" 
      543        size 4 BY 2.0 tooltip "Autorizacao"
      544        auto-go.
      545   
      546   define button b-fechar
      547        image-up file "igp/fechar-up.gif" image-size 4 by 4
      548        label "&Fechar"   
      549        size 4 BY 2.0 tooltip "Fechar"
      550        auto-go.
      551   
      552   define button b-prorrogar
      553        image-up file "igp/prorrogar-up.gif" image-size 4 by 4
      554        label "&Prorrogar" 
      555        size 4 BY 2.0 tooltip "Prorrogar"
      556        auto-go.
      557   
      558   define button b-prestador
      559        image-up file "igp/prestador-up.gif" image-size 4 by 4
      560        label "&Prestador" 
      561        size 4 BY 2.0 tooltip "Prestador"
      562        auto-go.
      563   
      564   define button b-ocorrencia
      565        image-up file "igp/ocorrencia-up.gif" image-size 4 by 4
      566        label "&Ocorrencia" 
      567        size 4 BY 2.0 tooltip "Ocorrencia"
      568        auto-go.
      569   
      570   define button b-solucao
      571        image-up file "igp/solucao-up.gif" image-size 4 by 4
      572        label "&Solucao" 
      573        size 4 BY 2.0 tooltip "Solucao"
      574        auto-go.
      575   
      576   define button b-reimprime
      577        image-up file "igp/reimprime-up.gif" image-size 4 by 4
      578        label "&Reimprime" 
      579        size 4 BY 2.0 tooltip "Reimprime"
      580        auto-go.
      581   
      582   define button b-contabiliza
      583        image-up file "igp/contabiliza-up.gif" image-size 4 by 4
      584        label "&Contabiliza" 
      585        size 4 BY 2.0 tooltip "Contabiliza"
      586        auto-go.
      587   
      588   define button b-descontabiliza
      589        image-up file "igp/descontabiliza-up.gif" image-size 4 by 4
      590        label "&Descontabiliza" 
      591        size 4 BY 2.0 tooltip "Descontabiliza"
      592        auto-go.
      593   
      594   define button b-emissao 
      595        image-up file "igp/relatorio-up.gif" image-size 4 by 4
      596        label "Emissao" 
      597        size 4 BY 2.0 tooltip "Emissao"
      598        auto-go.
      599   
      600   define button b-reemissao
      601        image-up file "igp/reimprime-up.gif" image-size 4 by 4
      602        label "Reemissao" 
      603        size 4 BY 2.0 tooltip "Reemissao"
      604        auto-go.
      605   
      606   define button b-renovacao
      607        image-up file "igp/atualiza-up.gif" image-size 4 by 4
      608        label "Renovacao" 
      609        size 4 BY 2.0 tooltip "Renovacao"
      610        auto-go.
      611   
      612   define button b-novavia
      613        image-up file "igp/inclui-up.gif" image-size 4 by 4
      614        label "Nova Via" 
      615        size 4 BY 2.0 tooltip "Nova Via"
      616        auto-go.
      617   define button b-reembolso
      618        image-up file "igp/reajustar-up.gif" image-size 4 by 4
      619        label "&Reembolso" 
      620        size 4 BY 2.0 tooltip "Reembolso"
      621        auto-go.
      622        
      623   define button b-gera-reembolso
      624        image-up file "igp/reajustar-up.gif" image-size 4 by 4
      625        label "&Gera Reembolso" 
      626        size 4 BY 2.0 tooltip "Gera Reembolso"
      627        auto-go.
      628        
      629   define rectangle Retangulo-1
      630        edge-pixels 2 graphic-edge  
      631        size 78 BY 3
      632        no-fill.
      633        
      634        
      635   
      636   
      637   
      638   
      639    
      640    
      641   /******************************************************************************
      642       Programa .....: hdregcpimla.i
      643       Data .........: 05/01/2004
      644       Sistema ......:
      645       Empresa ......: DZSET SOLUCOES E SISTEMAS
      646       Cliente ......:
      647       Programador ..: ELIZETE
      648       Objetivo .....: Rgua de arquivo, consiste, parametro, importa e layout
      649   *-----------------------------------------------------------------------------*
      650       Versao     DATA         RESPONSAVEL
      651                  05/01/2004   ELIZETE
      652   ******************************************************************************/
      653   /* ---------------------------------------------------- REGUAS PARA UNIX --- */
      654   def var tb-cpimla as char extent 6 initial ["Arquivo",
      655                                               "Consiste",
      656                                               "Parametro",
      657                                               "Importa",
      658                                               "Layout",      
      659                                               "Fim"]       no-undo.
      660    
      661   /******************************************************************************
      662       Programa .....: hdregcpimla.f
      663       Data .........: 05/01/2004
      664       Sistema ......:
      665       Empresa ......: DZSET SOLUCOES E SISTEMAS
      666       Cliente ......:
      667       Programador ..: ELIZETE
      668       Objetivo .....: Rgua de arquivo, consiste, parametro, importa e layout
      669   *-----------------------------------------------------------------------------*
      670       Versao     DATA         RESPONSAVEL
      671                  05/01/2004   ELIZETE
      672   ******************************************************************************/
      673   /* --------------------------------------------------- FRAMES PARA UNIX --- */
      674   form tb-cpimla[1] format "x(7)"
      675        tb-cpimla[2] format "x(8)"
      676        tb-cpimla[3] format "x(9)"
      677        tb-cpimla[4] format "x(7)"
      678        tb-cpimla[5] format "x(6)"
      679        tb-cpimla[6] format "x(3)"
      680        with no-labels attr row 21 no-box overlay centered frame f-cpimla.
      681                   
      682   /* ----------------------------------------------- FRAMES PARA WINDOWS --- */                
      683   define frame f-regua-cpimla 
      684        b-arquivo    at row 1.48 col 24
      685        b-consiste   at row 1.48 col 28
      686        b-parametro  at row 1.48 col 32
      687        b-importa    at row 1.48 col 36
      688        b-layout     at row 1.48 col 40
      689        b-fim        at row 1.48 col 58
      690        b-help       at row 1.48 col 62
      691        Retangulo-1  at row 1    col 2
      692        with 1 down no-box keep-tab-order overlay centered
      693             side-labels no-underline three-d 
      694             at col 1 row 1
      695             size 80 by 3.
      696    
      697   
      698   /* include de variaveis dos display de tela dos relatorios */
      699   /* hdp/hdvarrel.i */
      700   
      701   
      702   def  var nm-cab-usuario           as char format "x(70)"                no-undo.
      703   def  var nm-prog                  as char format "x(08)"                no-undo.
      704   def  var nr-posicao               as integer                            no-undo.
      705   def  var espacos                  as char format "x(80)"                no-undo.
      706   def  var c-versao                 as char format "x(08)"                no-undo.
      707   def  var ds-inicializa-aux        as char format "x(40)"                no-undo.
      708   def  var ds-normal-ativa-aux      as char format "x(40)"                no-undo.
      709   def  var ds-normal-desat-aux      as char format "x(40)"                no-undo.
      710   def  var ds-negrit-ativa-aux      as char format "x(40)"                no-undo.
      711   def  var ds-negrit-desat-aux      as char format "x(40)"                no-undo.
      712   def  var ds-italic-ativa-aux      as char format "x(40)"                no-undo.
      713   def  var ds-italic-desat-aux      as char format "x(40)"                no-undo.
      714   def  var ds-expand-ativa-aux      as char format "x(40)"                no-undo.
      715   def  var ds-expand-desli-aux      as char format "x(40)"                no-undo.
      716   def  var ds-10cpp-ativa-aux       as char format "x(40)"                no-undo.
      717   def  var ds-10cpp-desat-aux       as char format "x(40)"                no-undo.
      718   def  var ds-15cpp-ativa-aux       as char format "x(40)"                no-undo.
      719   def  var ds-15cpp-desat-aux       as char format "x(40)"                no-undo.
      720   def  var ds-20cpp-ativa-aux       as char format "x(40)"                no-undo.
      721   def  var ds-20cpp-desat-aux       as char format "x(40)"                no-undo.
      722   def  var ds-format-folha-aux      as char format "x(40)"                no-undo.
      723   def  var ds-linha-folha-aux       as char format "x(40)"                no-undo.
      724   def  var ds-margem-aux            as char format "x(40)"                no-undo.
      725   def  var ds-primei-linha-aux      as char format "x(40)"                no-undo.
      726   def  var ds-mc-linha-ativa-aux    as char format "x(40)"                no-undo.
      727   def  var ds-mc-linha-desat-aux    as char format "x(40)"                no-undo.
      728   def  var ds-eq-margem-ativa-aux   as char format "x(40)"                no-undo.
      729   def  var ds-eq-margem-desat-aux   as char format "x(40)"                no-undo.
      730   def  var lg-ver-tela-aux          as logical initial no
      731                                        Format "Video/Arquivo"                no-undo.
      732   def  var nm-arq-tela-quo          as char format "x(24)"                no-undo.
      733   def  var ds-campo-imp-quo         as char format "x(132)"               no-undo.
      734   
      735   def  var nm-arquivo-windows-aux   as character                          no-undo.
      736   def  var nr-linhas-windows-aux    as int init 64  format "9999"         no-undo.
      737   def  var nr-pagina-windows-aux    as integer                            no-undo.
      738   def  var nr-fonte-windows-aux     as int init 1                         no-undo.
      739   def  var lg-ok-imprime-windows-aux as logical                           no-undo.
      740   def new global shared var v_cod_usuar_corren as character
      741           format "x(12)":U label "Usu rio Corrente"
      742           column-label "Usu rio Corrente"                                    no-undo.       
      743   assign espacos = fill(" ",80).
      744   
      745   DEF VAR char-aux1 AS CHAR NO-UNDO.
      746   DEF VAR char-aux2 AS CHAR NO-UNDO.
      747   DEF VAR char-aux3 AS CHAR NO-UNDO.
      748   DEF VAR char-aux4 AS CHAR NO-UNDO.
      749    
      750   nm-cab-usuario = "Importacao dos Beneficiarios" .
      751   nm-prog        = "CG/0310V".
      752   c-versao       = "7.15.001".
      753   /******************************************************************************
      754       Programa .....: hdlog.i
      755       Data .........: 01/11/2005
      756       Sistema ......:
      757       Empresa ......: DZSET SOLUCOES E SISTEMAS
      758       Cliente ......:
      759       Programador ..: NORA
      760       Objetivo .....: Rotina que gera o log de versao
      761   *-----------------------------------------------------------------------------*
      762       Versao     DATA         RESPONSAVEL
      763       7.00.000   01/11/2005   NORA
      764   ******************************************************************************/
      765   /* --- IMPLEMENTADO UMA CHAMADA A PROGRAMA POIS ESTAVA ESTOURANDO 
      766          O SEGMENTO DOS PROGRAMAS                                          --- */
      767   def new global shared var v_cod_usuar_corren as character
      768                             format "x(12)":U label "Usu rio Corrente"
      769                                           column-label "Usu rio Corrente" no-undo.       
      770   def new global shared var in-origem-chamada-menu as character format "x(12)"    
      771                                                                           no-undo.
      772   /* ----------------------------- testa se Serious 7.0 ou GESTAO DE PLANOS ---*/
      773   /* ------------- CASO FOR GESTÃO DE PLANOS RETORNA A VERSÃO DO ROUNTABLE --- */
      774   if in-origem-chamada-menu <> "TEMENU70"
      775   then assign c-versao      = c_prg_vrs. 
      776   
      777   if session:multitasking-interval = 1
      778   then do:
      779          run rtp/rthdlog.p (input c-versao,
      780                             input program-name(1)).
      781        end.
      782       
      783    
      784   /* rtp/rtparmo1.i */
      785   
      786   /* -------------------- Pesquisa os parametros MO --------------------------- */
      787   def new shared var cd-tipo-medi-aux like parammo.cd-tipo-medi-tp       no-undo.
      788   def new shared var cd-mediocupa-aux like modalid.cd-modalidade         no-undo.
      789   def new shared var cd-admis-aux     like parammo.cd-admissional-tr     no-undo.
      790   def new shared var cd-afast-aux     like parammo.cd-afastado-tr        no-undo.
      791   def new shared var cd-ativo-aux     like parammo.cd-ativo-tr           no-undo.
      792   def new shared var cd-demis-aux     like parammo.cd-demissional-tr     no-undo.
      793   def new shared var cd-desli-aux     like parammo.cd-desligado-tr       no-undo.
      794   def new shared var cd-perio-aux     like parammo.cd-periodico-tr       no-undo.
      795   def new shared var cd-rettr-aux     like parammo.cd-retorno-trabalho-tr no-undo.
      796   def new shared var cd-trofu-aux     like parammo.cd-troca-funcao-tr    no-undo.
      797   def new shared var cd-trose-aux     like parammo.cd-troca-setor-tr     no-undo.
      798   def new shared var cd-manut-aux     like parammo.cd-manutencao-pp      no-undo.
      799   def new shared var cd-proge-aux     like parammo.cd-pronto-geracao-pp  no-undo.
      800   def new shared var cd-proco-aux     like parammo.cd-pronto-copia-pp    no-undo.
      801   def new shared var cd-atipp-aux     like parammo.cd-ativo-pp           no-undo.
      802   def new shared var cd-inati-aux     like parammo.cd-inativo-pp         no-undo.
      803   def new shared var cd-norma-aux     like parammo.cd-normal-pc          no-undo.
      804   def new shared var cd-envco-aux     like parammo.cd-enviadoco-pc       no-undo.
      805   def new shared var cd-envfa-aux     like parammo.cd-enviadofa-pc       no-undo.
      806   def new shared var cd-proce-aux     like parammo.cd-processado-pc      no-undo.
      807   def new shared var nr-perio-aux     like parammo.nr-periodo-cb         no-undo.
      808   def new shared var cd-espec-aux     like parammo.cd-especialid-ep      no-undo.
      809   def new shared var cd-parpr-aux     like parammo.cd-parampron-pa       no-undo.
      810   def new shared var cd-parin-aux     like parammo.cd-paraminsp-pa       no-undo.
      811   def new shared var cd-gerad-aux     like parammo.cd-gerado-pc          no-undo.
      812   def new shared var cd-concl-aux     like parammo.cd-concluido-pc       no-undo.
      813   def new shared var cd-cobra-aux     like parammo.cd-cobrado-pc         no-undo.
      814   def new shared var cd-pagos-aux     like parammo.cd-pago-pc            no-undo.
      815   def new shared var cd-execu-aux     like parammo.cd-executado-pc       no-undo.
      816   def new shared var cd-espam-aux     like parammo.cd-esp-amb-pc         no-undo.
      817   def new shared var cd-gruam-aux     like parammo.cd-grupo-proc-amb-pc  no-undo.
      818   def new shared var cd-proam-aux     like parammo.cd-procedimento-pc    no-undo.
      819   def new shared var cd-dvamb-aux     like parammo.dv-procedimento-pc    no-undo.
      820   def new shared var cd-super-aux     like parammo.cd-supervisor-mg      no-undo.
      821   def new shared var cd-conta-aux     like parammo.cd-transacao-contas   no-undo.
      822   def new shared var cd-extra-aux     like parammo.cd-exame-extra-tr     no-undo.
      823   def new shared var cd-naoex-aux     like parammo.cd-naoexecutou-pc     no-undo.
      824   def new shared var lg-ant-exam-aux  like parammo.lg-antecipa-exames    no-undo.
      825   def new shared var lg-recalc-aux    like parammo.lg-recalcula-periodo  no-undo.
      826   
      827   find first parammo no-lock no-error.
      828   
      829   if available parammo
      830   then do:
      831           assign cd-tipo-medi-aux = parammo.cd-tipo-medi-tp
      832                  cd-admis-aux     = parammo.cd-admissional-tr
      833                  cd-afast-aux     = parammo.cd-afastado-tr
      834                  cd-ativo-aux     = parammo.cd-ativo-tr
      835                  cd-demis-aux     = parammo.cd-demissional-tr
      836                  cd-desli-aux     = parammo.cd-desligado-tr
      837                  cd-perio-aux     = parammo.cd-periodico-tr
      838                  cd-rettr-aux     = parammo.cd-retorno-trabalho-tr
      839                  cd-trofu-aux     = parammo.cd-troca-funcao-tr
      840                  cd-trose-aux     = parammo.cd-troca-setor-tr
      841                  cd-manut-aux     = parammo.cd-manutencao-pp
      842                  cd-proge-aux     = parammo.cd-pronto-geracao-pp
      843                  cd-proco-aux     = parammo.cd-pronto-copia-pp
      844                  cd-atipp-aux     = parammo.cd-ativo-pp
      845                  cd-inati-aux     = parammo.cd-inativo-pp
      846                  cd-norma-aux     = parammo.cd-normal-pc
      847                  nr-perio-aux     = parammo.nr-periodo-cb
      848                  cd-espec-aux     = parammo.cd-especialid-ep
      849                  cd-parpr-aux     = parammo.cd-parampron-pa
      850                  cd-parin-aux     = parammo.cd-paraminsp-pa
      851                  cd-gerad-aux     = parammo.cd-gerado-pc
      852                  cd-concl-aux     = parammo.cd-concluido-pc
      853                  cd-cobra-aux     = parammo.cd-cobrado-pc
      854                  cd-pagos-aux     = parammo.cd-pago-pc
      855                  cd-execu-aux     = parammo.cd-executado-pc
      856                  cd-espam-aux     = parammo.cd-esp-amb-pc
      857                  cd-gruam-aux     = parammo.cd-grupo-proc-amb-pc
      858                  cd-proam-aux     = parammo.cd-procedimento-pc
      859                  cd-dvamb-aux     = parammo.dv-procedimento-pc
      860                  cd-envco-aux     = parammo.cd-enviadoco-pc
      861                  cd-envfa-aux     = parammo.cd-enviadofa-pc
      862                  cd-proce-aux     = parammo.cd-processado-pc
      863                  cd-super-aux     = parammo.cd-supervisor-mg
      864                  cd-conta-aux     = parammo.cd-transacao-contas
      865                  cd-extra-aux     = parammo.cd-exame-extra-tr
      866                  cd-naoex-aux     = parammo.cd-naoexecutou-pc
      867                  lg-ant-exam-aux  = parammo.lg-antecipa-exames
      868                  lg-recalc-aux    = parammo.lg-recalcula-periodo.
      869        end.
      870   
      871    
      872   
      873                 
      874   /********************* Definicao Variaveis de Importacao *********************/
      875   def new shared stream s-relat-erro.
      876    
      877   def new shared var lg-plano-aux          as logical                     no-undo.
      878   def new shared var lg-medocup-aux        as logical                     no-undo.
      879   def new shared var cd-empresa            like  contrat.cd-contratante   no-undo.
      880   def new shared var lg-relat-erro         as logi                        no-undo.
      881   def new shared var lg-relat-erro-aux     as logi initial no             no-undo.
      882   def new shared var nr-proposta-imp-aux   like propost.nr-proposta       no-undo.
      883   def new shared var r-propost             as recid                       no-undo.
      884   def new shared var lg-modulo-erro        as log initial no              no-undo.
      885   def new shared var lg-medocup-erro       as log initial no              no-undo.
      886   def            var lg-repasse-erro       as log                         no-undo.
      887   
      888   def var nr-proposta-aux        like usuario.nr-proposta      no-undo.
      889   def var cd-titular-aux         like usuario.cd-titular       no-undo.
      890   def var nr-idade-aux           as int                        no-undo.
      891   
      892   /* -------------------- variaveis p/ consistencia ----------------------------*/
      893   def var nr-carte-antiga                 as char format "x(13)"          no-undo.
      894   def var nr-cont-antigo                  as char format "x(15)"          no-undo.
      895   def var ix                              as int     format "99"          no-undo.
      896   def var lg-consist                      as logical initial no           no-undo.
      897   def var lg-consist-aux                  as logical initial no           no-undo.
      898   def var lg-formato-livre-aux            as log                          no-undo.
      899   def var ix-cont-aux                     as int                          no-undo.
      900   DEF VAR cont-aux                        AS INT                          NO-UNDO.
      901   /*def var cd-cpf-aux                      like usuario.cd-cpf             no-undo.*/
      902   /*def var nr-cgc-cpf-aux                  like contrat.nr-cgc-cpf         no-undo.*/
      903   def var lg-inf-cpf-pis-cartaonac-aux    like paravpmc.lg-inf-cpf-pis-cartaonac 
      904                                                                           no-undo.
      905   def var lg-inf-mae-aux                  like paravpmc.lg-inf-mae        no-undo.       
      906   def var cd-mot-incl-aux                 as char                         no-undo. /* Utilizada na procedure consiste-nr-prod-origem */
      907   def var nr-prod-or-aux                  as int                          no-undo. /* Utilizada na procedure consiste-nr-prod-origem */
      908   def var nm-diretorio-aux                as char                         no-undo.
      909   def var ds-barra                        as char format "x(1)"           no-undo.
      910   def var cd-tam-aux                      as int                          no-undo.  
      911   def var ds-cpo-aux                      as char format "x(1226)"        no-undo.  
      912   def var lg-imp-erro                     as log initial no               no-undo.
      913   DEF VAR qtd-reg-rest                    AS INT                          NO-UNDO.
      914   def var nome-abrev-usu                  as char format "x(40)"          no-undo.
      915   def var nome-abrev2-usu                 as char format "x(40)"          no-undo.
      916   def var nome-usuario-aux                like usuario.nm-usuario         no-undo.
      917   def var nome-usuario2-aux               like usuario.nm-usuario         no-undo.
      918   def var cartao-aux                      like usuario.nm-usuario-cartao  no-undo.
      919   def var nome-cartao-usu                 as char format "x(28)"          no-undo.
      920   def var lg-undo-retry                   as log init no                  no-undo.
      921   def var ds-mensagem-aux                 as char format "x(80)"          no-undo.
      922   def var ds-movto-aux                    as char format "x(14)"          no-undo.
      923   def var lg-critica                      as logi                         no-undo.
      924   def var ds-mascara-aux                  like propost.ds-mascara         no-undo.  
      925   def var nr-digito-aux                   as int                          no-undo.
      926   DEF VAR lg-insc-fat-aux                 as log                          no-undo.
      927   def var dt-fim-aux                      as date                         no-undo. 
      928   def var lg-mensagem                     as log initial no               no-undo.
      929   def var cd-tipo-mens                    as char format "x(01)"          no-undo.                     
      930   def var ds-tipo-mens                    as char format "x(90)"          no-undo.
      931   def var lg-retorna                      as log initial no               no-undo.
      932   def var cd-cidade-aux                   like usuario.cd-cidade          no-undo.
      933   def var lg-erro-reajus1-aux             as log                          no-undo.
      934   def var ds-mensagem-reajus1-aux         as char                         no-undo.
      935   def var nr-ident-compl-aux              as int                          no-undo.
      936   def var cd-tab-preco-aux                as char format "x(5)"           no-undo.
      937   def var nro-seq-aux                     as int initial 0                no-undo.
      938   
      939   /*----------- VARIAVEIS PARA SELECTIO-LIST DO IN-SEGMENTO-ASSISTENCIAL ------*/
      940   def            var lista-segmento-posicao-aux    as char                no-undo.
      941                               
      942   assign lista-segmento-posicao-aux = "01,02,03,04,05,06,07,08,10,11,13,14".
      943   
      944   /*---------------------------------------------------------------------------*/
      945   def new shared var lg-registro-modulos         as log init no  format "Sim/Nao"
      946                                                                          no-undo.
      947   def new shared var lg-registro-repasse         as log init no  format "Sim/Nao"
      948                                                                          no-undo.
      949   def new shared var  lg-gerar-termo-aux         as log                  no-undo.
      950   def new shared var  lg-carteira-antig-aux      as log                  no-undo.
      951   
      952   
      953   def var lg-registro-repasse-aux      as log                            no-undo.
      954   def var lg-parametro                 as log initial no                 no-undo.
      955   /*---------------------------------------------------------------------------*/
      956   def            var nr-idade-usuario    as int                           no-undo.
      957   def            var lg-erro-aux         as log                           no-undo.
      958   def            var lg-achou            as log                           no-undo.
      959   def            var nr-faixa-etaria-aux as int                           no-undo.
      960   def            var nr-insc-contrat-ant like propost.nr-insc-contratante no-undo.
      961   def            var cd-modalidade-ant   like modalid.cd-modalidade       no-undo.
      962   def            var nr-proposta-ant     like usuario.nr-proposta         no-undo.
      963   def            var nm-usuario-ant      like usuario.nm-usuario          no-undo.
      964   def            var dt-nascimento-ant   like usuario.dt-nascimento       no-undo.
      965   def            var cd-grau-parent-ant  like usuario.cd-grau-parentesco  no-undo.
      966   def            var dt-excl-plano-ant   like usuario.dt-exclusao-plano   no-undo.
      967   def            var dt-incl-plano-ant   like usuario.dt-inclusao-plano   no-undo.
      968   def            var ct-grava            as int                           no-undo.
      969   DEF            VAR lg-validar-cpf-aux  AS LOG                           NO-UNDO.
      970   
      971   /*DEF VAR h-handle-aux AS HANDLE NO-UNDO.
      972   RUN cgp/cg0311v.p PERSISTENT SET h-handle-aux.
      973   */
      974   DEF VAR h-cg0311v-aux AS HANDLE NO-UNDO.
      975   
      976   /* --- DECLARACAO DE VARIAVEIS UTILIZADAS POR HDRUNPERSIS E HDDELPERSIS --- */
      977   
      978   def var h-handle-aux              as handle no-undo.
      979   def var h-handle2-aux             as handle no-undo.
      980   
      981   def new shared var id-requisicao-handle-aux as char init "" no-undo.
      982   
      983   def new global shared var v_cod_usuar_corren as char no-undo.
      984    
      985   *** Encrypted Source ***
      986   *** Encrypted Source ***
      987   *** Encrypted Source ***
      988   *** Encrypted Source ***
      989   *** Encrypted Source ***
      990   *** Encrypted Source ***
      991   *** Encrypted Source ***
      992   *** Encrypted Source ***
      993   *** Encrypted Source ***
      994   *** Encrypted Source ***
      995   *** Encrypted Source ***
      996   *** Encrypted Source ***
      997   *** Encrypted Source ***
      998   *** Encrypted Source ***
      999   *** Encrypted Source ***
     1000   *** Encrypted Source ***
     1001   *** Encrypted Source ***
     1002   *** Encrypted Source ***
     1003   *** Encrypted Source ***
     1004   *** Encrypted Source ***
     1005   *** Encrypted Source ***
     1006   *** Encrypted Source ***
     1007   *** Encrypted Source ***
     1008   *** Encrypted Source ***
     1009   *** Encrypted Source ***
     1010   *** Encrypted Source ***
     1011   *** Encrypted Source ***
     1012   *** Encrypted Source ***
     1013   *** Encrypted Source ***
     1014   *** Encrypted Source ***
     1015   *** Encrypted Source ***
     1016   *** Encrypted Source ***
     1017   *** Encrypted Source ***
     1018   *** Encrypted Source ***
     1019   *** Encrypted Source ***
     1020   *** Encrypted Source ***
     1021   *** Encrypted Source ***
     1022   *** Encrypted Source ***
     1023   *** Encrypted Source ***
     1024   *** Encrypted Source ***
     1025   *** Encrypted Source ***
     1026   *** Encrypted Source ***
     1027   *** Encrypted Source ***
     1028   *** Encrypted Source ***
     1029   *** Encrypted Source ***
     1030   *** Encrypted Source ***
     1031   *** Encrypted Source ***
     1032   *** Encrypted Source ***
     1033   *** Encrypted Source ***
     1034   *** Encrypted Source ***
     1035   *** Encrypted Source ***
     1036   *** Encrypted Source ***
     1037   *** Encrypted Source ***
     1038   *** Encrypted Source ***
     1039   *** Encrypted Source ***
     1040   *** Encrypted Source ***
     1041   *** Encrypted Source ***
     1042   *** Encrypted Source ***
     1043   *** Encrypted Source ***
     1044   *** Encrypted Source ***
     1045   *** Encrypted Source ***
     1046   *** Encrypted Source ***
     1047   *** Encrypted Source ***
     1048   *** Encrypted Source ***
     1049   *** Encrypted Source ***
     1050   *** Encrypted Source ***
     1051   *** Encrypted Source ***
     1052   *** Encrypted Source ***
     1053   *** Encrypted Source ***
     1054   *** Encrypted Source ***
     1055   *** Encrypted Source ***
     1056   *** Encrypted Source ***
     1057   *** Encrypted Source ***
     1058   *** Encrypted Source ***
     1059   *** Encrypted Source ***
     1060   *** Encrypted Source ***
     1061   *** Encrypted Source ***
     1062   *** Encrypted Source ***
     1063   *** Encrypted Source ***
     1064   *** Encrypted Source ***
     1065   *** Encrypted Source ***
     1066   *** Encrypted Source ***
     1067   *** Encrypted Source ***
     1068   *** Encrypted Source ***
     1069   *** Encrypted Source ***
     1070   *** Encrypted Source ***
     1071   *** Encrypted Source ***
     1072   *** Encrypted Source ***
     1073   *** Encrypted Source ***
     1074   *** Encrypted Source ***
     1075   *** Encrypted Source ***
     1076   *** Encrypted Source ***
     1077   *** Encrypted Source ***
     1078   *** Encrypted Source ***
     1079   *** Encrypted Source ***
     1080   *** Encrypted Source ***
     1081   *** Encrypted Source ***
     1082   *** Encrypted Source ***
     1083   *** Encrypted Source ***
     1084   *** Encrypted Source ***
     1085   *** Encrypted Source ***
     1086   *** Encrypted Source ***
     1087   *** Encrypted Source ***
     1088   *** Encrypted Source ***
     1089   *** Encrypted Source ***
     1090    
     1091   
     1092   def new shared var lg-erro                  as logi                     no-undo.
     1093   
     1094   /* ------------------- CHAMADA DE INCLUDE DA ROTINA CONSISTENCIA ENDERECO --- */
     1095   /******************************************************************************
     1096   *      Programa .....: rtendere.i                                             *
     1097   *      Data .........: 11 de novembro 2003                                    *
     1098   *      Sistema ......: RT - ROTINAS PADRAO                                    *
     1099   *      Empresa ......: DZSET Solucoes e Sistemas                              *
     1100   *      Programador ..: Rafael F. Ceron                                        *
     1101   *      Objetivo .....: Definicao de variaveis compartilhadas entre o programa *
     1102   *                      chamador e a rotina rtendere.p                         *
     1103   ******************************************************************************/
     1104   def new shared temp-table tmp-mensa-rtendere                                  no-undo
     1105       field cd-mensagem-mens                   like mensiste.cd-mensagem
     1106       field ds-mensagem-mens                   like mensiste.ds-mensagem-sistema
     1107       field ds-complemento-mens                like mensiste.ds-mensagem-sistema
     1108       field in-tipo-mensagem-mens              like mensiste.in-tipo-mensagem
     1109       field ds-chave-mens                      like mensiste.ds-mensagem-sistema.
     1110   /* ------------------------------ VARIAVEIS COMPARTILHADAS NA API ----------- */
     1111   
     1112   def new shared var lg-erro-rtendere-aux             as log                     no-undo.
     1113   def new shared var lg-prim-mens-rtendere-aux        as log                     no-undo.
     1114   
     1115   /* ------------------------------ VARIAVEIS INTERNAS DA API ----------------- */
     1116   
     1117   def new shared var in-modulo-sistema-rtendere-aux   as char format "x(2)"      no-undo.
     1118   def new shared var in-tipo-rtendere-aux             as char format "x(1)"      no-undo.
     1119   /* in-tipo-rtendere-aux = B (beneficiario) , C (contratante) , P (prestador)*/
     1120   def new shared var in-tipo-tela-rtendere-aux        as log                     no-undo.
     1121   /*Sim p/ tela || No p/ relatorio*/
     1122   
     1123   def new shared var proposta-rowid                   as rowid                   no-undo.
     1124   
     1125   def new shared var in-tp-rtendere-aux               like parapess.in-tipo-pessoa no-undo.
     1126   
     1127   def new shared var cd-cidade-rtendere-aux           like dzcidade.cd-cidade    no-undo.
     1128   def new shared var nm-cidade-rtendere-aux           like dzcidade.nm-cidade    no-undo.
     1129   
     1130   
     1131   def new shared var en-uf-rtendere-aux               like usuario.en-uf         no-undo.
     1132   def new shared var en-cep-rtendere-aux              like usuario.en-cep        no-undo. 
     1133   def new shared var en-rua-rtendere-aux              like usuario.en-rua        no-undo.
     1134   def new shared var en-bairro-retendere-aux          like usuario.en-bairro     no-undo.
     1135   
     1136   /* ------------------------------------------------------------------------- */
     1137   
     1138   
     1139   /* ------------------------------------- DEFINICAO DE INCLUDES DAS API'S --- */
     1140   /******************************************************************************
     1141   *      Programa .....: rtapi041.i                                             *
     1142   *      Data .........: 12 de Junho de 2000                                    *
     1143   *      Sistema ......: RT - ROTINAS PADRAO                                    *
     1144   *      Empresa ......: DZSET Solucoes e Sistemas                              *
     1145   *      Programador ..: Leonardo Deimomi                                       *
     1146   *      Objetivo .....: Definicao de variaveis compartilhadas entre o programa *
     1147   *                      chamador e a API rtapi041.p                            *
     1148   *-----------------------------------------------------------------------------*
     1149   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                            *
     1150   *      D.00.000  12/06/2000  Leonardo       Desenvolvimento                   *
     1151   *      E.00.000  25/10/2000  Nora            Mudanca Versao Banco             *
     1152   *      E.00.001  29/01/2001  Jaque          Passar parametros para testar se  *
     1153   *                                           o responsavel esta excluido deixar*
     1154   *                                           incluir o dependente excluido para*
     1155   *                                           beneficiarios incluidos via progra*
     1156   *                                           mas de migracao apenas(Modulo CG).*
     1157   ******************************************************************************/
     1158   
     1159   /* ------------------ DEFINICAO DA TABELA TEMPORARIA DE MENSAGENS PADRAO --- */
     1160   def new shared temp-table tmp-mensa-rtapi041                                  no-undo
     1161       field cd-mensagem-mens                   like mensiste.cd-mensagem
     1162       field ds-mensagem-mens                   like mensiste.ds-mensagem-sistema
     1163       field ds-complemento-mens                like mensiste.ds-mensagem-sistema
     1164       field in-tipo-mensagem-mens              like mensiste.in-tipo-mensagem
     1165       field ds-chave-mens                      like mensiste.ds-mensagem-sistema.
     1166   
     1167   /* ------------------------ DEFINICAO DE VARIAVEIS COMPARTILHADAS NA API --- */
     1168   def new shared var in-funcao-rtapi041-aux           as char format "x(03)"     no-undo.
     1169   def new shared var lg-prim-mens-rtapi041-aux        as log                     no-undo.
     1170   def new shared var lg-erro-rtapi041-aux             as log                     no-undo.
     1171   
     1172   /* ------------------------------ DEFINICAO DE VARIAVEIS INTERNAS DA API --- */
     1173   def new shared var in-funcao-chamadora-rtapi041-aux as char format "x(03)"     no-undo.
     1174   def new shared var lg-simula-chamadora-rtapi041-aux as log                     no-undo.
     1175   def new shared var cd-modalidade-rtapi041-aux       like usuario.cd-modalidade no-undo.
     1176   def new shared var nr-proposta-rtapi041-aux         like usuario.nr-proposta   no-undo.
     1177   def new shared var cd-usuario-rtapi041-aux          like usuario.cd-usuario    no-undo.
     1178   def new shared var cd-titular-rtapi041-aux          like usuario.cd-titular    no-undo.
     1179   def new shared var lg-sexo-rtapi041-aux             like usuario.lg-sexo       no-undo.
     1180   def new shared var cd-grau-parentesco-rtapi041-aux  like usuario.cd-grau-parentesco
     1181                                                                           no-undo.
     1182   def new shared var dt-nascimento-rtapi041-aux       like usuario.dt-nascimento no-undo.
     1183   def new shared var dt-inclusao-plano-rtapi041-aux   like usuario.dt-inclusao-plano
     1184                                                                           no-undo.
     1185   def new shared var lg-importacao-rtapi041-aux       as log                     no-undo.
     1186   def new shared var in-modulo-sistema-rtapi041-aux   as char format "x(2)"      no-undo.
     1187   def new shared var dt-exclusao-plano-rtapi041-aux   like usuario.dt-exclusao-plano
     1188                                                                           no-undo. 
     1189   def new shared var lg-responsavel-rtapi041-aux      as log                     no-undo.
     1190   def new shared var lg-altera-sexo-conj-rtapi041-aux as log  initial no         no-undo.
     1191   
     1192   
     1193   /************************************************************************************************
     1194   *      Programa .....: srrepres.iv                                                              *
     1195   *      Data .........: 08 de Junho de 2001.                                                     *
     1196   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                                          *
     1197   *      Sistema ......: SRINCL - INCLUDES PARA CONVERSAO DE SISTEMAS                             *
     1198   *      Cliente ......: COOPERATIVAS MEDICAS                                                     *
     1199   *      Programador ..: Leonardo Deimomi                                                         *
     1200   *      Objetivo .....: Definicao de variaveis do include srrepres.i                             *
     1201   *-----------------------------------------------------------------------------------------------*
     1202   *      VERSAO    DATA        RESPONSAVEL     MOTIVO                                             *
     1203   *      E.00.000  08/06/2001  Leonardo        Desenvolvimento                                    *
     1204   ************************************************************************************************/
     1205   
     1206   def var lg-avail-srrepres        as log                      no-undo.
     1207   def var nm-representante-srems   like contrat.nm-contratante no-undo.
     1208   def var ds-natureza-repres-srems as char format "x(1)"       no-undo.
     1209   def var nr-cpf-cgc-repres-srems  like contrat.nr-cgc-cpf     no-undo.
     1210   
     1211   /* ------------------------------------------------------------------------------------------- */
     1212   
     1213   
     1214   def new shared var nm-arquivo-importar  as char format "x(35)"
     1215           label   "Nome do Arquivo a Importar "
     1216           initial "imp/BENEFIC.TXT".
     1217   
     1218   DEF NEW SHARED TEMP-TABLE tt-erro NO-UNDO
     1219       FIELD nr-seq            AS INT
     1220       FIELD nr-seq-contr      LIKE erro-process-import.num-seqcial-control 
     1221       FIELD nom-tab-orig-erro AS CHAR
     1222       FIELD des-erro          AS CHAR
     1223       INDEX nr-seq       
     1224             nr-seq-contr.
     1225   
     1226   DEF NEW SHARED TEMP-TABLE tt-import-bnfciar NO-UNDO
     1227       FIELD rowid-import-bnfciar AS ROWID
     1228       FIELD nome-usuario         like usuario.nm-usuario 
     1229       field nome-abrev-usu       as char format "x(40)"           
     1230       field nome-usuario-aux     like usuario.nm-usuario          
     1231       field cartao-aux           like usuario.nm-usuario-cartao   
     1232       field nome-cartao-usu      as char format "x(28)"
     1233       FIELD lg-insc-fat          as LOG
     1234       FIELD cd-cidade            like usuario.cd-cidade
     1235       FIELD nr-idade-usuario     AS INT
     1236       FIELD nr-faixa-etaria      AS INT
     1237       INDEX id rowid-import-bnfciar.
     1238   
     1239   /*-------------------------------------------------------------------------*/
     1240   def var ds-cabecalho                 as char format "x(30)"             no-undo.
     1241   def var ds-rodape                    as char format "x(80)"  init ""    no-undo.
     1242    
     1243   def var nm-arquivo-mag               as char format "x(30)"             no-undo.
     1244   
     1245   def buffer b-import-bnfciar for import-bnfciar.
     1246   DEF BUFFER b-usuario        FOR usuario.
     1247   DEF BUFFER b-tt-erro        FOR tt-erro.
     1248    
     1249   /*----------------------------------------------------------------------------*/
     1250   
     1251   /**
     1252    * Quando qt-sair-aux tiver valor diferente de zero, processara registros ate
     1253    * atingir esse numero e saira do programa.
     1254    * Usar essa opcao quando o chamador for um laco encadeado com os outros processos
     1255    * de migracao, para dividir o processamento.
     1256    */
     1257   DEF            VAR qt-sair-aux      AS INT INIT 0 NO-UNDO.
     1258   DEF NEW SHARED VAR qt-cont-sair-aux AS INT INIT 0 NO-UNDO.
     1259   
     1260   def new shared var in-classif       as int  init 1                     no-undo.
     1261   def var tb-classif                  as char extent 3 initial
     1262      ["1 - Obriga", "2 - Opcional", "3 - Ambos"]                         no-undo.
     1263   
     1264   def var nm-arquivo-erros     as char format "x(35)"
     1265           label   "Nome do Arquivo de Erros   ".
     1266           
     1267   def var nm-arquivo-inconsist  as char format "x(35)"
     1268           label   "Nome Arq. de inconsistencia".
     1269    
     1270   form tb-classif[1] format "x(12)"
     1271        tb-classif[2] format "x(12)"
     1272        tb-classif[3] format "x(12)"
     1273        with no-labels 1 column column 38 no-attr row 16 overlay frame f-classif      
     1274        title " Opcao ".
     1275   
     1276   form header
     1277        fill("-", 132) format "x(132)"                           skip
     1278        ds-cabecalho
     1279        "Inconsistencias Importacao do Beneficiario"             at 47
     1280        "Folha:"                                                 at 122
     1281        page-number(s-relat-erro)                                at 128
     1282        format ">>>9" skip
     1283        fill("-", 112) format "x(112)"
     1284        today "-" string(time, "HH:MM:SS")
     1285        skip(1)
     1286        with no-labels stream-io no-box page-top width 132 frame f-cabeca-erro.
     1287    
     1288   form tt-erro.nr-seq-contr                      column-label "Nro.Seq.Controle"         
     1289        tt-erro.nom-tab-orig-erro  format "x(30)" column-label "Tab.Origem Erro"
     1290        tt-erro.des-erro           format "x(80)" column-label "DescriÆo Erro"           
     1291        with width 132 down no-box attr-space frame f-erro stream-io. 
     1292   
     1293   def rectangle f-consis 
     1294       edge-pixels 3 graphic-edge no-fill size 67 by 3.
     1295   
     1296   form skip(1)
     1297        space(02)
     1298        nm-arquivo-inconsist  view-as fill-in size 36 by 1.3 native
     1299        validate(nm-arquivo-inconsist <> "", "Nao pode ser espacos")
     1300        f-consis at row 1.3 col 1.7
     1301        with three-d row 14 column 8 side-labels attr-space overlay frame f-consist size 69 by 4.
     1302           
     1303   def rectangle f-arq-mag
     1304       edge-pixels 3 graphic-edge no-fill size 67 by 3.
     1305   
     1306   form skip(1.3)
     1307        nm-arquivo-erros    view-as fill-in size 36 by 1.3 native label   "   Nome do Arquivo de Erros" at 03
     1308           validate(nm-arquivo-erros <> "", "Nao pode ser espacos")
     1309        f-arq-mag at row 1.45 col 2
     1310        with three-d row 14 column 8 side-labels attr-space overlay frame f-arquivo-mag size 69 by 4.
     1311   
     1312   def rectangle f-param
     1313       edge-pixels 3 graphic-edge no-fill size 35 by 4.5.
     1314   
     1315   form skip(1.3)
     1316        lg-registro-modulos view-as fill-in size 5 by 1.3 native label "Modulos do Beneficiario" at 05    
     1317        lg-registro-repasse view-as fill-in size 5 by 1.3 native label "Repasse do Beneficiario" at 04.8     
     1318        f-param at row 1.3 col 1.7
     1319        with three-d row 14 column 8 side-labels overlay frame f-parametro size 37 by 6.5
     1320        title " Parametros da Importacao ".
     1321   
     1322   form header ds-rodape format "x(132)"
     1323        with no-labels stream-io no-box width 132 page-bottom frame f-rodape. 
     1324   
     1325   /*----------------------------------------------------------------------------*/
     1326   find first paramecp no-lock no-error.
     1327   if   available paramecp
     1328   then do:
     1329          find unimed where unimed.cd-unimed = paramecp.cd-unimed
     1330               no-lock no-error.
     1331          if   available unimed
     1332          then assign ds-cabecalho = unimed.nm-unimed-reduz.
     1333        end.
     1334   else do:
     1335          message "Parametros gerais do sistema nao cadastrados."
     1336                  view-as alert-box title " Atencao !!! ".
     1337          return.
     1338        end.
     1339    
     1340   find first paravpmc no-lock no-error.
     1341   if   not avail paravpmc
     1342   then do:
     1343          message "Parametros dos modulos VP e MC nao localizados."
     1344                  view-as alert-box title " Atencao !!! ".
     1345          return.
     1346        end.
     1347   
     1348   IF can-find(first param-movimen-bnfciar
     1349               WHERE param-movimen-bnfciar.log-cpf-invldo = NO)
     1350   THEN ASSIGN lg-validar-cpf-aux = YES.
     1351   ELSE ASSIGN lg-validar-cpf-aux = NO.
     1352   
     1353   
     1354   /* ---------------------------------------------------------------------------------------- */
     1355   run rtp/rtspool.p(input-output nm-diretorio-aux).
     1356   
     1357   assign ds-barra = substring(nm-diretorio-aux,(length(nm-diretorio-aux)),1).
     1358   
     1359   if    ds-barra <> "/"
     1360   then  nm-diretorio-aux = nm-diretorio-aux + "/".
     1361   
     1362   assign nm-arquivo-erros     = nm-diretorio-aux + "ERROS-B.LST" 
     1363          nm-arquivo-inconsist = nm-diretorio-aux + "inconsist.lst".
     1364    
     1365   /*******************************************************************************
     1366   ** hdvararq.i - definicao de variaveis e form para abrir a saida
     1367   ** {1}      - diretorio do arquivo
     1368   ** {2}      - Nome do arquivo
     1369   ** {3}      - extensao do arquivo
     1370   ** {4}      - tipo da variavel
     1371   ** {5}      - possui relatorio de erro? "1" = possui.
     1372   *******************************************************************************/
     1373   
     1374   def  var l-saida       as logical format "Impressora/Arquivo" init yes.
     1375   def  var nm-diretorio  as char format "x(30)"
     1376                             label "Nome do diretorio"  initial "spool/"     no-undo.
     1377   def  var nm-arquivo    as char format "x(20)"
     1378                             label "     Nome arquivo"  initial "BENEFIC"     no-undo.
     1379   def  var nm-extensao   as char format "x(03)"
     1380                             label "         Extensao" initial "LST"      no-undo.
     1381   def  var nm-diretorio-old   as char  format "x(30)"                 no-undo.
     1382   def  var nm-arquivo-old     as char  format "x(20)"                 no-undo.
     1383   def  var nm-extensao-old    as char  format "x(03)"                 no-undo.
     1384   def  var c-saida       as character format "x(30)"                  no-undo.
     1385   def  var c-arquivo1    as character                                 no-undo.
     1386   def  var c-arquivo2    as character                                 no-undo.
     1387   def  var c-arquivo     as character extent 2 initial
     1388                     [ "", "" ]                                           no-undo.
     1389   def  var nr-contador-aux   as int format  "9" initial 1             no-undo.
     1390   def  var nr-contador-fim   as int format "9" initial 1              no-undo.
     1391   def  var ds-titulo-imp     as char format "x(20)" initial "Saida"   no-undo.
     1392   def  var c-nome-imp    as character format "x(12)"
     1393                             label "Nome da Impressora" init "default".
     1394   def  var l-xxxtmp      as logical                                   no-undo.
     1395   def  var c-yyytmp      as character                                 no-undo.
     1396   def  var l-resp        as log   no-undo format "S/N".
     1397   def  var l-letra       as char  format "x(01)"                      no-undo.
     1398   def var nm-programa-hdvararq-aux as char no-undo.
     1399   def var ds-param-hdpedarq-aux as char no-undo.
     1400   /*---------------------------------------------------------------------------*/
     1401   
     1402   define temp-table disp-tela
     1403          field ds-linha1 as char format "x(77)"
     1404          field ds-linha2 as char format "x(77)".
     1405   
     1406   
     1407   define query zoom-tela for disp-tela scrolling.
     1408   define browse browse-disp-tela query zoom-tela no-lock
     1409   display disp-tela.ds-linha1 no-label
     1410           disp-tela.ds-linha2 no-label
     1411           with 2 down size 77 by 17.
     1412   
     1413   define frame f-disp-tela
     1414          browse-disp-tela at row 01 col 02
     1415          "F1-Sair"        at row 18 col 02
     1416          "-> p/Direita"   at row 18 col 16
     1417          "<- p/Esquerda"  at row 18 col 35
     1418          with row 03 column 01 size 80 by 21 overlay view-as dialog-box three-d
     1419               title " RELATORIO EM VIDEO ".
     1420   
     1421   if in-batch-online-par = "online"
     1422   then do:
     1423          on help, end-error of browse-disp-tela in frame f-disp-tela
     1424          do:
     1425            return no-apply.
     1426          end.
     1427          
     1428          on go of browse-disp-tela in frame f-disp-tela
     1429          do:
     1430            close query zoom-tela.
     1431            hide frame f-disp-tela.
     1432          end.
     1433        end.
     1434   
     1435    def  var in-saida as int init 1 view-as radio-set vertical
     1436                 radio-buttons "Impressora Windows", 1,
     1437                               "Impressora Sistema", 2,
     1438                               "Arquivo", 3
     1439                               size 22.5 by 3.67 no-undo.
     1440   
     1441   .
     1442   
     1443   define  variable in-tela as integer 
     1444        view-as radio-set vertical
     1445        radio-buttons 
     1446        "Arquivo", 1,
     1447        "Video", 2 
     1448        size 12.5 by 2.67 no-undo.
     1449   
     1450       
     1451   
     1452   
     1453   
     1454   assign nm-programa-hdvararq-aux = program-name(1).
     1455   
     1456   
     1457   /* define impressora de acordo com o usuario ativo e o nome do programa */
     1458   
     1459   assign c-yyytmp = substr(program-name(1), r-index(program-name(1), "/") + 1)
     1460          c-yyytmp = substr(c-yyytmp, 1, length(c-yyytmp) - 2).
     1461   
     1462   find dzuseimp where dzuseimp.nm-usuario-sistema = v_cod_usuar_corren
     1463                   and dzuseimp.nm-programa = c-yyytmp
     1464                       no-lock no-error.
     1465   
     1466   if not available dzuseimp
     1467   then find dzuseimp where dzuseimp.nm-usuario-sistema = v_cod_usuar_corren
     1468                        and dzuseimp.nm-programa = "*"
     1469                            no-lock no-error.
     1470   
     1471   if available dzuseimp
     1472   then assign c-nome-imp = dzuseimp.nm-impressora.
     1473   
     1474   if "" = "1"
     1475   then nr-contador-fim = 2.
     1476   else nr-contador-fim = 1.
     1477   
     1478   assign nm-diretorio-old = nm-diretorio
     1479          nm-arquivo-old   = nm-arquivo
     1480          nm-extensao-old  = nm-extensao.
     1481    
     1482    
     1483   assign ds-rodape  = " " + replace(nm-prog,"/","") + " - " + c-versao
     1484          ds-rodape  = FILL("-", 132 - LENGTH(ds-rodape)) + ds-rodape
     1485    
     1486          nm-arquivo-mag = "imp/BENEFIC.TXT".
     1487    
     1488   /* ----------------------- INICIALIZACAO ------------------------------------ */
     1489   /*****************************************************************************
     1490   *      Programa .....: hdtitrel.i                                            *
     1491   *      Data .........: 20 de Janeiro de 1997                                 *
     1492   *      Autor ........: DZSET SOLUCOES E SISTEMAS LTDA.                       *
     1493   *      Sistema ......: RT - Rotinas do Sistema                               *
     1494   *      Programador ..: Nora                                                  *
     1495   *      Objetivo .....: Titulos dos Relatorio dos programas DZSET             *
     1496   ******************************************************************************
     1497   *      VERSAO    DATA        RESPONSAVEL    MOTIVO                           *
     1498   *****************************************************************************/
     1499   def var nm-time  as char no-undo.
     1500   def var dt-today as date no-undo.
     1501   def var nm-traco as char initial "-" no-undo.
     1502   def var ds-linha2 as char format "x(75)" no-undo.
     1503   def var ds-linha2-aux as char format "x(75)" no-undo.
     1504   def var nm-cab-usu-rela as char format "x(75)" no-undo.
     1505   def image in-fundo file "igp/logodzre".
     1506   def rectangle r-relatorio-padrao 
     1507         edge-pixels 3 graphic-edge no-fill size 78 by 17.
     1508   def rectangle r-retangulo-imagem 
     1509         edge-pixels 5 graphic-edge no-fill size 55.1 by 9.2.
     1510   
     1511   if "" <> ""
     1512   then do:
     1513        find first cmovdata where
     1514                   cmovdata.in-entidade = ""
     1515               and cmovdata.dt-inicio-excessao <= today
     1516               and cmovdata.dt-fim-excessao    >= today
     1517                   no-lock no-error.
     1518        if avail cmovdata
     1519        then do:
     1520             message "Movimentacao nao pode ser executada entre as datas de"
     1521                     skip
     1522                     string(cmovdata.dt-inicio-excessao,"99/99/9999")
     1523                     " ate " string(cmovdata.dt-fim-excessao,"99/99/9999")
     1524             view-as alert-box title " Atencao !!! ".
     1525             return.
     1526             end.
     1527        end.
     1528   
     1529   .
     1530   
     1531   if in-batch-online-par = "online"
     1532   then do:
     1533          define frame windows-rela
     1534            r-relatorio-padrao at row 1 col 1
     1535            r-retangulo-imagem at row 2.5 col 12
     1536            nm-cab-usu-rela view-as fill-in size 70 by 1.3 native at row 14 column 5 
     1537            ds-linha2 view-as fill-in size 76 by 1.3 native at row 16 column 2 
     1538            in-fundo at row 3 col 13
     1539            with centered row 4 no-labels no-box three-d.
     1540          
     1541          dt-today = today.
     1542          nm-time  = string(time,"HH:MM").
     1543          
     1544          define rectangle rodhlire
     1545                 edge-pixels 1 graphic-edge no-fill
     1546                 size 80 by  .1 .
     1547          
     1548          define frame
     1549                 rodapere rodhlire at row 1 col 1 with 1 down no-box
     1550                 keep-tab-order overlay no-hide no-labels no-underline three-d
     1551                 at col 1 row 20 size 80 by 1.
     1552          
     1553          define frame linhare1
     1554                       nm-cab-usu-rela at row 1 col 1
     1555                       with 1 down overlay no-labels no-hide
     1556                       no-underline at col 1 row 15 centered bgcolor 15.
     1557          
     1558          define frame linhare2
     1559                       ds-linha2
     1560                       with 1 down overlay no-labels no-hide no-underline no-box
     1561                       at col 1 row 18 centered bgcolor 15.
     1562          
     1563          nr-posicao     = (70 - (length(nm-cab-usuario))) / 2.
     1564          
     1565          assign nm-cab-usu-rela = substring(espacos,1,nr-posicao) + nm-cab-usuario.
     1566                 ds-linha2-aux   = string(dt-today,"99/99/9999") + " - " + nm-time 
     1567                                          + "  " + nm-prog + " - " + c-versao.
     1568          
     1569          nr-posicao     = (75 - (length(ds-linha2-aux))) / 2.
     1570          
     1571          assign ds-linha2 = substring(espacos,1,nr-posicao) + ds-linha2-aux.
     1572          
     1573          if "MS-WINXP" = "TTY"
     1574          then view frame hdtitrela.
     1575          else do:
     1576                 pause 0.
     1577                 view frame windows-rela.
     1578                 display nm-cab-usu-rela
     1579                         ds-linha2 with frame windows-rela.
     1580               end.
     1581          
     1582          if "MS-WINXP" = "TTY"
     1583          then display substring(espacos,1,nr-posicao) + nm-cab-usuario +
     1584                       substring(espacos,1,nr-posicao) @ nm-cab-usuario
     1585                       with frame linhare1.
     1586          
     1587          nr-posicao     = 19.
     1588          if "MS-WINXP" = "TTY"
     1589          then do:
     1590                 pause 0.
     1591                 display substring(espacos,1,nr-posicao) + string(dt-today,"99/99/9999") +
     1592                         " - " + nm-time + "  " + nm-prog + " - " + c-versao @ ds-linha2
     1593                         with frame linhare2.
     1594                 view frame rodapere.
     1595               end.
     1596          pause 0.
     1597          
     1598          status input "Entre dados ou pressione F4 para sair".
     1599          status default "Datasul Medical                F2 para ajuda".
     1600          
     1601           
     1602          
     1603          assign b-layout:hidden = true.
     1604          assign b-consiste:hidden = true.
     1605        end.
     1606    
     1607   IF v_cod_usuar_corren = ""
     1608   THEN ASSIGN v_cod_usuar_corren = "migracao".
     1609   
     1610   IF in-batch-online-par = "BATCH"
     1611   THEN DO:
     1612          assign ct-grava            = 0
     1613                 lg-erro             = no
     1614                 lg-plano-aux        = lg-plano-par
     1615                 lg-medocup-aux      = lg-medocup-par
     1616                 lg-registro-modulos = lg-registro-modulos-par
     1617                 lg-registro-repasse = lg-registro-repasse-par
     1618                 in-classif          = in-classif-par
     1619                 qt-sair-aux         = qt-sair-par
     1620                 lg-gerar-termo-aux  = lg-gerar-termo-par
     1621                 lg-carteira-antig-aux = if in-carteira-antig-par = "S" then yes else no.
     1622   
     1623          run importa-dados.
     1624        END.
     1625   ELSE DO:
     1626           repeat on endkey undo,retry on error undo, retry with frame f-arquivo-mag:
     1627            
     1628             hide frame f-saida        no-pause.
     1629             hide frame f-nome         no-pause.
     1630             hide frame f-nome-imp     no-pause.
     1631             hide frame f-layout       no-pause.
     1632             hide frame f-arquivo-mag  no-pause.
     1633             hide frame f-consist      no-pause.
     1634             hide frame f-parametro    no-pause.
     1635             hide message              no-pause.
     1636             /******************************************************************************
     1637               Programa .....: hdbotcpimla.i
     1638               Data .........: 05/01/2004
     1639               Sistema ......:
     1640               Empresa ......: DZSET SOLUCOES E SISTEMAS
     1641               Cliente ......:
     1642               Programador ..: ELIZETE
     1643               Objetivo .....: Rgua de arquivo, consiste, parametro, importa e layout
     1644           *-----------------------------------------------------------------------------*
     1645               Versao     DATA         RESPONSAVEL
     1646                          05/01/2004   ELIZETE
     1647           ******************************************************************************/
     1648           
     1649            do:
     1650                   on choose of b-help in frame f-regua-cpimla
     1651                   do:
     1652                     c-opcao = replace(b-help:label in frame f-regua-cpimla,"&","").
     1653                     run rtp/rtexibehelp.p.
     1654                   end.
     1655           
     1656                   on end-error of b-help in frame f-regua-cpimla
     1657                   do:
     1658                     return no-apply.
     1659                   end.
     1660                   
     1661                   on choose of b-fim in frame f-regua-cpimla
     1662                   do:
     1663                     c-opcao = replace(b-fim:label in frame f-regua-cpimla,"&","").
     1664                   end.
     1665                   
     1666                   on end-error of b-fim in frame f-regua-cpimla
     1667                   do:
     1668                     return no-apply.
     1669                   end.
     1670                   
     1671                   on choose of b-arquivo in frame f-regua-cpimla
     1672                   do:
     1673                     c-opcao = replace(b-arquivo:label in frame f-regua-cpimla,"&","").
     1674                   end.
     1675                   
     1676                   on end-error of b-arquivo in frame f-regua-cpimla
     1677                   do:
     1678                     return no-apply.
     1679                   end.
     1680                   
     1681                   on choose of b-consiste in frame f-regua-cpimla
     1682                   do:
     1683                     c-opcao = replace(b-consiste:label in frame f-regua-cpimla,"&","").
     1684                   end.
     1685                   
     1686                   on end-error of b-consiste in frame f-regua-cpimla
     1687                   do:
     1688                     return no-apply.
     1689                   end.
     1690           
     1691                   on choose of b-parametro in frame f-regua-cpimla
     1692                   do:
     1693                     c-opcao = replace(b-parametro:label in frame f-regua-cpimla,"&","").
     1694                   end.
     1695                   
     1696                   on end-error of b-parametro in frame f-regua-cpimla
     1697                   do:
     1698                     return no-apply.
     1699                   end.
     1700                   
     1701                   on choose of b-importa in frame f-regua-cpimla
     1702                   do:
     1703                     c-opcao = replace(b-importa:label in frame f-regua-cpimla,"&","").
     1704                   end.
     1705                   
     1706                   on end-error of b-importa in frame f-regua-cpimla
     1707                   do:
     1708                     return no-apply.
     1709                   end.
     1710           
     1711                   on choose of b-layout in frame f-regua-cpimla
     1712                   do:
     1713                     c-opcao = replace(b-layout:label in frame f-regua-cpimla,"&","").
     1714                   end.
     1715                   
     1716                   on end-error of b-layout in frame f-regua-cpimla
     1717                   do:
     1718                     return no-apply.
     1719                   end.
     1720                   update unless-hidden b-arquivo b-consiste b-parametro b-importa b-layout b-fim b-help 
     1721                          go-on("get" "put" "recall" "clear")
     1722                          with frame f-regua-cpimla.
     1723                 end.
     1724           
     1725            .
     1726            
     1727             /**  parametro de entrada:                                                     **
     1728           **      &permissao - nome do campo que contem a lista de permissoes           **
     1729           **      &usuario   - nome do usuario que se deseja testar a permissao         **
     1730           **  parametro de saida:                                                       **
     1731           **      &tem-permissao - nome do campo que diz se tem ou permissao            **
     1732           **                                                                            **
     1733           ** Acrescimo de teste na impressora escrava quando TTY colocado nome do userid**
     1734           *******************************************************************************/
     1735           /*define variable nome as character format  "x(50)"      no-undo.*/
     1736           
     1737           assign ds-param-hdpedarq-aux = "".
     1738                                           
     1739           run rtp/rthdpedarq.p( input        c-opcao                    ,
     1740                                 input        ds-param-hdpedarq-aux      ,
     1741                                 input        nm-programa-hdvararq-aux   ,
     1742                                 input-output nm-cab-usuario             ,
     1743                                 input-output nm-prog                    ,
     1744                                 input-output nr-posicao                 ,
     1745                                 input-output espacos                    ,
     1746                                 input-output c-versao                   ,
     1747                                 input-output ds-inicializa-aux          ,
     1748                                 input-output ds-normal-ativa-aux        ,
     1749                                 input-output ds-normal-desat-aux        ,
     1750                                 input-output ds-negrit-ativa-aux        ,
     1751                                 input-output ds-negrit-desat-aux        ,
     1752                                 input-output ds-italic-ativa-aux        ,
     1753                                 input-output ds-italic-desat-aux        ,
     1754                                 input-output ds-expand-ativa-aux        ,
     1755                                 input-output ds-expand-desli-aux        ,
     1756                                 input-output ds-10cpp-ativa-aux         ,
     1757                                 input-output ds-10cpp-desat-aux         ,
     1758                                 input-output ds-15cpp-ativa-aux         ,
     1759                                 input-output ds-15cpp-desat-aux         ,
     1760                                 input-output ds-20cpp-ativa-aux         ,
     1761                                 input-output ds-20cpp-desat-aux         ,
     1762                                 input-output ds-format-folha-aux        ,
     1763                                 input-output ds-linha-folha-aux         ,
     1764                                 input-output ds-margem-aux              ,
     1765                                 input-output ds-primei-linha-aux        ,
     1766                                 input-output ds-mc-linha-ativa-aux      ,
     1767                                 input-output ds-mc-linha-desat-aux      ,
     1768                                 input-output ds-eq-margem-ativa-aux     ,
     1769                                 input-output ds-eq-margem-desat-aux     ,
     1770                                 input-output lg-ver-tela-aux            ,
     1771                                 input-output nm-arq-tela-quo            ,
     1772                                 input-output ds-campo-imp-quo           ,
     1773                                 input-output nm-arquivo-windows-aux     ,
     1774                                 input-output nr-linhas-windows-aux      ,
     1775                                 input-output nr-pagina-windows-aux      ,
     1776                                 input-output nr-fonte-windows-aux       ,
     1777                                 input-output lg-ok-imprime-windows-aux  ,
     1778                                 input-output l-saida                    ,
     1779                                 input-output nm-diretorio               ,
     1780                                 input-output nm-arquivo                 ,
     1781                                 input-output nm-extensao                ,
     1782                                 input-output nm-diretorio-old           ,
     1783                                 input-output nm-arquivo-old             ,
     1784                                 input-output nm-extensao-old            ,
     1785                                 input-output c-saida                    ,
     1786                                 input-output c-arquivo1                 ,
     1787                                 input-output c-arquivo2                 ,
     1788                                 input-output nr-contador-aux            ,
     1789                                 input-output nr-contador-fim            ,
     1790                                 input-output ds-titulo-imp              ,
     1791                                 input-output c-nome-imp                 ,
     1792                                 input-output l-xxxtmp                   ,
     1793                                 input-output c-yyytmp                   ,
     1794                                 input-output l-resp                     ,
     1795                                 input-output l-letra                    ,
     1796                                 input-output in-saida                   ,
     1797                                 input-output in-tela).            
     1798           
     1799           assign c-arquivo[1] = c-arquivo1
     1800                  c-arquivo[2] = c-arquivo2.
     1801               
     1802           /*------------------------- EOF ---------------------------------------------*/
     1803            
     1804           
     1805             case c-opcao:
     1806           
     1807                when "Parametro"
     1808                then do on error undo, retry on endkey undo, leave with frame f-parametro:
     1809                        
     1810                        assign c-opcao      = "Parametro"
     1811                               lg-parametro = no.
     1812                                     
     1813                        update lg-registro-modulos with frame f-parametro.   
     1814                
     1815                        if   lg-registro-modulos = yes
     1816                        then do on error undo, retry on endkey undo, leave:
     1817                                
     1818                                display tb-classif with frame f-classif.
     1819                                choose field tb-classif auto-return with frame f-classif.
     1820                                in-classif = frame-index.
     1821                             end.
     1822                        
     1823                        hide frame f-classif no-pause.
     1824                  
     1825                        update lg-registro-repasse with frame f-parametro.
     1826                  
     1827                        assign lg-parametro = yes.
     1828                        hide frame f-parametro no-pause.
     1829                     end.
     1830           
     1831                when "Importa"
     1832                then do on error undo, retry on endkey undo, leave:
     1833           
     1834                        if   not lg-parametro
     1835                        then do:
     1836                               message "Nenhum Parametro Selecionado."
     1837                               view-as alert-box title " Atencao !!! ".
     1838                               undo, retry.
     1839                             end.
     1840           
     1841                        update nm-arquivo-erros with frame f-arquivo-mag.
     1842                        
     1843                        message " Importando Dados, Aguarde...".
     1844               
     1845                        output stream s-relat-erro to value(nm-arquivo-erros) page-size 64.
     1846           
     1847                        HIDE FRAME f-arquivo-mag.
     1848                      
     1849                        view stream s-relat-erro frame f-cabeca-erro.
     1850                        view stream s-relat-erro frame f-rodape.
     1851               
     1852                        assign ct-grava                = 0
     1853                               lg-erro                 = no
     1854                               lg-plano-aux            = no
     1855                               lg-medocup-aux          = NO
     1856                               lg-gerar-termo-aux      = lg-gerar-termo-par
     1857                               lg-carteira-antig-aux = if in-carteira-antig-par = "S" then yes else no.
     1858           
     1859                        run importa-dados.
     1860           
     1861                        put stream s-relat-erro
     1862                             skip(05)
     1863                             " Nome do Arquivo       : "  at 40  nm-arquivo-importar  skip(01).
     1864           
     1865                        output stream s-relat-erro close.
     1866           
     1867                        HIDE FRAME f-contador.
     1868           
     1869                        if lg-imp-erro
     1870                        then message "Ocorreram Erro(s)." skip
     1871                                     "Verifique Relatorio de Erros "
     1872                                     view-as alert-box title "Atencao !!!".
     1873                        else message "Importacao concluida com sucesso!"
     1874                                     view-as alert-box title "Atencao !!!".
     1875                             
     1876                        hide message no-pause.
     1877                     end.
     1878           
     1879               when "Fim"
     1880               then do:
     1881                      hide all no-pause.
     1882                      leave.
     1883                    end.
     1884             end case.
     1885           end.
     1886        END.
     1887   
     1888   /*DELETE PROCEDURE h-handle-aux.*/
     1889   /* ------------------------------------------------- RETIRA A API DA PERSISTENCIA --- */
     1890   *** Encrypted Source ***
     1891   *** Encrypted Source ***
     1892   *** Encrypted Source ***
     1893   *** Encrypted Source ***
     1894   *** Encrypted Source ***
     1895   *** Encrypted Source ***
     1896   *** Encrypted Source ***
     1897   *** Encrypted Source ***
     1898   *** Encrypted Source ***
     1899   *** Encrypted Source ***
     1900   *** Encrypted Source ***
     1901   *** Encrypted Source ***
     1902   *** Encrypted Source ***
     1903   *** Encrypted Source ***
     1904   *** Encrypted Source ***
     1905   *** Encrypted Source ***
     1906   *** Encrypted Source ***
     1907   *** Encrypted Source ***
     1908   *** Encrypted Source ***
     1909   *** Encrypted Source ***
     1910   *** Encrypted Source ***
     1911   *** Encrypted Source ***
     1912   *** Encrypted Source ***
     1913   *** Encrypted Source ***
     1914   *** Encrypted Source ***
     1915   *** Encrypted Source ***
     1916   *** Encrypted Source ***
     1917   *** Encrypted Source ***
     1918   *** Encrypted Source ***
     1919   *** Encrypted Source ***
     1920   *** Encrypted Source ***
     1921   *** Encrypted Source ***
     1922   *** Encrypted Source ***
     1923   *** Encrypted Source ***
     1924   *** Encrypted Source ***
     1925   *** Encrypted Source ***
     1926   *** Encrypted Source ***
     1927   *** Encrypted Source ***
     1928   *** Encrypted Source ***
     1929   *** Encrypted Source ***
     1930   *** Encrypted Source ***
     1931   *** Encrypted Source ***
     1932   *** Encrypted Source ***
     1933   *** Encrypted Source ***
     1934   *** Encrypted Source ***
     1935   *** Encrypted Source ***
     1936   *** Encrypted Source ***
     1937   *** Encrypted Source ***
     1938    
     1939   
     1940   
     1941   /* ------------------------------------------------------------------------- */
     1942   procedure importa-dados:
     1943   
     1944       ASSIGN qtd-reg-rest = 1000.
     1945   
     1946       REPEAT:
     1947           PROCESS EVENTS.
     1948   
     1949           IF NOT CAN-FIND (FIRST import-bnfciar WHERE import-bnfciar.ind-sit-import = in-status-monitorar-par)
     1950           THEN LEAVE. 
     1951   
     1952           ASSIGN cont-aux = 0.
     1953   
     1954           case in-status-benef-par:
     1955   
     1956               /* --- ATIVOS E INATIVOS ------------------------------------------------------ */
     1957               when 'A' 
     1958               then do:
     1959                      IF CAN-FIND (FIRST import-bnfciar 
     1960                                   WHERE import-bnfciar.ind-sit-import = in-status-monitorar-par
     1961                                     AND import-bnfciar.log-respons)   
     1962                      THEN 
     1963                           FOR EACH import-bnfciar
     1964                              WHERE import-bnfciar.ind-sit-import = in-status-monitorar-par NO-LOCK USE-INDEX imprtbnf_ix2 /*EXCLUSIVE-LOCK*/ /*,*/
     1965                              /*FIRST import-propost NO-LOCK  /*USE-INDEX imprtprp_id3 */
     1966                              WHERE import-propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo */
     1967                                    BREAK BY import-bnfciar.log-respons DESC
     1968                                          BY import-bnfciar.cd-grau-parentesco:
     1969   
     1970                               message "Imp. Benef.Resp. Sit: " in-status-monitorar-par " " import-bnfciar.num-seqcial-control.
     1971                               pause 0.
     1972                           
     1973                               RUN consiste-dados.
     1974                           
     1975                               IF  cont-aux = qtd-reg-rest
     1976                               THEN LEAVE.
     1977                           END.
     1978                      ELSE 
     1979                           FOR EACH import-bnfciar
     1980                              WHERE import-bnfciar.ind-sit-import = in-status-monitorar-par NO-LOCK USE-INDEX imprtbnf_ix2 /*EXCLUSIVE-LOCK*/ /*,*/
     1981                              /*FIRST import-propost NO-LOCK
     1982                              WHERE import-propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo*/ :
     1983                           
     1984                               message "Imp. Benef.Dep. Sit: " in-status-monitorar-par " " import-bnfciar.num-seqcial-control.
     1985                               pause 0.
     1986   
     1987                               RUN consiste-dados.
     1988                           
     1989                               IF  cont-aux = qtd-reg-rest
     1990                               THEN LEAVE.
     1991                           END.
     1992                    end.
     1993               /* --- ATIVOS ----------------------------------------------------------------- */
     1994               when 'AT' 
     1995               then do:
     1996                      IF CAN-FIND (FIRST import-bnfciar 
     1997                                   WHERE import-bnfciar.ind-sit-import = in-status-monitorar-par
     1998                                     AND import-bnfciar.log-respons
     1999                                     AND import-bnfciar.dt-exclusao-plano = ?)   
     2000                      THEN 
     2001                           FOR EACH import-bnfciar
     2002                              WHERE import-bnfciar.ind-sit-import    = in-status-monitorar-par
     2003                                AND import-bnfciar.dt-exclusao-plano = ? NO-LOCK USE-INDEX imprtbnf_ix2 /*EXCLUSIVE-LOCK*/ /*,*/
     2004                              /*FIRST import-propost NO-LOCK
     2005                              WHERE import-propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo*/
     2006                                    BREAK BY import-bnfciar.log-respons DESC
     2007                                          BY import-bnfciar.cd-grau-parentesco:
     2008                           
     2009                               message "Imp. Benef.Resp.ATIVOS Sit: " in-status-monitorar-par " " import-bnfciar.num-seqcial-control.
     2010                               pause 0.
     2011   
     2012                               RUN consiste-dados.
     2013                           
     2014                               IF  cont-aux = qtd-reg-rest
     2015                               THEN LEAVE.
     2016                           END.
     2017                      ELSE 
     2018                           FOR EACH import-bnfciar
     2019                              WHERE import-bnfciar.ind-sit-import    = in-status-monitorar-par
     2020                                AND import-bnfciar.dt-exclusao-plano = ? NO-LOCK USE-INDEX imprtbnf_ix2 /*EXCLUSIVE-LOCK*/ /*,*/
     2021                              /*FIRST import-propost NO-LOCK
     2022                              WHERE import-propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo*/ :
     2023                           
     2024                               message "Imp. Benef.Dep.ATIVOS Sit: " in-status-monitorar-par " " import-bnfciar.num-seqcial-control.
     2025                               pause 0.
     2026   
     2027                               RUN consiste-dados.
     2028                           
     2029                               IF  cont-aux = qtd-reg-rest
     2030                               THEN LEAVE.
     2031                           END.   
     2032                    end.
     2033               /* --- INATIVOS --------------------------------------------------------------- */
     2034               when 'I' 
     2035               then do:
     2036                      IF CAN-FIND (FIRST import-bnfciar 
     2037                                   WHERE import-bnfciar.ind-sit-import = in-status-monitorar-par
     2038                                     AND import-bnfciar.log-respons
     2039                                     AND import-bnfciar.dt-exclusao-plano <> ?)   
     2040                      THEN 
     2041                           FOR EACH import-bnfciar
     2042                              WHERE import-bnfciar.ind-sit-import    = in-status-monitorar-par
     2043                                AND import-bnfciar.dt-exclusao-plano <> ? NO-LOCK USE-INDEX imprtbnf_ix2 /*EXCLUSIVE-LOCK*/ /*,*/
     2044                              /*FIRST import-propost NO-LOCK
     2045                              WHERE import-propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo*/
     2046                                    BREAK BY import-bnfciar.log-respons DESC
     2047                                          BY import-bnfciar.cd-grau-parentesco:
     2048                           
     2049                               message "Imp. Benef.Resp.INATIVOS Sit: " in-status-monitorar-par " " import-bnfciar.num-seqcial-control.
     2050                               pause 0.
     2051   
     2052                               RUN consiste-dados.
     2053                           
     2054                               IF  cont-aux = qtd-reg-rest
     2055                               THEN LEAVE.
     2056                           END.
     2057                      ELSE 
     2058                           FOR EACH import-bnfciar
     2059                              WHERE import-bnfciar.ind-sit-import    = in-status-monitorar-par
     2060                                AND import-bnfciar.dt-exclusao-plano <> ? NO-LOCK USE-INDEX imprtbnf_ix2 /*EXCLUSIVE-LOCK*/ /*,*/
     2061                              /*FIRST import-propost NO-LOCK
     2062                              WHERE import-propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo*/ :
     2063                           
     2064                               message "Imp. Benef.Dep.INATIVOS Sit: " in-status-monitorar-par " " import-bnfciar.num-seqcial-control.
     2065                               pause 0.
     2066   
     2067                               RUN consiste-dados.
     2068                           
     2069                               IF  cont-aux = qtd-reg-rest
     2070                               THEN LEAVE.
     2071                           END.   
     2072                    end.
     2073           end case.
     2074   
     2075           /* cria registros */
     2076           run cria-registros IN h-cg0311v-aux ASYNCHRONOUS.
     2077   
     2078           IF in-batch-online-par = "ONLINE"
     2079           then run mostra-erro.
     2080           run pi-grava-erro.
     2081           
     2082           IF  qt-sair-aux <> 0
     2083           AND qt-cont-sair-aux >= qt-sair-aux
     2084           THEN LEAVE.
     2085       END.    
     2086       
     2087   end procedure.
     2088   
     2089   PROCEDURE consiste-dados:
     2090   
     2091       assign lg-registro-repasse-aux = no
     2092              lg-relat-erro-aux       = no
     2093              lg-formato-livre-aux    = yes.
     2094   
     2095       assign lg-imp-erro     = no
     2096              lg-plano-aux    = NO
     2097              lg-relat-erro   = no
     2098              lg-repasse-erro = no.
     2099       
     2100       FIND FIRST modalid WHERE modalid.cd-modalidade = int(import-bnfciar.cd-modalidade) NO-LOCK NO-ERROR.
     2101       
     2102       if   avail modalid
     2103       THEN DO:
     2104              IF modalid.cd-tipo-medicina = paramecp.cd-mediocupa
     2105              THEN assign lg-medocup-aux = NO.
     2106              ELSE assign lg-medocup-aux = YES.
     2107            END.
     2108       ELSE DO:
     2109              RUN pi-cria-tt-erros("Modalidade Invalida").
     2110              assign lg-relat-erro = yes.
     2111            END.
     2112       
     2113       FOR FIRST propost USE-INDEX propo24
     2114           WHERE propost.nr-contrato-antigo = import-bnfciar.nr-contrato-antigo NO-LOCK:
     2115       END.
     2116       
     2117       if   not avail propost
     2118       then do:
     2119              ASSIGN lg-relat-erro = YES.
     2120              run pi-cria-tt-erros("Proposta nao cadastrada. Contr. Antigo: " + 
     2121                                   if import-bnfciar.nr-contrato-antigo <> ?
     2122                                   then string(import-bnfciar.nr-contrato-antigo)
     2123                                   else "0").
     2124            end.
     2125       
     2126       ELSE do:
     2127              IF NOT CAN-FIND (FIRST contrat where contrat.nr-insc-contratante = propost.nr-insc-contratante)
     2128              THEN DO:
     2129                     ASSIGN lg-relat-erro = YES.
     2130                     run pi-cria-tt-erros("Contratante nao cadastrado. Inscricao: " + 
     2131                                          if propost.nr-insc-contratante <> ?
     2132                                          then string(propost.nr-insc-contratante)
     2133                                          else "0").
     2134                   end.
     2135       
     2136              find ti-pl-sa where ti-pl-sa.cd-modalidade = propost.cd-modalidade
     2137                              and ti-pl-sa.cd-plano      = propost.cd-plano
     2138                              and ti-pl-sa.cd-tipo-plano = propost.cd-tipo-plano
     2139                                  no-lock no-error.
     2140              
     2141              if   not avail ti-pl-sa 
     2142              then do:
     2143                     assign lg-relat-erro = yes.
     2144                     RUN pi-cria-tt-erros("Tipo de Plano nao cadastrado. Mod. " + string(propost.cd-modalidade) +
     2145                                          " Pl. "    + string(propost.cd-plano)     +
     2146                                          " Tp.Pl. " + string(propost.cd-tipo-plano)).
     2147                   end.
     2148   
     2149              /**
     2150               * Tratamento do REGISTRO PLANO ANS 
     2151               */
     2152              if propost.in-registro-plano = 2 /* registro ANS no beneficiario */
     2153              then do:
     2154                     if  (import-bnfciar.cd-registro-plano  = 0  or import-bnfciar.cd-registro-plano  = ?)
     2155                     and (import-bnfciar.cd-plano-operadora = "" or import-bnfciar.cd-plano-operadora = ?)
     2156                     then do:
     2157                            assign lg-relat-erro = yes.
     2158                            run pi-cria-tt-erros ("Codigo do Registro de Plano Regulamentado ou Nao Regulamentado\Adaptado deve ser informado"). 
     2159                          end.
     2160                     
     2161                     if  (import-bnfciar.cd-registro-plano  <> 0  and import-bnfciar.cd-registro-plano  <> ?)
     2162                     and (import-bnfciar.cd-plano-operadora <> "" and import-bnfciar.cd-plano-operadora <> ?)
     2163                     then do:
     2164                            assign lg-relat-erro = yes.
     2165                            run pi-cria-tt-erros ("Codigo do Registro de Plano Regulamentado e Codigo do Registro de Plano Nao Regulamentado\Adaptado informados. Informar apenas um."). 
     2166                          end.
     2167                     else do:
     2168                            /* plano eh regulamentado */
     2169                            if  import-bnfciar.cd-registro-plano <> 0
     2170                            and import-bnfciar.cd-registro-plano <> ?
     2171                            then do:
     2172                                   /*for first reg-plano-saude fields(cdn-plano-ans idi-registro)
     2173                                       where reg-plano-saude.cdn-plano-ans = import-bnfciar.cd-registro-plano 
     2174                                             no-lock query-tuning(no-index-hint): 
     2175                                   end.
     2176                                   if not avail reg-plano-saude */
     2177                                   
     2178                                   if NOT CAN-FIND(FIRST reg-plano-saude
     2179                                                   WHERE reg-plano-saude.cdn-plano-ans = import-bnfciar.cd-registro-plano)
     2180                                   then do:
     2181                                          if import-bnfciar.cd-registro-plano <> ?
     2182                                          then char-aux1 = string(import-bnfciar.cd-registro-plano).
     2183                                          else char-aux1 = "nulo".
     2184                            
     2185                                          assign lg-relat-erro = yes.
     2186                                          run pi-cria-tt-erros ("Registro Plano Regulamentado nao encontrado.  Cod. Reg.: " + char-aux1). 
     2187                                        end.
     2188                                 end.
     2189                            else do:
     2190                                   /* plano eh nao regulamentado ou adaptado */
     2191                                   for first import-propost fields (num-livre-8)
     2192                                       where import-propost.nr-contrato-antigo = propost.nr-contrato-antigo USE-INDEX imprtprp_id3
     2193                                             no-lock /*query-tuning (no-index-hint)*/:
     2194                                   end.
     2195                            
     2196                                   /*for first reg-plano-saude fields(cod-plano-operadora idi-registro)
     2197                                       where reg-plano-saude.cod-plano-operadora    = import-bnfciar.cd-plano-operadora 
     2198                                         and reg-plano-saude.in-tipo-regulamentacao = import-propost.num-livre-8
     2199                                             no-lock query-tuning (no-index-hint): 
     2200                                   end.
     2201                                   if not avail reg-plano-saude*/
     2202                                   
     2203                                   IF NOT CAN-FIND(FIRST reg-plano-saude
     2204                                                   WHERE reg-plano-saude.cod-plano-operadora    = import-bnfciar.cd-plano-operadora
     2205                                                     AND reg-plano-saude.in-tipo-regulamentacao = import-propost.num-livre-8)
     2206                                   then do:
     2207                                          if import-bnfciar.cd-plano-operadora <> ?
     2208                                          then char-aux1 = string(import-bnfciar.cd-plano-operadora).
     2209                                          else char-aux1 = "nulo".
     2210                            
     2211                                          assign lg-relat-erro = yes.
     2212                                          run pi-cria-tt-erros("Registro Plano Nao-Regulamentado nao encontrado. Cod. Reg.: " + char-aux1 + " - Tipo Reg.: " + string(import-propost.num-livre-8)).
     2213                                        end.
     2214                                 end.
     2215                          end.
     2216                   end.
     2217            end.
     2218              
     2219       IF lg-gerar-termo-aux
     2220       AND AVAIL propost
     2221       THEN DO:
     2222              FOR FIRST ter-ade
     2223                  WHERE ter-ade.cd-modalidade = propost.cd-modalidade
     2224                    AND ter-ade.nr-ter-adesao = propost.nr-ter-adesao NO-LOCK:
     2225              END.
     2226              if   not avail ter-ade
     2227              then do:
     2228                     ASSIGN lg-relat-erro = YES.
     2229                     run pi-cria-tt-erros("Termo nao cadastrado. Modalidade: " + STRING(propost.cd-modalidade) + 
     2230                                          " Termo: " + STRING(propost.nr-ter-adesao)).
     2231                   end.
     2232            END.
     2233   
     2234       IF  import-bnfciar.cd-carteira-origem-responsavel <> import-bnfciar.cd-carteira-antiga
     2235       AND import-bnfciar.log-respons = NO
     2236       AND NOT CAN-FIND (first usuario where usuario.cd-carteira-antiga = import-bnfciar.cd-carteira-origem-responsavel)
     2237       THEN do:
     2238              FOR FIRST b-import-bnfciar FIELDS (num-seqcial-control)
     2239                  where b-import-bnfciar.cd-carteira-antiga = import-bnfciar.cd-carteira-origem-responsavel NO-LOCK:
     2240              END.
     2241       
     2242              IF AVAIL b-import-bnfciar
     2243              THEN run pi-cria-tt-erros("Respons. deste beneficiario nao foi importado. Num. seqcial controle do benef. resp.:" + string(b-import-bnfciar.num-seqcial-control)).
     2244              ELSE run pi-cria-tt-erros("Nao encontrado registro na tabela import-bnfciar correspondente ao benef. respons vel. Carteira do resp. informada: " + string(import-bnfciar.cd-carteira-origem-responsavel)).
     2245       
     2246              ASSIGN lg-relat-erro = YES.
     2247            END.
     2248       
     2249       IF lg-relat-erro 
     2250       THEN DO:
     2251              IF in-batch-online-par = "ONLINE"
     2252              then run mostra-erro.
     2253             
     2254              run pi-grava-erro.
     2255              
     2256              assign lg-imp-erro = yes.
     2257       
     2258              RETURN.
     2259            END.
     2260       
     2261       /* --- CONSISTE DADOS -------------------------------------------------------------------- */
     2262       
     2263       /* --- CONSISTE DADOS USUARIO -------------- */
     2264       ASSIGN lg-relat-erro = NO.
     2265       RUN consiste-dados-benef.
     2266       
     2267       IF lg-relat-erro
     2268       THEN ASSIGN lg-relat-erro-aux = YES.
     2269       
     2270       /* --- CONSISTE MODULOS USUARIO ------------ */
     2271       if lg-registro-modulos
     2272       THEN DO:
     2273              ASSIGN lg-relat-erro = NO.
     2274              RUN consiste-modulos-benef.
     2275              
     2276              IF lg-relat-erro
     2277              THEN ASSIGN lg-relat-erro-aux = YES.
     2278            END.
     2279       
     2280       /* --- CONSISTE REPASSE USUARIO ------------ */
     2281       if lg-registro-repasse
     2282       then do:
     2283              ASSIGN lg-relat-erro = NO.
     2284              RUN consiste-repasse-benef.
     2285             
     2286              IF lg-relat-erro
     2287              THEN ASSIGN lg-relat-erro-aux = YES.
     2288            END.        
     2289       
     2290       /* --- CONSISTE REPASSE ATEND. USUARIO ----- */
     2291       IF  lg-registro-repasse
     2292       AND lg-registro-repasse-aux = YES
     2293       THEN DO:
     2294              ASSIGN lg-relat-erro = NO.
     2295              RUN consiste-repas-atend.
     2296              
     2297              IF lg-relat-erro
     2298              THEN ASSIGN lg-relat-erro-aux = YES.
     2299            END.
     2300       
     2301       /* --- CONSISTE PAD. COB. USUARIO ---------- */
     2302       ASSIGN lg-relat-erro = NO.
     2303       RUN consiste-padrao-benef.
     2304       
     2305       IF lg-relat-erro
     2306       THEN ASSIGN lg-relat-erro-aux = YES.
     2307       
     2308       /*IF lg-plano-aux = NO
     2309       THEN DO:
     2310              RUN pi-cria-tt-erros("Nenhum modulo foi escolhido para o beneficiario").
     2311              ASSIGN lg-relat-erro-aux = YES.     
     2312            END.*/
     2313       
     2314       /* --------------------------------------------------------------------------------------- */
     2315       ASSIGN cont-aux = cont-aux + 1.
     2316       
     2317       if lg-relat-erro-aux
     2318       then DO:
     2319              IF in-batch-online-par = "ONLINE"
     2320              then run mostra-erro.
     2321              run pi-grava-erro.
     2322              
     2323              assign lg-imp-erro = yes. 
     2324            END.
     2325       ELSE DO:
     2326              CREATE tt-import-bnfciar.
     2327              ASSIGN tt-import-bnfciar.rowid-import-bnfciar = rowid(import-bnfciar)
     2328                     tt-import-bnfciar.nome-usuario         = nome-usuario-aux        
     2329                     tt-import-bnfciar.nome-abrev-usu       = nome-abrev-usu     
     2330                     tt-import-bnfciar.nome-usuario-aux     = nome-usuario-aux   
     2331                     tt-import-bnfciar.cartao-aux           = cartao-aux         
     2332                     tt-import-bnfciar.nome-cartao-usu      = nome-cartao-usu
     2333                     tt-import-bnfciar.lg-insc-fat          = lg-insc-fat-aux
     2334                     tt-import-bnfciar.cd-cidade            = cd-cidade-aux
     2335                     tt-import-bnfciar.nr-idade-usuario     = nr-idade-usuario
     2336                     tt-import-bnfciar.nr-faixa-etaria      = nr-faixa-etaria-aux.
     2337            END.
     2338   
     2339   END PROCEDURE.
     2340   
     2341   
     2342   /* ------------------------------------------------------------------------------------- */     
     2343   /* ------------------------------------------------------------------------- */
     2344   procedure mostra-erro.
     2345   
     2346       FOR EACH tt-erro NO-LOCK:
     2347   
     2348           display stream s-relat-erro
     2349                   tt-erro.nr-seq-contr          
     2350                   tt-erro.nom-tab-orig-erro  
     2351                   tt-erro.des-erro             
     2352                   with frame f-erro.  
     2353           down stream s-relat-erro with frame f-erro.
     2354   
     2355       END.
     2356    
     2357   end procedure.
     2358   
     2359   /* ------------------------------------------------------------------------------------------- */
     2360   PROCEDURE pi-cria-tt-erros:
     2361   
     2362       DEF INPUT PARAM ds-erro-par AS CHAR NO-UNDO.
     2363       
     2364       DEF VAR num-seq-aux AS INT NO-UNDO.
     2365   
     2366       FOR LAST b-tt-erro FIELDS (nr-seq) 
     2367          WHERE b-tt-erro.nr-seq-contr = import-bnfciar.num-seqcial-control NO-LOCK:
     2368       END.
     2369   
     2370       CREATE tt-erro.
     2371   
     2372       IF AVAIL b-tt-erro
     2373       THEN ASSIGN num-seq-aux = b-tt-erro.nr-seq + 1.
     2374       ELSE ASSIGN num-seq-aux = 1.
     2375   
     2376       ASSIGN tt-erro.nr-seq            = num-seq-aux
     2377              tt-erro.nr-seq-contr      = import-bnfciar.num-seqcial-control
     2378              tt-erro.nom-tab-orig-erro = "BE - import-bnfciar"
     2379              tt-erro.des-erro          = ds-erro-par. 
     2380   
     2381       /*OUTPUT STREAM s-rel-erro TO VALUE(nm-rel-erro-aux) APPEND.
     2382       PUT STREAM s-rel-erro UNFORMATTED tt-erro.nr-seq-contr ";"
     2383                                         tt-erro.nom-tab-orig-erro ";"
     2384                                         tt-erro.des-erro ";"
     2385                                         get-trace() SKIP.
     2386       OUTPUT STREAM s-rel-erro CLOSE.*/
     2387   
     2388   END PROCEDURE.
     2389   
     2390   procedure pi-grava-erro:
     2391   
     2392       ASSIGN nro-seq-aux = 0.
     2393   
     2394       FOR EACH tt-erro FIELDS(nr-seq-contr nom-tab-orig-erro des-erro) EXCLUSIVE-LOCK
     2395           BREAK BY tt-erro.nr-seq-contr:
     2396   
     2397           IF nro-seq-aux = 0
     2398           THEN do:
     2399                  IF CAN-FIND (FIRST erro-process-import WHERE erro-process-import.num-seqcial-control = tt-erro.nr-seq-contr)
     2400                  THEN RUN pi-consulta-prox-seq (INPUT tt-erro.nr-seq-contr, OUTPUT nro-seq-aux).
     2401                  ELSE ASSIGN nro-seq-aux = nro-seq-aux + 1.
     2402                END.
     2403           ELSE ASSIGN nro-seq-aux = nro-seq-aux + 1.
     2404   
     2405           /**
     2406            * Garantir unicidade da chave.
     2407            */
     2408           create erro-process-import.
     2409           REPEAT:
     2410               assign erro-process-import.num-seqcial         = nro-seq-aux
     2411                      erro-process-import.num-seqcial-control = tt-erro.nr-seq-contr NO-ERROR.
     2412               VALIDATE erro-process-import NO-ERROR.
     2413               IF ERROR-STATUS:ERROR
     2414               OR ERROR-STATUS:NUM-MESSAGES > 0
     2415               THEN do:
     2416                      ASSIGN nro-seq-aux = nro-seq-aux + 1.
     2417                      PAUSE(1). /* aguarda 1seg e busca novamente o proximo nr livre.*/
     2418                    END.
     2419               else leave.    /* o nr gerado eh valido. continua o processo.*/
     2420           END.
     2421   
     2422           ASSIGN erro-process-import.nom-tab-orig-erro   = tt-erro.nom-tab-orig-erro
     2423                  erro-process-import.des-erro            = tt-erro.des-erro
     2424                  erro-process-import.dat-erro            = today. 
     2425   
     2426           FOR FIRST control-migrac FIELDS (ind-sit-import)
     2427               WHERE control-migrac.num-seqcial = tt-erro.nr-seq-contr EXCLUSIVE-LOCK:
     2428           END.
     2429           if avail control-migrac
     2430           then assign control-migrac.ind-sit-import = "PE".
     2431   
     2432           FOR FIRST b-import-bnfciar FIELDS (ind-sit-import) 
     2433               WHERE b-import-bnfciar.num-seqcial-control = erro-process-import.num-seqcial-control EXCLUSIVE-LOCK:
     2434           END.
     2435           IF AVAIL b-import-bnfciar
     2436           THEN DO:        
     2437                  ASSIGN b-import-bnfciar.ind-sit-import = "PE".
     2438   
     2439                  RELEASE  b-import-bnfciar.
     2440                  VALIDATE b-import-bnfciar.
     2441                END.
     2442   
     2443           DELETE tt-erro.
     2444       END.
     2445   
     2446   end procedure.
     2447   
     2448   procedure pi-consulta-prox-seq:
     2449   
     2450       def input  parameter nr-seq-contr-p like erro-process-import.num-seqcial-control no-undo.
     2451       def output parameter nro-seq-par    as int initial 0                             no-undo.
     2452   
     2453       def buffer b-erro-process-import for erro-process-import.
     2454   
     2455       select max(erro-process-import.num-seqcial) into nro-seq-par 
     2456              from erro-process-import 
     2457              where erro-process-import.num-seqcial-control = nr-seq-contr-p.
     2458   
     2459       if nro-seq-par = ?
     2460       then assign nro-seq-par = 1.
     2461       else assign nro-seq-par = nro-seq-par + 1.
     2462   
     2463   end procedure.
     2464   
     2465   PROCEDURE consiste-dados-benef:
     2466       
     2467       if (import-bnfciar.in-via-transferencia = "B" 
     2468       or  import-bnfciar.in-via-transferencia = "D")
     2469       and import-bnfciar.cdn-produt-orig = 0
     2470       then do:
     2471              assign lg-relat-erro = yes.
     2472              RUN pi-cria-tt-erros("Nr.Produto Operadora Origem nao informado").
     2473            end.
     2474   
     2475       /* ---------------- Nr INSCRICAO CONTRATANTE ---------------------*/  
     2476       if   int(import-bnfciar.nr-insc-contratante) <> 0
     2477       AND  NOT CAN-FIND (FIRST contrat where contrat.nr-insc-contratante = int(import-bnfciar.nr-insc-contratante))
     2478       then do:
     2479              assign lg-relat-erro = yes.
     2480              RUN pi-cria-tt-erros("Inscricao do Contratante Invalida").
     2481            end.
     2482   
     2483       /* ------------------ CONTRATO ANTIGO -----------------------*/
     2484       if import-bnfciar.nr-contrato-antigo = ""
     2485       then do:
     2486              assign lg-relat-erro = yes.
     2487              RUN pi-cria-tt-erros("Contrato Antigo Invalido").
     2488            end.
     2489    
     2490       if   propost.cd-modalidade <> import-bnfciar.cd-modalidade     
     2491       then do:
     2492              assign lg-relat-erro = yes.       
     2493              RUN pi-cria-tt-erros("Modalidade Contrato Antigo nao confere. Modalide Proposta: " + STRING(propost.cd-modalidade) +
     2494                                   "Modalidade tab. Importacao: " + STRING(import-bnfciar.cd-modalidade)).
     2495            end.
     2496    
     2497       /* --------------------- PROPOSTA  ----------------------------*/
     2498       assign nr-proposta-imp-aux = propost.nr-proposta
     2499              nr-proposta-aux     = propost.nr-proposta
     2500              r-propost           = recid(propost).
     2501   
     2502       if  int(import-bnfciar.nr-proposta) <> 0
     2503       AND propost.nr-proposta <> import-bnfciar.nr-proposta 
     2504       then do:
     2505              ASSIGN lg-relat-erro = yes.       
     2506              RUN pi-cria-tt-erros("Proposta/Contrato Antigo nao confere").
     2507            end.
     2508       
     2509       if propost.cd-tipo-proposta <> 9
     2510       then do: 
     2511              assign lg-relat-erro = yes.       
     2512              RUN pi-cria-tt-erros("Tipo de Proposta nao e migracao").
     2513            end.
     2514       
     2515       /*assign cd-cpf-aux = import-bnfciar.cd-cpf.*/
     2516   
     2517       /*------------ NOME DO BENEFICIARIO ---------------*/
     2518       run rtp/rtcarint.p ( input 0,
     2519                            input import-bnfciar.nom-usuar,
     2520                            input no,
     2521                            output nome-usuario-aux,
     2522                            output nome-abrev-usu,
     2523                            output cartao-aux,
     2524                            output lg-undo-retry,
     2525                            output ds-mensagem-aux).
     2526       if   lg-undo-retry
     2527       then do:
     2528              /**
     2529               * Se ocorreu erro de nome cartao maior que 25 posicoes, chamar a rotina novamente com funcao 2,
     2530               * para gerar somente esse campo sem apresentar erro.
     2531               */
     2532              IF ds-mensagem-aux = "Nome apos abreviatura continua com mais de 25 posicoes" 
     2533              THEN DO:
     2534                     run rtp/rtcarint.p ( input 2,
     2535                                          input import-bnfciar.nom-usuar,
     2536                                          input no,
     2537                                          output nome-usuario2-aux,
     2538                                          output nome-abrev2-usu,
     2539                                          output cartao-aux,
     2540                                          output lg-undo-retry,
     2541                                          output ds-mensagem-aux).
     2542                     IF lg-undo-retry
     2543                     THEN DO:
     2544                            assign lg-relat-erro = yes.
     2545                            RUN pi-cria-tt-erros(ds-mensagem-aux).
     2546                          END.
     2547                   END.
     2548              ELSE DO:
     2549                     assign lg-relat-erro = yes.
     2550                     RUN pi-cria-tt-erros(ds-mensagem-aux).
     2551                   END.
     2552            end.
     2553   
     2554       IF lg-validar-cpf-aux
     2555       THEN DO:
     2556              run rtp/rtcgccpf.p (input  import-bnfciar.in-tipo-pessoa,
     2557                                  input  import-bnfciar.cd-cpf,
     2558                                  input  no,
     2559                                  output ds-mensagem-aux,
     2560                                  output lg-erro-aux).
     2561              
     2562              if   lg-erro-aux
     2563              then do:
     2564                     ASSIGN lg-relat-erro = yes.
     2565                     RUN pi-cria-tt-erros(ds-mensagem-aux).
     2566                   end.
     2567            END.
     2568   
     2569       /* ----------------- CAMPOS ESPECIFICOS ---------- */
     2570       run consiste-campos-espec.
     2571   
     2572      
     2573       /* ----------------------- Carteira Antiga ----------------------*/  
     2574       if import-bnfciar.cd-carteira-antiga = 0
     2575       then do:
     2576              assign lg-relat-erro = yes.
     2577              RUN pi-cria-tt-erros("Codigo da Carteira antiga deve ser informado").
     2578            end.
     2579    
     2580       IF CAN-FIND (FIRST b-usuario USE-INDEX usuari26
     2581                    WHERE b-usuario.cd-carteira-antiga = import-bnfciar.cd-carteira-antiga)
     2582       then do:           
     2583              assign lg-relat-erro = yes.
     2584              RUN pi-cria-tt-erros("Beneficiario ja cadastrado com esta carteira antiga").
     2585            end.
     2586   
     2587       /* ------------------------------------------------------------------- */      
     2588       if  (int(import-bnfciar.in-est-civil) >= 1  
     2589       and  int(import-bnfciar.in-est-civil) <= 5)
     2590        or  int(import-bnfciar.in-est-civil)  = 9
     2591       then.
     2592       else do:
     2593              assign lg-relat-erro = yes.
     2594              RUN pi-cria-tt-erros("Estado Civil Invalido").
     2595            end.
     2596   
     2597       /* --------------------------- CBO ------------------------------------- */
     2598       if  import-bnfciar.cd-cbo = 0
     2599       and  not lg-medocup-aux 
     2600       then do:
     2601              assign lg-relat-erro = yes.                                  
     2602              RUN pi-cria-tt-erros("CBO deve ser informado para Modalidade de Medicina Ocupacional").
     2603            end.
     2604   
     2605       if import-bnfciar.cd-cbo <> 0
     2606       AND NOT CAN-FIND (FIRST dz-cbo02 where dz-cbo02.cd-cbo = import-bnfciar.cd-cbo)
     2607       then do:
     2608              assign lg-relat-erro = yes.                                                  
     2609              RUN pi-cria-tt-erros("CBO nao cadastrado").
     2610            end.
     2611   
     2612       /*------------------------------------------------------------------------*/
     2613       /*----------------- VERIFICA SE CBO POSSUI PROCEDIMENTOS -----------------*/ 
     2614       /*------------------------------------------------------------------------*/
     2615       if modalid.cd-tipo-medicina = cd-tipo-medi-aux
     2616       AND NOT CAN-FIND (first cboproce use-index cboproc2
     2617                         where cboproce.cd-cbo       = import-bnfciar.cd-cbo
     2618                           and cboproce.cd-transacao = cd-perio-aux)
     2619       then do:
     2620              IF NOT CAN-FIND (first fundepri 
     2621                               where fundepri.cd-modalidade   = import-bnfciar.cd-modalidade
     2622                                 and fundepri.nr-proposta     = propost.nr-proposta
     2623                                 and fundepri.cd-departamento = import-bnfciar.cd-departamento
     2624                                 and fundepri.cd-secao        = import-bnfciar.cd-secao
     2625                                 and fundepri.cd-setor        = import-bnfciar.cd-setor
     2626                                 and fundepri.cd-cbo          = import-bnfciar.cd-cbo)
     2627              THEN 
     2628              IF NOT CAN-FIND (first fundepri 
     2629                               where fundepri.cd-modalidade   = import-bnfciar.cd-modalidade
     2630                                 and fundepri.nr-proposta     = propost.nr-proposta
     2631                                 and fundepri.cd-departamento = import-bnfciar.cd-departamento
     2632                                 and fundepri.cd-secao        = import-bnfciar.cd-secao
     2633                                 and fundepri.cd-setor        = import-bnfciar.cd-setor
     2634                                 and fundepri.cd-cbo          = 0)
     2635              
     2636              then do:
     2637                     assign lg-relat-erro = yes.                      
     2638                     RUN pi-cria-tt-erros("CBO nao possui exames cadastrados - " +  
     2639                                          if import-bnfciar.cd-cbo <> ?
     2640                                          then string(import-bnfciar.cd-cbo,"99999999")
     2641                                          else "00000000").
     2642                   end.                                              
     2643            end.  
     2644       
     2645       /* ------------------------------------------------------------------- */
     2646       if   import-bnfciar.dt-exclusao-plano = ?
     2647       THEN DO:
     2648              IF propost.dt-libera-doc <> ?
     2649              then do:
     2650                     assign lg-relat-erro = yes.
     2651                     RUN pi-cria-tt-erros("Beneficiario Ativo nao sera incluido em proposta cancelada").
     2652                  end.
     2653   
     2654              /* ------------- TRATAMENTO MOTIVO DO CANCELAMENTO DO BENEFICIARIO --- */
     2655              /* ------- BENEFICIARIO ATIVO COM MOTIVO DE CANCELAMENTO INFORMADO --- */
     2656              if import-bnfciar.cd-motivo-cancel <> 0
     2657              then do:
     2658                     assign lg-relat-erro = yes.
     2659                     RUN pi-cria-tt-erros("Beneficiario Ativo com motivo de cancelamento").
     2660                   end.
     2661            END.
     2662       ELSE /* -------- BENEFICIARIO CANCELADO COM MOTIVO DE CANCELAMENTO ZERO --- */
     2663            if import-bnfciar.cd-motivo-cancel  = 0
     2664            then do:
     2665                   assign lg-relat-erro = yes.
     2666                   RUN pi-cria-tt-erros("Beneficiario cancelado com motivo de cancelamento zero").
     2667                 end.
     2668    
     2669       /* ------------------------------ CONSISTENCIA MOTIVO CANCELAMENTO --- */
     2670       if   import-bnfciar.cd-motivo-cancel <> 0
     2671       AND  import-bnfciar.cd-motivo-cancel <> ?
     2672       AND NOT CAN-FIND (FIRST motcange 
     2673                         where motcange.in-entidade = "MC"
     2674                           and motcange.cd-motivo   = import-bnfciar.cd-motivo-cancel)
     2675       then do:
     2676              assign lg-relat-erro = yes.
     2677              RUN pi-cria-tt-erros("Motivo do cancelamento nao cadastrado: " + STRING(import-bnfciar.cd-motivo-cancel)).
     2678            end.
     2679   
     2680       /* ------------------------------------------------------------------- */
     2681       run rtp/rtidade.p (input  import-bnfciar.dt-nascimento,
     2682                          input  today,
     2683                          output nr-idade-usuario,
     2684                          output lg-erro-aux ).
     2685       IF lg-valida-idade-aux
     2686       AND NOT propost.lg-pea
     2687       THEN DO:
     2688               IF  modalid.lg-usa-faixa-etaria
     2689               AND propost.lg-faixa-etaria-esp = yes
     2690               then do:
     2691                      if  can-find(first teadgrpa where teadgrpa.cd-modalidade      = import-bnfciar.cd-modalidade            
     2692                                                    and teadgrpa.nr-proposta        = propost.nr-proposta 
     2693                                                    and teadgrpa.cd-grau-parentesco = import-bnfciar.cd-grau-parentesco)          
     2694                      then do:
     2695                             assign lg-achou = no.    
     2696            
     2697                             for each teadgrpa FIELDS (nr-idade-minima nr-idade-maxima nr-faixa-etaria)
     2698                                where teadgrpa.cd-modalidade      = import-bnfciar.cd-modalidade 
     2699                                  and teadgrpa.nr-proposta        = propost.nr-proposta
     2700                                  and teadgrpa.cd-grau-parentesco = import-bnfciar.cd-grau-parentesco NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     2701            
     2702                                 if   nr-idade-usuario >= teadgrpa.nr-idade-minima
     2703                                 and  nr-idade-usuario <= teadgrpa.nr-idade-maxima
     2704                                 then do:
     2705                                        assign lg-achou = yes         
     2706                                               nr-faixa-etaria-aux = teadgrpa.nr-faixa-etaria.
     2707                                        leave.
     2708                                      end.
     2709                             end.
     2710            
     2711                             if   not lg-achou
     2712                             then do:
     2713                                    assign lg-relat-erro = yes.
     2714                                    RUN pi-cria-tt-erros("Idade fora de faixa para este grau de parentesco").
     2715                                  end.
     2716                           end.
     2717                      else do:
     2718                             assign lg-relat-erro = yes.
     2719                             RUN pi-cria-tt-erros("Grau de Parentesco nao cadastrado p/termo de Adesao").
     2720                           end.
     2721                    end.
     2722               else do:  
     2723                      if  can-find(first pl-gr-pa 
     2724                                   where pl-gr-pa.cd-modalidade      = import-bnfciar.cd-modalidade
     2725                                     and pl-gr-pa.cd-plano           = propost.cd-plano
     2726                                     and pl-gr-pa.cd-tipo-plano      = propost.cd-tipo-plano
     2727                                     and pl-gr-pa.cd-grau-parentesco = import-bnfciar.cd-grau-parentesco)
     2728                      then do:
     2729                             assign lg-achou = no.    
     2730                             
     2731                             for each pl-gr-pa FIELDS (nr-idade-minima nr-idade-maxima nr-faixa-etaria)
     2732                                where pl-gr-pa.cd-modalidade      = import-bnfciar.cd-modalidade
     2733                                  and pl-gr-pa.cd-plano           = propost.cd-plano
     2734                                  and pl-gr-pa.cd-tipo-plano      = propost.cd-tipo-plano
     2735                                  and pl-gr-pa.cd-grau-parentesco = import-bnfciar.cd-grau-parentesco NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     2736            
     2737                                 if   nr-idade-usuario >= pl-gr-pa.nr-idade-minima
     2738                                 and  nr-idade-usuario <= pl-gr-pa.nr-idade-maxima
     2739                                 then do:
     2740                                        assign lg-achou = yes
     2741                                               nr-faixa-etaria-aux = pl-gr-pa.nr-faixa-etaria.
     2742                                        leave.
     2743                                      end.
     2744                             end.
     2745                             if   not lg-achou
     2746                             and (import-bnfciar.dt-exclusao-plano = ? 
     2747                              or  import-bnfciar.dt-exclusao-plano > today)
     2748                             then do:
     2749                                    assign lg-relat-erro = yes.
     2750                                    RUN pi-cria-tt-erros("Idade fora de faixa para este grau de parentesco. Modalidade: " + STRING(import-bnfciar.cd-modalidade) + 
     2751                                                         " Plano: "         + STRING(propost.cd-plano) +
     2752                                                         " Tipo de Plano: " + STRING(propost.cd-tipo-plano) +
     2753                                                         " Grau: "          + STRING(import-bnfciar.cd-grau-parentesco) + 
     2754                                                         " Idade: "         +  string(nr-idade-usuario)).
     2755                                  end.
     2756                           end.
     2757                      else do:
     2758                             assign lg-relat-erro = yes.
     2759                             RUN pi-cria-tt-erros("Grau de Parentesco nao cadastrado para Plano").
     2760                           end.
     2761                    end.
     2762            END.
     2763   
     2764       /* ------------------------------------------------------------------- */
     2765       /* Verifica de tipo de plano recebe repasse */
     2766       if   ti-pl-sa.in-tipo-movto-recebido <> 0
     2767       then do:
     2768              IF CAN-FIND (FIRST import-negociac-bnfciar WHERE import-negociac-bnfciar.num-seqcial-bnfciar = import-bnfciar.num-seqcial-bnfciar)
     2769              THEN DO:
     2770                     IF NOT CAN-FIND (FIRST unimed where unimed.cd-unimed = import-bnfciar.cd-unimed-origem)
     2771                     then do:
     2772                            assign lg-relat-erro = yes.
     2773                            RUN pi-cria-tt-erros("Codigo da unidade origem nao cadastrado: " +
     2774                                                 if import-bnfciar.cd-unimed-origem <> ?
     2775                                                 then string(import-bnfciar.cd-unimed-origem,"9999")
     2776                                                 else "0000").
     2777                          end.
     2778                     
     2779                     /*--- Valida o campo de Identificacao Origem do Beneficiario ---*/
     2780                     if  import-bnfciar.cd-unimed-origem        = 0
     2781                     and import-bnfciar.cd-identific-uni-origem = 0
     2782                     then do:
     2783                            assign lg-relat-erro = yes.
     2784                            RUN pi-cria-tt-erros("Codigo Identif na unidade Origem deve ser informado: " +
     2785                                                 if import-bnfciar.cd-identific-uni-origem <> ?
     2786                                                 then string(import-bnfciar.cd-identific-uni-origem,"9999999999999")
     2787                                                 else "0000000000000").
     2788                          end.
     2789                           
     2790                     /*------ Valida o campo de Identificacao Origem -----------------------*/
     2791                     if import-bnfciar.cd-identific-orig-resp  = 0 
     2792                     or import-bnfciar.cd-identific-uni-origem = 0
     2793                     then do:
     2794                            assign lg-relat-erro = yes.
     2795                            RUN pi-cria-tt-erros("Cod Identif Origem deve ser informado. Respons: " +
     2796                                                 if import-bnfciar.cd-identific-orig-resp <> ?
     2797                                                 then string(import-bnfciar.cd-identific-orig-resp,"9999999999999")
     2798                                                 else "9999999999999" + 
     2799                                                 " Benef: " +  
     2800                                                 if import-bnfciar.cd-identific-uni-origem <> ?
     2801                                                 then string(import-bnfciar.cd-identific-uni-origem,"9999999999999")
     2802                                                 else "9999999999999").
     2803                          end.
     2804                     
     2805                     /*------------ CONSISTE DATA DE INCLUSAO PLANO ORIGEM -------------*/
     2806                     if import-bnfciar.dt-inclusao-origem <> ?
     2807                     then do:
     2808                            if ti-pl-sa.in-tipo-movto-recebido = 1  /* repasse */
     2809                            then do:
     2810                                   if import-bnfciar.dt-inclusao-origem  > import-bnfciar.dt-inclusao-plano 
     2811                                   then do:
     2812                                          assign lg-relat-erro = yes.
     2813                                          RUN pi-cria-tt-erros("Dt Incl Plano origem: "   +
     2814                                                               if import-bnfciar.dt-inclusao-origem <> ?
     2815                                                               then string(import-bnfciar.dt-inclusao-origem,"99/99/9999")
     2816                                                               else "00/00/0000" +                                      
     2817                                                               " deve ser menor que incl plano atual: "       +
     2818                                                               if import-bnfciar.dt-inclusao-plano <> ?
     2819                                                               then string(import-bnfciar.dt-inclusao-plano,"99/99/9999")
     2820                                                               else "00/00/0000").
     2821                                        end.
     2822                                 end.
     2823                            else do:    
     2824                                   if ti-pl-sa.in-tipo-movto-recebido = 0
     2825                                   then assign ds-movto-aux = "00 - Contratos".
     2826                                   else if ti-pl-sa.in-tipo-movto-recebido = 2
     2827                                        then assign ds-movto-aux = "02 - Produtos".
     2828                     
     2829                                   assign lg-relat-erro = yes.
     2830                                   RUN pi-cria-tt-erros("Tipo plano nao permite incl benef repassados. Movto permitido p/Tipo Plano: " + ds-movto-aux).
     2831                                 end.
     2832                          end.
     2833                   END.
     2834            end.
     2835       else do:
     2836              if import-bnfciar.cd-unimed-origem <> 0
     2837              then do:
     2838                     assign lg-relat-erro = yes.
     2839                     RUN pi-cria-tt-erros("Modalidade nao indica beneficiario de outra unidade").
     2840                   end.
     2841                  
     2842              if import-bnfciar.cd-identific-uni-origem <> 0
     2843              then do:
     2844                     assign lg-relat-erro = yes.
     2845                     RUN pi-cria-tt-erros("Unidade origem zerada, identificacao nao pode ser preenchida").
     2846                   end.
     2847                
     2848              if import-bnfciar.cd-plano-origem <> ""
     2849              then do:
     2850                     assign lg-relat-erro = yes.
     2851                     RUN pi-cria-tt-erros("Unidade origem zerada, plano origem nao pode ser preenchido").
     2852                   end.
     2853              
     2854              if import-bnfciar.nom-plano-orig <> ""
     2855              then do:
     2856                     assign lg-relat-erro = yes.
     2857                     RUN pi-cria-tt-erros("Plano origem zerado, nome nao pode ser preenchido").
     2858                   end.
     2859                   
     2860              if import-bnfciar.cd-identific-orig-resp <> 0 
     2861              then do:
     2862                     assign lg-relat-erro = yes.
     2863                     RUN pi-cria-tt-erros("Unidade origem zerada, identific resp nao pode ser preenchida").
     2864                   end.
     2865                    
     2866              if import-bnfciar.dt-inclusao-origem <> ?
     2867              then do:
     2868                     assign lg-relat-erro = yes.
     2869                     RUN pi-cria-tt-erros("Md nao indica benef de outra unidade, dt incl plano origem nao pode ser preenchida").
     2870                   end.
     2871            end.
     2872       
     2873       /* ------------------------------------------------------------------- */
     2874       IF NOT lg-gerar-termo-aux
     2875       THEN if   propost.cd-sit-proposta > modalid.cd-sit-proposta
     2876            then do:
     2877                   assign lg-relat-erro = yes.       
     2878                   RUN pi-cria-tt-erros("Situacao da Proposta nao permite inclusao do beneficiario").
     2879                 end.
     2880        
     2881       /* ------------------------------------------------------------------- */
     2882       if   not propost.lg-mascara
     2883       then do:
     2884              if   import-bnfciar.cd-funcionario <> ""
     2885              then do:
     2886                     assign lg-relat-erro = yes.
     2887                     RUN pi-cria-tt-erros("Parametro nao definido para codigo do funcionario").
     2888                   end.
     2889            end.   
     2890       else do:
     2891              if   propost.ds-mascara <> ""
     2892              and  import-bnfciar.cd-funcionario = ""
     2893              then do:
     2894                     assign lg-relat-erro = yes.
     2895                     RUN pi-cria-tt-erros("Codigo do funcionario deve ser informado").
     2896                   end.
     2897              
     2898              if   import-bnfciar.cd-funcionario <> ""
     2899              then do: 
     2900                     run mcp/mc0111a5.p (input  propost.ds-mascara,
     2901                                         input  import-bnfciar.cd-funcionario,
     2902                                         input  "F",
     2903                                         output lg-critica,
     2904                                         output ds-mascara-aux).
     2905                               
     2906                     if   lg-critica
     2907                     then do:
     2908                            assign lg-relat-erro = yes.
     2909                            RUN pi-cria-tt-erros("Codigo do Funcionario esta Fora do Padrao").
     2910                          end.
     2911                   
     2912                     if   import-bnfciar.log-respons
     2913                     then do:
     2914                            IF CAN-FIND (first usuario USE-INDEX usuario9 
     2915                                         where usuario.cd-modalidade     = propost.cd-modalidade
     2916                                           and usuario.nr-proposta       = propost.nr-proposta
     2917                                           and usuario.cd-funcionario    =  ds-mascara-aux
     2918                                           and usuario.dt-exclusao-plano = ? )
     2919                            then do:
     2920                                   assign lg-relat-erro = yes.
     2921                                   RUN pi-cria-tt-erros("Ja existe outro responsavel com este codigo").
     2922                                 end.
     2923                          end.
     2924                   end.       
     2925            end.
     2926    
     2927       /* ---------------------------- GRAU PARENTESCO -------------------- */
     2928       IF NOT CAN-FIND (FIRST gra-par where gra-par.cd-grau-parent = int(import-bnfciar.cd-grau-parentesco))
     2929       then do:
     2930              assign lg-relat-erro = yes.
     2931              RUN pi-cria-tt-erros("Grau de Parentesco nao Cadastrado").
     2932            end.
     2933    
     2934       if not import-bnfciar.log-respons
     2935       and    import-bnfciar.cd-grau-parentesco = ti-pl-sa.cd-grau-parentesco
     2936       and    ti-pl-sa.lg-obriga-responsavel
     2937       then do:
     2938              assign lg-relat-erro = yes.
     2939              RUN pi-cria-tt-erros("Beneficiario possui grau de parentesco de Responsavel mas LOG-RESPONS está FALSE").
     2940            end.
     2941       /* ------------------ DATA DE INCLUSAO DO PLANO ---------------------*/
     2942       if import-bnfciar.dt-inclusao-plano < propost.dt-proposta
     2943       then do:
     2944              assign lg-relat-erro = yes.
     2945              RUN pi-cria-tt-erros("Data de inclusao do Plano e menor que data da Proposta").
     2946            end.
     2947       
     2948        /* ------------------------- UF ------------------------------- */
     2949        if import-bnfciar.en-uf <> ""
     2950        AND import-bnfciar.en-uf <> ?
     2951        AND NOT CAN-FIND (FIRST dzestado 
     2952                          where dzestado.nm-pais = "BRASIL"
     2953                            and dzestado.en-uf   = import-bnfciar.en-uf)
     2954        then do:
     2955               assign lg-relat-erro = yes.
     2956               RUN pi-cria-tt-erros("Estado nao Cadastrado ").
     2957             end.
     2958    
     2959       /* ------------------------------------------------------------------- */
     2960       FOR FIRST b-usuario FIELDS (cd-funcionario cd-titular cd-modalidade nr-proposta) USE-INDEX usuari26
     2961           where b-usuario.cd-carteira-antiga = import-bnfciar.cd-carteira-origem-responsavel
     2962             and b-usuario.cd-usuario         = b-usuario.cd-titular NO-LOCK:
     2963       END.
     2964       
     2965       /* ------------------------------------------------------------------- */
     2966       ASSIGN cd-titular-aux = 0.
     2967   
     2968       if   import-bnfciar.log-respons 
     2969       AND  ti-pl-sa.lg-obriga-responsavel
     2970       then do: 
     2971              if   import-bnfciar.cd-carteira-origem-responsavel <> import-bnfciar.cd-carteira-antiga        
     2972              then do: 
     2973                     assign lg-relat-erro = yes.
     2974                     RUN pi-cria-tt-erros("Indicador de Responsavel (log-respons=yes) mas carteira origem diferente (cd-carteira-origem-responsavel <> cd-carteira-antiga)").
     2975                   end.
     2976            end.
     2977       else if avail b-usuario                
     2978            then do:
     2979                   if   import-bnfciar.cd-funcionario <> b-usuario.cd-funcionario
     2980                   then do:
     2981                          assign lg-relat-erro = yes.
     2982                          RUN pi-cria-tt-erros("Codigo do Funcionario informado difere do responsavel").
     2983                        end.
     2984   
     2985                   /**
     2986                    * Verificar se o titular foi criado em outro contrato.
     2987                    */
     2988                   IF import-bnfciar.cd-modalidade <> b-usuario.cd-modalidade
     2989                   OR nr-proposta-imp-aux          <> b-usuario.nr-proposta
     2990                   then do:
     2991                          assign lg-relat-erro = yes.
     2992                          RUN pi-cria-tt-erros("Responsavel foi criado em outra proposta. Verifique os DE/PARAS da Estrutura do Produto. Mod.Resp: " +
     2993                                               STRING(b-usuario.cd-modalidade) + " Prop.Resp: " + 
     2994                                               STRING(b-usuario.nr-proposta)   + " Mod.Dep: " + 
     2995                                               STRING(import-bnfciar.cd-modalidade) + " Prop.Dep: " +
     2996                                               STRING(nr-proposta-imp-aux) + "Cart.Antiga Resp.: " +
     2997                                               STRING(import-bnfciar.cd-carteira-origem-responsavel) + " Carteira Antiga Dep.: " +
     2998                                               STRING(import-bnfciar.cd-carteira-antiga)).
     2999                        end.
     3000    
     3001                   assign cd-titular-aux = b-usuario.cd-titular.             
     3002                 end. 
     3003         
     3004       if   import-bnfciar.dt-nascimento > today
     3005       then do:
     3006              assign lg-relat-erro = yes.
     3007              RUN pi-cria-tt-erros("Data de Nascimento Invalida.").
     3008            end.
     3009      
     3010        if   import-bnfciar.dt-nascimento > import-bnfciar.dt-inclusao-plano
     3011        then do:
     3012               assign lg-relat-erro = yes.
     3013               RUN pi-cria-tt-erros("Data de Inclusao no Plano Invalida").
     3014             end.
     3015        
     3016        if  import-bnfciar.dt-admissao = ?
     3017        THEN DO:
     3018               IF modalid.cd-tipo-medicina = cd-tipo-medi-aux
     3019               then do:
     3020                      assign lg-relat-erro = yes.
     3021                      RUN pi-cria-tt-erros("Para Modalidade de Medicina Ocupacional, Data de admissao Deve ser Informada").
     3022                    end. 
     3023             END.
     3024        ELSE if  import-bnfciar.dt-admissao < import-bnfciar.dt-nascimento
     3025             then do:
     3026                    assign lg-relat-erro = yes.
     3027                    RUN pi-cria-tt-erros("Data de admissao nao pode ser menor que de nascimento").
     3028                  end.
     3029        
     3030        IF NOT lg-relat-erro
     3031        THEN run responsavel.
     3032    
     3033       /*----------------------------- DIGITO VERIFICADOR DO PIS ---------------------*/
     3034       if import-bnfciar.cd-pis-pasep <> 0
     3035       then do:
     3036              assign nr-digito-aux = int(SUBstr(STRING(import-bnfciar.cd-pis-pasep,"99999999999"),11,1)).
     3037              
     3038              run rtp/rtdigver.p("PIS",
     3039                                 yes,
     3040                                 SUBstr(STRING(import-bnfciar.cd-pis-pasep,"99999999999"),1,10),
     3041                                 no,
     3042                                 output ds-mensagem-aux,
     3043                                 output lg-undo-retry,
     3044                                 input-output nr-digito-aux).
     3045              
     3046              if not lg-undo-retry
     3047              then do:
     3048                     assign lg-relat-erro = yes.
     3049                     RUN pi-cria-tt-erros("Codigo do PIS/PASEP Invalido: " +
     3050                                          if import-bnfciar.cd-pis-pasep <> ?
     3051                                          then string(import-bnfciar.cd-pis-pasep,"99999999999")
     3052                                          else "99999999999" + " " + trim(ds-mensagem-aux)).
     3053                   end.
     3054            end.
     3055       
     3056       /*----------------------------- Valida faixa do segmento assistencial ---------------------*/
     3057       if import-bnfciar.in-segmento-assistencial <> 0
     3058       AND lookup(string(import-bnfciar.in-segmento-assistencial,"99"),lista-segmento-posicao-aux) = 0
     3059       then do:
     3060              assign lg-relat-erro = yes.
     3061              RUN pi-cria-tt-erros("Codigo Segmento Assistencial Invalido " +
     3062                                   if import-bnfciar.in-segmento-assistencial <> ?
     3063                                   then string(import-bnfciar.in-segmento-assistencial,"99")
     3064                                   else "00").
     3065            end.
     3066   
     3067       /* ------- VERIFICA DATA TITULAR SUPERIOR DEPENDENTE ------ */
     3068       if   import-bnfciar.cd-carteira-origem-responsavel <> import-bnfciar.cd-carteira-antiga
     3069       then do:
     3070              /* ----- LOCALIZA BENEFICIARIO RESP BASE ------ */
     3071              FOR first b-usuario FIELDS (dt-inclusao-plano)
     3072                  where b-usuario.cd-carteira-antiga = import-bnfciar.cd-carteira-origem-responsavel NO-LOCK:
     3073              END.
     3074              
     3075              IF NOT AVAIL b-usuario
     3076              THEN do:
     3077   
     3078                     assign lg-relat-erro = yes.
     3079                     RUN pi-cria-tt-erros("Beneficiario Responsavel nao cadastrado. Carteira Antiga: " +
     3080                                          STRING(import-bnfciar.cd-carteira-antiga) +
     3081                                          " Carteira Responsavel: " +
     3082                                          STRING(import-bnfciar.cd-carteira-origem-responsavel)).
     3083   
     3084                   end.
     3085   
     3086              ELSE if import-bnfciar.dt-inclusao-plano < b-usuario.dt-inclusao-plano
     3087                   then do:
     3088                          assign lg-relat-erro = yes.
     3089                          RUN pi-cria-tt-erros("Dt.Incl.Dep. e menor que a dt. incl.Resp. Dt.Incl.Dep.:" +
     3090                                               if import-bnfciar.dt-inclusao-plano <> ?
     3091                                               then string(import-bnfciar.dt-inclusao-plano,"99/99/9999")
     3092                                               else "00/00/0000" + 
     3093                                               " Dt.Incl.Resp.:" + 
     3094                                               if b-usuario.dt-inclusao-plano <> ?
     3095                                               then string(b-usuario.dt-inclusao-plano,"99/99/9999")
     3096                                               else "00/00/0000").
     3097                        end.
     3098            end.
     3099    
     3100       /* ---------------------- NOME DO USUARIO ----------------------*/
     3101       if   import-bnfciar.nom-usuar = "" 
     3102       then do:
     3103              assign lg-relat-erro = yes.
     3104              RUN pi-cria-tt-erros("Nome do Beneficiario em Branco.").
     3105            end.
     3106       
     3107       if  propost.lg-altera-taxa-inscricao 
     3108       AND import-bnfciar.log-inscr-fatur = ?
     3109       then do: 
     3110              assign lg-relat-erro = yes.
     3111              RUN pi-cria-tt-erros("Indicador Taxa Insc. Fatura deve ser informado").
     3112            end.
     3113   
     3114       if propost.lg-altera-fator-moderador 
     3115       then do: 
     3116              if import-bnfciar.log-cobr-fator-moder = ?
     3117              then do: 
     3118                     assign lg-relat-erro = yes.
     3119                     RUN pi-cria-tt-erros("Indicador Cobra Fator Partic. deve ser informado").
     3120                    end.
     3121   
     3122               assign lg-insc-fat-aux = import-bnfciar.log-cobr-fator-moder.
     3123            end.
     3124       else assign lg-insc-fat-aux = yes.
     3125          
     3126       if   import-bnfciar.dt-exclusao-plano < import-bnfciar.dt-inclusao-plano
     3127       then do:
     3128              assign lg-relat-erro = yes.
     3129              RUN pi-cria-tt-erros("Data da exclusao no Plano menor do que data de inclusao ").
     3130            end.
     3131   
     3132       /* -------------------------------------------------------- */
     3133       if not ti-pl-sa.lg-usa-padrao-cobertura
     3134       then do:
     3135              if import-bnfciar.cd-padrao-cob <> ""
     3136              then do:
     3137                     assign lg-relat-erro = yes.
     3138                     RUN pi-cria-tt-erros("Tipo de Plano nao aceita padrao de cobertura ").
     3139                   end.          
     3140            end.
     3141       else do:
     3142              if import-bnfciar.cd-padrao-cob = ""
     3143              then do:
     3144                     assign lg-relat-erro = yes.
     3145                     RUN pi-cria-tt-erros("Codigo do Padrao de Cobertura nao Informado " +
     3146                                          if import-bnfciar.cd-padrao-cob <> ?
     3147                                          then import-bnfciar.cd-padrao-cob
     3148                                          else "").
     3149                   end.
     3150              else do:
     3151                     /*
     3152                     /*------- Rotina Congelamento Padrao Cobertura -------*/  
     3153                     run rtp/rtconpad.p(input   import-bnfciar.cd-modalidade,
     3154                                        input   propost.nr-proposta,
     3155                                        input   import-bnfciar.cd-padrao-cob,
     3156                                        input   lg-mensagem, 
     3157                                        output  cd-tipo-mens,
     3158                                        output  ds-tipo-mens,
     3159                                        output  lg-retorna). 
     3160       
     3161                     if   cd-tipo-mens = "E"
     3162                     then do: 
     3163                            assign lg-relat-erro = yes.
     3164                            RUN pi-cria-tt-erros(ds-tipo-mens).
     3165                          end.
     3166                     */
     3167                     /*----------------------------------------------------*/            
     3168                   end.       
     3169            end.                                               
     3170        
     3171       if   import-bnfciar.dt-mvto-alteracao <> ?
     3172       AND (import-bnfciar.dt-mvto-alteracao < import-bnfciar.dt-inclusao-plano 
     3173       or   import-bnfciar.dt-mvto-alteracao > import-bnfciar.dt-exclusao-plano)
     3174       then do:
     3175              assign lg-relat-erro = yes.
     3176              RUN pi-cria-tt-erros("Data movto alteracao deve estar em periodo onde beneficiario esteja ativo").
     3177            end.
     3178       
     3179       /*----- PROPOSTA PEA ----------------------------------------------------*/
     3180       if propost.lg-pea
     3181       THEN DO:
     3182              if import-bnfciar.dt-exclusao-plano = ?
     3183              then do:
     3184                     assign lg-relat-erro = yes.
     3185                     RUN pi-cria-tt-erros("PEA - Beneficiario ativo nao sera incluido em proposta Cancelada").
     3186                   end.
     3187              ELSE IF import-bnfciar.dt-exclusao-plano > propost.dt-libera-doc
     3188                   then do:
     3189                          run atual-datas.
     3190                          assign propost.dt-libera-doc = import-bnfciar.dt-exclusao-plano.
     3191                        end.   
     3192   
     3193              IF import-bnfciar.dt-falecimento-titular = ?  
     3194              then do:
     3195                     assign lg-relat-erro = yes.
     3196                     RUN pi-cria-tt-erros("PEA - Data do falecimento do titular deve ser Informada").
     3197                   end.
     3198              ELSE IF import-bnfciar.dt-inclusao-plano < import-bnfciar.dt-falecimento-titular
     3199                   then do:
     3200                          assign lg-relat-erro = yes.
     3201                          RUN pi-cria-tt-erros("PEA - Data de Inclusao menor que data de Falecimento ").
     3202                        end. 
     3203   
     3204              if  import-bnfciar.log-respons 
     3205              and import-bnfciar.dt-inclusao-plano <> import-bnfciar.dt-exclusao-plano
     3206              then do:
     3207                     assign lg-relat-erro = yes.
     3208                     run pi-cria-tt-erros("PEA - Responsavel Sinistrado deve possuir mesma data de Inclusao/Exclusao").
     3209                   end. 
     3210   
     3211              /* Codigo de cliente do benef. substituto */
     3212              if  import-bnfciar.num-livre-10 <> 0
     3213              and import-bnfciar.num-livre-10 <> ?
     3214              then do:
     3215                     if not can-find(first ems5.cliente 
     3216                                     where ems5.cliente.cod_empresa = string(paramecp.ep-codigo)
     3217                                       and ems5.cliente.cdn_cliente = import-bnfciar.num-livre-10)
     3218                     then do:
     3219                             assign lg-relat-erro = YES.
     3220                             run pi-cria-tt-erros ("PEA - Beneficiario Substituto nao Cadastrado como Cliente no EMS").
     3221                          end.
     3222                   end.
     3223            END. 
     3224       ELSE DO:
     3225              if import-bnfciar.dt-falecimento-titular <> ? 
     3226              then do:
     3227                     assign lg-relat-erro = yes.
     3228                     RUN pi-cria-tt-erros("Data do falecimento nao deve ser informada").
     3229                   end.  
     3230   
     3231              if import-bnfciar.dt-exclusao-plano <> ? 
     3232              then do:
     3233                     if import-bnfciar.dt-exclusao-plano > propost.dt-libera-doc
     3234                     then do:
     3235                            assign lg-relat-erro = yes.
     3236                            RUN pi-cria-tt-erros("Data da exclusao no Plano maior que data de cancelamento da proposta").
     3237                          end.
     3238   
     3239                     /* ----------------------- ULTIMO DIA DO MES DE REALIZACAO --- */
     3240                     run rtp/rtultdia.p (input  year (import-bnfciar.dt-exclusao-plano),
     3241                                         input  month(import-bnfciar.dt-exclusao-plano),
     3242                                         output dt-fim-aux).
     3243                    
     3244                     if  (year (dt-fim-aux)< import-bnfciar.aa-ult-fat-period) or 
     3245                         (month(dt-fim-aux)< import-bnfciar.num-mes-ult-faturam and
     3246                          year(dt-fim-aux) = import-bnfciar.aa-ult-fat-period)
     3247                     then do:
     3248                            assign lg-relat-erro = yes.
     3249                            RUN pi-cria-tt-erros("Data da exclusao menor que o ultimo faturamento do beneficiario").
     3250                          end.  
     3251                   end.
     3252            END.
     3253       
     3254       if   import-bnfciar.dt-falecimento-titular <> ?  
     3255       THEN DO:
     3256              if   import-bnfciar.dt-falecimento-titular > today
     3257              then do:
     3258                     assign lg-relat-erro = yes.
     3259                     RUN pi-cria-tt-erros("Data de falecimento do titular maior que a atual.").
     3260                   end.
     3261   
     3262              if ti-pl-sa.lg-obriga-responsavel = no
     3263              then do:
     3264                     assign lg-relat-erro = yes.
     3265                     RUN pi-cria-tt-erros("Tipo de Plano deve obrigar responsavel em prop. seguro assist.").
     3266                   end.
     3267            END.
     3268        
     3269       if import-bnfciar.dt-atualizacao-carencia <> ? 
     3270       then do:
     3271              IF import-bnfciar.cd-userid-carencia = ""
     3272              THEN DO:
     3273                     assign lg-relat-erro = yes.
     3274                     RUN pi-cria-tt-erros("Data da atualiz. Carencia informada Usu atualiz. Carencia nao Informado.").
     3275                   END.
     3276              
     3277              if import-bnfciar.dt-atualizacao-carencia < import-bnfciar.dt-inclusao-plano 
     3278              or import-bnfciar.dt-atualizacao-carencia > import-bnfciar.dt-exclusao-plano
     3279              then do:
     3280                     assign lg-relat-erro = yes.
     3281                     RUN pi-cria-tt-erros("Data atual. carencia deve estar em periodo onde o beneficiario esteja ativo").
     3282                   end.
     3283            end.
     3284       
     3285       if import-bnfciar.dt-inicio-vinculo-unidade > import-bnfciar.dt-inclusao-plano 
     3286       then do:
     3287              assign lg-relat-erro = yes.
     3288              RUN pi-cria-tt-erros("Data Inicio do vinculo Maior que data de Inclusao").
     3289            end.
     3290          
     3291       /*---- verifica se  mes e ano diferentes ----   */
     3292       if (import-bnfciar.num-mes-ult-faturam <> 0 and
     3293           import-bnfciar.aa-ult-fat-period = 0 ) 
     3294       or (import-bnfciar.num-mes-ult-faturam = 0 and 
     3295           import-bnfciar.aa-ult-fat-period <> 0 ) 
     3296       then do:
     3297              assign lg-relat-erro = yes.
     3298              RUN pi-cria-tt-erros("Mes/Ano  do ultimo faturamento difere da data de Inicio da proposta").
     3299            end.
     3300           
     3301       /*Comentado 30/06/16*/
     3302      /*if import-bnfciar.num-mes-ult-faturam <> 0  and
     3303          import-bnfciar.aa-ult-fat-period   <> 0 
     3304       then do: 
     3305              if import-bnfciar.aa-ult-fat-period < year(import-bnfciar.dt-inclusao-plano)
     3306              then do:
     3307                     assign lg-relat-erro = yes.
     3308                     RUN pi-cria-tt-erros("Data do ultimo faturamento difere da data de Inicio da proposta").
     3309                   end.
     3310              
     3311              if  import-bnfciar.aa-ult-fat-period   =  year(import-bnfciar.dt-inclusao-plano)                
     3312              and import-bnfciar.num-mes-ult-faturam < month(import-bnfciar.dt-inclusao-plano)
     3313              then do:
     3314                     assign lg-relat-erro = yes.
     3315                     RUN pi-cria-tt-erros("Data do ultimo faturamento difere da data de Inicio da proposta").
     3316                   end.
     3317            end.*/
     3318       
     3319       /* --------------------------------------------------------------------- */
     3320       if   import-bnfciar.num-mes-ult-faturam <> 0
     3321       and  import-bnfciar.num-mes-ult-faturam <> int(substr(propost.mm-aa-ult-fat-mig,1,2))
     3322       then if  year(import-bnfciar.dt-exclusao-plano) <> 0
     3323            then if  int(substr(propost.mm-aa-ult-fat-mig,3,4)) < import-bnfciar.aa-ult-fat-period
     3324                 or (int(substr(propost.mm-aa-ult-fat-mig,3,4)) = import-bnfciar.aa-ult-fat-period
     3325                 and int(substr(propost.mm-aa-ult-fat-mig,1,2)) < import-bnfciar.num-mes-ult-faturam)
     3326                 then do:
     3327                        /* Comentado 30/06 */
     3328                        /*assign lg-relat-erro = yes.
     3329                        RUN pi-cria-tt-erros("Ultimo faturamento do Benf. MAIOR que da proposta").*/
     3330                      end.
     3331                 else.
     3332            else do:
     3333                   assign lg-relat-erro = yes.
     3334                   RUN pi-cria-tt-erros("Mes de referencia da ultima fatura invalida").
     3335                 end.
     3336              
     3337       IF lg-gerar-termo-aux
     3338       THEN DO:
     3339              IF AVAIL ter-ade
     3340              THEN DO:
     3341                     if  import-bnfciar.aa-ult-fat-period <> 0 
     3342                     and import-bnfciar.aa-ult-fat-period <> ter-ade.aa-ult-fat
     3343                     then if  year(import-bnfciar.dt-exclusao-plano) <>  0
     3344                          then if  ter-ade.aa-ult-fat < import-bnfciar.aa-ult-fat-period
     3345                               then do:
     3346                                      assign lg-relat-erro = yes.
     3347                                      RUN pi-cria-tt-erros("Ano ultimo faturamento MAIOR que o do TERMO").
     3348                                    end.    
     3349                               else.
     3350                          else do:
     3351                                 assign lg-relat-erro = yes.
     3352                                 RUN pi-cria-tt-erros("Ano de referencia da ultima fatura invalida (TERMO)").
     3353                               end.                                           
     3354                   END.
     3355   
     3356            END.
     3357       ELSE DO:
     3358              if  import-bnfciar.aa-ult-fat-period <> 0 
     3359              and import-bnfciar.aa-ult-fat-period <> int(substr(propost.mm-aa-ult-fat-mig,3,4))
     3360              then if  year(import-bnfciar.dt-exclusao-plano) <>  0
     3361                   then if  int(substr(propost.mm-aa-ult-fat-mig,3,4)) < import-bnfciar.aa-ult-fat-period
     3362                        then do:
     3363                               assign lg-relat-erro = yes.
     3364                               RUN pi-cria-tt-erros("Ano ultimo faturamento MAIOR que o da proposta").
     3365                             end.    
     3366                        else.
     3367                   else do:
     3368                          assign lg-relat-erro = yes.
     3369                          RUN pi-cria-tt-erros("Ano de referencia da ultima fatura invalida").
     3370                        end.                                           
     3371            END.
     3372       /* ------------------ Padrao de Cob. Anterior ------------------*/
     3373       if not ti-pl-sa.lg-usa-padrao-cobertura
     3374       then do:
     3375              if import-bnfciar.cd-padrao-cob-ant <> ""
     3376              then do:
     3377                     assign lg-relat-erro = yes.
     3378                     RUN pi-cria-tt-erros("Tipo de Plano nao aceita padrao de cobertura").
     3379                   end.          
     3380            end.
     3381       else do:
     3382              if import-bnfciar.cd-padrao-cob-ant <> ""
     3383              then do:
     3384                     /*------- Rotina Congelamento Padrao Cobertura -------*/  
     3385                     run rtp/rtconpad.p(input  import-bnfciar.cd-modalidade,
     3386                                        input  propost.nr-proposta,
     3387                                        input  import-bnfciar.cd-padrao-cob,
     3388                                        input  lg-mensagem, 
     3389                                        output cd-tipo-mens,
     3390                                        output ds-tipo-mens,
     3391                                        output lg-retorna). 
     3392                     
     3393                     if cd-tipo-mens = "E"
     3394                     then do: 
     3395                            assign lg-relat-erro = yes.
     3396                            RUN pi-cria-tt-erros(ds-tipo-mens).
     3397                          end.
     3398                   end.
     3399            end.
     3400       
     3401       /*----- MEDICINA OCUPACIONAL --------------------------------------------*/
     3402       if not lg-medocup-aux
     3403       then do:
     3404              /*----- VERIFICA SE CAMPOS ZERADOS -------------------------------*/
     3405              if   import-bnfciar.cd-departamento = 0
     3406              then do:
     3407                     assign lg-relat-erro   = yes
     3408                            lg-medocup-erro = yes.
     3409                     RUN pi-cria-tt-erros("Departamento nao foi informado").
     3410                   end.        
     3411       
     3412              if  import-bnfciar.cd-secao = 0
     3413              then do:
     3414                     assign lg-relat-erro   = yes
     3415                            lg-medocup-erro = yes.
     3416                     RUN pi-cria-tt-erros("Secao nao foi informado").
     3417                   end.        
     3418       
     3419              if  import-bnfciar.cd-setor = 0
     3420              then do:
     3421                     assign lg-relat-erro   = yes
     3422                            lg-medocup-erro = yes.
     3423                     RUN pi-cria-tt-erros("Setor nao foi informado").
     3424                   end.
     3425       
     3426              if  import-bnfciar.cd-carteira-trabalho = ""
     3427              then do:
     3428                     assign lg-relat-erro   = yes
     3429                            lg-medocup-erro = yes.
     3430                     RUN pi-cria-tt-erros("Carteira Trabalho nao foi informada").
     3431                   end.
     3432       
     3433              if import-bnfciar.dt-primeira-consulta = ?
     3434              then do:
     3435                     assign lg-relat-erro   = yes
     3436                            lg-medocup-erro = yes.
     3437                     RUN pi-cria-tt-erros("Data Primeira Consulta nao informada").
     3438                   end. 
     3439        
     3440              /*----- VERIFICA DEPARTAMENTO ------------------------------------*/
     3441              IF NOT CAN-FIND (FIRST departa where departa.cd-departamento = import-bnfciar.cd-departamento)
     3442              then do:
     3443                     assign lg-relat-erro  = yes
     3444                            lg-medocup-erro = yes.
     3445                     RUN pi-cria-tt-erros("Departamento nao Cadastrado - " + 
     3446                                          if import-bnfciar.cd-departamento <> ?
     3447                                          then string(import-bnfciar.cd-departamento,"999")
     3448                                          else "000").
     3449                   end.
     3450       
     3451              /*----- VERIFICA SECAO -------------------------------------------*/
     3452              IF NOT CAN-FIND (FIRST secao where secao.cd-secao = import-bnfciar.cd-secao)
     3453              then do:
     3454                     assign lg-relat-erro   = yes
     3455                            lg-medocup-erro = yes.
     3456                     RUN pi-cria-tt-erros("Secao nao Cadastrada - " + 
     3457                                          if import-bnfciar.cd-secao <> ?
     3458                                          then string(import-bnfciar.cd-secao,"999")
     3459                                          else "000").
     3460                   end.
     3461          
     3462              /*----- VERIFICA SETOR -------------------------------------------*/
     3463              IF NOT CAN-FIND (FIRST setor where setor.cd-setor = import-bnfciar.cd-setor)
     3464              then do:
     3465                     assign lg-relat-erro  = yes
     3466                            lg-medocup-erro = yes.
     3467                     RUN pi-cria-tt-erros("Setor nao Cadastrado - " + 
     3468                                                        if import-bnfciar.cd-setor <> ?
     3469                                                        then string(import-bnfciar.cd-setor,"999") 
     3470                                                        else "000").
     3471                   end.
     3472                   
     3473              /*----- CRIA DEPSETSE -----------------------------*/
     3474              IF NOT CAN-FIND (first depsetse
     3475                               where depsetse.cd-modalidade   = import-bnfciar.cd-modalidade
     3476                                 and depsetse.nr-proposta     = propost.nr-proposta
     3477                                 and depsetse.cd-departamento = import-bnfciar.cd-departamento
     3478                                 and depsetse.cd-secao        = import-bnfciar.cd-secao
     3479                                 and depsetse.cd-setor        = import-bnfciar.cd-setor)
     3480              then do:
     3481                     assign lg-relat-erro  = yes
     3482                            lg-medocup-erro = yes.
     3483                     
     3484                     RUN pi-cria-tt-erros("Tabela de PropostaXDepXSecaoXSetor nao cadastrada" +                 
     3485                                          " -Dep.: "  + if import-bnfciar.cd-departamento <> ?                                     
     3486                                                        then string(import-bnfciar.cd-departamento,"999")                          
     3487                                                        else "000" +                                             
     3488                                          " -Secao: " + if import-bnfciar.cd-secao <> ?                                    
     3489                                                        then string(import-bnfciar.cd-secao,"999")                         
     3490                                                        else "000" +                                            
     3491                                          " -Setor: " + if import-bnfciar.cd-setor <> ?                                    
     3492                                                        then string(import-bnfciar.cd-setor,"999")                         
     3493                                                        else "000").
     3494                   end.
     3495              ELSE FOR first depsetse FIELDS (char-1)
     3496                       where depsetse.cd-modalidade   = import-bnfciar.cd-modalidade
     3497                         and depsetse.nr-proposta     = propost.nr-proposta
     3498                         and depsetse.cd-departamento = import-bnfciar.cd-departamento
     3499                         and depsetse.cd-secao        = import-bnfciar.cd-secao
     3500                         and depsetse.cd-setor        = import-bnfciar.cd-setor NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     3501       
     3502                       if depsetse.char-1 <> "A"
     3503                       then do:
     3504                              assign lg-relat-erro  = yes
     3505                                     lg-medocup-erro = yes.
     3506                              RUN pi-cria-tt-erros("PropostaXDepXSecaoXSetor nao esta ativo" +
     3507                                                   " -Dep.: " + if import-bnfciar.cd-departamento <> ?
     3508                                                                then string(import-bnfciar.cd-departamento,"999")
     3509                                                                else "000" +
     3510                                                   " -Secao: " + if import-bnfciar.cd-secao <> ?
     3511                                                                 then string(import-bnfciar.cd-secao,"999")
     3512                                                                 else "000" +
     3513                                                   " -Setor: " + if import-bnfciar.cd-setor <> ?
     3514                                                                 then string(import-bnfciar.cd-setor,"999")
     3515                                                                 else "000").
     3516                            end. 
     3517       
     3518                   END.
     3519            end.
     3520            
     3521       if  lg-inf-mae-aux                                 
     3522       then do:
     3523              /* --- O NOME DA MAE NAO PODE CONTER CARACTERES IGUAIS NAS 3 PRIMEIRAS POSICOES --- */
     3524              if import-bnfciar.nom-mae <> ""
     3525              AND (substring(import-bnfciar.nom-mae,1,1) = substring(import-bnfciar.nom-mae,2,1) AND 
     3526                   substring(import-bnfciar.nom-mae,1,1) = substring(import-bnfciar.nom-mae,3,1))
     3527                   then do:
     3528                          assign lg-relat-erro = yes.
     3529                          RUN pi-cria-tt-erros("Nome da mae nao pode repetir letras iguais nas 3 primeiras posicoes.").
     3530                        end. 
     3531            end.
     3532       
     3533       /* ------------ CONSISTE DADOS PARA ANS CONFORME IN 18 -------------------- */
     3534       /* ------------------------------------------------------------------------ */
     3535       if  (   import-bnfciar.cd-unimed-origem = 0                            
     3536            or import-bnfciar.cd-unimed-origem = paramecp.cd-unimed)
     3537       and  lg-medocup-aux
     3538       and  lg-inf-cpf-pis-cartaonac-aux
     3539       then do:
     3540              assign nr-ident-compl-aux = 0.
     3541       
     3542              if   import-bnfciar.cd-cpf      <> ?
     3543              and  dec(import-bnfciar.cd-cpf) <> 0
     3544              then assign nr-ident-compl-aux = nr-ident-compl-aux + 1.
     3545       
     3546              if   import-bnfciar.cd-pis-pasep <> 0
     3547              then assign nr-ident-compl-aux = nr-ident-compl-aux + 1.
     3548       
     3549              if   import-bnfciar.nom-mae <> ""
     3550              then assign nr-ident-compl-aux = nr-ident-compl-aux + 1.
     3551       
     3552              if   import-bnfciar.cd-cartao-nacional-saude <> 0
     3553              then assign nr-ident-compl-aux = nr-ident-compl-aux + 1.
     3554       
     3555              /* Titular */
     3556              if   import-bnfciar.log-respons            
     3557              and  ti-pl-sa.cd-grau-parentesco = import-bnfciar.cd-grau-parentesco
     3558              AND  nr-ident-compl-aux < 1 
     3559              then do:                                 
     3560                     assign lg-relat-erro = yes.
     3561                     RUN pi-cria-tt-erros("Pelo menos um dos campos de ident.complementar deve ser informado para beneficiarios titulares").
     3562                   end.
     3563            end.
     3564       
     3565       /*----- VENDEDOR --------------------------------------------------------*/
     3566   
     3567       /*--- le a tabela vendedor ---*/
     3568       /************************************************************************************************
     3569   *      Include  .....: srrepres.i                                                               *
     3570   *      Data .........: 05 de Agosto de 2000                                                     *
     3571   *      Empresa ......: DZSET SOLUCOES & SISTEMAS                                                *
     3572   *      Programador ..: Jaqueline Formigheri                                                     *
     3573   *      Objetivo .....: Leitura da tabela repres                                                 *
     3574   *-----------------------------------------------------------------------------------------------*
     3575   *      VERSAO    DATA        RESPONSAVEL     MOTIVO                                             *
     3576   *      D.00.000  05/09/2000  Jaque           Desenvolvimento                                    *
     3577   *      E.00.000  25/10/2000  Nora            Mudanca Versao Banco                               *
     3578   *      E.01.000  07/06/2001  Leonardo        Conversao EMS504                                   *
     3579   ************************************************************************************************/
     3580   
     3581    /*do:
     3582           find representante
     3583                where representante.cod_empresa = string(propost.ep-codigo)
     3584                  and representante.cdn_repres  = import-bnfciar.cd-vendedor
     3585                      no-lock no-error.
     3586           if   avail representante
     3587           then do:
     3588                   assign lg-avail-srrepres      = yes
     3589                          nm-representante-srems = representante.nom_pessoa.
     3590   
     3591                   find emscad.pessoa_fisic where 
     3592                        emscad.pessoa_fisic.num_pessoa_fisic = representante.num_pessoa 
     3593                        no-lock no-error.
     3594   
     3595                   if avail emscad.pessoa_fisic
     3596                   then assign ds-natureza-repres-srems = "F"
     3597                               nr-cpf-cgc-repres-srems  = emscad.pessoa_fisic.cod_id_feder.
     3598                   else do:
     3599                          find pessoa_jurid where 
     3600                               pessoa_jurid.num_pessoa_jurid = representante.num_pessoa 
     3601                               no-lock no-error.
     3602                          if avail pessoa_jurid 
     3603                          then assign ds-natureza-repres-srems = "J"
     3604                                      nr-cpf-cgc-repres-srems  = pessoa_jurid.cod_id_feder.
     3605                          else assign ds-natureza-repres-srems = " "
     3606                                      nr-cpf-cgc-repres-srems  = "".
     3607                       end.
     3608                end.
     3609           else assign lg-avail-srrepres        = no
     3610                       nm-representante-srems   = "** NAO CADASTRADO **"
     3611                       ds-natureza-repres-srems = " "
     3612                       nr-cpf-cgc-repres-srems  = "".
     3613         end.
     3614   
     3615   
     3616   /* ------------------------------------------------------------------------------------------- */
     3617    .
     3618   
     3619       if   not lg-avail-srrepres
     3620       then do:
     3621              assign lg-relat-erro = yes.
     3622              RUN pi-cria-tt-erros("Codigo do vendedor nao cadastrado").
     3623            end.*/
     3624       
     3625       /* --------------------------------------------------------------------- */
     3626       if  (import-bnfciar.des-orgao-emissor-ident <> "" or import-bnfciar.nom-pais <> "" or import-bnfciar.nr-identidade <> "")
     3627       AND (import-bnfciar.des-orgao-emissor-ident = "                              " or import-bnfciar.nom-pais = "" or import-bnfciar.nr-identidade = "")
     3628       then do:
     3629              assign lg-relat-erro = yes.
     3630              RUN pi-cria-tt-erros("Quando um dos campos a seguir for informado, tornam-se obrigatorios: Orgao emissor ident; Pais emissao ident; Nro da C.Ident.").
     3631            end.
     3632       
     3633       /* ------------- CONSISTE O ORGAO EMISSOR DO DOCUMENTO DE IDENTIFICACAO --- */
     3634       if trim(import-bnfciar.des-orgao-emissor-ident) <> ""
     3635       then do:           
     3636              run valida-orgao-emissor(input  trim(import-bnfciar.des-orgao-emissor-ident),
     3637                                       output lg-erro-aux).
     3638              if lg-erro-aux
     3639              then do:
     3640                     assign lg-relat-erro = yes.
     3641                     RUN pi-cria-tt-erros("Campo Orgao Emissor do Documento de Identificacao com valor incorreto: " + trim(import-bnfciar.des-orgao-emissor-ident)).
     3642                   end.
     3643            end.
     3644       
     3645       /* ---------------------------------------------- MOTIVO DE INCLUSAO --- */
     3646       if import-bnfciar.in-via-transferencia = ""
     3647       then do:
     3648              assign lg-relat-erro = yes.
     3649              RUN pi-cria-tt-erros("Motivo da inclusao nao informado").
     3650            end.
     3651       else do:
     3652              if  import-bnfciar.in-via-transferencia <> "N"
     3653              and import-bnfciar.in-via-transferencia <> "C"
     3654              and import-bnfciar.in-via-transferencia <> "V"
     3655              and import-bnfciar.in-via-transferencia <> "S"
     3656              and import-bnfciar.in-via-transferencia <> "B"
     3657              and import-bnfciar.in-via-transferencia <> "D"
     3658              then do:
     3659                     assign lg-relat-erro = yes.
     3660                     RUN pi-cria-tt-erros("Motivo da inclusao invalido").
     3661                   end.
     3662            end.
     3663       
     3664       if import-bnfciar.dt-emissao-ident <> ?
     3665       then do:
     3666              if import-bnfciar.dt-emissao-ident < import-bnfciar.dt-nascimento 
     3667              then do:
     3668                     assign lg-relat-erro = yes.
     3669                     RUN pi-cria-tt-erros("Data emissao documento menor que data nascimento").
     3670                   end.
     3671       
     3672              if import-bnfciar.dt-emissao-ident > today 
     3673              then do:
     3674                     assign lg-relat-erro = yes.
     3675                     RUN pi-cria-tt-erros("Data emissao documento maior que data atual").
     3676                   end.
     3677            end.
     3678       
     3679       /**
     3680        * 06/12/16 - Alex Boeira - validacao retirada pois Demitidos no Unicoo sao convertidos em 2 registros no TOTVS, com mesmo CCO.
     3681        *                          Um deles vinculado a empresa em que trabalhou, o outro eh o plano DEMAP (ele eh o proprio contratante origem).
     3682       IF import-bnfciar.cd-controle-oper-ans <> 0
     3683       AND CAN-FIND (FIRST b-usuario use-index usuari45 where b-usuario.cd-controle-oper-ans = import-bnfciar.cd-controle-oper-ans)
     3684       then do:
     3685              assign lg-relat-erro = yes.
     3686              RUN pi-cria-tt-erros("Codigo de Controle Operacional ja cadastrado").
     3687            end.
     3688       */
     3689       
     3690       /*------------------------------------------------------------------------*/
     3691       if import-bnfciar.cd-padrao-cob <> ""
     3692       then do: 
     3693              /**
     3694               * Alex Boeira - 25/02/2016
     3695               * Comentei essa logica pois entendo ser redundante.
     3696               * Essa validacao deve ser feita na criacao da proposta, nao aqui no beneficiario.
     3697               * Perda de performance.
     3698               
     3699              for each propcopa FIELDS (cd-modalidade nr-proposta cd-modulo)
     3700                 where propcopa.cd-modalidade       = propost.cd-modalidade
     3701                   and propcopa.nr-proposta         = propost.nr-proposta  
     3702                   and propcopa.cd-padrao-cobertura = import-bnfciar.cd-padrao-cob       
     3703                       NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     3704                  
     3705                  FOR first pro-pla FIELDS (lg-cobertura-obrigatoria cd-modulo)  
     3706                      where pro-pla.cd-modalidade = propcopa.cd-modalidade
     3707                        and pro-pla.nr-proposta   = propcopa.nr-proposta
     3708                        and pro-pla.cd-modulo     = propcopa.cd-modulo NO-LOCK QUERY-TUNING (NO-INDEX-HINT):
     3709                  END.
     3710       
     3711                  if not avail pro-pla 
     3712                  then do: 
     3713                         assign lg-relat-erro = yes.
     3714                         RUN pi-cria-tt-erros("Modulo " + 
     3715                                              if propcopa.cd-modulo <> ?
     3716                                              then string(propcopa.cd-modulo)
     3717                                              else "" + 
     3718                                              " nao vinculado a proposta " + 
     3719                                              if propcopa.nr-proposta <> ?
     3720                                              then string(propcopa.nr-proposta)
     3721                                              else "" + 
     3722                                              " da modalidade " + 
     3723                                              if propcopa.cd-modalidade <> ?
     3724                                              then string(propcopa.cd-modalidade)
     3725                                              else "").
     3726                       end.
     3727                  ELSE if pro-pla.lg-cobertura-obrigatoria = no /* s½ vai para o usu-mod o que nao for obrigatorio */
     3728                       AND NOT CAN-FIND (FIRST pla-mod
     3729                                         where pla-mod.cd-modalidade = propost.cd-modalidade
     3730                                           and pla-mod.cd-plano      = propost.cd-plano
     3731                                           and pla-mod.cd-tipo-plano = propost.cd-tipo-plano
     3732                                           and pla-mod.cd-modulo     = pro-pla.cd-modulo)
     3733                       then do:
     3734                              assign lg-relat-erro = yes.
     3735                      
     3736                              RUN pi-cria-tt-erros("Modulo " + 
     3737                                                   if pro-pla.cd-modulo <> ?
     3738                                                   then string(pro-pla.cd-modulo)
     3739                                                   else "" + 
     3740                                                   " nao associado a modalidade " + 
     3741                                                   if propost.cd-modalidade <> ?
     3742                                                   then string(propost.cd-modalidade)
     3743                                                   else "" + 
     3744                                                   ", plano " + 
     3745                                                   if propost.cd-plano <> ?
     3746                                                   then string(propost.cd-plano)
     3747                                                   else "" + 
     3748                                                   ", tipo de plano " + 
     3749                                                   if propost.cd-tipo-plano <> ?
     3750                                                   then string(propost.cd-tipo-plano)
     3751                                                   else "").
     3752                            end. 
     3753              end.*/
     3754            end. /* if cd-padrao-cob-imp <> "" */
     3755       else 
     3756            /**
     3757             * Alex Boeira - 25/02/2016
     3758             * Retirei essa logica daqui e coloquei no inicio do cg0310x.p (migracao de propostas).
     3759             * Dessa forma a validacao eh feita apenas uma vez, sem se repetir para cada beneficiario.
     3760             * Perda de performance.
     3761   
     3762            for each pla-mod FIELDS (cd-modalidade cd-plano cd-tipo-plano cd-modulo)
     3763               where pla-mod.cd-modalidade = propost.cd-modalidade 
     3764                 and pla-mod.cd-plano      = propost.cd-plano
     3765                 and pla-mod.cd-tipo-plano = propost.cd-tipo-plano
     3766                 and pla-mod.lg-grava-automatico 
     3767                     NO-LOCK,
     3768   
     3769                first pro-pla FIELDS (lg-cobertura-obrigatoria)   
     3770                where pro-pla.cd-modalidade = propost.cd-modalidade
     3771                  and pro-pla.nr-proposta   = propost.nr-proposta
     3772                  and pro-pla.cd-modulo     = pla-mod.cd-modulo
     3773                      NO-LOCK, 
     3774       
     3775                FIRST mod-cob where mod-cob.cd-modulo = pla-mod.cd-modulo NO-LOCK:
     3776   
     3777                IF  pro-pla.lg-cobertura-obrigatoria = no
     3778                AND mod-cob.in-identifica-modulo     = "S" 
     3779                AND NOT CAN-FIND (FIRST paramdsg 
     3780                                  where paramdsg.cd-chave-primaria = paravpmc.cd-chave-primaria                                             
     3781                                    and paramdsg.cd-modalidade     = pla-mod.cd-modalidade                                                  
     3782                                    and paramdsg.cd-plano          = pla-mod.cd-plano                                                       
     3783                                    and paramdsg.cd-tipo-plano     = pla-mod.cd-tipo-plano                                                  
     3784                                    and paramdsg.cd-modulo         = pla-mod.cd-modulo)                         
     3785                then do:                                                                                   
     3786                       assign lg-relat-erro  = yes.
     3787                       RUN pi-cria-tt-erros("Parametros dos Modulos de Seguro nao Cadastrados").
     3788                     end.   
     3789            end.*/
     3790   
     3791       /*----- SE MEDICINA OCUPACIONAL -----------------------------------------*/
     3792       if not lg-medocup-aux
     3793       AND import-bnfciar.cd-funcao <> 0 
     3794       AND NOT CAN-FIND (first funcprop 
     3795                         where funcprop.cd-modalidade = import-bnfciar.cd-modalidade
     3796                           and funcprop.nr-proposta   = import-bnfciar.nr-proposta
     3797                           and (funcprop.cd-setor     = import-bnfciar.cd-setor 
     3798                                or funcprop.cd-setor  = 0)
     3799                           and funcprop.cd-funcao     = import-bnfciar.cd-funcao
     3800                           and funcprop.in-situacao   = "A" )
     3801       then do:        
     3802              assign lg-relat-erro  = yes.
     3803              RUN pi-cria-tt-erros("Funcao empresa nao cadastrada para esta proposta" + ds-mensagem-aux).
     3804            end.
     3805   
     3806       /* consistir lotacao */
     3807       IF paravpmc.log-livre-26 /* indicador se utiliza lotacao */
     3808       THEN DO:
     3809              IF modalid.in-tipo-pessoa = "J"
     3810              THEN DO:
     3811                     IF import-bnfciar.num-livre-2 <> 0 /* cdn-respons-financ, utilizado somente quando beneficiario APOSENTADO / DEMITIDO */
     3812                     THEN DO:
     3813                            /* validacao retirada pois apos nova definicao, planos ADESAO tambem podem informar responsavel financeiro, mesmo sem lotacao (Alex Boeira 20/04/2017)
     3814                            IF import-bnfciar.num-livre-1 <> 99999
     3815                            THEN DO:
     3816                                   assign lg-relat-erro  = yes.
     3817                                   RUN pi-cria-tt-erros("Quando IMPORT-BNFCIAR.NUM-LIVRE-2 (CDN-RESPONS-FINANC) esta preenchido a lotacao deve ser 99999 (DEMITIDO/APOSENTADO). Recebida: "
     3818                                                        + STRING(IMPORT-BNFCIAR.NUM-LIVRE-1)).
     3819                                 END.
     3820                            */
     3821                            IF NOT CAN-FIND(FIRST contrat WHERE contrat.cd-contratante = import-bnfciar.num-livre-2)
     3822                            THEN DO:
     3823                                   assign lg-relat-erro  = yes.
     3824                                   RUN pi-cria-tt-erros("Contratante codigo : " + STRING(import-bnfciar.num-livre-2) 
     3825                                                        + " nao cadastrado como Contratante para ser Responsavel Financeiro pela familia.").
     3826                                 END.
     3827                          END.
     3828                     ELSE DO:
     3829                            IF import-bnfciar.num-livre-1 = 1 /* codigo fixo para lotacao de DEMITIDO/APOSENTADO */
     3830                            THEN DO:
     3831                                   assign lg-relat-erro  = yes.
     3832                                   RUN pi-cria-tt-erros("Quando a lotacao for 1 (DEMITIDO/APOSENTADO), IMPORT-BNFCIAR.NUM-LIVRE-2 (CDN-RESPONS-FINANC) deve ser preenchido. "
     3833                                                        + " CDN-RESPONS-FINANC: " + STRING(import-bnfciar.num-livre-2)).
     3834                                 END.
     3835                          END.
     3836                   END.
     3837              ELSE DO:
     3838                     IF import-bnfciar.num-livre-1 <> 0 /* cdn-lotacao */
     3839                     THEN DO:
     3840                            assign lg-relat-erro  = yes.
     3841                            RUN pi-cria-tt-erros("IMPORT-BNFCIAR.NUM-LIVRE-1 (CDN-LOTACAO) esta preenchido para beneficiario de modalidade FISICA.").
     3842                          END.
     3843                   END.
     3844            END.
     3845       ELSE DO:
     3846              IF import-bnfciar.num-livre-1 <> 0 /* cdn-lotacao */
     3847              THEN DO:
     3848                     assign lg-relat-erro  = yes.
     3849                     RUN pi-cria-tt-erros("Sistema parametrizado para nao usar lotacao, mas IMPORT-BNFCIAR.NUM-LIVRE-1 esta informado.").
     3850                   END.
     3851            END.
     3852   
     3853   END PROCEDURE.
     3854   
     3855   PROCEDURE consiste-campos-espec:
     3856   
     3857       def var ix-campo                  as int                             no-undo.
     3858       def var ix-contador               as int                             no-undo.
     3859       def var tt-frame                  as int                             no-undo.
     3860       def var ds-campo-auxil            as char format "x(20)"  extent 4   no-undo.
     3861       def var ds-mascara-aux            as char format "x(20)"  extent 4   no-undo.
     3862       def var nr-esp-aux                as int                  extent 4   no-undo.
     3863       def var lg-critica                as log                             no-undo.
     3864       def var lg-erro-mascara           as log                             no-undo.
     3865       def var lg-erro-masc              as log                             no-undo.
     3866       def var c-dig-mascara             as char format "x".
     3867       def var ct-cont                   as inte.
     3868       def var cd-mascara-aux            as char format "x(20)"             no-undo.
     3869       def var ds-esp-aux                like  usuario.ds-especifico1       no-undo.
     3870       def var ds-mascara-aux-imp        as char format "x(20)"             no-undo.
     3871   
     3872       FOR FIRST campprop FIELDS (ds-campo ds-mascara cd-modalidade nr-proposta lg-obriga-digitacao lg-consiste-dados)
     3873           where campprop.cd-modalidade = import-bnfciar.cd-modalidade
     3874             and campprop.nr-proposta   = nr-proposta-aux NO-LOCK:
     3875       END.
     3876    
     3877       if avail campprop
     3878       then do:    
     3879              /* --------------------------------------------------------------- */
     3880              assign ix-contador = 0
     3881                     ix-campo    = 0.
     3882           
     3883              do ix-campo = 1 to 4:
     3884           
     3885                 if   campprop.ds-campo[ix-campo] <> ""
     3886                 then do:
     3887                        ix-contador = ix-campo.
     3888           
     3889                        case ix-contador:
     3890                           when 1
     3891                           then assign ds-campo-auxil[1] = campprop.ds-campo[ix-campo]
     3892                                       ds-mascara-aux[1] = campprop.ds-mascara[ix-campo]
     3893                                       nr-esp-aux[1]     = ix-campo.
     3894                           when 2
     3895                           then assign ds-campo-auxil[2] = campprop.ds-campo[ix-campo]
     3896                                       ds-mascara-aux[2] = campprop.ds-mascara[ix-campo]
     3897                                       nr-esp-aux[2]     = ix-campo.
     3898                           when 3
     3899                           then assign ds-campo-auxil[3] = campprop.ds-campo[ix-campo]
     3900                                       ds-mascara-aux[3] = campprop.ds-mascara[ix-campo]
     3901                                       nr-esp-aux[3]     = ix-campo.
     3902                           when 4
     3903                           then assign ds-campo-auxil[4] = campprop.ds-campo[ix-campo]
     3904                                       ds-mascara-aux[4] = campprop.ds-mascara[ix-campo]
     3905                                       nr-esp-aux[4]     = ix-campo.
     3906                        end case.
     3907           
     3908                        if   ix-contador = 4
     3909                        then leave.
     3910                      end.
     3911              end.
     3912           
     3913              /* --------------------------------------------------------------- */
     3914              if   import-bnfciar.des-espcif-1 <> ""
     3915              and  ds-campo-auxil[1]  <> ""
     3916              then do:
     3917                     run mcp/mc0111a5.p (input  ds-mascara-aux[1],
     3918                                         input  (import-bnfciar.des-espcif-1),
     3919                                         input  "F",
     3920                                         output lg-critica,
     3921                                         output ds-mascara-aux-imp).
     3922           
     3923                     if   lg-critica
     3924                     then do:
     3925                            assign lg-relat-erro = yes.
     3926                            run pi-cria-tt-erros("Mascara do cpo especifico 1 nao esta do Padrao " + import-bnfciar.des-espcif-1 + " Cadastro: " + ds-mascara-aux[1]). 
     3927                          end.
     3928           
     3929                     if   import-bnfciar.des-espcif-1 <> ds-mascara-aux-imp
     3930                     then do:
     3931                            assign lg-relat-erro = yes.
     3932                            run pi-cria-tt-erros("Campo especifico 1 nao esta do Padrao " + import-bnfciar.des-espcif-1 + " Cadastro: " + ds-mascara-aux[1]). 
     3933                          end.
     3934                   end.
     3935           
     3936              if   ds-campo-auxil[1] <> ""
     3937              then do:
     3938                     assign lg-erro-mascara = no.
     3939           
     3940                     /* ----------------------------------- CONSISTENCIA PARA CAMPO 1 -------- */
     3941                     if  campprop.lg-obriga-digitacao[1]
     3942                     AND ds-campo-auxil[1] <> ""
     3943                     AND import-bnfciar.des-espcif-1 = ""
     3944                     then do:
     3945                            assign lg-relat-erro = yes.
     3946                            run pi-cria-tt-erros("Mascara do campo especifico 1 no formato " + campprop.ds-mascara[1] + " deve ser informada").
     3947                            assign lg-erro-mascara = yes.
     3948                          end.
     3949                     
     3950                     /*if  campprop.lg-consiste-dados[1]
     3951                     AND ds-campo-auxil[1] <> ""
     3952                     then do:
     3953                            FOR FIRST b-usuario FIELDS (cd-usuario nm-usuario)
     3954                                where b-usuario.cd-modalidade     = campprop.cd-modalidade
     3955                                  and b-usuario.nr-proposta       = campprop.nr-proposta
     3956                                  and b-usuario.ds-especifico1    = ds-campo-auxil[1]
     3957                                  and b-usuario.cd-usuario       <> usuario.cd-usuario
     3958                                  and b-usuario.dt-exclusao-plano = ? NO-LOCK:
     3959                            END.
     3960                            if avail b-usuario
     3961                            then do:
     3962                                   assign lg-relat-erro = yes.
     3963                                   run pi-cria-tt-erros("Mascara ja cadastrada para beneficiario - Codigo: " + string(b-usuario.cd-usuario,"999999") + b-usuario.nm-usuario).
     3964                                   assign lg-erro-mascara = yes.
     3965                                 end. 
     3966                          end.*/
     3967                   end.
     3968           
     3969              /* --------------------------------------------------------------- */
     3970              if   import-bnfciar.des-espcif-2 <> ""
     3971              and  ds-campo-auxil[2] <> ""
     3972              then do:
     3973                     run mcp/mc0111a5.p  (input  ds-mascara-aux[2],
     3974                                          input (import-bnfciar.des-espcif-2),
     3975                                          input "F",
     3976                                          output lg-critica,
     3977                                          output ds-mascara-aux-imp).
     3978           
     3979                     if   lg-critica
     3980                     then do:
     3981                            assign lg-relat-erro = yes.
     3982                            run pi-cria-tt-erros("Mascara do cpo especifico 2 nao esta do Padrao " + import-bnfciar.des-espcif-2 + " Cadastro: " + ds-mascara-aux[2]). 
     3983                          end.
     3984           
     3985                     if   import-bnfciar.des-espcif-2 <> ds-mascara-aux-imp
     3986                     then do:
     3987                            assign lg-relat-erro = yes.
     3988                            run pi-cria-tt-erros("Campo especifico 2 nao esta do Padrao " + import-bnfciar.des-espcif-2 + " Cadastro: " + ds-mascara-aux[2]). 
     3989                          end.
     3990                   end.
     3991           
     3992              if   ds-campo-auxil[2] <> ""
     3993              then do:
     3994                     assign lg-erro-mascara = no.
     3995           
     3996                     /* ----------------------------------- CONSISTENCIA PARA CAMPO ---------- */
     3997                     if  campprop.lg-obriga-digitacao[2]
     3998                     AND ds-campo-auxil[2] <> ""
     3999                     AND import-bnfciar.des-espcif-2 = ""
     4000                     then do:
     4001                            assign lg-relat-erro = yes.
     4002                            run pi-cria-tt-erros("Mascara do campo especifico 2 no formato " + campprop.ds-mascara[2] + " deve ser informada").
     4003                            assign lg-erro-mascara = yes.
     4004                          end.
     4005                     
     4006                     /*if  campprop.lg-consiste-dados[2]
     4007                     AND ds-campo-auxil[2] <> ""
     4008                     then do:
     4009                            FOR FIRST b-usuario FIELDS (cd-usuario nm-usuario)
     4010                                where b-usuario.cd-modalidade     = campprop.cd-modalidade
     4011                                  and b-usuario.nr-proposta       = campprop.nr-proposta
     4012                                  and b-usuario.ds-especifico2    = ds-campo-auxil[2]
     4013                                  and b-usuario.cd-usuario       <> usuario.cd-usuario
     4014                                  and b-usuario.dt-exclusao-plano = ? NO-LOCK:
     4015                            END.
     4016                            if avail b-usuario
     4017                            then do:
     4018                                   assign lg-relat-erro = yes.
     4019                                   run pi-cria-tt-erros("Mascara ja cadastrada para beneficiario - Codigo: " + string(b-usuario.cd-usuario,"999999") + b-usuario.nm-usuario).
     4020                                   assign lg-erro-mascara = yes.
     4021                                 end.
     4022                          end.*/
     4023   
     4024                   end.
     4025           
     4026              /* --------------------------------------------------------------- */
     4027              if   import-bnfciar.des-espcif-3 <> ""
     4028              and  ds-campo-auxil[3] <> ""
     4029              then do:
     4030                     run mcp/mc0111a5.p  (input  ds-mascara-aux[3],
     4031                                          input (import-bnfciar.des-espcif-3),
     4032                                          input "F",
     4033                                          output  lg-critica,
     4034                                          output ds-mascara-aux-imp).
     4035           
     4036                     if   lg-critica
     4037                     then do:
     4038                            assign lg-relat-erro = yes.
     4039                            run pi-cria-tt-erros("Mascara do cpo especifico 3 nao esta do Padrao " + import-bnfciar.des-espcif-3 + " Cadastro: " + ds-mascara-aux[3]). 
     4040                          end.
     4041           
     4042                     if   import-bnfciar.des-espcif-3 <> ds-mascara-aux-imp
     4043                     then do:
     4044                            assign lg-relat-erro = yes.
     4045                            run pi-cria-tt-erros("Campo especifico 3 nao esta do Padrao " + import-bnfciar.des-espcif-3 + " Cadastro: " + ds-mascara-aux[3]). 
     4046                          end.
     4047                   end.
     4048           
     4049              if   ds-campo-auxil[3] <> ""
     4050              then do:
     4051                     assign lg-erro-mascara = no.
     4052           
     4053                     /* ----------------------------------- CONSISTENCIA PARA CAMPO ---------- */
     4054                     if  campprop.lg-obriga-digitacao[3]
     4055                     AND ds-campo-auxil[3] <> ""
     4056                     and import-bnfciar.des-espcif-3 = ""
     4057                     then do:
     4058                            assign lg-relat-erro = yes.
     4059                            run pi-cria-tt-erros("Mascara do campo especifico 3 no formato " + campprop.ds-mascara[3] + " deve ser informada").
     4060                            assign lg-erro-mascara = yes.
     4061                          end.
     4062                     
     4063                     /*if  campprop.lg-consiste-dados[3]
     4064                     AND ds-campo-auxil[3] <> ""
     4065                     then do:
     4066                            FOR FIRST b-usuario FIELDS (cd-usuario nm-usuario)
     4067                                where b-usuario.cd-modalidade     = campprop.cd-modalidade
     4068                                  and b-usuario.nr-proposta       = campprop.nr-proposta
     4069                                  and b-usuario.ds-especifico3    = ds-campo-auxil[3]
     4070                                  and b-usuario.cd-usuario       <> usuario.cd-usuario
     4071                                  and b-usuario.dt-exclusao-plano = ? NO-LOCK :
     4072                            END.
     4073                            if avail b-usuario
     4074                            then do:
     4075                                   assign lg-relat-erro = yes.
     4076                                   run pi-cria-tt-erros("Mascara ja cadastrada para beneficiario - Codigo: " + string(b-usuario.cd-usuario,"999999") + b-usuario.nm-usuario).
     4077                                   assign lg-erro-mascara = yes.
     4078                                 end.
     4079                          end.*/
     4080                   end.
     4081           
     4082              /* --------------------------------------------------------------- */
     4083              if   import-bnfciar.des-espcif-4 <> ""
     4084              and  ds-campo-auxil[4] <> ""
     4085              then do:
     4086                     run mcp/mc0111a5.p  (input ds-mascara-aux[4],
     4087                                          input (import-bnfciar.des-espcif-4),
     4088                                          input "F",
     4089                                          output  lg-critica,
     4090                                          output ds-mascara-aux-imp).
     4091           
     4092                     if   lg-critica
     4093                     then do:
     4094                            assign lg-relat-erro = yes.
     4095                            run pi-cria-tt-erros("Mascara do cpo especifico 4 nao esta no Padrao " + import-bnfciar.des-espcif-4 + " Cadastro: " + ds-mascara-aux[4]). 
     4096                          end.
     4097           
     4098                     if   import-bnfciar.des-espcif-4 <> ds-mascara-aux-imp
     4099                     then do:
     4100                            assign lg-relat-erro = yes.
     4101                            run pi-cria-tt-erros("Campo especifico 4 nao esta no Padrao " + import-bnfciar.des-espcif-4 +  " Cadastro: " + ds-mascara-aux[4]).  
     4102                          end.
     4103                   end.
     4104           
     4105              if   ds-campo-auxil[4] <> ""
     4106              then do:
     4107                     assign lg-erro-mascara = no.
     4108           
     4109                     /* ----------------------------------- CONSISTENCIA PARA CAMPO ---------- */
     4110                     if  campprop.lg-obriga-digitacao[4]
     4111                     AND ds-campo-auxil[4] <> ""
     4112                     AND import-bnfciar.des-espcif-4 = ""
     4113                     then do:
     4114                            assign lg-relat-erro = yes.
     4115                            run pi-cria-tt-erros("Mascara do campo especifico 4 no formato " + campprop.ds-mascara[4] + " deve ser informada").
     4116                            assign lg-erro-mascara = yes.
     4117                          end.
     4118                     
     4119                     /*if  campprop.lg-consiste-dados[4]
     4120                     AND ds-campo-auxil[4] <> ""
     4121                     then do:
     4122                            FOR FIRST b-usuario FIELDS (cd-usuario nm-usuario)
     4123                                where b-usuario.cd-modalidade     = campprop.cd-modalidade
     4124                                  and b-usuario.nr-proposta       = campprop.nr-proposta
     4125                                  and b-usuario.ds-especifico4    = ds-campo-auxil[4]
     4126                                  and b-usuario.cd-usuario       <> usuario.cd-usuario
     4127                                  and b-usuario.dt-exclusao-plano = ? NO-LOCK:
     4128                            END.
     4129                            if avail b-usuario
     4130                            then do:
     4131                                   assign lg-relat-erro = yes.
     4132                                   run pi-cria-tt-erros("Mascara ja cadastrada para beneficiario - Codigo: " + string(b-usuario.cd-usuario,"999999") + b-usuario.nm-usuario).
     4133                                   assign lg-erro-mascara = yes.
     4134                                 end.
     4135                          end.*/
     4136                   end.
     4137            END.
     4138       else if   import-bnfciar.des-espcif-1 <> ""
     4139            or   import-bnfciar.des-espcif-2 <> ""
     4140            or   import-bnfciar.des-espcif-3 <> ""
     4141            or   import-bnfciar.des-espcif-4 <> ""
     4142            then do:
     4143                   assign lg-relat-erro = yes.
     4144                   run pi-cria-tt-erros("Campos Especificos devem conter brancos"). 
     4145                 end.
     4146   
     4147        if lg-erro-mascara = yes
     4148        THEN lg-relat-erro = YES.
     4149   
     4150   END PROCEDURE.
     4151   
     4152                         
     4153   procedure RESPONSAVEL.
     4154    
     4155      assign lg-retorna = no.
     4156    
     4157      /* ---------------------- CONSISTE GRAU DE PARENTESCO DO BENEFICIARIO --- */
     4158      assign in-funcao-rtapi041-aux           = "CST"
     4159             lg-prim-mens-rtapi041-aux        = no
     4160             lg-erro-rtapi041-aux             = no
     4161             in-funcao-chamadora-rtapi041-aux = "INC"
     4162             lg-simula-chamadora-rtapi041-aux = no
     4163             cd-modalidade-rtapi041-aux       = import-bnfciar.cd-modalidade
     4164             nr-proposta-rtapi041-aux         = nr-proposta-imp-aux
     4165             cd-usuario-rtapi041-aux          = 0
     4166             cd-titular-rtapi041-aux          = cd-titular-aux
     4167             lg-sexo-rtapi041-aux             = import-bnfciar.log-sexo
     4168             cd-grau-parentesco-rtapi041-aux  = import-bnfciar.cd-grau-parentesco
     4169             dt-nascimento-rtapi041-aux       = import-bnfciar.dt-nascimento
     4170             dt-inclusao-plano-rtapi041-aux   = import-bnfciar.dt-inclusao-plano
     4171             lg-importacao-rtapi041-aux       = no
     4172             in-modulo-sistema-rtapi041-aux   = "CG"              
     4173             lg-responsavel-rtapi041-aux      = import-bnfciar.log-respons 
     4174             dt-exclusao-plano-rtapi041-aux   = import-bnfciar.dt-exclusao-plano.
     4175   
     4176      run rtp/rtapi041.p no-error.
     4177    
     4178      if   error-status:error
     4179      then do: 
     4180             assign lg-relat-erro = yes
     4181                    lg-retorna    = yes.
     4182   
     4183             if   error-status:num-messages = 0
     4184             then RUN pi-cria-tt-erros("Operador teclou Ctrl-C").
     4185             else RUN pi-cria-tt-erros(substring(error-status:get-message(error-status:num-messages),1,75)).
     4186   
     4187             return.
     4188           end.
     4189    
     4190      if   lg-erro-rtapi041-aux
     4191      then do:
     4192             assign lg-relat-erro = yes
     4193                    lg-retorna    = yes.
     4194    
     4195             for each tmp-mensa-rtapi041
     4196                where tmp-mensa-rtapi041.in-tipo-mensagem = "E":
     4197    
     4198                 RUN pi-cria-tt-erros(if tmp-mensa-rtapi041.ds-mensagem <> ?
     4199                                      then "(rtapi041)" + STRING(tmp-mensa-rtapi041.cd-mensagem-mens) + " " + tmp-mensa-rtapi041.ds-mensagem + " " + tmp-mensa-rtapi041.ds-complemento-mens + " " + tmp-mensa-rtapi041.ds-chave-mens
     4200                                      else "").
     4201             end.
     4202           end.
     4203    
     4204   end procedure.
     4205   
     4206   
     4207   /* -------------- CONSISTE O ORGAO EMISSOR DO DOCUMENTO DE IDENTIFICACAO --- */
     4208   procedure valida-orgao-emissor:
     4209   
     4210       define input parameter  ds-orgao-par as char           no-undo.
     4211       define output parameter lg-erro-par  as log initial no no-undo.
     4212   
     4213       define variable ds-opcoes-aux as char no-undo.
     4214       
     4215       assign ds-opcoes-aux = "SSP-SECRET.SEGURANCA PUBLICA,"  
     4216                            + "MINISTERIO DA AERONAUTICA,"     
     4217                            + "MINISTERIO DO EXERCITO,"        
     4218                            + "MINISTERIO DA MARINHA,"         
     4219                            + "POLICIA FEDERAL,"               
     4220                            + "CARTEIRA DE IDENTID. CLASSISTA,"
     4221                            + "CONS.REG.DE ADMINISTRACAO,"     
     4222                            + "CONS.REG.DE ASSIST.SOCIAIS,"    
     4223                            + "CONS.REG.DE BIBLIOTECONOMIA,"   
     4224                            + "CONS.REG.DE CONTABILIDADE,"     
     4225                            + "CONS.REG.CORRETORES IMOVEIS,"   
     4226                            + "CONS.REG.ENFERMAGEM,"           
     4227                            + "CONS.REG.ENG.ARQ. E AGRONOMIA," 
     4228                            + "CONS.REG.DE ESTATISTICA,"       
     4229                            + "CONS.REG.DE FARMACIA,"          
     4230                            + "CONS.REG.FISIOT.TERAPIA OCUP.," 
     4231                            + "CONS.REG.DE MEDICINA,"          
     4232                            + "CONS.REG.MEDICINA VETERINARIA," 
     4233                            + "CONS.REG.DE NUTRICAO,"          
     4234                            + "CONS.REG.DE ODONTOLOGIA,"       
     4235                            + "CONS.REG.PROF.RELACOES PUBLIC.,"
     4236                            + "CONS.REG.DE PSICOLOGIA,"        
     4237                            + "CONS.REG.DE QUIMICA,"           
     4238                            + "CONS.REG.REPRES.COMERCIAIS,"    
     4239                            + "ORDEM DOS MUSICOS DO BRASIL,"   
     4240                            + "ORDEM DOS ADVOGADOS DO BRASIL," 
     4241                            + "OUTROS EMISSORES,"              
     4242                            + "DOCUMENTOS ESTRANGEIROS".       
     4243   
     4244       if lookup(ds-orgao-par,ds-opcoes-aux) = 0
     4245       then assign lg-erro-par = yes.
     4246   
     4247   end procedure.
     4248   
     4249   /* ------------------------------------------------------------------------- */
     4250   procedure atual-datas:
     4251    
     4252      for each pro-pla FIELDS (dt-cancelamento dt-fim)  
     4253         where pro-pla.cd-modalidade   = propost.cd-modalidade 
     4254           and pro-pla.nr-proposta     = propost.nr-proposta   
     4255           and pro-pla.dt-cancelamento = propost.dt-libera-doc
     4256               EXCLUSIVE-LOCK QUERY-TUNING (NO-INDEX-HINT):
     4257          assign pro-pla.dt-cancelamento = import-bnfciar.dt-exclusao-plano
     4258                 pro-pla.dt-fim          = import-bnfciar.dt-exclusao-plano.
     4259      end.
     4260      
     4261      for each pr-mo-am FIELDS (dt-fim dt-cancelamento) 
     4262         where pr-mo-am.cd-modalidade   = propost.cd-modalidade 
     4263           and pr-mo-am.nr-proposta     = propost.nr-proposta   
     4264           and pr-mo-am.dt-cancelamento = propost.dt-libera-doc
     4265               EXCLUSIVE-LOCK QUERY-TUNING (NO-INDEX-HINT):
     4266          assign pr-mo-am.dt-fim          = import-bnfciar.dt-exclusao-plano
     4267                 pr-mo-am.dt-cancelamento = import-bnfciar.dt-exclusao-plano.
     4268      end.                        
     4269    
     4270      for each propunim FIELDS (dt-cancelamento dt-fim) 
     4271         where propunim.cd-modalidade = propost.cd-modalidade 
     4272           and propunim.nr-proposta   = propost.nr-proposta  
     4273               EXCLUSIVE-LOCK QUERY-TUNING (NO-INDEX-HINT):
     4274          if propunim.dt-cancelamento = propunim.dt-fim
     4275          then assign propunim.dt-cancelamento = import-bnfciar.dt-exclusao-plano
     4276                      propunim.dt-fim          = import-bnfciar.dt-exclusao-plano.
     4277      end.
     4278    
     4279   end procedure.
     4280   
     4281   /* ------------------------------------------------------------------------- */
     4282   PROCEDURE consiste-modulos-benef:
     4283       
     4284       FOR EACH import-modul-bnfciar EXCEPT (cod-livre-1 cod-livre-2 cod-livre-3 cod-livre-4 cod-livre-5 cod-livre-6 cod-livre-7 cod-livre-8 cod-livre-9 
     4285                                             cod-livre-10 num-livre-1 num-livre-2 num-livre-3 num-livre-4 num-livre-5 num-livre-6 num-livre-7 num-livre-8 
     4286                                             num-livre-9 num-livre-10 val-livre-1 val-livre-2 val-livre-3 val-livre-4 val-livre-5 val-livre-6 val-livre-7 
     4287                                             val-livre-8 val-livre-9 val-livre-10 log-livre-1 log-livre-2 log-livre-3 log-livre-4 log-livre-5 log-livre-6 
     4288                                             log-livre-7 log-livre-8 log-livre-9 log-livre-10 dat-livre-1 dat-livre-2 dat-livre-3 dat-livre-4 dat-livre-5 
     4289                                             dat-livre-6 dat-livre-7 dat-livre-8 dat-livre-9 dat-livre-10)
     4290          WHERE import-modul-bnfciar.num-seqcial-bnfciar = import-bnfciar.num-seqcial-bnfciar 
     4291            AND import-modul-bnfciar.num-livre-1         = import-bnfciar.num-seqcial-control NO-LOCK:
     4292   
     4293           FOR FIRST mod-cob FIELDS (in-identifica-modulo)
     4294               WHERE mod-cob.cd-modulo = import-modul-bnfciar.cdn-modul NO-LOCK:
     4295           END.
     4296           if   not avail mod-cob
     4297           then do:
     4298                  RUN pi-cria-tt-erros("Modulo nao Cadastrado - Modulo: " + string(import-modul-bnfciar.cdn-modul,"999")).
     4299           
     4300                  assign lg-relat-erro  = yes
     4301                         lg-modulo-erro = yes.
     4302                  NEXT.
     4303                END.
     4304   
     4305           FOR FIRST pro-pla FIELDS (dt-inicio dt-cancelamento cd-modulo lg-cobertura-obrigatoria)
     4306               where pro-pla.cd-modalidade = import-bnfciar.cd-modalidade
     4307                 and pro-pla.nr-proposta   = propost.nr-proposta
     4308                 and pro-pla.cd-modulo     = import-modul-bnfciar.cdn-modul NO-LOCK:
     4309           END.
     4310           
     4311           if not avail pro-pla
     4312           then do:
     4313                  RUN pi-cria-tt-erros("Modulo nao cadastrado para a proposta: " + string(import-modul-bnfciar.cdn-modul)).
     4314           
     4315                  assign lg-relat-erro  = yes
     4316                         lg-modulo-erro = yes.
     4317                  NEXT.
     4318                end.
     4319   
     4320           FOR first pla-mod FIELDS (lg-modulo-agregado lg-grava-automatico)
     4321               where pla-mod.cd-modalidade = propost.cd-modalidade  
     4322                 and pla-mod.cd-plano      = propost.cd-plano       
     4323                 and pla-mod.cd-tipo-plano = propost.cd-tipo-plano  
     4324                 and pla-mod.cd-modulo     = import-modul-bnfciar.cdn-modul NO-LOCK:
     4325           END.
     4326   
     4327           IF NOT AVAIL pla-mod
     4328           THEN DO:
     4329                  assign lg-relat-erro  = yes
     4330                         lg-modulo-erro = yes.
     4331                  RUN pi-cria-tt-erros("Modulo nao cadastrado para a Estrutura: " + string(import-modul-bnfciar.cdn-modul)). 
     4332                  NEXT.
     4333                END.
     4334           
     4335           if   import-modul-bnfciar.dat-inic = ?
     4336           then do:
     4337                  RUN pi-cria-tt-erros("Data de inicio do Modulo Invalida").
     4338                  assign lg-relat-erro  = yes
     4339                         lg-modulo-erro = yes.
     4340                end.
     4341           ELSE DO:
     4342                  if   import-modul-bnfciar.dat-inic < propost.dt-proposta
     4343                  then do:
     4344                         IF import-modul-bnfciar.dat-inic <> ?
     4345                         THEN char-aux1 = STRING(import-modul-bnfciar.dat-inic,"99/99/9999").
     4346                         ELSE char-aux1 = "nulo".
     4347                         
     4348                         IF propost.dt-proposta <> ?
     4349                         THEN char-aux2 = STRING(propost.dt-proposta,"99/99/9999").
     4350                         ELSE char-aux2 = "nulo".
     4351                         
     4352                         RUN pi-cria-tt-erros("Data de Inicio (" + char-aux1 + ") do Modulo (" 
     4353                                              + STRING(import-modul-bnfciar.cdn-modul) 
     4354                                              + ") menor que data da Proposta ( + char-aux2 + )").
     4355                         assign lg-relat-erro  = yes
     4356                                lg-modulo-erro = yes.
     4357                       end.
     4358   
     4359                  if import-modul-bnfciar.dat-inic < import-bnfciar.dt-inclusao-plano
     4360                  then do:
     4361                         IF import-modul-bnfciar.dat-inic <> ?
     4362                         THEN char-aux1 = STRING(import-modul-bnfciar.dat-inic,"99/99/9999").
     4363                         ELSE char-aux1 = "nulo".
     4364                         
     4365                         IF import-bnfciar.dt-inclusao-plano <> ?
     4366                         THEN char-aux2 = STRING(import-bnfciar.dt-inclusao-plano,"99/99/9999").
     4367                         ELSE char-aux2 = "nulo".
     4368   
     4369                         RUN pi-cria-tt-erros("Data de inicio (" + char-aux1 + ") do modulo ( " + STRING(import-modul-bnfciar.cdn-modul) 
     4370                                              + " ) nao pode ser inferior a inclusao do beneficiario (" + char-aux2 + ")").
     4371                         assign lg-relat-erro  = yes
     4372                                lg-modulo-erro = yes.
     4373                       end.
     4374   
     4375                  if import-modul-bnfciar.dat-inic < pro-pla.dt-inicio
     4376                  then do:
     4377                         IF import-modul-bnfciar.dat-inic <> ?
     4378                         THEN char-aux1 = STRING(import-modul-bnfciar.dat-inic,"99/99/9999").
     4379                         ELSE char-aux1 = "nulo".
     4380   
     4381                         IF pro-pla.dt-inicio <> ?
     4382                         THEN char-aux2 = STRING(pro-pla.dt-inicio,"99/99/9999").
     4383                         ELSE char-aux2 = "nulo".
     4384   
     4385                         RUN pi-cria-tt-erros("Data de inicio (" + char-aux1 + ") do modulo opcional do beneficiario (" 
     4386                                              + STRING(import-modul-bnfciar.cdn-modul) 
     4387                                              + ") nao pode ser inferior a data de inicio do modulo da proposta(" + char-aux2 + ")").
     4388                         assign lg-relat-erro  = yes
     4389                                lg-modulo-erro = yes.
     4390                       end.
     4391               END.
     4392           
     4393           if  import-modul-bnfciar.dat-fim = ?
     4394           THEN DO:
     4395                  IF  import-modul-bnfciar.cdn-motiv-cancel <> 0
     4396                  AND import-modul-bnfciar.cdn-motiv-cancel <> ?
     4397                  then do:
     4398                         RUN pi-cria-tt-erros("Codigo do motivo de cancelamento nao deve ser informado. Motivo recebido: " + STRING(import-modul-bnfciar.cdn-motiv-cancel)).
     4399                         assign lg-relat-erro  = yes
     4400                                lg-modulo-erro = yes.
     4401                       end. 
     4402   
     4403                  if  pro-pla.dt-cancelamento <> ? 
     4404                  then do:
     4405                         RUN pi-cria-tt-erros("Proposta com modulo cancelado e beneficiario com modulo ativo. Modulo:" + string(pro-pla.cd-modulo)).
     4406                         assign lg-relat-erro  = yes
     4407                                lg-modulo-erro = yes.
     4408                       end.
     4409                END.
     4410           ELSE DO:
     4411                  IF import-modul-bnfciar.cdn-motiv-cancel  = ?
     4412                  or import-modul-bnfciar.cdn-motiv-cancel  = 0
     4413                  then do:
     4414                         RUN pi-cria-tt-erros("Codigo do motivo de cancelamento deve ser informado").
     4415                         assign lg-relat-erro  = yes
     4416                                lg-modulo-erro = yes.
     4417                       end.
     4418   
     4419                  FOR FIRST motcange FIELDS (in-tipo-obito-ans)
     4420                      where motcange.in-entidade = "MC"
     4421                        and motcange.cd-motivo   = import-modul-bnfciar.cdn-motiv-cancel
     4422                        and motcange.log-4       = no /* Registro nao excluido */ NO-LOCK:
     4423                  END.
     4424   
     4425                  IF NOT AVAIL motcange
     4426                  then do:
     4427                         RUN pi-cria-tt-erros("Codigo motivo de cancelamento do modulo nao cadastrado: " + STRING(import-modul-bnfciar.cdn-motiv-cancel)).
     4428                         assign lg-relat-erro  = yes
     4429                                lg-modulo-erro = yes.
     4430                       end.
     4431                  else IF motcange.in-tipo-obito-ans > 0 
     4432                       then do:
     4433                              RUN pi-cria-tt-erros("Codigo motivo de cancelamento do modulo nao pode indicar obito").
     4434                              assign lg-relat-erro  = yes
     4435                                     lg-modulo-erro = yes.
     4436                            end. 
     4437   
     4438                  if import-modul-bnfciar.dat-fim > import-bnfciar.dt-exclusao-plano
     4439                  then do:
     4440                         IF import-modul-bnfciar.dat-fim <> ?
     4441                         THEN char-aux1 = STRING(import-modul-bnfciar.dat-fim).
     4442                         ELSE char-aux1 = "nulo".
     4443   
     4444                         IF import-bnfciar.dt-exclusao-plano <> ?
     4445                         THEN char-aux2 = STRING(import-bnfciar.dt-exclusao-plano).
     4446                         ELSE char-aux2 = "nulo".
     4447                         
     4448                         IF import-modul-bnfciar.cdn-modul <> ?
     4449                         THEN char-aux3 = string(import-modul-bnfciar.cdn-modul).
     4450                         ELSE char-aux3 = "nulo".
     4451   
     4452                         RUN pi-cria-tt-erros("Data de cancelamento do Modulo nao pode ser superior ao cancelamento do beneficiario. Canc.Modulo: " + char-aux1 +
     4453                                              " Canc.Benef: " + char-aux2 + " Modulo? " + char-aux3).
     4454                  
     4455                         assign lg-relat-erro  = yes
     4456                                lg-modulo-erro = yes.
     4457                       end.
     4458                  
     4459                  if   import-modul-bnfciar.dat-fim < import-modul-bnfciar.dat-inic
     4460                  then do:
     4461                         IF import-modul-bnfciar.dat-fim <> ?
     4462                         THEN char-aux1 = string(import-modul-bnfciar.dat-fim,"99/99/9999").
     4463                         ELSE char-aux1 = "nulo".
     4464   
     4465                         IF import-modul-bnfciar.dat-inic <> ?
     4466                         THEN char-aux2 = string(import-modul-bnfciar.dat-ini,"99/99/9999").
     4467                         ELSE char-aux2 = "nulo".
     4468   
     4469                         RUN pi-cria-tt-erros("Data de cancelamento do Modulo do Beneficiario nao pode ser anterior a sua inclusao. Exclusao:  " +
     4470                                              char-aux1 + " Inclusao: " + char-aux2).
     4471                  
     4472                         assign lg-relat-erro  = yes
     4473                                lg-modulo-erro = yes.
     4474                       end.
     4475   
     4476                  if pro-pla.dt-cancelamento < import-modul-bnfciar.dat-fim
     4477                  then do:
     4478                         assign lg-relat-erro  = yes
     4479                                lg-modulo-erro = yes.
     4480                         RUN pi-cria-tt-erros("Cancelamento de modulo da proposta inferior a cancelamento do modulo do beneficiario. Modulo:" + string(pro-pla.cd-modulo)).
     4481                       end.
     4482                END.
     4483                    
     4484           if   import-modul-bnfciar.aa-ult-fat-period <> 0
     4485           then do:
     4486                  if   import-modul-bnfciar.aa-ult-fat-period < year(import-modul-bnfciar.dat-inic)
     4487                  then do:
     4488                         IF import-modul-bnfciar.aa-ult-fat-period <> ?
     4489                         THEN char-aux1 = string(import-modul-bnfciar.aa-ult-fat-period).
     4490                         ELSE char-aux1 = "nulo".
     4491   
     4492                         IF import-modul-bnfciar.dat-inic <> ?
     4493                         THEN char-aux2 = STRING(import-modul-bnfciar.dat-inic).
     4494                         ELSE char-aux2 = "nulo".
     4495   
     4496                         RUN pi-cria-tt-erros("Ano do faturamento do modulo (" + char-aux1 + ") menor que a data de inclusao do modulo(" + char-aux2 + ")").
     4497           
     4498                         assign lg-relat-erro  = yes
     4499                                lg-modulo-erro = yes.
     4500                       end.
     4501                       
     4502                  if   import-modul-bnfciar.aa-ult-fat-period   =  year(import-modul-bnfciar.dat-inic)
     4503                  and  import-modul-bnfciar.num-mes-ult-faturam < month(import-modul-bnfciar.dat-inic)
     4504                  then do:
     4505                         IF import-modul-bnfciar.aa-ult-fat-period <> ?
     4506                         THEN char-aux1 = string(import-modul-bnfciar.aa-ult-fat-period).
     4507                         ELSE char-aux1 = "nulo".
     4508                         
     4509                         IF import-modul-bnfciar.num-mes-ult-faturam <> ?
     4510                         THEN char-aux2 = STRING(import-modul-bnfciar.num-mes-ult-faturam).
     4511                         ELSE char-aux2 = "nulo".
     4512   
     4513                         IF month(import-modul-bnfciar.dat-inic) <> ?
     4514                         THEN char-aux3 = STRING(month(import-modul-bnfciar.dat-inic)).
     4515                         ELSE char-aux3 = "nulo".
     4516   
     4517                         RUN pi-cria-tt-erros("Mes do faturamento (" + char-aux1 + "/" + char-aux2 + ") do modulo (" + STRING(import-modul-bnfciar.cdn-modul) 
     4518                                              + ") menor que a data de inclusao do modulo (" + char-aux1 + "/" + char-aux3 + ")").
     4519           
     4520                         assign lg-relat-erro  = yes
     4521                                lg-modulo-erro = yes.
     4522                       end.
     4523           
     4524                  if   import-modul-bnfciar.dat-fim = ?
     4525                  and (import-modul-bnfciar.aa-ult-fat-period   <> import-bnfciar.aa-ult-fat-period
     4526                   or  import-modul-bnfciar.num-mes-ult-faturam <> import-bnfciar.num-mes-ult-faturam)
     4527                  then do:
     4528                         IF import-modul-bnfciar.aa-ult-fat-period <> ?
     4529                         THEN char-aux1 = string(import-modul-bnfciar.aa-ult-fat-period).
     4530                         ELSE char-aux1 = "nulo".
     4531                         
     4532                         IF import-bnfciar.aa-ult-fat-period <> ?
     4533                         THEN char-aux2 = string(import-bnfciar.aa-ult-fat-period).
     4534                         ELSE char-aux2 = "nulo".
     4535   
     4536                         IF import-modul-bnfciar.num-mes-ult-faturam <> ?
     4537                         THEN char-aux3 = STRING(import-modul-bnfciar.num-mes-ult-faturam).
     4538                         ELSE char-aux3 = "nulo".
     4539                         
     4540                         IF import-bnfciar.num-mes-ult-faturam <> ?
     4541                         THEN char-aux4 = STRING(import-bnfciar.num-mes-ult-faturam).
     4542                         ELSE char-aux4 = "nulo".
     4543                         
     4544                         RUN pi-cria-tt-erros("Data do faturamento (" + char-aux1 + "/" + char-aux3 
     4545                                              + ") do modulo (" + STRING(import-modul-bnfciar.cdn-modul) 
     4546                                              + ") difere da data do faturamento do beneficiario (" + char-aux2 + "/" + char-aux4 + ")").
     4547           
     4548                         assign lg-relat-erro  = yes
     4549                                lg-modulo-erro = yes.
     4550                       end.
     4551   
     4552                  if  import-modul-bnfciar.num-mes-ult-faturam <> 0 
     4553                  then do:
     4554                         /* Comentado 30/06/16 */
     4555                         /*if import-modul-bnfciar.aa-ult-fat-period < year(import-modul-bnfciar.dat-inic)
     4556                         then do:
     4557                                RUN pi-cria-tt-erros("Data do ultimo faturamento do modulo difere da data de Inicio do modulo").
     4558                                assign lg-relat-erro  = yes.
     4559                              end.
     4560                  
     4561                         if  import-modul-bnfciar.aa-ult-fat-period   =  year(import-modul-bnfciar.dat-inic)
     4562                         and import-modul-bnfciar.num-mes-ult-faturam < month(import-modul-bnfciar.dat-inic)
     4563                         then do:
     4564                                RUN pi-cria-tt-erros("Data do ultimo faturamento do modulo difere da data de Inicio do modulo").
     4565                                assign lg-relat-erro  = yes.
     4566                              end.*/
     4567                       end.
     4568                end.
     4569           
     4570           if  ti-pl-sa.lg-usa-padrao-cobertura
     4571           then do:
     4572                  if (mod-cob.in-identifica-modulo = "S" and  pla-mod.lg-grava-automatico)
     4573                  or pla-mod.lg-modulo-agregado
     4574                  then.
     4575                  else do:
     4576                         IF NOT CAN-FIND (FIRST propcopa use-index propcop1
     4577                                          where propcopa.cd-modalidade       = import-bnfciar.cd-modalidade  
     4578                                            and propcopa.nr-proposta         = propost.nr-proposta
     4579                                            and propcopa.cd-padrao-cobertura = import-bnfciar.cd-padrao-cob  
     4580                                            and propcopa.cd-modulo           = import-modul-bnfciar.cdn-modul)
     4581                         THEN DO:
     4582                               /* if (import-bnfciar.dt-exclusao-plano = ?  and
     4583                                    import-modul-bnfciar.dat-fim <> ?)
     4584                                or (import-bnfciar.dt-exclusao-plano <> ? and
     4585                                    import-bnfciar.dt-exclusao-plano <> import-modul-bnfciar.dat-fim and 
     4586                                    import-modul-bnfciar.dat-fim     <  import-bnfciar.dt-exclusao-plano)
     4587                                then.
     4588                                else do:
     4589                                       assign lg-relat-erro  = yes
     4590                                              lg-modulo-erro = yes.
     4591                                       RUN pi-cria-tt-erros("Modulo nao cadastrado para o padrao de cobertura. Modulo: " + string(import-modul-bnfciar.cdn-modul)).
     4592                                     end.*/
     4593                              END.
     4594                         ELSE do:
     4595                                if  import-bnfciar.dt-exclusao-plano = ?
     4596                                and import-modul-bnfciar.dat-fim    <> ?
     4597                                then do:
     4598                                       assign lg-relat-erro  = yes
     4599                                              lg-modulo-erro = yes.
     4600                                       RUN pi-cria-tt-erros("Modulo cancelado para padrao ativo").
     4601                                    end.
     4602                         
     4603                                if  import-bnfciar.dt-exclusao-plano <> ?
     4604                                and import-modul-bnfciar.dat-fim     <> ?
     4605                                and import-bnfciar.dt-exclusao-plano <> import-modul-bnfciar.dat-fim
     4606                                then do:
     4607                                       assign lg-relat-erro  = yes
     4608                                              lg-modulo-erro = yes.
     4609                                       RUN pi-cria-tt-erros("Padrao de Cobertura X modulo invalido").
     4610                                     end.
     4611                              end.
     4612                       end.               
     4613                   
     4614                  if pro-pla.lg-cobertura-obrigatoria = no
     4615                  and in-classif = 1
     4616                  then do:
     4617                         assign lg-relat-erro  = yes
     4618                                lg-modulo-erro = yes.
     4619                         RUN pi-cria-tt-erros("Indicador Cobertura Obrigatoria invalido para este parametro de importacao").
     4620                       end.
     4621   
     4622                  if pro-pla.lg-cobertura-obrigatoria = yes
     4623                  and in-classif = 2
     4624                  then do:
     4625                         assign lg-relat-erro  = yes
     4626                                lg-modulo-erro = yes.
     4627                         RUN pi-cria-tt-erros("Indicador Cobertura Opcional invalido para este parametro de importacao").
     4628                       end.
     4629                end.
     4630       END.
     4631   
     4632   END PROCEDURE.
     4633   
     4634   PROCEDURE consiste-repasse-benef:
     4635   
     4636       FOR EACH import-negociac-bnfciar FIELDS (cd-unidade-destino dt-intercambio num-mes-ult-repas num-ano-ult-repas dat-saida)
     4637          WHERE import-negociac-bnfciar.num-seqcial-bnfciar = import-bnfciar.num-seqcial-bnfciar NO-LOCK:
     4638   
     4639           /* ----------------------------------------------- LEITURA NEGOCIACAO --- */
     4640           FOR FIRST propunim FIELDS (aa-ult-rep mm-ult-rep)
     4641               where propunim.cd-modalidade = import-bnfciar.cd-modalidade
     4642                 and propunim.nr-proposta   = propost.nr-proposta
     4643                 and propunim.cd-unimed     = import-negociac-bnfciar.cd-unidade-destino NO-LOCK:
     4644           END.
     4645           if not avail propunim
     4646           then do:
     4647                  assign lg-relat-erro  = yes
     4648                         lg-modulo-erro = yes.
     4649                  run pi-cria-tt-erros("Unidade de repasse nao cadastrada para Esta Proposta").
     4650                  NEXT.
     4651                end.
     4652   
     4653           /* ------------------------------------------------ CODIGO DA UNIDADE --- */
     4654           if   import-negociac-bnfciar.cd-unidade-destino = 0
     4655           then do:
     4656                  assign lg-relat-erro  = yes
     4657                         lg-modulo-erro = yes.
     4658                  run pi-cria-tt-erros("Unidade destino do Repasse Zerada").
     4659                end.
     4660           
     4661           /* --------------------------------------------------- LEITURA UNIMED --- */
     4662           IF NOT CAN-FIND (FIRST unimed where unimed.cd-unimed = import-negociac-bnfciar.cd-unidade-destino)
     4663           then do:
     4664                  assign lg-relat-erro  = yes
     4665                         lg-modulo-erro = yes.
     4666                  run pi-cria-tt-erros("Unidade destino do Repasse Nao Cadastrada").
     4667                end.
     4668   
     4669           /* ---------------------------------------------------------------------- */
     4670           if  import-bnfciar.dt-exclusao-plano <> ?
     4671           THEN DO:
     4672                  IF import-negociac-bnfciar.dt-intercambio > import-bnfciar.dt-exclusao-plano
     4673                  then do:
     4674                         assign lg-relat-erro  = yes
     4675                                lg-modulo-erro = yes.
     4676                         run pi-cria-tt-erros("Data de Intercambio maior que a data de exclusao do Beneficiario").
     4677                       end.
     4678   
     4679                  IF import-negociac-bnfciar.dat-saida > import-bnfciar.dt-exclusao-plano
     4680                  then do:
     4681                         assign lg-relat-erro  = yes
     4682                                lg-modulo-erro = yes.
     4683                         run pi-cria-tt-erros("Data de saida do Repasse maior que a data de exclusao do Beneficiario").
     4684                       end.
     4685                END.
     4686   
     4687           /* ---------------------------------------------------------------------- */
     4688           IF import-bnfciar.dt-inclusao-plano <> ?
     4689           THEN DO:
     4690                  if import-negociac-bnfciar.dt-intercambio < import-bnfciar.dt-inclusao-plano
     4691                  then do:
     4692                         assign lg-relat-erro  = yes
     4693                                lg-modulo-erro = yes.
     4694                         run pi-cria-tt-erros("Data de Intercambio maior que a data de inclusao do Beneficiario").
     4695                       end.
     4696                      
     4697                  if   import-negociac-bnfciar.dat-saida < import-bnfciar.dt-inclusao-plano
     4698                  then do:
     4699                         assign lg-relat-erro  = yes
     4700                                lg-modulo-erro = yes.
     4701                         run pi-cria-tt-erros("Data de saida do Repasse menor que a data de inclusao do Beneficiario").
     4702                       end.
     4703                END.
     4704           
     4705           /* ---------------------------------------------------------------------- */
     4706           IF import-negociac-bnfciar.dat-saida = ?
     4707           THEN DO:
     4708                  if import-bnfciar.num-mes-ult-faturam <> import-negociac-bnfciar.num-mes-ult-repas
     4709                  then do:
     4710                         assign lg-relat-erro  = yes
     4711                                lg-modulo-erro = yes.
     4712                         run pi-cria-tt-erros("Mes do ultimo repasse calculado Invalido por diferir do Ultimo mes faturado do Benef.").
     4713                       end.
     4714   
     4715                  if import-bnfciar.aa-ult-fat-period <> import-negociac-bnfciar.num-ano-ult-repas
     4716                  then do:
     4717                         assign lg-relat-erro  = yes
     4718                                lg-modulo-erro = yes.
     4719                         run pi-cria-tt-erros("Ano do ultimo repasse calculado invalido por diferir do ultimo ano faturado do Benef.").
     4720                       end.
     4721   
     4722                  if   import-negociac-bnfciar.num-ano-ult-repas <> 0
     4723                  and  import-negociac-bnfciar.num-mes-ult-repas <> 0
     4724                  then do:
     4725                         if import-negociac-bnfciar.num-ano-ult-repas <> propunim.aa-ult-rep
     4726                         or import-negociac-bnfciar.num-mes-ult-repas <> propunim.mm-ult-rep                
     4727                         then do:
     4728                                assign lg-relat-erro  = yes
     4729                                       lg-modulo-erro = yes.
     4730                                run pi-cria-tt-erros("Ultimo repasse calculado (" + STRING(import-negociac-bnfciar.num-mes-ult-repas) 
     4731                                                     + "/" + STRING(import-negociac-bnfciar.num-ano-ult-repas) 
     4732                                                     + ") invalido por diferir do ultimo repasse calculado para negociacao(" + 
     4733                                                     STRING(propunim.mm-ult-rep) + "/" + STRING(propunim.aa-ult-rep) + ")").
     4734                              end.
     4735                       end.
     4736                END.
     4737   
     4738           ASSIGN lg-registro-repasse-aux = yes.
     4739   
     4740       END.
     4741   
     4742   END PROCEDURE.
     4743   
     4744   PROCEDURE consiste-repas-atend:
     4745   
     4746       FOR EACH import-atendim-bnfciar WHERE import-atendim-bnfciar.num-seqcial-bnfciar = import-bnfciar.num-seqcial-bnfciar NO-LOCK:
     4747   
     4748           /* ------------------------------------------------ CODIGO DA UNIDADE --- */
     4749           if   import-atendim-bnfciar.cd-unidade-destino = 0
     4750           then do:
     4751                  RUN pi-cria-tt-erros("Unidade Atendimento do Repasse Zerada").
     4752           
     4753                  assign lg-relat-erro = yes
     4754                         lg-modulo-erro    = yes.
     4755                end.
     4756           
     4757           /* --------------------------------------------------- LEITURA UNIMED --- */
     4758           IF NOT CAN-FIND (FIRST unimed where unimed.cd-unimed = import-atendim-bnfciar.cd-unidade-destino )
     4759           then do:
     4760                  RUN pi-cria-tt-erros("Unidade Atendimento do Repasse Nao Cadastrada").
     4761           
     4762                  assign lg-relat-erro = yes
     4763                         lg-modulo-erro    = yes.
     4764                end.
     4765           
     4766           /* ---------------------------------------------------------------------- */
     4767           find first import-negociac-bnfciar where import-negociac-bnfciar.num-seqcial-bnfciar = import-bnfciar.num-seqcial-bnfciar no-lock no-error.
     4768           
     4769           IF import-atendim-bnfciar.dat-intercam-atendim < import-negociac-bnfciar.dt-intercambio
     4770           then do:
     4771                  RUN pi-cria-tt-erros("Data de Atendimento maior que a data de intercambio do Beneficiario").
     4772           
     4773                  assign lg-relat-erro = yes
     4774                         lg-modulo-erro    = yes.
     4775                end.
     4776           
     4777           /* ---------------------------------------------------------------------- */
     4778           if import-bnfciar.dt-exclusao-plano <> ?
     4779           THEN DO:
     4780                  if import-atendim-bnfciar.dat-intercam-atendim  > import-bnfciar.dt-exclusao-plano
     4781                  then do:
     4782                         RUN pi-cria-tt-erros("Data de Atendimento maior que a data de exclusao do Beneficiario").
     4783                  
     4784                         assign lg-relat-erro  = yes
     4785                                lg-modulo-erro = yes.
     4786                       end.
     4787   
     4788                  if import-atendim-bnfciar.dat-saida-atendim > import-bnfciar.dt-exclusao-plano
     4789                  then do:
     4790                         RUN pi-cria-tt-erros("Data de saida do atendimento  maior que a data de exclusao do Beneficiario").
     4791                  
     4792                         assign lg-relat-erro = yes
     4793                                lg-modulo-erro    = yes.           
     4794                       end.
     4795                END.
     4796           
     4797           /* ---------------------------------------------------------------------- */
     4798           IF import-atendim-bnfciar.dat-saida-atendim = ?
     4799           THEN DO:
     4800                  if import-negociac-bnfciar.dat-saida <> ?
     4801                  then do:
     4802                         RUN pi-cria-tt-erros("Existe unidade de atendimento ativa para a unidade de negociacao cancelada").
     4803                  
     4804                         assign lg-relat-erro  = yes
     4805                                lg-modulo-erro = yes. 
     4806                       end. 
     4807                END.
     4808           ELSE if   import-atendim-bnfciar.dat-saida-atendim < import-bnfciar.dt-inclusao-plano
     4809                then do:
     4810                       RUN pi-cria-tt-erros("Data de saida do Atendimento menor que a data de inclusao do Beneficiario").
     4811                
     4812                       assign lg-relat-erro  = yes
     4813                              lg-modulo-erro = yes. 
     4814                     end.
     4815                       
     4816       END.
     4817   
     4818   END PROCEDURE.
     4819   
     4820   PROCEDURE consiste-padrao-benef:
     4821   
     4822       def var lg-procedimento-aux as log no-undo.
     4823   
     4824       FOR EACH import-cobert-bnfciar WHERE import-cobert-bnfciar.num-seqcial-bnfciar = import-bnfciar.num-seqcial-bnfciar NO-LOCK:
     4825   
     4826           if   import-cobert-bnfciar.cdn-modulo = 0
     4827           then do:
     4828                  RUN pi-cria-tt-erros("Modulo de cobertura nao informado").
     4829                  assign lg-relat-erro = yes.
     4830                end.
     4831           
     4832           if   import-cobert-bnfciar.in-tipo-movimento <> "P"
     4833           and  import-cobert-bnfciar.in-tipo-movimento <> "I"
     4834           then do:
     4835                  RUN pi-cria-tt-erros("Tipo do movimento invalido").
     4836                  assign lg-relat-erro = yes.                           
     4837                end.
     4838           else if import-cobert-bnfciar.in-tipo-movimento = "P"
     4839                then assign lg-procedimento-aux = yes.
     4840                else assign lg-procedimento-aux = no.
     4841   
     4842           IF lg-procedimento-aux
     4843           THEN DO:
     4844                  if import-cobert-bnfciar.cd-proc-insu = 0
     4845                  then do:
     4846                         RUN pi-cria-tt-erros("Codigo do movimento invalido").
     4847                         assign lg-relat-erro = yes.                    
     4848                       end.
     4849                  
     4850                  if int(import-cobert-bnfciar.cod-tip-insumo) <> 0 
     4851                  then do:
     4852                         RUN pi-cria-tt-erros("Tipo de insumo deve ser zero para procedimento").
     4853                         assign lg-relat-erro = yes.                    
     4854                       end.
     4855   
     4856                   IF NOT CAN-FIND (FIRST ambproce 
     4857                                    where ambproce.cd-esp-amb        = int(substr(string(import-cobert-bnfciar.cd-proc-insu,"99999999"),1,2))
     4858                                      and ambproce.cd-grupo-proc-amb = int(substr(string(import-cobert-bnfciar.cd-proc-insu,"99999999"),3,2))
     4859                                      and ambproce.cd-procedimento   = int(substr(string(import-cobert-bnfciar.cd-proc-insu,"99999999"),5,3))
     4860                                      and ambproce.dv-procedimento   = int(substr(string(import-cobert-bnfciar.cd-proc-insu,"99999999"),8,1)))
     4861                   then do:
     4862                          RUN pi-cria-tt-erros("Procedimento nao cadastrado").
     4863                          assign lg-relat-erro = yes.
     4864                        end.
     4865                END.
     4866           else if import-cobert-bnfciar.cd-proc-insu <> 0
     4867                then do:
     4868                       IF NOT CAN-FIND (FIRST tipoinsu where tipoinsu.cd-tipo-insumo = int(import-cobert-bnfciar.cod-tip-insumo))
     4869                       then do:
     4870                              RUN pi-cria-tt-erros("Tipo de insumo nao cadastrado").
     4871                              assign lg-relat-erro = yes.
     4872                            end.
     4873           
     4874                       IF NOT CAN-FIND (FIRST insumos 
     4875                                        where insumos.cd-tipo-insumo = int(import-cobert-bnfciar.cod-tip-insumo)
     4876                                          and insumos.cd-insumo      = import-cobert-bnfciar.cd-proc-insu )
     4877                       then do:
     4878                              RUN pi-cria-tt-erros("Insumo nao cadastrado").
     4879                              assign lg-relat-erro = yes.
     4880                            end.
     4881                     end. 
     4882           
     4883           if   string(import-cobert-bnfciar.cdn-tab-preco) = ""  
     4884           then do:
     4885                  RUN pi-cria-tt-erros("Tabela de moedas e carencias invalida").
     4886                  assign lg-relat-erro = yes.                              
     4887                end.
     4888           
     4889           if   import-cobert-bnfciar.in-carencia <> 1
     4890           and  import-cobert-bnfciar.in-carencia <> 2
     4891           and  import-cobert-bnfciar.in-carencia <> 5
     4892           then do:
     4893                  RUN pi-cria-tt-erros("Indicador de carencia invalido").
     4894                  assign lg-relat-erro = yes.                  
     4895                end.
     4896           
     4897           if   import-cobert-bnfciar.dat-inicial = ?      
     4898           then do:
     4899                  RUN pi-cria-tt-erros("Data de inicio invalida").
     4900                  assign lg-relat-erro = yes.                        
     4901                end.
     4902   
     4903   
     4904           if propost.cd-sit-propost > 5 
     4905           then do:
     4906                  /* ---------------------------- VERIFICA COBERTURA PARA O MODULO --- */
     4907                  FOR first pro-pla FIELDS (lg-cobertura-obrigatoria) use-index pro-pla3 
     4908                      where pro-pla.cd-modalidade   = import-bnfciar.cd-modalidade
     4909                        and pro-pla.nr-proposta     = propost.nr-proposta  
     4910                        and pro-pla.cd-modulo       = import-cobert-bnfciar.cdn-modulo 
     4911                        and pro-pla.dt-cancelamento = ?
     4912                        and pro-pla.dt-inicio      <= today
     4913                            NO-LOCK.
     4914                  END.
     4915                  if not avail pro-pla
     4916                  then FOR first pro-pla FIELDS (lg-cobertura-obrigatoria) use-index pro-pla3
     4917                           where pro-pla.cd-modalidade    = import-bnfciar.cd-modalidade
     4918                             and pro-pla.nr-proposta      = propost.nr-proposta  
     4919                             and pro-pla.cd-modulo        = import-cobert-bnfciar.cdn-modulo 
     4920                             and pro-pla.dt-cancelamento <> ?
     4921                             and pro-pla.dt-cancelamento >= today
     4922                             and pro-pla.dt-inicio       <= today
     4923                                 NO-LOCK.
     4924                       END.
     4925                end.
     4926           else do:
     4927                  /* ---------------------------- VERIFICA COBERTURA PARA O MODULO --- */                 
     4928                  FOR first pro-pla FIELDS (lg-cobertura-obrigatoria) use-index pro-pla3 
     4929                      where pro-pla.cd-modalidade   = import-bnfciar.cd-modalidade            
     4930                        and pro-pla.nr-proposta     = propost.nr-proposta              
     4931                        and pro-pla.cd-modulo       = import-cobert-bnfciar.cdn-modulo                       
     4932                            NO-LOCK.       
     4933                  END.
     4934                  if not avail pro-pla                                                                    
     4935                  then FOR first pro-pla FIELDS (lg-cobertura-obrigatoria) use-index pro-pla3 
     4936                           where pro-pla.cd-modalidade = import-bnfciar.cd-modalidade      
     4937                             and pro-pla.nr-proposta   = propost.nr-proposta        
     4938                             and pro-pla.cd-modulo     = import-cobert-bnfciar.cdn-modulo                 
     4939                                 NO-LOCK.
     4940                       END.
     4941                end.
     4942           
     4943           if not avail pro-pla
     4944           then do:
     4945                  RUN pi-cria-tt-erros("Proposta sem cobertura para este modulo").
     4946                  assign lg-relat-erro = yes.  
     4947                end.
     4948   
     4949           if import-bnfciar.dt-exclusao-plano <> ?
     4950           then do:
     4951                  if import-cobert-bnfciar.dat-cancel = ?
     4952                  then do:
     4953                         RUN pi-cria-tt-erros("Beneficiario com data de exclusao. Deve ser informada data de cancelamento").
     4954                         assign lg-relat-erro = yes.
     4955                       end.
     4956           
     4957                  if import-cobert-bnfciar.dat-cancel > import-bnfciar.dt-exclusao-plano 
     4958                  then do:
     4959                         RUN pi-cria-tt-erros("Data cancelamento nao pode ser maior que data exclusao beneficiaro").
     4960                         assign lg-relat-erro = yes.
     4961                       end.
     4962                end.
     4963           
     4964           if  import-cobert-bnfciar.dat-cancel <> ?
     4965           and import-cobert-bnfciar.dat-cancel <= import-cobert-bnfciar.dat-inicial
     4966           then do: 
     4967                  RUN pi-cria-tt-erros("Data de Cancelamento deve ser maior do que a Data Inicial").
     4968                  assign lg-relat-erro = yes.
     4969                end.
     4970   
     4971           if import-cobert-bnfciar.in-carencia = 1
     4972           then do:
     4973                  if lg-procedimento-aux
     4974                  then do:
     4975                         /* Veririca cobertura no produto */
     4976                         IF CAN-FIND (FIRST pl-mo-am 
     4977                                      where pl-mo-am.cd-modalidade = propost.cd-modalidade     
     4978                                        and pl-mo-am.cd-plano      = propost.cd-plano          
     4979                                        and pl-mo-am.cd-tipo-plano = propost.cd-tipo-plano     
     4980                                        and pl-mo-am.cd-modulo     = import-cobert-bnfciar.cdn-modulo                
     4981                                        and pl-mo-am.cd-amb        = import-cobert-bnfciar.cd-proc-insu)
     4982                         then do:        
     4983                                /* Verifica restricao de cobertura na proposta */
     4984                                for each pr-mo-am FIELDS (dt-inicio dt-cancelamento)
     4985                                   where pr-mo-am.cd-modalidade          = propost.cd-modalidade
     4986                                     and pr-mo-am.nr-proposta            = propost.nr-proposta
     4987                                     and pr-mo-am.cd-modulo              = import-cobert-bnfciar.cdn-modulo
     4988                                     and pr-mo-am.cd-amb                 = import-cobert-bnfciar.cd-proc-insu
     4989                                     and pr-mo-am.lg-acrescimo-cobertura = no /* Restricao */
     4990                                         no-lock:
     4991                               
     4992                                    if  (pr-mo-am.dt-inicio <= import-cobert-bnfciar.dat-inicial and pr-mo-am.dt-cancelamento  = ?)
     4993                                    or  (pr-mo-am.dt-inicio <= import-cobert-bnfciar.dat-inicial and pr-mo-am.dt-cancelamento <> ? and  pr-mo-am.dt-cancelamento >= import-cobert-bnfciar.dat-inicial)
     4994                                    then leave.
     4995                                end.
     4996           
     4997                                if not avail pr-mo-am
     4998                                then do:
     4999                                       RUN pi-cria-tt-erros("Beneficiario ja possui cobertura para o procedimento").
     5000                                       assign lg-relat-erro = yes.
     5001                                       NEXT.
     5002                                     end.
     5003                              end.
     5004                         else do:
     5005                                /* Verifica acrescimo de cobertura na proposta */
     5006                                for each pr-mo-am FIELDS (dt-inicio dt-cancelamento)
     5007                                   where pr-mo-am.cd-modalidade          = propost.cd-modalidade
     5008                                     and pr-mo-am.nr-proposta            = propost.nr-proposta
     5009                                     and pr-mo-am.cd-modulo              = import-cobert-bnfciar.cdn-modulo
     5010                                     and pr-mo-am.cd-amb                 = import-cobert-bnfciar.cd-proc-insu
     5011                                     and pr-mo-am.lg-acrescimo-cobertura = yes /* Acrescimo */
     5012                                         no-lock:
     5013                                
     5014                                    if  (pr-mo-am.dt-inicio       <= import-cobert-bnfciar.dat-inicial
     5015                                    and  pr-mo-am.dt-cancelamento  = ?)
     5016                                    or  (pr-mo-am.dt-inicio       <= import-cobert-bnfciar.dat-inicial
     5017                                    and  pr-mo-am.dt-cancelamento <> ?
     5018                                    and  pr-mo-am.dt-cancelamento >= import-cobert-bnfciar.dat-inicial)
     5019                                    then leave.
     5020                                        
     5021                                end.
     5022                                
     5023                                if avail pr-mo-am
     5024                                then do:
     5025                                       RUN pi-cria-tt-erros("Beneficiario ja possui cobertura para o procedimento").
     5026                                       assign lg-relat-erro = yes.
     5027                                       NEXT.
     5028                                     end.
     5029                              end.
     5030                       end.
     5031                  else do:
     5032                         find partinsu where partinsu.cd-modalidade  = propost.cd-modalidade             
     5033                                         and partinsu.cd-plano       = propost.cd-plano                  
     5034                                         and partinsu.cd-tipo-plano  = propost.cd-tipo-plano             
     5035                                         and partinsu.cd-modulo      = import-cobert-bnfciar.cdn-modulo                        
     5036                                         and partinsu.cd-tipo-insumo = int(import-cobert-bnfciar.cod-tip-insumo)
     5037                                         and partinsu.cd-insumo      = import-cobert-bnfciar.cd-proc-insu              
     5038                                             no-lock no-error.                                           
     5039                         if not available partinsu                                                       
     5040                         then find partinsu where partinsu.cd-modalidade  = propost.cd-modalidade   
     5041                                              and partinsu.cd-plano       = propost.cd-plano        
     5042                                              and partinsu.cd-tipo-plano  = propost.cd-tipo-plano   
     5043                                              and partinsu.cd-modulo      = import-cobert-bnfciar.cdn-modulo              
     5044                                              and partinsu.cd-tipo-insumo = int(import-cobert-bnfciar.cod-tip-insumo)
     5045                                              and partinsu.cd-insumo      = 0    
     5046                                                  no-lock no-error.                                 
     5047                              if not available partinsu                                             
     5048                              then find partinsu where partinsu.cd-modalidade  = propost.cd-modalidade
     5049                                                   and partinsu.cd-plano       = propost.cd-plano     
     5050                                                   and partinsu.cd-tipo-plano  = propost.cd-tipo-plano
     5051                                                   and partinsu.cd-modulo      = import-cobert-bnfciar.cdn-modulo           
     5052                                                   and partinsu.cd-tipo-insumo = 0
     5053                                                   and partinsu.cd-insumo      = 0                    
     5054                                                       no-lock no-error.                              
     5055                         if available partinsu                      
     5056                         then do:
     5057                                RUN pi-cria-tt-erros("Beneficiario ja possui cobertura para o insumo").
     5058                                assign lg-relat-erro = yes.
     5059                                NEXT.
     5060                              end.
     5061                       end.
     5062                end.
     5063   
     5064          if import-cobert-bnfciar.in-carencia = 2  /* Restricao */                                                                        
     5065          or import-cobert-bnfciar.in-carencia = 5  /* Acrescimo */
     5066          then do:                                                                                        
     5067                 if lg-procedimento-aux                                                                   
     5068                 then do:               
     5069                        /* Verifica se tem cobertura para restringir ou sobrepor */
     5070                        IF NOT CAN-FIND (FIRST pl-mo-am 
     5071                                         where pl-mo-am.cd-modalidade = propost.cd-modalidade                
     5072                                           and pl-mo-am.cd-plano      = propost.cd-plano                     
     5073                                           and pl-mo-am.cd-tipo-plano = propost.cd-tipo-plano                
     5074                                           and pl-mo-am.cd-modulo     = import-cobert-bnfciar.cdn-modulo                           
     5075                                           and pl-mo-am.cd-amb        = import-cobert-bnfciar.cd-proc-insu)
     5076                        then do:       
     5077                               /* Verifica acrescimo de cobertura na proposta */
     5078                               for each pr-mo-am FIELDS (dt-inicio dt-cancelamento)
     5079                                  where pr-mo-am.cd-modalidade          = propost.cd-modalidade
     5080                                    and pr-mo-am.nr-proposta            = propost.nr-proposta
     5081                                    and pr-mo-am.cd-modulo              = import-cobert-bnfciar.cdn-modulo
     5082                                    and pr-mo-am.cd-amb                 = import-cobert-bnfciar.cd-proc-insu
     5083                                    and pr-mo-am.lg-acrescimo-cobertura = yes /* Acrescimo */
     5084                                        no-lock:
     5085                               
     5086                                   if  (pr-mo-am.dt-inicio       <= import-cobert-bnfciar.dat-inicial
     5087                                   and  pr-mo-am.dt-cancelamento  = ?)
     5088                                   or  (pr-mo-am.dt-inicio       <= import-cobert-bnfciar.dat-inicial
     5089                                   and  pr-mo-am.dt-cancelamento <> ?
     5090                                   and  pr-mo-am.dt-cancelamento >= import-cobert-bnfciar.dat-inicial)
     5091                                   then leave.
     5092                               end.
     5093                               
     5094                               if not avail pr-mo-am
     5095                               then do:
     5096                                      RUN pi-cria-tt-erros("Beneficiario nao possui cobertura para o procedimento").
     5097                                      assign lg-relat-erro = yes.
     5098                                      NEXT.
     5099                                    end.
     5100                             end.
     5101                        else do:
     5102                               /* Verifica restricao de cobertura na proposta */
     5103                               for each pr-mo-am FIELDS (dt-inicio dt-cancelamento)
     5104                                  where pr-mo-am.cd-modalidade          = propost.cd-modalidade
     5105                                    and pr-mo-am.nr-proposta            = propost.nr-proposta
     5106                                    and pr-mo-am.cd-modulo              = import-cobert-bnfciar.cdn-modulo
     5107                                    and pr-mo-am.cd-amb                 = import-cobert-bnfciar.cd-proc-insu
     5108                                    and pr-mo-am.lg-acrescimo-cobertura = no /* Restricao */
     5109                                        no-lock:
     5110                               
     5111                                   if  (pr-mo-am.dt-inicio <= import-cobert-bnfciar.dat-inicial and pr-mo-am.dt-cancelamento  = ?)
     5112                                   or  (pr-mo-am.dt-inicio <= import-cobert-bnfciar.dat-inicial and pr-mo-am.dt-cancelamento <> ? and  pr-mo-am.dt-cancelamento >= import-cobert-bnfciar.dat-inicial)
     5113                                   then leave.
     5114                               end.
     5115                               
     5116                               if avail pr-mo-am
     5117                               then do:
     5118                                      RUN pi-cria-tt-erros("Beneficiario nao possui cobertura para o procedimento").
     5119                                      assign lg-relat-erro = yes.
     5120                                      NEXT.
     5121                                    end.
     5122                             end.
     5123                      end.                                                                                
     5124                 else do:                                                                                 
     5125                        find partinsu where partinsu.cd-modalidade  = propost.cd-modalidade               
     5126                                        and partinsu.cd-plano       = propost.cd-plano                    
     5127                                        and partinsu.cd-tipo-plano  = propost.cd-tipo-plano               
     5128                                        and partinsu.cd-modulo      = import-cobert-bnfciar.cdn-modulo                          
     5129                                        and partinsu.cd-tipo-insumo = int(import-cobert-bnfciar.cod-tip-insumo)
     5130                                        and partinsu.cd-insumo      = import-cobert-bnfciar.cd-proc-insu                
     5131                                            no-lock no-error.                                             
     5132                        if not available partinsu                                                         
     5133                        then find partinsu where partinsu.cd-modalidade  = propost.cd-modalidade          
     5134                                             and partinsu.cd-plano       = propost.cd-plano               
     5135                                             and partinsu.cd-tipo-plano  = propost.cd-tipo-plano          
     5136                                             and partinsu.cd-modulo      = import-cobert-bnfciar.cdn-modulo                     
     5137                                             and partinsu.cd-tipo-insumo = int(import-cobert-bnfciar.cod-tip-insumo)
     5138                                             and partinsu.cd-insumo      = 0                              
     5139                                                 no-lock no-error.                                        
     5140                             if not available partinsu                                                    
     5141                             then find partinsu where partinsu.cd-modalidade  = propost.cd-modalidade     
     5142                                                  and partinsu.cd-plano       = propost.cd-plano          
     5143                                                  and partinsu.cd-tipo-plano  = propost.cd-tipo-plano     
     5144                                                  and partinsu.cd-modulo      = import-cobert-bnfciar.cdn-modulo                
     5145                                                  and partinsu.cd-tipo-insumo = 0                         
     5146                                                  and partinsu.cd-insumo      = 0                         
     5147                                                      no-lock no-error.                                   
     5148                        if not available partinsu                                                             
     5149                        then do: 
     5150                               RUN pi-cria-tt-erros("Beneficiario nao possui cobertura para o insumo").
     5151                               assign lg-relat-erro = yes.
     5152                               NEXT.
     5153                             end.                                                                         
     5154                      end.                                                                                
     5155               end.  
     5156   
     5157          assign cd-tab-preco-aux = substr(string(import-cobert-bnfciar.cdn-tab-preco),1,03)
     5158                                  + substr(string(import-cobert-bnfciar.cdn-tab-preco),5,02).
     5159          
     5160          if import-cobert-bnfciar.in-carencia <> 2 
     5161          then do:
     5162                 if   lg-procedimento-aux
     5163                 then do:
     5164                        if import-cobert-bnfciar.in-carencia = 5    
     5165                        AND avail pr-mo-am 
     5166                        then do: 
     5167                               if avail promodpr 
     5168                               and (promodpr.in-tipo-regra = 1 or promodpr.in-tipo-regra = 3)
     5169                               then do:
     5170                                      if string(import-cobert-bnfciar.cdn-tab-preco) = pr-mo-am.cd-tab-preco                                                       
     5171                                      and       import-cobert-bnfciar.nr-dias        = promodpr.nr-dias-validade
     5172                                      then do:    
     5173                                             RUN pi-cria-tt-erros("Para sobreposicao a tabela de moedas e carencias ou numero de dias devem ser diferentes da cobertura ja existente").
     5174                                             assign lg-relat-erro = yes.
     5175                                           end.   
     5176                                    end.
     5177                               else do:
     5178                                      if string(import-cobert-bnfciar.cdn-tab-preco) = pr-mo-am.cd-tab-preco                                                       
     5179                                      and       import-cobert-bnfciar.nr-dias        = pr-mo-am.nr-dias                                                            
     5180                                      then do:     
     5181                                             RUN pi-cria-tt-erros("Para sobreposicao a tabela de moedas e carencias ou numero de dias devem ser diferentes da cobertura ja existente ").
     5182                                             assign lg-relat-erro = yes.
     5183                                           end.   
     5184                                    end.                                                                                                                                                                                                                                                                                                                                          
     5185                             end.                                                                                                        
     5186                      end.
     5187                 else do:
     5188                        if   avail partinsu
     5189                        AND string(import-cobert-bnfciar.cdn-tab-preco) = partinsu.cd-tab-preco
     5190                        and        import-cobert-bnfciar.in-carencia    = 5
     5191                        then do:
     5192                               RUN pi-cria-tt-erros("Para sobreposicao a tabela de moedas e carencias deve ser diferente da cobertura ja existente ").
     5193                               assign lg-relat-erro = yes.
     5194                             end.
     5195                      end.
     5196          
     5197                 IF NOT CAN-FIND (first precproc 
     5198                                  where precproc.cd-tab-preco   = cd-tab-preco-aux                     
     5199                                    and precproc.cd-forma-pagto = propost.cd-forma-pagto                  
     5200                                    and precproc.dt-limite     >= TODAY)                                      
     5201                 then do:       
     5202                        RUN pi-cria-tt-erros("Tabela de moedas e carencias nao cadastrada ou com data limite vencida").
     5203                        assign lg-relat-erro = yes.
     5204                      end.   
     5205               end.
     5206       END.
     5207   
     5208   END PROCEDURE.
