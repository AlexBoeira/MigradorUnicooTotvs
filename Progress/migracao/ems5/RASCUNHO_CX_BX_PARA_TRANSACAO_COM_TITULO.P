def var v_hdl_aux as Handle no-undo.
def var lg_erro_bx_aux       as log no-undo.

DEF NEW GLOBAL SHARED VAR v_cod_usuar_corren  AS CHAR FORMAT "x(12)" NO-UNDO.
DEF NEW GLOBAL SHARED VAR v_cod_grp_usuar_lst AS CHAR FORMAT "x(12)" NO-UNDO.

DEF BUFFER b_ti_cx_bx_acr FOR ti_cx_bx_acr.

RUN escrever-log("@@@@@ ANTES DE LER TI_CX_BX_ACR CDSITUACAO: " + in-status-par).

/* Inicio do processamento */
FOR EACH ti_cx_bx_acr where ti_cx_bx_acr.cdsituacao = in-status-par:

    ASSIGN lg_erro_bx_aux=NO.

    /* Limpa Temporaria */
    empty temp-table tt_integr_acr_liquidac_lote.
    empty temp-table tt_integr_acr_liq_item_lote_3.
    empty temp-table tt_integr_acr_abat_antecip.
    empty temp-table tt_integr_acr_abat_prev.
    empty temp-table tt_integr_acr_cheq.
    empty temp-table tt_integr_acr_liquidac_impto_2.
    empty temp-table tt_integr_acr_rel_pend_cheq.
    empty temp-table tt_integr_acr_liq_aprop_ctbl.
    empty temp-table tt_integr_acr_liq_desp_rec.
    empty temp-table tt_integr_acr_aprop_liq_antec.
    empty temp-table tt_log_erros_import_liquidac.
    empty temp-table tt_integr_cambio_ems5.
    empty temp-table tt_params_generic_api.     
    /* Limpa Temporaria */

    RUN escrever-log("@@@@@ ANTES DE LER TIT_ACR. cod_estab: " + STRING(ti_cx_bx_acr.cod_estab)
                     + " cod_espec_docto: " + STRING(ti_cx_bx_acr.cod_espec_docto)
                     + " cod_ser_docto: " + STRING(ti_cx_bx_acr.COD_SER_DOCTO)
                     + " cod_tit_acr: " + STRING(ti_cx_bx_acr.cod_titulo_acr)
                     + " cod_parcela: " + string(ti_cx_bx_acr.cod_parcela)
                     + " cod_cliente: " + STRING(ti_cx_bx_acr.cod_cliente)
                     ).

    FIND FIRST tit_acr WHERE tit_acr.cod_estab       = ti_cx_bx_acr.cod_estab
                         and tit_acr.cod_espec_docto = ti_cx_bx_acr.cod_espec_docto
                         AND tit_acr.COD_SER_DOCTO   = ti_cx_bx_acr.COD_SER_DOCTO
                         AND tit_acr.cod_tit_acr     = ti_cx_bx_acr.cod_titulo_acr 
                         and tit_acr.cod_parcela     = ti_cx_bx_acr.cod_parcela
                         AND tit_acr.cdn_cliente     = ti_cx_bx_acr.cod_cliente 
                         NO-LOCK NO-ERROR. 

    PROCESS EVENTS.

    IF AVAIL tit_acr THEN DO:

        RUN escrever-log("@@@@@ ACHOU TIT_ACR").

        message in-status-par " - BAIXA TITULOS ACR "
                tit_acr.cdn_cliente         skip
                ti_cx_bx_acr.cod_cliente    skip
                tit_acr.cod_tit_acr         skip
                ti_cx_bx_acr.cod_titulo_acr skip
                tit_acr.cod_estab           skip
                ti_cx_bx_acr.cod_estab      skip
                tit_acr.cod_espec_docto     skip
                ti_cx_bx_acr.cod_espec_docto skip
                tit_acr.cod_parcela         skip
                ti_cx_bx_acr.cod_parcela    skip
                TI_CX_BX_ACR.NRSEQ_CONTROLE_INTEGRACAO.

        CREATE tt_integr_acr_liquidac_lote.
        ASSIGN
            tt_integr_acr_liquidac_lote.tta_cod_empresa                 = ti_cx_bx_acr.cod_empresa
            tt_integr_acr_liquidac_lote.tta_cod_estab_refer             = ti_cx_bx_acr.cod_estab
            tt_integr_acr_liquidac_lote.tta_cod_refer                   = "H" + string(ti_cx_bx_acr.nrseq_controle_integracao)
            tt_integr_acr_liquidac_lote.tta_cod_usuario                 = v_cod_usuar_corren 
            tt_integr_acr_liquidac_lote.tta_dat_transacao               = TODAY
            tt_integr_acr_liquidac_lote.tta_dat_gerac_lote_liquidac     = TODAY
            tt_integr_acr_liquidac_lote.ttv_rec_lote_liquidac_acr       = 1
            tt_integr_acr_liquidac_lote.tta_ind_tip_liquidac_acr        = "Lote"
            tt_integr_acr_liquidac_lote.ttv_log_atualiz_refer           = YES /*l-atu-ref*/
            tt_integr_acr_liquidac_lote.ttv_log_gera_lote_parcial       = YES /*l-atu-parc*/ .

        /*eliminar temporarias de lote de liquidacao da mesma referencia - residuo de processamentos anteriores em que ocorreu erro e nao desfez a transacao corretamente*/
        /*U##COD_ESTAB_REFER, U##COD_REFER*/
        FOR EACH lote_liquidac_acr EXCLUSIVE-LOCK
           WHERE lote_liquidac_acr.cod_estab_refer = tt_integr_acr_liquidac_lote.tta_cod_estab_refer
             AND lote_liquidac_acr.cod_refer       = tt_integr_acr_liquidac_lote.tta_cod_refer:

                 /*U##COD_ESTAB_REFER, U##COD_REFER, NUM_SEQ_REFER*/
                 FOR EACH ITEM_lote_liquidac_acr EXCLUSIVE-LOCK
                    WHERE ITEM_lote_liquidac_acr.cod_estab_refer = lote_liquidac_acr.cod_estab_refer
                      AND ITEM_lote_liquidac_acr.cod_refer       = lote_liquidac_acr.cod_refer:
                     
                          RUN escrever-log("@@@@@ELIMINANDO ITEM_LOTE_LIQUIDAC_ACR COM O PAI").
                          DELETE ITEM_lote_liquidac_acr.
                 END.

                 RUN escrever-log("@@@@@ELIMINANDO LOTE_LIQUIDAC_ACR COM O FILHO").
                 DELETE lote_liquidac_acr.
        END.

/*ANALISAR SE FAZ SENTIDO APAGAR ITEM_LOTE_LIQUIDAC_ACR PREVIAMENTE EXISTENTE PARA O MESMO TITULO!!!!!        */
        
        /*U##COD_ESTAB, U##COD_ESPEC_DOCTO, U##COD_SER_DOCTO, U##COD_TIT_ACR, U##COD_PARCELA, PROGRESS_RECID*/
        /*
        FIND FIRST ems5.ITEM_lote_liquidac_acr NO-LOCK
             WHERE ITEM_lote_liquidac_acr.cod_estab       = ti_cx_bx_acr.cod_estab
               AND ITEM_lote_liquidac_acr.cod_espec_docto = tit_acr.cod_espec_docto
               AND ITEM_lote_liquidac_acr.cod_ser_docto   = tit_acr.cod_ser_docto
               AND ITEM_lote_liquidac_acr.cod_tit_acr     = tit_acr.cod_tit_acr
               AND ITEM_lote_liquidac_acr.cod_parcela     = tit_acr.cod_parcela 
                   NO-ERROR.
        IF AVAIL ITEM_lote_liquidac_acr 
        THEN ASSIGN tt_integr_acr_liquidac_lote.tta_cod_refer = ITEM_lote_liquidac_acr.cod_refer.
        ELSE ASSIGN tt_integr_acr_liquidac_lote.tta_cod_refer = "H" + string(ti_cx_bx_acr.nrseq_controle_integracao).

        RUN escrever-log("@@@@@tt_integr_acr_liquidac_lote.tta_cod_refer: " + string(tt_integr_acr_liquidac_lote.tta_cod_refer)).
        */
        FOR EACH ems5.ITEM_lote_liquidac_acr EXCLUSIVE-LOCK
             WHERE ITEM_lote_liquidac_acr.cod_estab       = ti_cx_bx_acr.cod_estab
               AND ITEM_lote_liquidac_acr.cod_espec_docto = tit_acr.cod_espec_docto
               AND ITEM_lote_liquidac_acr.cod_ser_docto   = tit_acr.cod_ser_docto
               AND ITEM_lote_liquidac_acr.cod_tit_acr     = tit_acr.cod_tit_acr
               AND ITEM_lote_liquidac_acr.cod_parcela     = tit_acr.cod_parcela:

                   RUN escrever-log("@@@@@ELIMINANDO ITEM_LOTE_LIQUIDAC_ACR (RESIDUO)").
                   DELETE ITEM_lote_liquidac_acr.
        END.

        CREATE tt_integr_acr_liq_item_lote_3.
        ASSIGN
            tt_integr_acr_liq_item_lote_3.tta_cod_empresa                 = tit_acr.cod_empresa
            tt_integr_acr_liq_item_lote_3.tta_cod_estab                   = tit_acr.cod_estab 
            tt_integr_acr_liq_item_lote_3.tta_cod_espec_docto             = tit_acr.cod_espec_docto 
            tt_integr_acr_liq_item_lote_3.tta_cod_ser_docto               = tit_acr.cod_ser_docto 
            tt_integr_acr_liq_item_lote_3.tta_cod_tit_acr                 = tit_acr.cod_tit_acr
            tt_integr_acr_liq_item_lote_3.tta_cod_parcela                 = tit_acr.cod_parcela 
            tt_integr_acr_liq_item_lote_3.tta_cdn_cliente                 = tit_acr.cdn_cliente
            tt_integr_acr_liq_item_lote_3.tta_cod_portador                = ti_cx_bx_acr.cod_portador  
            tt_integr_acr_liq_item_lote_3.tta_cod_cart_bcia               = tit_acr.cod_cart_bcia 
            tt_integr_acr_liq_item_lote_3.tta_cod_indic_econ              = tit_acr.cod_indic_econ
            tt_integr_acr_liq_item_lote_3.tta_dat_cr_liquidac_tit_acr     = ti_cx_bx_acr.dat_baixa
            tt_integr_acr_liq_item_lote_3.tta_dat_cr_liquidac_calc        = ti_cx_bx_acr.dat_baixa
            tt_integr_acr_liq_item_lote_3.tta_dat_liquidac_tit_acr        = ti_cx_bx_acr.dat_baixa 
            
            tt_integr_acr_liq_item_lote_3.tta_val_liquidac_tit_acr        = ti_cx_bx_acr.val_liq_titulo
                                                                            /*+ ti_cx_bx_acr.val_desconto
                                                                            + ti_cx_bx_acr.val_abatimento
                                                                            - ti_cx_bx_acr.val_juros
                                                                            - ti_cx_bx_acr.val_multa*/

            tt_integr_acr_liq_item_lote_3.tta_val_desc_tit_acr            = ti_cx_bx_acr.val_desconto
            tt_integr_acr_liq_item_lote_3.tta_val_abat_tit_acr            = ti_cx_bx_acr.val_abatimento
            tt_integr_acr_liq_item_lote_3.tta_val_despes_bcia             = 0
            tt_integr_acr_liq_item_lote_3.tta_val_juros                   = ti_cx_bx_acr.val_juros
            tt_integr_acr_liq_item_lote_3.tta_val_multa_tit_acr           = ti_cx_bx_acr.val_multa
            tt_integr_acr_liq_item_lote_3.tta_log_gera_antecip            = NO 
            tt_integr_acr_liq_item_lote_3.tta_log_gera_avdeb              = NO
            tt_integr_acr_liq_item_lote_3.tta_ind_tip_item_liquidac_acr   = "Pagamento" 
            tt_integr_acr_liq_item_lote_3.ttv_rec_lote_liquidac_acr       = 1 
            tt_integr_acr_liq_item_lote_3.tta_des_text_histor             = "" /* observacoes para a baixa do titulo */
            tt_integr_acr_liq_item_lote_3.ttv_rec_item_lote_liquidac_acr  = RECID(tt_integr_acr_liq_item_lote). 

        /*teste Alex Boeira 20/03/2018. antes esse campo nunca estava sendo populado*/
        /*ASSIGN tt_integr_acr_liq_item_lote_3.tta_val_liquidac_orig = tt_integr_acr_liq_item_lote_3.tta_val_liquidac_tit_acr.*/
        ASSIGN tt_integr_acr_liq_item_lote_3.tta_val_liquidac_orig = ti_cx_bx_acr.val_liq_titulo
                                                                        + ti_cx_bx_acr.val_desconto
                                                                        + ti_cx_bx_acr.val_abatimento
                                                                        - ti_cx_bx_acr.val_juros
                                                                        - ti_cx_bx_acr.val_multa.

        /*****/
        
        RUN escrever-log("@@@@@tt_integr_acr_liq_item_lote_3.tta_val_liquidac_tit_acr: " + string(tt_integr_acr_liq_item_lote_3.tta_val_liquidac_tit_acr)).
        RUN escrever-log("@@@@@tt_integr_acr_liq_item_lote_3.tta_val_liquidac_orig: "    + string(tt_integr_acr_liq_item_lote_3.tta_val_liquidac_orig)).

        run prgfin/acr/acr901zf.py persistent set v_hdl_aux.

        IF lg-log-tmp-aux
        THEN DO:
               OUTPUT TO c:\temp\tt_integr_acr_liquidac_lote.csv APPEND.
               FOR EACH tt_integr_acr_liquidac_lote:
                   EXPORT DELIMITER ";" tt_integr_acr_liquidac_lote.
               END.
               OUTPUT CLOSE.
               OUTPUT TO c:\temp\tt_integr_acr_liq_item_lote_3.csv APPEND.
               PUT UNFORMATTED "tta_cod_empresa;tta_cod_estab;tta_cod_espec_docto;tta_cod_ser_docto;tta_num_seq_refer;tta_cod_tit_acr;tta_cod_parcela;tta_cdn_cliente;tta_cod_portador;tta_cod_portad_ext;tta_cod_cart_bcia;tta_cod_modalid_ext;tta_cod_finalid_econ;tta_cod_finalid_econ_ext;tta_cod_indic_econ;tta_dat_cr_liquidac_tit_acr;tta_dat_cr_liquidac_calc;tta_dat_liquidac_tit_acr;tta_cod_autoriz_bco;tta_val_tit_acr;tta_val_liquidac_tit_acr;tta_val_desc_tit_acr;tta_val_abat_tit_acr;tta_val_despes_bcia;tta_val_multa_tit_acr;tta_val_juros;tta_val_cm_tit_acr;tta_val_liquidac_orig;tta_val_desc_tit_acr_orig;tta_val_abat_tit_acr_orig;tta_val_despes_bcia_orig;tta_val_multa_tit_acr_origin;tta_val_juros_tit_acr_orig;tta_val_cm_tit_acr_orig;tta_val_nota_db_orig;tta_log_gera_antecip;tta_des_text_histor;tta_ind_sit_item_lote_liquidac;tta_log_gera_avdeb;tta_cod_indic_econ_avdeb;tta_cod_portad_avdeb;tta_cod_cart_bcia_avdeb;tta_dat_vencto_avdeb;tta_val_perc_juros_avdeb;tta_val_avdeb;tta_log_movto_comis_estordo;tta_ind_tip_item_liquidac_acr;ttv_rec_lote_liquidac_acr;ttv_rec_item_lote_liquidac_acr;tta_cod_livre_1;tta_cod_livre_2;tta_log_livre_1;tta_log_livre_2;tta_dat_livre_1;tta_dat_livre_2;tta_val_livre_1;tta_val_livre_2;tta_num_livre_1;tta_num_livre_2;tta_val_cotac_indic_econ;tta_ind_tip_calc_juros;tta_log_retenc_impto_liq;tta_val_retenc_pis;tta_val_retenc_cofins;tta_val_retenc_csll;ttv_log_verific_reg_perda_dedut;" SKIP.
               FOR EACH tt_integr_acr_liq_item_lote_3:
                   EXPORT DELIMITER ";" tt_integr_acr_liq_item_lote_3.
               END.
               OUTPUT CLOSE.
        end.
        
        run pi_main_code_api_integr_acr_liquidac_6 in v_hdl_aux (Input 1,
                                                                 input table tt_integr_acr_liquidac_lote,
                                                                 input table tt_integr_acr_liq_item_lote_3,
                                                                 input table tt_integr_acr_abat_antecip,
                                                                 input table tt_integr_acr_abat_prev,
                                                                 input table tt_integr_acr_cheq,
                                                                 input table tt_integr_acr_liquidac_impto_2,
                                                                 input table tt_integr_acr_rel_pend_cheq,
                                                                 input table tt_integr_acr_liq_aprop_ctbl,
                                                                 input table tt_integr_acr_liq_desp_rec,
                                                                 input table tt_integr_acr_aprop_liq_antec,
                                                                 INPUT '', /*Matriz de traduá∆o*/
                                                                 output table tt_log_erros_import_liquidac,
                                                                 input table tt_integr_cambio_ems5,
                                                                 input table tt_params_generic_api).
        
        Delete procedure v_hdl_aux.

        FOR EACH tt_log_erros_import_liquidac:

            create TI_FALHA_DE_PROCESSO. 
              assign
              TI_FALHA_DE_PROCESSO.CDINTEGRACAO = "Baixa Receber"
              TI_FALHA_DE_PROCESSO.TXAJUDA = tt_log_erros_import_liquidac.ttv_des_msg_erro
              TI_FALHA_DE_PROCESSO.TXFALHA = "Erro na Atualizaá∆o do Lote de Liquidaá∆o"
              TI_FALHA_DE_PROCESSO.NRMENSAGEM = tt_log_erros_import_liquidac.ttv_num_erro_log 
              TI_FALHA_DE_PROCESSO.NRSEQ_CONTROLE_INTEGRACAO = ti_cx_bx_acr.nrseq_controle_integracao.
 
            ASSIGN lg_erro_bx_aux=YES.
        END.

        IF lg_erro_bx_aux THEN DO:

          find b_ti_cx_bx_acr where rowid(b_ti_cx_bx_acr) = rowid(ti_cx_bx_acr) no-error.

          ASSIGN ti_cx_bx_acr.cdsituacao="PE".

        END.
        ELSE DO:
        
          find b_ti_cx_bx_acr where rowid(b_ti_cx_bx_acr) = rowid(ti_cx_bx_acr) no-error.

          ASSIGN ti_cx_bx_acr.cdsituacao="IT".

        END.

    END.
    ELSE DO: 

        RUN escrever-log("@@@@@ NAO ACHOU TIT_ACR").

       /* manter ocorrencia na fila ('RC') caso o titulo ainda nao esteja integrado.
       create TI_FALHA_DE_PROCESSO. 
       assign
             TI_FALHA_DE_PROCESSO.CDINTEGRACAO = "Baixa Receber"
             TI_FALHA_DE_PROCESSO.TXAJUDA = "N∆o Encontrou Titulo no ACR"
             TI_FALHA_DE_PROCESSO.TXFALHA = "T°tulo n∆o existe no ACR"
             TI_FALHA_DE_PROCESSO.NRMENSAGEM = 0 
             TI_FALHA_DE_PROCESSO.NRSEQ_CONTROLE_INTEGRACAO = ti_cx_bx_acr.nrseq_controle_integracao.

        /* Josias - 30-06-2015 - Comentei a linha para que o sistema reprecesso a baixo novamente, e verifique se o titulo j· foi inserido. */       
		/* find b_ti_cx_bx_acr where rowid(b_ti_cx_bx_acr) = rowid(ti_cx_bx_acr) no-error.*/
        /* ASSIGN ti_cx_bx_acr.cdsituacao="RC".*/ /* vinicius 34-07-2015 alterado para continuar RC* - Alessandro 03/08/2014 */

		ASSIGN ti_cx_bx_acr.cdsituacao="PE".
       */
    END.
END.

PROCEDURE escrever-log:
    DEF INPUT PARAM ds-par AS CHAR NO-UNDO.
END PROCEDURE.
